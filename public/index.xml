<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Ryan Yang</title>
    <link>https://www.yangcs.net/</link>
    <description>Recent content on Ryan Yang</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <lastBuildDate>Tue, 23 Jan 2018 08:26:58 +0000</lastBuildDate>
    <atom:link href="/" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Linuxå…¨å±€æ™ºèƒ½åˆ†æµæ–¹æ¡ˆ</title>
      <link>https://www.yangcs.net/posts/linux-circumvent/</link>
      <pubDate>Tue, 23 Jan 2018 08:26:58 +0000</pubDate>
      
      <guid>https://www.yangcs.net/posts/linux-circumvent/</guid>
      <description>&lt;p&gt;
&lt;strong&gt;æœ¬æ¥æˆ‘æ˜¯å†³å®šä¸å†å†™è¿™æ ·çš„æ–‡ç« äº†çš„ã€‚ä½†æ˜¯å‘¢ï¼Œæœ€è¿‘è¿ç»­é…ç½®äº†ä¸¤æ¬¡ &lt;code&gt;ArchLinux&lt;/code&gt;ï¼Œåœ¨é…ç½®è¿™ç§ä¸œè¥¿çš„æ—¶å€™è¿ç»­æ’åˆ°äº†åŒæ ·çš„å‘ï¼ŒåŠ ä¸Šè¿™æ®µæ—¶é—´ç»å¸¸æœ‰äººé—®æˆ‘å…³äº &lt;code&gt;Linux&lt;/code&gt; ä¸‹çš„ &lt;code&gt;shadowsocks&lt;/code&gt; çš„é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘æƒ³äº†æƒ³è¿˜æ˜¯å†™ä¸€ç¯‡è®°å½•ä¸€ä¸‹å§ï¼Œä¹Ÿå…å¾—è‡ªå·±ä»¥åå†å¿˜è®°äº†ã€‚&lt;/strong&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;è¿™é‡Œæœ‰ä¸¤ç§æ–¹æ¡ˆï¼Œéƒ½å¯ä»¥å®ç°å…¨å±€æ™ºèƒ½åˆ†æµã€‚ç¬¬ä¸€ç§æ–¹æ¡ˆçš„æ€è·¯æ˜¯ä½¿ç”¨ &lt;code&gt;ipset&lt;/code&gt; è½½å…¥ &lt;code&gt;chnroute&lt;/code&gt; çš„ &lt;code&gt;IP&lt;/code&gt; åˆ—è¡¨å¹¶ä½¿ç”¨ &lt;code&gt;iptables&lt;/code&gt; å®ç°å¸¦è‡ªåŠ¨åˆ†æµå›½å†…å¤–æµé‡çš„å…¨å±€ä»£ç†ã€‚ä¸ºä»€ä¹ˆä¸ç”¨ &lt;code&gt;PAC&lt;/code&gt; å‘¢ï¼Ÿå› ä¸º &lt;code&gt;PAC&lt;/code&gt; è¿™ç§ä¸œè¥¿åªå¯¹æµè§ˆå™¨æœ‰ç”¨ã€‚éš¾é“ä½ åœ¨æµè§ˆå™¨ä¹‹å¤–å°±ä¸éœ€è¦ç§‘å­¦ä¸Šç½‘äº†å—ï¼Ÿåæ­£æˆ‘æ˜¯ä¸ä¿¡çš„â€¦â€¦&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&lt;font color=Blue&gt;æœ¬æ•™ç¨‹æ‰€ç”¨ç³»ç»Ÿä¸º &lt;code&gt;Archlinux&lt;/code&gt;ï¼Œå…¶ä»–å‘å‹ç‰ˆç±»ä¼¼ï¼Œè¯·è‡ªè¡Œå‚è€ƒç›¸å…³èµ„æ–™ã€‚&lt;/font&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;h2 id=&#34;p-markdown-1-style-margin-bottom-2em-margin-right-5px-padding-8px-15px-letter-spacing-2px-background-image-linear-gradient-to-right-bottom-rgb-0-188-212-rgb-63-81-181-background-color-rgb-63-81-181-color-rgb-255-255-255-border-left-10px-solid-rgb-51-51-51-border-radius-5px-text-shadow-rgb-102-102-102-1px-1px-1px-box-shadow-rgb-102-102-102-1px-1px-2px-1-é€šè¿‡-iptables-å®ç°æ™ºèƒ½åˆ†æµ-p&#34;&gt;&lt;p markdown=&#34;1&#34; style=&#34;margin-bottom:2em; margin-right: 5px; padding: 8px 15px; letter-spacing: 2px; background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); background-color: rgb(63, 81, 181); color: rgb(255, 255, 255); border-left: 10px solid rgb(51, 51, 51); border-radius:5px; text-shadow: rgb(102, 102, 102) 1px 1px 1px; box-shadow: rgb(102, 102, 102) 1px 1px 2px;&#34;&gt;1. é€šè¿‡ iptables å®ç°æ™ºèƒ½åˆ†æµ&lt;/p&gt;&lt;/h2&gt;

&lt;h3 id=&#34;1-1-å®‰è£…ç›¸å…³è½¯ä»¶&#34;&gt;1.1 å®‰è£…ç›¸å…³è½¯ä»¶&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;shadowsocks-libev&lt;/li&gt;
&lt;li&gt;ipset&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ pacman -S shadowsocks-libev ipset
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;1-2-é…ç½®shadowsocks-libev-ç•¥è¿‡&#34;&gt;1.2 é…ç½®shadowsocks-libevï¼ˆç•¥è¿‡ï¼‰&lt;/h3&gt;

&lt;p&gt;å‡è®¾shadowsocksé…ç½®æ–‡ä»¶ä¸º/etc/shadowsocks.json&lt;/p&gt;

&lt;h3 id=&#34;1-3-è·å–ä¸­å›½ipæ®µ&#34;&gt;1.3 è·å–ä¸­å›½IPæ®µ&lt;/h3&gt;

&lt;p&gt;å°†ä»¥ä¸‹å‘½ä»¤å†™å…¥è„šæœ¬ä¿å­˜æ‰§è¡Œï¼ˆå‡è®¾ä¿å­˜åœ¨/home/yang/bin/è·¯ç”±è¡¨/ç›®å½•ä¸‹ï¼‰ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#!/bin/sh
wget -c http://ftp.apnic.net/stats/apnic/delegated-apnic-latest
cat delegated-apnic-latest | awk -F &#39;|&#39; &#39;/CN/&amp;amp;&amp;amp;/ipv4/ {print $4 &amp;quot;/&amp;quot; 32-log($5)/log(2)}&#39; | cat &amp;gt; /home/yang/bin/è·¯ç”±è¡¨/cn_rules.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;1-4-åˆ›å»ºå¯åŠ¨å’Œå…³é—­è„šæœ¬&#34;&gt;1.4 åˆ›å»ºå¯åŠ¨å’Œå…³é—­è„šæœ¬&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ vim /home/yang/bin/shadowsocks/ss-up.sh
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#!/bin/bash

SOCKS_SERVER=$SERVER_IP # SOCKS æœåŠ¡å™¨çš„ IP åœ°å€
# Setup the ipset
ipset -N chnroute hash:net maxelem 65536

for ip in $(cat &#39;/home/yang/bin/è·¯ç”±è¡¨/cn_rules.conf&#39;); do
  ipset add chnroute $ip
done

# åœ¨natè¡¨ä¸­æ–°å¢ä¸€ä¸ªé“¾ï¼Œåå«ï¼šSHADOWSOCKS
iptables -t nat -N SHADOWSOCKS

# Allow connection to the server
iptables -t nat -A SHADOWSOCKS -d $SOCKS_SERVER -j RETURN

# Allow connection to reserved networks
iptables -t nat -A SHADOWSOCKS -d 0.0.0.0/8 -j RETURN
iptables -t nat -A SHADOWSOCKS -d 10.0.0.0/8 -j RETURN
iptables -t nat -A SHADOWSOCKS -d 127.0.0.0/8 -j RETURN
iptables -t nat -A SHADOWSOCKS -d 169.254.0.0/16 -j RETURN
iptables -t nat -A SHADOWSOCKS -d 172.16.0.0/12 -j RETURN
iptables -t nat -A SHADOWSOCKS -d 192.168.0.0/16 -j RETURN
iptables -t nat -A SHADOWSOCKS -d 224.0.0.0/4 -j RETURN
iptables -t nat -A SHADOWSOCKS -d 240.0.0.0/4 -j RETURN

# Allow connection to chinese IPs
iptables -t nat -A SHADOWSOCKS -p tcp -m set --match-set chnroute dst -j RETURN
# å¦‚æœä½ æƒ³å¯¹ icmp åè®®ä¹Ÿå®ç°æ™ºèƒ½åˆ†æµï¼Œå¯ä»¥åŠ ä¸Šä¸‹é¢è¿™ä¸€æ¡
# iptables -t nat -A SHADOWSOCKS -p icmp -m set --match-set chnroute dst -j RETURN

# Redirect to Shadowsocks
# æŠŠ1081æ”¹æˆä½ çš„shadowsocksæœ¬åœ°ç«¯å£
iptables -t nat -A SHADOWSOCKS -p tcp -j REDIRECT --to-port 1081
# å¦‚æœä½ æƒ³å¯¹ icmp åè®®ä¹Ÿå®ç°æ™ºèƒ½åˆ†æµï¼Œå¯ä»¥åŠ ä¸Šä¸‹é¢è¿™ä¸€æ¡
# iptables -t nat -A SHADOWSOCKS -p icmp -j REDIRECT --to-port 1081

# å°†SHADOWSOCKSé“¾ä¸­æ‰€æœ‰çš„è§„åˆ™è¿½åŠ åˆ°OUTPUTé“¾ä¸­
iptables -t nat -A OUTPUT -p tcp -j SHADOWSOCKS
# å¦‚æœä½ æƒ³å¯¹ icmp åè®®ä¹Ÿå®ç°æ™ºèƒ½åˆ†æµï¼Œå¯ä»¥åŠ ä¸Šä¸‹é¢è¿™ä¸€æ¡
# iptables -t nat -A OUTPUT -p icmp -j SHADOWSOCKS

# å†…ç½‘æµé‡æµç» shadowsocks è§„åˆ™é“¾
iptables -t nat -A PREROUTING -s 192.168/16 -j SHADOWSOCKS
# å†…ç½‘æµé‡æºNAT
iptables -t nat -A POSTROUTING -s 192.168/16 -j MASQUERADE
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&amp;emsp;&amp;emsp;è¿™æ˜¯åœ¨å¯åŠ¨ &lt;code&gt;shadowsocks&lt;/code&gt; ä¹‹å‰æ‰§è¡Œçš„è„šæœ¬ï¼Œç”¨æ¥è®¾ç½® &lt;code&gt;iptables&lt;/code&gt; è§„åˆ™ï¼Œå¯¹å…¨å±€åº”ç”¨ä»£ç†å¹¶å°† &lt;code&gt;chnroute&lt;/code&gt; å¯¼å…¥ &lt;code&gt;ipset&lt;/code&gt; æ¥å®ç°è‡ªåŠ¨åˆ†æµã€‚æ³¨æ„è¦æŠŠæœåŠ¡å™¨ &lt;code&gt;IP&lt;/code&gt; å’Œæœ¬åœ°ç«¯å£ç›¸å…³çš„ä»£ç å…¨éƒ¨æ›¿æ¢æˆä½ è‡ªå·±çš„ã€‚
&amp;emsp;&amp;emsp;è¿™é‡Œå°±æœ‰ä¸€ä¸ªå‘äº†ï¼Œå°±æ˜¯åœ¨æŠŠ &lt;code&gt;chnroute.txt&lt;/code&gt; åŠ å…¥ &lt;code&gt;ipset&lt;/code&gt; çš„æ—¶å€™ã€‚å› ä¸º &lt;code&gt;chnroute.txt&lt;/code&gt; æ˜¯ä¸€ä¸ª &lt;code&gt;IP&lt;/code&gt; æ®µåˆ—è¡¨ï¼Œè€Œä¸­å›½æŒæœ‰çš„ &lt;code&gt;IP&lt;/code&gt; æ•°é‡ä¸Šè¿˜æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œæ‰€ä»¥å¦‚æœä½¿ç”¨ &lt;code&gt;hash:ip&lt;/code&gt; æ¥å¯¼å…¥çš„è¯ä¼šä½¿å†…å­˜æº¢å‡ºã€‚æˆ‘åœ¨ç¬¬äºŒæ¬¡é‡æ–°é…ç½®çš„æ—¶å€™å°±æ’è¿›äº†è¿™ä¸ªå¤§å‘â€¦â€¦
&amp;emsp;&amp;emsp;ä½†æ˜¯ä½ ä¹Ÿä¸èƒ½å°è¯•æŠŠæ•´ä¸ªåˆ—è¡¨å¯¼å…¥ &lt;code&gt;iptables&lt;/code&gt;ã€‚è™½ç„¶å¯¼å…¥ &lt;code&gt;iptables&lt;/code&gt; ä¸ä¼šå¯¼è‡´å†…å­˜æº¢å‡ºï¼Œä½†æ˜¯ &lt;code&gt;iptables&lt;/code&gt; æ˜¯çº¿æ€§æŸ¥è¡¨ï¼Œå³ä½¿ä½ å…¨éƒ¨å¯¼å…¥è¿›å»ï¼Œä¹Ÿä¼šå› ä¸ºä½ä¸‹çš„æ€§èƒ½è€ŒæŠ“ç‹‚ã€‚
&lt;br \&gt;
ç„¶åå†åˆ›å»º &lt;code&gt;/home/yang/bin/shadowsocks/ss-down.sh&lt;/code&gt;, è¿™æ˜¯ç”¨æ¥æ¸…é™¤ä¸Šè¿°è§„åˆ™çš„è„šæœ¬ï¼Œæ¯”è¾ƒç®€å•&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#!/bin/bash

# iptables -t nat -D OUTPUT -p icmp -j SHADOWSOCKS
iptables -t nat -D OUTPUT -p tcp -j SHADOWSOCKS
iptables -t nat -F SHADOWSOCKS
iptables -t nat -X SHADOWSOCKS
ipset destroy chnroute
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ¥ç€æ‰§è¡Œ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ chmod +x ss-up.sh
$ chmod +x ss-down.sh
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;1-5-é…ç½®ss-rediræœåŠ¡&#34;&gt;1.5 é…ç½®ss-rediræœåŠ¡&lt;/h3&gt;

&lt;p&gt;é¦–å…ˆï¼Œé»˜è®¤çš„ &lt;code&gt;ss-local&lt;/code&gt; å¹¶ä¸èƒ½ç”¨æ¥ä½œä¸º &lt;code&gt;iptables&lt;/code&gt; æµé‡è½¬å‘çš„ç›®æ ‡ï¼Œå› ä¸ºå®ƒæ˜¯ &lt;code&gt;socks5&lt;/code&gt; ä»£ç†è€Œéé€æ˜ä»£ç†ã€‚æˆ‘ä»¬è‡³å°‘è¦æŠŠ &lt;code&gt;systemd&lt;/code&gt; æ‰§è¡Œçš„ç¨‹åºæ”¹æˆ &lt;code&gt;ss-redir&lt;/code&gt;ã€‚å…¶æ¬¡ï¼Œä¸Šè¿°ä¸¤ä¸ªè„šæœ¬è¿˜ä¸èƒ½è‡ªåŠ¨æ‰§è¡Œï¼Œå¿…é¡»è®© &lt;code&gt;systemd&lt;/code&gt; åˆ†åˆ«åœ¨å¯åŠ¨ &lt;code&gt;shadowsocks&lt;/code&gt; ä¹‹å‰å’Œå…³é—­ä¹‹åå°†è„šæœ¬æ‰§è¡Œï¼Œè¿™æ ·æ‰èƒ½è‡ªåŠ¨é…ç½®å¥½ &lt;code&gt;iptables&lt;/code&gt; è§„åˆ™ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ vim /usr/lib/systemd/system/shadowsocks-libev@.service
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[Unit]
Description=Shadowsocks-Libev Client Service
After=network.target

[Service]
User=root
CapabilityBoundingSet=~CAP_SYS_ADMIN
ExecStart=
ExecStartPre=/home/yang/bin/shadowsocks/ss-up.sh
ExecStart=/usr/bin/ss-redir -u -c /etc/%i.json
ExecStopPost=/home/yang/bin/shadowsocks/ss-down.sh

[Install]
WantedBy=multi-user.target
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶åå¯åŠ¨æœåŠ¡&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ systemctl start shadowsocks-libev@shadowsocks
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¼€æœºè‡ªå¯&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ systemctl enable shadowsocks-libev@shadowsocks
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;1-6-é…ç½®æ™ºèƒ½-dns-æœåŠ¡&#34;&gt;1.6 é…ç½®æ™ºèƒ½ DNS æœåŠ¡&lt;/h3&gt;

&lt;p&gt;å®Œæˆäº†ä»¥ä¸Šå·¥ä½œä¹‹åæ˜¯ä¸æ˜¯å°±å¯ä»¥å®ç°å…¨å±€ç§‘å­¦ä¸Šç½‘äº†å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œæˆ‘ä»¬è¿˜æœ‰æœ€åä¸€é¡¹å·¥ä½œéœ€è¦å®Œæˆï¼Œé‚£å°±æ˜¯è§£å†³ &lt;code&gt;DNS&lt;/code&gt; æ±¡æŸ“é—®é¢˜ã€‚å¦‚æœä½ ä¸çŸ¥é“ä»€ä¹ˆæ˜¯ &lt;code&gt;DNS&lt;/code&gt; æ±¡æŸ“ï¼Œæˆ‘å¯ä»¥ç®€å•åœ°ç»™ä½ æ™®åŠä¸€ä¸‹ï¼š&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;DNS&lt;/code&gt; æ±¡æŸ“æ˜¯ä¸€ç§è®©ä¸€èˆ¬ç”¨æˆ·ç”±äºå¾—åˆ°è™šå‡ç›®æ ‡ä¸»æœº &lt;code&gt;IP&lt;/code&gt; è€Œä¸èƒ½ä¸å…¶é€šä¿¡çš„æ–¹æ³•ï¼Œæ˜¯ä¸€ç§ &lt;code&gt;DNS&lt;/code&gt; ç¼“å­˜æŠ•æ¯’æ”»å‡»ï¼ˆDNS cache poisoningï¼‰ã€‚å…¶å·¥ä½œæ–¹å¼æ˜¯ï¼šç”±äºé€šå¸¸çš„ &lt;code&gt;DNS&lt;/code&gt; æŸ¥è¯¢æ²¡æœ‰ä»»ä½•è®¤è¯æœºåˆ¶ï¼Œè€Œä¸” &lt;code&gt;DNS&lt;/code&gt; æŸ¥è¯¢é€šå¸¸åŸºäºçš„ &lt;code&gt;UDP&lt;/code&gt; æ˜¯æ— è¿æ¥ä¸å¯é çš„åè®®ï¼Œå› æ­¤ &lt;code&gt;DNS&lt;/code&gt; çš„æŸ¥è¯¢éå¸¸å®¹æ˜“è¢«ç¯¡æ”¹ï¼Œé€šè¿‡å¯¹ &lt;code&gt;UDP&lt;/code&gt; ç«¯å£ 53 ä¸Šçš„ &lt;code&gt;DNS&lt;/code&gt; æŸ¥è¯¢è¿›è¡Œå…¥ä¾µæ£€æµ‹ï¼Œä¸€ç»å‘ç°ä¸å…³é”®è¯ç›¸åŒ¹é…çš„è¯·æ±‚åˆ™ç«‹å³ä¼ªè£…æˆç›®æ ‡åŸŸåçš„è§£ææœåŠ¡å™¨ï¼ˆNSï¼ŒName Serverï¼‰ç»™æŸ¥è¯¢è€…è¿”å›è™šå‡ç»“æœã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;code&gt;DNS&lt;/code&gt; æ±¡æŸ“ç—‡çŠ¶ï¼šç›®å‰ä¸€äº›è¢«ç¦æ­¢è®¿é—®çš„ç½‘ç«™å¾ˆå¤šå°±æ˜¯é€šè¿‡ &lt;code&gt;DNS&lt;/code&gt; æ±¡æŸ“æ¥å®ç°çš„ï¼Œä¾‹å¦‚ &lt;code&gt;YouTube&lt;/code&gt;ã€&lt;code&gt;Facebook&lt;/code&gt; ç­‰ç½‘ç«™ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;åº”å¯¹dnsæ±¡æŸ“çš„æ–¹æ³•&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å¯¹äº &lt;code&gt;DNS&lt;/code&gt; æ±¡æŸ“ï¼Œå¯ä»¥è¯´ï¼Œä¸ªäººç”¨æˆ·å¾ˆéš¾å•å•é è®¾ç½®è§£å†³ï¼Œé€šå¸¸å¯ä»¥ä½¿ç”¨ &lt;code&gt;VPN&lt;/code&gt; æˆ–è€…åŸŸåè¿œç¨‹è§£æçš„æ–¹æ³•è§£å†³ï¼Œä½†è¿™å¤§å¤šéœ€è¦è´­ä¹°ä»˜è´¹çš„ &lt;code&gt;VPN&lt;/code&gt; æˆ– &lt;code&gt;SSH&lt;/code&gt; ç­‰&lt;/li&gt;
&lt;li&gt;ä¿®æ”¹ &lt;code&gt;Hosts&lt;/code&gt; çš„æ–¹æ³•ï¼Œæ‰‹åŠ¨è®¾ç½®åŸŸåæ­£ç¡®çš„ &lt;code&gt;IP&lt;/code&gt; åœ°å€&lt;/li&gt;
&lt;li&gt;&lt;code&gt;dns&lt;/code&gt; åŠ å¯†è§£æï¼š&lt;a href=&#34;https://dnscrypt.org/&#34; target=&#34;_blank&#34;&gt;DNSCrypt&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;å¿½ç•¥ &lt;code&gt;DNS&lt;/code&gt; æŠ•æ¯’æ±¡æŸ“å°å·¥å…·ï¼š&lt;a href=&#34;https://github.com/chengr28/Pcap_DNSProxy&#34; target=&#34;_blank&#34;&gt;Pcap_DNSProxy&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æˆ‘ä»¬é€‰æ‹©ç”¨ &lt;code&gt;Pcap_DNSProxy&lt;/code&gt; æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä»¥å‰ç”¨çš„æ˜¯ &lt;code&gt;Pdnsd + Dnsmasq&lt;/code&gt; ç»„åˆï¼Œ åæ¥å‘ç° &lt;code&gt;TCP&lt;/code&gt; è¯·æ±‚æ•ˆç‡å¤ªä½åŠ ä¸Šå®¶é‡Œç½‘ç»œä¸é‚£äº›å›½å¤–çš„ &lt;code&gt;DNS&lt;/code&gt; ä¸¢åŒ…å®åœ¨æ˜¯ä¸¥é‡ï¼Œ æ‰€ä»¥æ‰“ç®—ç”¨ &lt;code&gt;Pcap_DNSProxy&lt;/code&gt; ä»£æ›¿ &lt;code&gt;Pdnsd&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;å…³äº &lt;code&gt;Pcap_DNSProxy&lt;/code&gt; çš„è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥å‚è€ƒ:
&lt;a href=&#34;https://github.com/chengr28/Pcap_DNSProxy&#34; target=&#34;_blank&#34;&gt;https://github.com/chengr28/Pcap_DNSProxy&lt;/a&gt;
å®‰è£…è¿‡ç¨‹å¯ä»¥å‚è€ƒï¼š
&lt;a href=&#34;https://github.com/chengr28/Pcap_DNSProxy/blob/master/Documents/ReadMe_Linux.zh-Hans.txt&#34; target=&#34;_blank&#34;&gt;https://github.com/chengr28/Pcap_DNSProxy/blob/master/Documents/ReadMe_Linux.zh-Hans.txt&lt;/a&gt;
æ›´è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜å¯ä»¥å‚è€ƒï¼š
&lt;a href=&#34;https://github.com/chengr28/Pcap_DNSProxy/blob/master/Documents/ReadMe.zh-Hans.txt&#34; target=&#34;_blank&#34;&gt;https://github.com/chengr28/Pcap_DNSProxy/blob/master/Documents/ReadMe.zh-Hans.txt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;è¿™é‡Œä¸»è¦é‡ç‚¹å¼ºè°ƒä¸€äº›éœ€è¦æ³¨æ„çš„é…ç½®é¡¹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;DNS&lt;/code&gt; - å¢ƒå¤–åŸŸåè§£æå‚æ•°åŒºåŸŸï¼ˆè¿™æ˜¯æœ€å…³é”®çš„ä¸€é¡¹é…ç½®ï¼‰&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[DNS]
# è¿™é‡Œä¸€å®šè¦å¡« IPv4 + TCPï¼ï¼ï¼è¡¨ç¤ºåªä½¿ç”¨ TCP åè®®å‘å¢ƒå¤–è¿œç¨‹ DNS æœåŠ¡å™¨å‘å‡ºè¯·æ±‚
Outgoing Protocol = IPv4 + TCP
# å»ºè®®å½“ç³»ç»Ÿä½¿ç”¨å…¨å±€ä»£ç†åŠŸèƒ½æ—¶å¯ç”¨ï¼Œç¨‹åºå°†é™¤å¢ƒå†…æœåŠ¡å™¨å¤–çš„æ‰€æœ‰è¯·æ±‚ç›´æ¥äº¤ç»™ç³»ç»Ÿè€Œä¸ä½œä»»ä½•è¿‡æ»¤ç­‰å¤„ç†ï¼Œç³»ç»Ÿä¼šå°†è¯·æ±‚è‡ªåŠ¨å‘å¾€è¿œç¨‹æœåŠ¡å™¨è¿›è¡Œè§£æ
Direct Request = IPv4
...
...
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Local DNS&lt;/code&gt; - å¢ƒå†…åŸŸåè§£æå‚æ•°åŒºåŸŸ&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[Local DNS]
# å‘é€è¯·æ±‚åˆ°å¢ƒå†… DNS æœåŠ¡å™¨æ—¶æ‰€ä½¿ç”¨çš„åè®®
Local Protocol = IPv4 + UDP
...
...
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Addresses&lt;/code&gt; - æ™®é€šæ¨¡å¼åœ°å€åŒºåŸŸ&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[Addresses]
...
...
# IPv4 ä¸»è¦å¢ƒå¤– DNS æœåŠ¡å™¨åœ°å€
IPv4 Main DNS Address = 8.8.4.4:53
# IPv4 å¤‡ç”¨å¢ƒå¤– DNS æœåŠ¡å™¨åœ°å€
IPv4 Alternate DNS Address = 8.8.8.8:53|208.67.220.220:443|208.67.222.222:5353
# IPv4 ä¸»è¦å¢ƒå†… DNS æœåŠ¡å™¨åœ°å€ï¼Œç”¨äºå¢ƒå†…åŸŸåè§£æï¼Œæ¨èä½¿ç”¨ onedns
IPv4 Local Main DNS Address = 112.124.47.27:53
# IPv4 å¤‡ç”¨å¢ƒå†… DNS æœåŠ¡å™¨åœ°å€ï¼Œç”¨äºå¢ƒå†…åŸŸåè§£æ
IPv4 Local Alternate DNS Address = 114.215.126.16:53
...
...
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;1-7-é…ç½®ç³»ç»Ÿ-dns-æœåŠ¡å™¨è®¾ç½®&#34;&gt;1.7 é…ç½®ç³»ç»Ÿ DNS æœåŠ¡å™¨è®¾ç½®&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;å¯å‚è§ &lt;a href=&#34;https://developers.google.com/speed/public-dns/docs/using&#34; target=&#34;_blank&#34;&gt;https://developers.google.com/speed/public-dns/docs/using&lt;/a&gt; ä¸­ &lt;code&gt;Changing your DNS servers settings&lt;/code&gt; ä¸­ &lt;code&gt;Linux&lt;/code&gt; ä¸€èŠ‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;å›¾å½¢ç•Œé¢ä»¥ &lt;code&gt;GNOME 3&lt;/code&gt; ä¸ºä¾‹ï¼š&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;æ‰“å¼€æ‰€æœ‰ç¨‹åºåˆ—è¡¨ï¼Œå¹¶ -&amp;gt; è®¾ç½® â€“ ç¡¬ä»¶åˆ†ç±» â€“ ç½‘ç»œ&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;å¦‚æœè¦å¯¹å½“å‰çš„ç½‘ç»œé…ç½®è¿›è¡Œç¼–è¾‘ -&amp;gt; å•å‡»é½¿è½®æŒ‰é’®&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;é€‰ä¸­ &lt;code&gt;IPv4&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;code&gt;DNS&lt;/code&gt; æ ç›®ä¸­ï¼Œå°†è‡ªåŠ¨æ‹¨å‘å…³é—­&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;åœ¨æœåŠ¡å™¨ä¸­å¡«å…¥ &lt;code&gt;127.0.0.1&lt;/code&gt; ï¼ˆæˆ–103.214.195.99:7300ï¼‰å¹¶åº”ç”¨&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;é€‰ä¸­ &lt;code&gt;IPv6&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;code&gt;DNS&lt;/code&gt; æ ç›®ä¸­ï¼Œå°†è‡ªåŠ¨æ‹¨å‘å…³é—­&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;åœ¨æœåŠ¡å™¨ä¸­å¡«å…¥ ::1 å¹¶åº”ç”¨&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;è¯·åŠ¡å¿…ç¡®ä¿åªå¡«å…¥è¿™ä¸¤ä¸ªåœ°å€ï¼Œå¡«å…¥å…¶å®ƒåœ°å€å¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿé€‰æ‹©å…¶å®ƒ DNS æœåŠ¡å™¨ç»•è¿‡ç¨‹åºçš„ä»£ç†&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;é‡å¯ç½‘ç»œè¿æ¥&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;ç›´æ¥ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶ä¿®æ”¹ DNS æœåŠ¡å™¨è®¾ç½®ï¼š&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;è‡ªåŠ¨è·å–åœ°å€(DHCP)æ—¶ï¼š&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;ä»¥ &lt;code&gt;root&lt;/code&gt; æƒé™è¿›å…¥ &lt;code&gt;/etc/dhcp&lt;/code&gt; æˆ– &lt;code&gt;/etc/dhcp3&lt;/code&gt; ç›®å½•ï¼ˆè§†ä¹ dhclient.conf æ–‡ä»¶ä½ç½®ï¼‰&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;ç›´æ¥ä¿®æ”¹ &lt;code&gt;dhclient.conf&lt;/code&gt; æ–‡ä»¶ï¼Œä¿®æ”¹æˆ–æ·»åŠ  &lt;code&gt;prepend domain-name-servers&lt;/code&gt; ä¸€é¡¹å³å¯&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;å¦‚æœ &lt;code&gt;prepend domain-name-servers&lt;/code&gt; ä¸€é¡¹è¢« # æ³¨é‡Šåˆ™éœ€è¦æŠŠæ³¨é‡Šå»æ‰ä»¥ä½¿é…ç½®ç”Ÿæ•ˆï¼Œä¸éœ€è¦æ·»åŠ æ–°çš„æ¡ç›®&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;code&gt;dhclient.conf&lt;/code&gt; æ–‡ä»¶å¯èƒ½å­˜åœ¨å¤šä¸ª &lt;code&gt;prepend domain-name-servers&lt;/code&gt; é¡¹ï¼Œæ˜¯å„ä¸ªç½‘ç»œæ¥å£çš„é…ç½®é¡¹ç›®ï¼Œç›´æ¥ä¿®æ”¹æ€»çš„é…ç½®é¡¹ç›®å³å¯&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;ä½¿ç”¨ &lt;code&gt;service network(/networking) restart&lt;/code&gt; æˆ– &lt;code&gt;ifdown/ifup&lt;/code&gt; æˆ– &lt;code&gt;ifconfig stop/start&lt;/code&gt; é‡å¯ç½‘ç»œæœåŠ¡/ç½‘ç»œç«¯å£&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;éè‡ªåŠ¨è·å–åœ°å€(DHCP)æ—¶ï¼š&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;ä»¥ &lt;code&gt;root&lt;/code&gt; æƒé™è¿›å…¥ &lt;code&gt;/etc&lt;/code&gt; ç›®å½•&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;ç›´æ¥ä¿®æ”¹ &lt;code&gt;resolv.conf&lt;/code&gt; æ–‡ä»¶é‡Œçš„ &lt;code&gt;nameserver&lt;/code&gt; å³å¯&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;å¦‚æœé‡å¯åé…ç½®è¢«è¦†ç›–ï¼Œåˆ™éœ€è¦ä¿®æ”¹æˆ–æ–°å»º &lt;code&gt;/etc/resolvconf/resolv.conf.d&lt;/code&gt; æ–‡ä»¶ï¼Œå†…å®¹å’Œ &lt;code&gt;resolv.conf&lt;/code&gt; ä¸€æ ·&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;ä½¿ç”¨ &lt;code&gt;service network(/networking) restart&lt;/code&gt; æˆ– &lt;code&gt;ifdown/ifup&lt;/code&gt; æˆ– &lt;code&gt;ifconfig stop/start&lt;/code&gt; é‡å¯ç½‘ç»œæœåŠ¡/ç½‘ç»œç«¯å£&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;1-8-æ‰“å¼€æµé‡è½¬å‘&#34;&gt;1.8 æ‰“å¼€æµé‡è½¬å‘&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cat /etc/sysctl.d/30-ipforward.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;net.ipv4.ip_forward=1

net.ipv6.conf.all.forwarding = 1

net.ipv4.tcp_congestion_control=westwood

net.ipv4.tcp_syn_retries = 5

net.ipv4.tcp_synack_retries = 5
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç¼–è¾‘å®Œæˆåï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä½¿å˜åŠ¨ç«‹å³ç”Ÿæ•ˆ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ sysctl -p
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;p-markdown-1-style-margin-bottom-2em-margin-right-5px-padding-8px-15px-letter-spacing-2px-background-image-linear-gradient-to-right-bottom-rgb-0-188-212-rgb-63-81-181-background-color-rgb-63-81-181-color-rgb-255-255-255-border-left-10px-solid-rgb-51-51-51-border-radius-5px-text-shadow-rgb-102-102-102-1px-1px-1px-box-shadow-rgb-102-102-102-1px-1px-2px-2-é€šè¿‡-nftables-å®ç°æ™ºèƒ½åˆ†æµ-p&#34;&gt;&lt;p markdown=&#34;1&#34; style=&#34;margin-bottom:2em; margin-right: 5px; padding: 8px 15px; letter-spacing: 2px; background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); background-color: rgb(63, 81, 181); color: rgb(255, 255, 255); border-left: 10px solid rgb(51, 51, 51); border-radius:5px; text-shadow: rgb(102, 102, 102) 1px 1px 1px; box-shadow: rgb(102, 102, 102) 1px 1px 2px;&#34;&gt;2. é€šè¿‡ nftables å®ç°æ™ºèƒ½åˆ†æµ&lt;/p&gt;&lt;/h2&gt;

&lt;h3 id=&#34;2-1-å®‰è£…ç›¸å…³è½¯ä»¶&#34;&gt;2.1 å®‰è£…ç›¸å…³è½¯ä»¶&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;shadowsocks-libev&lt;/li&gt;
&lt;li&gt;nftables&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ pacman -S shadowsocks-libev nftables
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;2-2-é…ç½®shadowsocks-libev-ç•¥è¿‡&#34;&gt;2.2 é…ç½®shadowsocks-libevï¼ˆç•¥è¿‡ï¼‰&lt;/h3&gt;

&lt;p&gt;å‡è®¾shadowsocksé…ç½®æ–‡ä»¶ä¸º/etc/shadowsocks.json&lt;/p&gt;

&lt;h3 id=&#34;2-3-è·å–ä¸­å›½ipæ®µ&#34;&gt;2.3 è·å–ä¸­å›½IPæ®µ&lt;/h3&gt;

&lt;p&gt;å°†ä»¥ä¸‹å‘½ä»¤å†™å…¥è„šæœ¬ä¿å­˜æ‰§è¡Œï¼ˆå‡è®¾ä¿å­˜åœ¨/home/yang/bin/è·¯ç”±è¡¨/ç›®å½•ä¸‹ï¼‰ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#!/bin/sh
wget -c http://ftp.apnic.net/stats/apnic/delegated-apnic-latest
cat delegated-apnic-latest | awk -F &#39;|&#39; &#39;/CN/&amp;amp;&amp;amp;/ipv4/ {print $4 &amp;quot;/&amp;quot; 32-log($5)/log(2)}&#39; | cat &amp;gt; /home/yang/bin/è·¯ç”±è¡¨/cn_rules.conf
cat cn_rules.conf|sed &#39;:label;N;s/\n/, /;b label&#39;|sed &#39;s/$/&amp;amp; }/g&#39;|sed &#39;s/^/{ &amp;amp;/g&#39; &amp;gt; /home/yang/bin/è·¯ç”±è¡¨/cn_rules1.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;2-4-åˆ›å»ºå¯åŠ¨å’Œå…³é—­è„šæœ¬&#34;&gt;2.4 åˆ›å»ºå¯åŠ¨å’Œå…³é—­è„šæœ¬&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ vim /home/yang/bin/shadowsocks/nftables-up.sh
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#! /bin/bash

nft_pre=&amp;quot;/usr/sbin/nft add rule nat prerouting&amp;quot;
nft_out=&amp;quot;/usr/sbin/nft add rule nat output&amp;quot;
chnroute=$(cat &#39;/home/yang/bin/è·¯ç”±è¡¨/cn_rules1.conf&#39;)

/usr/bin/nft -f /etc/nftables.conf

${nft_pre} tcp dport 8385 return
${nft_pre} ip daddr 139.162.87.98 return
${nft_pre} ip daddr { 0.0.0.0/8, 10.0.0.0/8, 127.0.0.0/8, 169.254.0.0/16, 172.16.0.0/12, 192.168.0.0/16, 224.0.0.0/4, 240.0.0.0/4, 172.16.39.0/24} return
${nft_pre} ip daddr $chnroute return
${nft_pre} tcp sport { 32768-61000} redirect to 1081
#${nft_pre} ip protocol icmp redirect to 1081
# å†…ç½‘æµé‡æºNAT
nft add rule nat postrouting ip saddr 192.168.0.0/12 masquerade

${nft_out} tcp dport 8385 return
${nft_out} ip daddr 139.162.87.98 return
${nft_out} ip daddr { 0.0.0.0/8, 10.0.0.0/8, 127.0.0.0/8, 169.254.0.0/16, 172.16.0.0/12, 192.168.0.0/16, 224.0.0.0/4, 240.0.0.0/4, 172.16.39.0/24} return
${nft_out} ip daddr $chnroute return
# /proc/sys/net/ipv4/ip_local_port_rangeï¼Œæœ¬åœ°å‘èµ·çš„è¿æ¥çš„ç«¯å£èŒƒå›´
${nft_out} tcp sport { 32768-61000} redirect to 1081
${nft_out} ip protocol icmp redirect to 1081
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&amp;emsp;&amp;emsp;è¿™æ˜¯åœ¨å¯åŠ¨ &lt;code&gt;shadowsocks&lt;/code&gt; ä¹‹å‰æ‰§è¡Œçš„è„šæœ¬ï¼Œç”¨æ¥è®¾ç½® &lt;code&gt;nftables&lt;/code&gt; è§„åˆ™ã€‚
ç„¶åå†åˆ›å»º &lt;code&gt;/home/yang/bin/shadowsocks/nftables-down.sh&lt;/code&gt;, è¿™æ˜¯ç”¨æ¥æ¸…é™¤ä¸Šè¿°è§„åˆ™çš„è„šæœ¬ï¼Œæ¯”è¾ƒç®€å•&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#!/bin/bash

sudo nft flush table nat
#sudo nft flush table filter
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ¥ç€æ‰§è¡Œ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ chmod +x nftables-up.sh
$ chmod +x nftables-down.sh
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;2-5-é…ç½®ss-rediræœåŠ¡&#34;&gt;2.5 é…ç½®ss-rediræœåŠ¡&lt;/h3&gt;

&lt;p&gt;é¦–å…ˆï¼Œé»˜è®¤çš„ &lt;code&gt;ss-local&lt;/code&gt; å¹¶ä¸èƒ½ç”¨æ¥ä½œä¸º &lt;code&gt;nftables&lt;/code&gt; æµé‡è½¬å‘çš„ç›®æ ‡ï¼Œå› ä¸ºå®ƒæ˜¯ &lt;code&gt;socks5&lt;/code&gt; ä»£ç†è€Œéé€æ˜ä»£ç†ã€‚æˆ‘ä»¬è‡³å°‘è¦æŠŠ &lt;code&gt;systemd&lt;/code&gt; æ‰§è¡Œçš„ç¨‹åºæ”¹æˆ &lt;code&gt;ss-redir&lt;/code&gt;ã€‚å…¶æ¬¡ï¼Œä¸Šè¿°ä¸¤ä¸ªè„šæœ¬è¿˜ä¸èƒ½è‡ªåŠ¨æ‰§è¡Œï¼Œå¿…é¡»è®© &lt;code&gt;systemd&lt;/code&gt; åˆ†åˆ«åœ¨å¯åŠ¨ &lt;code&gt;shadowsocks&lt;/code&gt; ä¹‹å‰å’Œå…³é—­ä¹‹åå°†è„šæœ¬æ‰§è¡Œï¼Œè¿™æ ·æ‰èƒ½è‡ªåŠ¨é…ç½®å¥½ &lt;code&gt;nftables&lt;/code&gt; è§„åˆ™ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ vim /usr/lib/systemd/system/shadowsocks-libev@.service
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[Unit]
Description=Shadowsocks-Libev Client Service
After=network.target

[Service]
User=root
CapabilityBoundingSet=~CAP_SYS_ADMIN
ExecStart=
ExecStartPre=/home/yang/bin/shadowsocks/nftables-up.sh
ExecStart=/usr/bin/ss-redir -u -c /etc/%i.json
ExecStopPost=/home/yang/bin/shadowsocks/nftables-down.sh

[Install]
WantedBy=multi-user.target
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶åå¯åŠ¨æœåŠ¡&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ systemctl start nftables
$ systemctl start shadowsocks-libev@shadowsocks
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¼€æœºè‡ªå¯&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ systemctl enable nftables
$ systemctl enable shadowsocks-libev@shadowsocks
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;2-6-é…ç½®æ™ºèƒ½-dns-æœåŠ¡&#34;&gt;2.6 é…ç½®æ™ºèƒ½ DNS æœåŠ¡&lt;/h3&gt;

&lt;p&gt;åŒä¸Š&lt;/p&gt;

&lt;h3 id=&#34;2-7-é…ç½®ç³»ç»Ÿ-dns-æœåŠ¡å™¨è®¾ç½®&#34;&gt;2.7 é…ç½®ç³»ç»Ÿ DNS æœåŠ¡å™¨è®¾ç½®&lt;/h3&gt;

&lt;p&gt;åŒä¸Š&lt;/p&gt;

&lt;h3 id=&#34;2-8-æ‰“å¼€æµé‡è½¬å‘&#34;&gt;2.8 æ‰“å¼€æµé‡è½¬å‘&lt;/h3&gt;

&lt;p&gt;åŒä¸Š&lt;/p&gt;

&lt;h2 id=&#34;p-markdown-1-style-margin-bottom-2em-margin-right-5px-padding-8px-15px-letter-spacing-2px-background-image-linear-gradient-to-right-bottom-rgb-0-188-212-rgb-63-81-181-background-color-rgb-63-81-181-color-rgb-255-255-255-border-left-10px-solid-rgb-51-51-51-border-radius-5px-text-shadow-rgb-102-102-102-1px-1px-1px-box-shadow-rgb-102-102-102-1px-1px-2px-3-é€šè¿‡ç­–ç•¥è·¯ç”±å®ç°æ™ºèƒ½åˆ†æµ-p&#34;&gt;&lt;p markdown=&#34;1&#34; style=&#34;margin-bottom:2em; margin-right: 5px; padding: 8px 15px; letter-spacing: 2px; background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); background-color: rgb(63, 81, 181); color: rgb(255, 255, 255); border-left: 10px solid rgb(51, 51, 51); border-radius:5px; text-shadow: rgb(102, 102, 102) 1px 1px 1px; box-shadow: rgb(102, 102, 102) 1px 1px 2px;&#34;&gt;3. é€šè¿‡ç­–ç•¥è·¯ç”±å®ç°æ™ºèƒ½åˆ†æµ&lt;/p&gt;&lt;/h2&gt;

&lt;h3 id=&#34;3-1-å®‰è£…ç›¸å…³è½¯ä»¶&#34;&gt;3.1 å®‰è£…ç›¸å…³è½¯ä»¶&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;badvpn&lt;/li&gt;
&lt;li&gt;shadowsocks&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ pacman -S badvpn shadowsocks
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;3-2-é…ç½®shadowsocks-ç•¥è¿‡&#34;&gt;3.2 é…ç½®shadowsocksï¼ˆç•¥è¿‡ï¼‰&lt;/h3&gt;

&lt;p&gt;å‡è®¾shadowsocksé…ç½®æ–‡ä»¶ä¸º/etc/shadowsocks.json&lt;/p&gt;

&lt;h3 id=&#34;3-3-è·å–ä¸­å›½ipæ®µ&#34;&gt;3.3 è·å–ä¸­å›½IPæ®µ&lt;/h3&gt;

&lt;p&gt;å°†ä»¥ä¸‹å‘½ä»¤å†™å…¥è„šæœ¬ä¿å­˜æ‰§è¡Œï¼ˆå‡è®¾ä¿å­˜åœ¨/home/yang/bin/è·¯ç”±è¡¨/ç›®å½•ä¸‹ï¼‰ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#!/bin/sh
wget -c http://ftp.apnic.net/stats/apnic/delegated-apnic-latest
cat delegated-apnic-latest | awk -F &#39;|&#39; &#39;/CN/&amp;amp;&amp;amp;/ipv4/ {print $4 &amp;quot;/&amp;quot; 32-log($5)/log(2)}&#39; | cat &amp;gt; /home/yang/bin/è·¯ç”±è¡¨/cn_rules.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;3-4-é…ç½®æ™ºèƒ½-dns-æœåŠ¡&#34;&gt;3.4 é…ç½®æ™ºèƒ½ DNS æœåŠ¡&lt;/h3&gt;

&lt;p&gt;åŒä¸Š&lt;/p&gt;

&lt;h3 id=&#34;3-5-é…ç½®ç³»ç»Ÿ-dns-æœåŠ¡å™¨è®¾ç½®&#34;&gt;3.5 é…ç½®ç³»ç»Ÿ DNS æœåŠ¡å™¨è®¾ç½®&lt;/h3&gt;

&lt;p&gt;åŒä¸Š&lt;/p&gt;

&lt;h3 id=&#34;3-6-å†™è·¯ç”±è¡¨å¯åŠ¨å’Œç»ˆæ­¢è„šæœ¬&#34;&gt;3.6 å†™è·¯ç”±è¡¨å¯åŠ¨å’Œç»ˆæ­¢è„šæœ¬&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ vim /usr/local/bin/socksfwd
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#!/bin/bash
SOCKS_SERVER=$SERVER_IP # SOCKS æœåŠ¡å™¨çš„ IP åœ°å€
SOCKS_PORT=1081 # æœ¬åœ°SOCKS æœåŠ¡å™¨çš„ç«¯å£
GATEWAY_IP=$(ip route|grep &amp;quot;default&amp;quot;|awk &#39;{print $3}&#39;) # å®¶ç”¨ç½‘å…³ï¼ˆè·¯ç”±å™¨ï¼‰çš„ IP åœ°å€ï¼Œä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‡å®š
TUN_NETWORK_DEV=tun0 # é€‰ä¸€ä¸ªä¸å†²çªçš„ tun è®¾å¤‡å·
TUN_NETWORK_PREFIX=10.0.0 # é€‰ä¸€ä¸ªä¸å†²çªçš„å†…ç½‘ IP æ®µçš„å‰ç¼€


start_fwd() {
ip tuntap del dev &amp;quot;$TUN_NETWORK_DEV&amp;quot; mode tun
# æ·»åŠ è™šæ‹Ÿç½‘å¡
ip tuntap add dev &amp;quot;$TUN_NETWORK_DEV&amp;quot; mode tun
# ç»™è™šæ‹Ÿç½‘å¡ç»‘å®šIPåœ°å€
ip addr add &amp;quot;$TUN_NETWORK_PREFIX.1/24&amp;quot; dev &amp;quot;$TUN_NETWORK_DEV&amp;quot;
# å¯åŠ¨è™šæ‹Ÿç½‘å¡
ip link set &amp;quot;$TUN_NETWORK_DEV&amp;quot; up
ip route del default via &amp;quot;$GATEWAY_IP&amp;quot;
ip route add &amp;quot;$SOCKS_SERVER&amp;quot; via &amp;quot;$GATEWAY_IP&amp;quot;
# ç‰¹æ®Šipæ®µèµ°å®¶ç”¨ç½‘å…³ï¼ˆè·¯ç”±å™¨ï¼‰çš„ IP åœ°å€ï¼ˆå¦‚å±€åŸŸç½‘è”æœºï¼‰
# ip route add &amp;quot;172.16.39.0/24&amp;quot; via &amp;quot;$GATEWAY_IP&amp;quot;
# å›½å†…ç½‘æ®µèµ°å®¶ç”¨ç½‘å…³ï¼ˆè·¯ç”±å™¨ï¼‰çš„ IP åœ°å€
for i in $(cat /home/yang/bin/è·¯ç”±è¡¨/cn_rules.conf)
do
ip route add &amp;quot;$i&amp;quot; via &amp;quot;$GATEWAY_IP&amp;quot;
done
# å°†é»˜è®¤ç½‘å…³è®¾ä¸ºè™šæ‹Ÿç½‘å¡çš„IPåœ°å€
ip route add 0.0.0.0/1 via &amp;quot;$TUN_NETWORK_PREFIX.1&amp;quot;
ip route add 128.0.0.0/1 via &amp;quot;$TUN_NETWORK_PREFIX.1&amp;quot;
# å°†socks5è½¬ä¸ºvpn
badvpn-tun2socks --tundev &amp;quot;$TUN_NETWORK_DEV&amp;quot; --netif-ipaddr &amp;quot;$TUN_NETWORK_PREFIX.2&amp;quot; --netif-netmask 255.255.255.0 --socks-server-addr &amp;quot;127.0.0.1:$SOCKS_PORT&amp;quot;
TUN2SOCKS_PID=&amp;quot;$!&amp;quot;
}


stop_fwd() {
ip route del 128.0.0.0/1 via &amp;quot;$TUN_NETWORK_PREFIX.1&amp;quot;
ip route del 0.0.0.0/1 via &amp;quot;$TUN_NETWORK_PREFIX.1&amp;quot;
for i in $(cat /home/yang/bin/è·¯ç”±è¡¨/cn_rules.conf)
do
ip route del &amp;quot;$i&amp;quot; via &amp;quot;$GATEWAY_IP&amp;quot;
done
ip route del &amp;quot;172.16.39.0/24&amp;quot; via &amp;quot;$GATEWAY_IP&amp;quot;
ip route del &amp;quot;$SOCKS_SERVER&amp;quot; via &amp;quot;$GATEWAY_IP&amp;quot;
ip route add default via &amp;quot;$GATEWAY_IP&amp;quot;
ip link set &amp;quot;$TUN_NETWORK_DEV&amp;quot; down
ip addr del &amp;quot;$TUN_NETWORK_PREFIX.1/24&amp;quot; dev &amp;quot;$TUN_NETWORK_DEV&amp;quot;
ip tuntap del dev &amp;quot;$TUN_NETWORK_DEV&amp;quot; mode tun
}



start_fwd
trap stop_fwd INT TERM
wait &amp;quot;$TUN2SOCKS_PID&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ vim /etc/systemd/system/socksfwd.service
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[Unit]

Description=Transparent SOCKS5 forwarding

After=network-online.target

[Service]

Type=simple

ExecStart=/usr/local/bin/socksfwd

LimitNOFILE=1048576


[Install]

WantedBy=multi-user.target
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯åŠ¨æœåŠ¡&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ systemctl start socksfwd
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¼€æœºè‡ªå¯&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ systemctl enable socksfwd
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;3-7-æ‰“å¼€æµé‡è½¬å‘&#34;&gt;3.7 æ‰“å¼€æµé‡è½¬å‘&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cat /etc/sysctl.d/30-ipforward.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;net.ipv4.ip_forward=1

net.ipv6.conf.all.forwarding = 1

net.ipv4.tcp_congestion_control=westwood

net.ipv4.tcp_syn_retries = 5

net.ipv4.tcp_synack_retries = 5
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç¼–è¾‘å®Œæˆåï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä½¿å˜åŠ¨ç«‹å³ç”Ÿæ•ˆ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ sysctl -p
&lt;/code&gt;&lt;/pre&gt;</description>
    </item>
    
    <item>
      <title>è‹±è¯­å­¦ä¹ ç»ˆæç§˜è¯€</title>
      <link>https://www.yangcs.net/learn-english/</link>
      <pubDate>Fri, 25 May 2018 06:46:19 +0000</pubDate>
      
      <guid>https://www.yangcs.net/learn-english/</guid>
      <description>

&lt;p&gt;å¾ˆä¹…å¾ˆä¹…ä»¥å‰ï¼Œå½“ç½‘æ˜“è¿˜åœ¨åšæ¢¦å¹»è¥¿æ¸¸å’Œå¤§è¯è¥¿æ¸¸çš„æ—¶å€™ï¼Œç½‘æ˜“æœ‰é“æ•™ç ”éƒ¨è¯ç”Ÿäº†ä¸€ä½å¤§ç‰›ï¼Œä»–æ˜¯&lt;strong&gt;å›½å†…æœ€çŸ¥åï¼Œæœ€æœ‰å½±å“åŠ›çš„è‹±è¯­å­¦ä¹ ç ”ç©¶è€…ï¼Œæ–°ä¸œæ–¹å£è¯­å¤§èµ›è¯„å§”ã€ç½‘æ˜“æœ‰é“æ•™ç ”æ€»ç›‘&lt;span id=&#34;inline-purple&#34;&gt;@æ¶é­”å¥¶çˆ¸Sam&lt;/span&gt;&lt;/strong&gt;ã€‚ä¸è¿‡ä»–ç°åœ¨å·²ç»ä¸åœ¨ç½‘æ˜“äº†ï¼Œå¯èƒ½æ˜¯ä¸æƒ³é™ªä¸ç£Šä¸€èµ·å…»çŒª ğŸ˜„&lt;/p&gt;

&lt;p&gt;&lt;center&gt;&lt;img src=&#34;http://o7z41ciog.bkt.clouddn.com/naiba.png?imageView/2/w/300/q/100&#34; alt=&#34;&#34; /&gt;&lt;/center&gt;
&lt;center&gt;- æ¶é­”å¥¶çˆ¸Sam -&lt;/center&gt;
&lt;center&gt;å‰ç½‘æ˜“æœ‰é“æ•™ç ”æ€»ç›‘&lt;/center&gt;
&lt;center&gt;æ–°ä¸œæ–¹å…¨å›½å£è¯­å¤§èµ›è¯„å§”&lt;/center&gt;
&lt;center&gt;çŸ¥ä¹è‹±è¯­å­¦ä¹ é¢†åŸŸç™¾ä¸‡èµç­”ä¸»&lt;/center&gt;&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;p&gt;è¾œé¸¿é“­æ›¾è¯´è¿‡ï¼Œâ€œä»Šäººå­¦è‹±æ–‡åå¹´ï¼Œå¼ ç›®ä»…èƒ½è¯»æŠ¥ï¼Œä¼¸æ‰‹ä»…èƒ½ä¿®å‡½ã€‚â€ï¼Œé‚£æ˜¯ä¸€ç™¾å¤šå¹´å‰çš„äº‹æƒ…ï¼Œå¦‚ä»Šå‘¢ï¼Ÿâ€œä»Šäººå­¦è‹±æ–‡åå¹´ï¼Œå¼ ç›®ä¸èƒ½è¯»æŠ¥ï¼Œä¼¸æ‰‹ä¸èƒ½ä¿®å‡½ã€‚â€&lt;/p&gt;

&lt;p&gt;å®ç”¨èƒ½åŠ›ï¼Œå¯è°“ä¸€å¡Œç³Šæ¶‚ã€‚&lt;/p&gt;

&lt;p&gt;åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘è¿˜åœ¨è‹±è¯­å­¦ä¹ çš„è‰°è‹¦é“è·¯ä¸Šå¾˜å¾Šä¸å‰ï¼Œæˆ‘è‡ªå·±ä¸ªäººåœ¨å¤§å­¦æ—¶æœŸè‹¦ä¿®è‹±æ–‡ï¼ŒåŒæ ·ä¸å¾—å…¶æ³•ï¼Œéå¸¸è‹¦é—·ï¼Œä¸è®ºæ€ä¹ˆå­¦ä¹ ï¼Œè‹±è¯­æ°´å¹³å°±æ˜¯å±€é™åœ¨æŸä¸ªç“¶é¢ˆï¼Œå°±æ˜¯çªç ´ä¸äº†ã€‚&lt;/p&gt;

&lt;p&gt;å› ä¸ºç°åœ¨çš„è‹±è¯­ææ–™å’Œè‹±è¯­æ–¹æ³•æ˜¯åœ¨å¤ªå¤šäº†ï¼Œç¾å‰§ï¼Œæ–°é—»ï¼Œæ–°æ¦‚å¿µï¼Œå¬å†™ï¼Œè·Ÿè¯»ï¼Œæ¨¡ä»¿ï¼Œä»¿å†™ï¼Œå¤è¿°ï¼Œè¿™ä¸ªåå¸ˆè®²è¯¾ï¼Œé‚£ä¸ªåå¸ˆè¯¾å ‚ï¼Œç­‰ç­‰ç­‰ç­‰ï¼Œè®©äººçœ¼èŠ±ç¼­ä¹±ï¼Œç›®ä¸è¡”æ¥ï¼Œæ ¹æœ¬ä¸çŸ¥é“å¦‚ä½•é€‰æ‹©ï¼Œæ‰€ä»¥æ›´åŠ æ„Ÿè§‰æ— ä»ä¸‹æ‰‹ã€‚&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¥ä¸ºæˆ‘çš„è‹±è¯­å­¦ä¹ ç”Ÿæ¶¯åˆ°æ­¤åº”è¯¥å°±æ­¢æ­¥äº†ï¼Œå¯å°±åœ¨æˆ‘å°†è¦ä¸§å¤±æ–—å¿—ä¹‹é™…ï¼Œæˆ‘è¯»åˆ°äº†å¥¶çˆ¸çš„æ–‡ç« ï¼Œä»–é‚£é«˜å±‹å»ºç“´ï¼Œçºµè§ˆå…¨å±€çš„è‹±è¯­å­¦ä¹ æ–¹æ³•è®ºè®©æˆ‘æ„Ÿåˆ°é†é†çŒé¡¶ï¼Œè·³å‡ºä¹‹å‰äºŒåå¹´è‹±è¯­å­¦ä¹ çš„è¯¯åŒºï¼Œé‡æ–°ç‡ƒèµ·äº†æ–—å¿—ï¼&lt;/p&gt;

&lt;p&gt;è‡³äºå…·ä½“çš„æ–¹æ³•è®ºï¼Œç”±äºç¯‡å¹…æœ‰é™ï¼Œå†æ­¤ä¸å¤šä½œä»‹ç»ï¼Œæœ¬æ–‡æœ«å°¾ä¼šæ”¾å‡ºè¯¦ç»†çš„é“¾æ¥ã€‚&lt;/p&gt;

&lt;p&gt;å¤§å®¶å¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ä¸ªé€”å¾„å…³æ³¨ä»–ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://site.douban.com/195274/&#34; target=&#34;_blank&#34;&gt;è±†ç“£å­¦ä¹ å°ç»„ï¼šå¥¶çˆ¸çš„è‹±è¯­æ•™å®¤&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;å¾®ä¿¡å…¬ä¼—å·ï¼šæ¶é­”å¥¶çˆ¸Sam&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å¥¶çˆ¸çš„æ–¹æ³•è®ºå¤§å¤šå€Ÿé‰´äº† &lt;a href=&#34;http://blog.sina.com.cn/u/1264366955&#34; target=&#34;_blank&#34;&gt;ä¼å›ä»ª&lt;/a&gt; çš„æ–¹æ³•è®ºï¼Œå¹¶åŠ ä»¥æ”¹è¿›ã€‚è€Œä¼å›ä»ªçš„ä¸»è¦æ–¹æ³•è®ºéƒ½é›†ä¸­åœ¨ä»–å’Œå¥¶çˆ¸åˆä½œå†™çš„ä¸€æœ¬æ•™æã€ŠæŠŠä½ çš„è‹±è¯­ç”¨èµ·æ¥ã€‹ä¸­ã€‚æœ¬æ–‡èŠ‚é€‰å‡ºè¯¥æ•™æçš„å‰è¨€éƒ¨åˆ†ï¼Œå¤§å®¶æ„Ÿå—ä¸€ä¸‹ï¼š&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-å¥¶çˆ¸-è¿™æ˜¯ä¸€æœ¬æ¸¸æˆæŒ‡å—-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;å¥¶çˆ¸ï¼šè¿™æ˜¯ä¸€æœ¬æ¸¸æˆæŒ‡å—&lt;/p&gt;&lt;/h2&gt;

&lt;p&gt;è¿™æ˜¯ä¸€æœ¬æ¸¸æˆæŒ‡å—ã€‚æ²¡é”™ï¼Œä½ æ²¡æœ‰çœ‹é”™ï¼Œè¿™å°±æ˜¯ä¸€æœ¬æ¸¸æˆæŒ‡å—ã€‚å½“ç„¶ï¼Œè¿™æœ¬æŒ‡å—é’ˆå¯¹çš„åªæ˜¯åä¸ºâ€œè‹±æ–‡â€çš„æ¸¸æˆã€‚&lt;/p&gt;

&lt;p&gt;æŠŠè‹±æ–‡å’Œç”µå­æ¸¸æˆæ¯”è¾ƒä¸€ä¸‹ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œè¿™ä¸¤è€…æœ‰æƒŠäººçš„ç›¸ä¼¼ä¹‹å¤„ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;ç¬¬ä¸€&lt;/strong&gt;ï¼Œå®ƒä»¬éƒ½éœ€è¦ä½ è€—è´¹å¤§é‡çš„æ—¶é—´ã€æŠ•å…¥å¾ˆå¤šç²¾åŠ›å»ç»ƒçº§ï¼Œç£¨ç‚¼ä½ çš„æŠ€èƒ½ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯ç”µè„‘æ¸¸æˆè¦ä½ ç»ƒçš„æ˜¯é­”æ³•å’Œå‰‘æœ¯æŠ€èƒ½ï¼Œè€Œè‹±æ–‡è¦ä½ ç»ƒçš„æ˜¯å¬ã€è¯´ã€è¯»ã€å†™çš„æŠ€èƒ½ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;ç¬¬äºŒ&lt;/strong&gt;ï¼Œå®ƒä»¬éƒ½è¦æ±‚ä½ ç§¯ç´¯å¤§é‡çš„ç»éªŒå€¼ï¼Œæ¸¸æˆè¦æ±‚ä½ æ‰“æ€ªå’Œåšå„ç§ä»»åŠ¡ï¼Œè€Œè‹±è¯­è¦æ±‚ä½ å®Œæˆå¤§é‡çš„å¬åŠ›ã€è·Ÿè¯»ã€é˜…è¯»ã€å†™ä½œç­‰ç»ƒä¹ ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;ç¬¬ä¸‰&lt;/strong&gt;ï¼Œè¿™ä¸¤è€…éƒ½æœ‰ä¸¥æ ¼çš„ç­‰çº§åˆ†åˆ«ï¼Œä¸åŒçš„ç­‰çº§ä»æŸç§ç¨‹åº¦ä¸Šè¯´ï¼Œä»£è¡¨ç€ä½ å¯ä»¥åœ¨è¿™ä¸ªä¸–ç•Œä¸Šâ€œä¸ºéä½œæ­¹â€ã€â€œä¸ºæ‰€æ¬²ä¸ºâ€çš„ç¨‹åº¦ã€‚æ¸¸æˆä¸­çš„ç­‰çº§é«˜ï¼Œä½ å¯ä»¥åœ¨ PK æ—¶å¤„å¤„å–èƒœï¼Œå¸¦ç€ç¾çœ‰åšä»»åŠ¡ï¼Œåšå¾—å¥¹ä»¬çš„èŠ³å¿ƒã€‚è‹±æ–‡ç­‰çº§é«˜äº†ï¼Œä½ å¯ä»¥å‡ºå›½ï¼Œæ‰¾ä»½ä¸é”™çš„å·¥ä½œï¼Œå»è‹±è¯­è§’åšå¾—ç¾çœ‰çš„èŠ³å¿ƒæˆ–è€…å¹²è„†ç›´æ¥å»æ³¡å¤–å›½å¦ï¼Œè¿™ä¸¤è€…åœ¨è¿™æ–¹é¢çœŸæ˜¯æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;ç¬¬å››&lt;/strong&gt;ï¼Œä¸ç®¡æ˜¯æ‰“æ¸¸æˆè¿˜æ˜¯å­¦è‹±è¯­ï¼Œä½ éƒ½å¿…é¡»é—¯è¿‡å¤šé‡å…³å¡ï¼Œè€Œæ¯ä¸ªå…³å¡éƒ½æœ‰ä½ ä¸å¾—ä¸é¢å¯¹çš„ bossã€‚ä¸ç®¡è¿™ä¸ª boss æ˜¯åä¸ºæš—é»‘ç ´åç¥å·«å¦–ç‹ï¼Œè¿˜æ˜¯å››å…­çº§æ‰˜ç¦é›…æ€ GREï¼Œæ¯ä¸ªå…³å¡ä½ æ˜¯éè¿‡ä¸å¯ï¼Œè¦ä¹ˆä½ æ‰“æ­» bossï¼Œè¦ä¹ˆè¢« boss æ‰“æ­»ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;ç¬¬äº”&lt;/strong&gt;ï¼Œåœ¨æ¸¸æˆçº§æ•°å‡åˆ°ä¸€å®šçº§åˆ«ä¹‹åï¼Œä½ éƒ½ä¼šé‡åˆ°å¾ˆä¸¥é‡çš„ç“¶é¢ˆï¼Œçº§æ•°å†å¾€ä¸Šå‡ä¼šå¾ˆå›°éš¾ï¼Œå› ä¸ºå®ƒéœ€è¦æ›´å¤šçš„ç»éªŒå€¼ã€æ›´å¤šçš„æ—¶é—´æŠ•å…¥ã€‚è‹±æ–‡åŒæ ·å¦‚æ­¤ï¼Œå¾ˆå¤šäººå­¦åˆ°ä¸€å®šå±‚æ¬¡ä¹‹åéƒ½å¾ˆå®¹æ˜“é™·å…¥å¹³å°æœŸï¼Œä¸çŸ¥é“å¦‚ä½•è¿›ä¸€æ­¥æé«˜ï¼Œè€—è´¹å¾ˆå¤šæ—¶é—´å´æ²¡å¤šå¤§è¿›å±•ï¼Œç”šè‡³å¹²è„†æ”¾å¼ƒã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;ç¬¬å…­&lt;/strong&gt;ï¼Œåœ¨æ‰“æ¸¸æˆå’Œå­¦è‹±è¯­çš„è¿‡ç¨‹ä¸­ï¼Œä½ éƒ½æœ‰å¯èƒ½å‘ç”Ÿæ„å¤–ã€‚æ¸¸æˆä¸­ï¼Œä½ å¯èƒ½ä¼šè†ç›–ä¸­äº†ä¸€ç®­ï¼Œè€Œå¦‚æœè‹±è¯­å­¦å¾—ä¸å¥½ï¼Œä½ å¯èƒ½å­¦ä½è¯éƒ½æ‹¿ä¸åˆ°ï¼Œå‡èŒæœºä¼šå°±æŠ“ä¸ä½ã€‚ä¸ºäº†é¿å…è¿™äº›æ„å¤–å‘ç”Ÿï¼Œæˆ‘ä»¬éƒ½åº”è¯¥å¥½å¥½æƒ³ä¸€æƒ³ï¼Œç”¨ä»€ä¹ˆæ ·çš„æ”»ç•¥å’Œæ–¹æ³•å»è¾¾åˆ°è‡ªå·±çš„ç›®æ ‡ã€‚&lt;/p&gt;

&lt;p&gt;è¿™ä¸¤è€…çš„ç›¸ä¼¼ç¨‹åº¦å¦‚æ­¤ä¹‹é«˜ï¼Œä»¥è‡³äºæˆ‘ä»¬æœ‰ç†ç”±ç›¸ä¿¡ï¼šå­¦è‹±è¯­ï¼Œä¹Ÿå¯ä»¥åƒç©æ¸¸æˆä¸€æ ·å……æ»¡ä¹è¶£ï¼Œè¶Šç©è¶Šæƒ³ç©ï¼&lt;/p&gt;

&lt;p&gt;å› æ­¤ï¼Œæœ¬ä¹¦çš„ç›®çš„æœ‰å››ï¼š&lt;/p&gt;

&lt;p&gt;&lt;font color=#0099ff&gt;ç¬¬ä¸€ï¼Œç»™å‡ºä¸€ä¸ªå®Œæ•´çš„è‹±æ–‡å­¦ä¹ æ”»ç•¥ï¼Œæ¶µç›–äº†ä»ABCåˆçº§å…¥é—¨ï¼Œåˆ°è½»æ¾çœ‹æ‡‚æ— å­—å¹•å½±è§†ã€åŸç‰ˆä¸“ä¸šæ•™æçš„å„ä¸ªç­‰çº§å’Œé˜¶æ®µã€‚&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;ä¸ç®¡ä½ æ˜¯ä¸€ä¸ªæ–°äººè¿˜æ˜¯ä¸€ä¸ªå°æœ‰åæ°”çš„é«˜æ‰‹ï¼Œæˆ‘ä»¬éƒ½ä¼šæä¾›å¾ªåºæ¸è¿›çš„ã€è¯¦ç»†ä¸”å®Œæ•´çš„æ­¥éª¤ä¾›ä½ å‚è€ƒï¼Œè€Œä¸åƒä»»ä½•ä¸€æœ¬å…¶ä»–æ”»ç•¥é‚£æ ·åªå‘Šè¯‰ä½ æŸä¸€ä¸ªä»»åŠ¡å…³çš„æ”»ç•¥ï¼ˆæ¯”å¦‚åªåé‡å¬è¯´è€Œæ²¡æœ‰æ¶µç›–è¯»å†™ä¹‹ç±»çš„å­¦ä¹ æ–¹æ³•æŒ‡å—ï¼‰ã€‚æˆ‘ä»¬æ¶µç›–çš„æ˜¯å…¨éƒ¨æµç¨‹ï¼Œæ¯ä¸€æ­¥éƒ½ç¨³æ‰ç¨³æ‰“ï¼Œè®©ä½ ä»ä¸€å newbieï¼ˆèœé¸Ÿï¼‰å˜æˆä¸€ä¸ªçœŸæ­£çš„éª¨ç°çº§é«˜æ‰‹ã€‚&lt;/p&gt;

&lt;p&gt;&lt;font color=#0099ff&gt;ç¬¬äºŒï¼Œæ•™ä½ å¦‚ä½•è¿…é€Ÿçªç ´è‹±æ–‡å­¦ä¹ çš„å¹³å°æœŸå’Œç“¶é¢ˆâ€”â€”è¿™ä¹Ÿæ˜¯æœ¬ä¹¦çš„æ ¸å¿ƒå†…å®¹ã€‚&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;å¦‚æœä½ è‹±æ–‡æ°´å¹³è¿˜ç®—ä¸é”™çš„è¯ï¼Œè‚¯å®šä¼šæ˜ç™½å¹³å°æœŸçš„ç—›è‹¦â€”â€”è‹¦å­¦ä¸‰ä¸ªæœˆæ¯«æ— è¿›æ­¥ï¼Œé‚£è¿™æœ¬æ”»ç•¥å°±æ­£æ˜¯ä½ æ‰€éœ€è¦çš„ã€‚å®ƒå¯ä»¥å¸®ä½ æ‰«æ¸…ä¸€åˆ‡å­¦ä¹ ä¸Šçš„è¿·æ€å’Œç—›è‹¦ï¼Œè¿…é€ŸæŠŠä½ å¸¦åˆ°çœŸæ­£é«˜æ°´å¹³çš„ä¸–ç•Œã€‚äº‹å®ä¸Šï¼Œè¿™æœ¬æ”»ç•¥æ˜¯å¦‚æ­¤æœ‰æ•ˆï¼Œä»¥è‡³äºä½ åœ¨ç”¨å®ƒæ¥æŒ‡å¯¼è‡ªå·±å­¦ä¹ çš„æ—¶å€™ï¼Œè¿›æ­¥çš„é€Ÿåº¦ä¼šå¿«å¾—è®©ä½ è‡ªå·±éƒ½æ„Ÿåˆ°åƒæƒŠã€‚&lt;/p&gt;

&lt;p&gt;&lt;font color=#0099ff&gt;ç¬¬ä¸‰ï¼Œè®©å¤§å®¶èƒ½å¤ŸåšæŒä¸‹å»å­¦å¥½è‹±æ–‡â€”â€”è¿™ä¹Ÿæ˜¯æœ¬ä¹¦æœ€å¤§çš„ç‰¹è‰²ã€‚&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;è®²è‹±æ–‡å­¦ä¹ çš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä¸ä»…ä»…æ˜¯å‘Šè¯‰å¤§å®¶å¦‚ä½•å­¦ä¹ ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬è¿˜ä¼šå‘Šè¯‰å¤§å®¶å¦‚ä½•å»â€œåšæŒå­¦ä¹ â€ã€‚æ¢è¨€ä¹‹ï¼Œæˆ‘ä»¬ä¼šæ‰‹æŠŠæ‰‹åœ°æ•™ä¼šå¤§å®¶æ­£ç¡®çš„é™¶å†¶å¿ƒæ™ºçš„æ–¹æ³•ï¼Œæœç»ä¸å½“æˆ–è€…é”™è¯¯çš„è‡ªæˆ‘è®¤çŸ¥ï¼Œä¸€æ­¥æ­¥åœ°é€šè¿‡è‡ªæˆ‘ç®¡ç†å’Œå¿ƒæ™ºåŸ¹å…»ï¼Œæ¥å®ç°äººç”Ÿæ»¡è¶³ã€‚&lt;/p&gt;

&lt;p&gt;&lt;font color=#0099ff&gt;ç¬¬å››ï¼Œè®©å¤§å®¶å­¦è‹±æ–‡åƒæ‰“ç”µå­æ¸¸æˆä¸€æ ·ï¼Œå……æ»¡ä¹è¶£ï¼Œä¸å†ä¸ºè‹±æ–‡å¤´ç—›ï¼Œå¿«é€Ÿé€šå…³ï¼&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬åœ¨ä¹¦ä¸­è®¾ç½®äº†ä¸­çº§ã€ä¸­é«˜çº§ã€å¬è¯´è¿›é˜¶çº§ã€é«˜çº§å››å¤§å…³å¡ï¼Œè®©å¤§å®¶å¥½åƒæ‰“æ¸¸æˆä¸€æ ·æ¥é—¯å…³å¾—åˆ†ï¼Œæé«˜è‡ªå·±çš„è‹±æ–‡æ°´å‡†ï¼è¿™å››å¤§å…³å¡åˆ†åˆ«æ¶µç›–äº†è‹±æ–‡çš„å¬åŠ›ã€å£è¯­äº¤é™…ã€åŸç‰ˆä¹¦é˜…è¯»ã€è¯­æ³•ã€è¯æ±‡ã€å†™ä½œç­‰å„ä¸ªéƒ¨åˆ†ï¼Œå¤§å®¶åœ¨å­¦ä¹ è‡ªå·±å–œæ¬¢å’Œæ„Ÿå…´è¶£çš„ææ–™æ—¶ï¼Œä¸çŸ¥ä¸è§‰ä¸­è¿™äº›èƒ½åŠ›éƒ½èƒ½å¤Ÿå¾—åˆ°é«˜æ•ˆçš„æé«˜&lt;/p&gt;

&lt;p&gt;æ­£æ˜¯æŠ±ç€è¿™æ ·çš„ç›®çš„ï¼Œä¼å›ä»ªè€å¸ˆå’Œä¸æ‰äºŒäººæ±‡æ€»äº†å„è‡ªçš„ä¸€äº›ç²—æµ…ç»éªŒï¼Œå†™å‡ºäº†è¿™ä¸€æœ¬è‹±æ–‡æ¸¸æˆæ”»ç•¥ã€‚æˆ‘ä»¬è™½ä¸ç®—æ˜¯åŠŸåŠ›éœ‡å¤çƒä»Šçš„ç»é¡¶é«˜æ‰‹ï¼Œä½†ä½œä¸ºæµ¸æ·«è‹±æ–‡æ¸¸æˆå¤šå¹´çš„è¿‡æ¥äººï¼Œä¹Ÿç®—æ˜¯ç•¥æœ‰å¿ƒå¾—ã€‚åœ¨è¿™æœ¬ä¹¦ä¸­ï¼Œæˆ‘ä»¬ç«­å°½æ‰€èƒ½ï¼Œå°†è¿™ä¸ªåä¸ºâ€œè‹±æ–‡â€çš„æ¸¸æˆä¸­çš„å„ç§æ³•é—¨ã€é™·é˜±ã€å¼¯è·¯ä¸€ä¸€é“æ¥ï¼Œè®©è¯¸å›çš„è‹±æ–‡èƒ½åŠ›å‡çº§åƒå¼€å¤–æŒ‚é‚£ä¹ˆè¿…é€Ÿï¼Œä¸€è·¯é—¯è¿‡å„ç§å…³å¡ï¼Œç­æ‰åä¸ºâ€œè‹±æ–‡å¬ã€è¯´ã€è¯»ã€å†™â€çš„å››å¤§é­”ç‹ä¹Ÿå¥½ï¼Œæ‰“è´¥å„ç±»åä¸ºâ€œå››å…­çº§â€çš„bossä¹Ÿå¥½ï¼Œå‡»é€€å„ç§åä¸ºâ€œè‹±æ–‡ä¼šè®®â€æˆ–æ˜¯â€œè‹±æ–‡é¢è¯•â€çš„å°å’ä¹Ÿå¥½ï¼Œè¯·æ‹¿å‡ºä½ çš„æ±—æ°´ã€å‹‡æ°”ã€æ™ºæ…§å»åŠªåŠ›å¥‹æ–—ï¼Œç›´è‡³ä½ æœ‰èƒ½åŠ›å»æŒ‘æˆ˜åä¸ºâ€œæµåˆ©è‹±è¯­ï¼Œæ¯è¯­æ°´å¹³â€çš„è¶…çº§å¤§é­”ç‹ï¼Œè®©â€œç¾å¥³å‰‘è±ªå¸¦ç€é…’æ¥äº†â€çš„çƒ­è¡€æ•…äº‹å¹¿ä¸ºæµä¼ ï¼&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-ç¦åˆ©-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;ç¦åˆ©&lt;/p&gt;&lt;/h2&gt;

&lt;p&gt;æœ¬ä¹¦å®Œæ•´ç‰ˆå¯ä»¥åˆ°å½“å½“æˆ–äºšé©¬é€Šè´­ä¹°ï¼Œæˆ‘è¿™é‡Œä¹Ÿæä¾›äº†å…è´¹çš„ç”µå­ç‰ˆï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://default-1252251317.cossh.myqcloud.com/%E6%8A%8A%E4%BD%A0%E7%9A%84%E8%8B%B1%E8%AF%AD%E7%94%A8%E8%B5%B7%E6%9D%A5.pdf&#34; target=&#34;_blank&#34;&gt;pdf&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://default-1252251317.cossh.myqcloud.com/%E6%8A%8A%E4%BD%A0%E7%9A%84%E8%8B%B1%E8%AF%AD%E7%94%A8%E8%B5%B7%E6%9D%A5.epub&#34; target=&#34;_blank&#34;&gt;epub&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å…³äºæœ¬ä¹¦ä¸­æ¨èçš„ Podcast: ã€ŠA Day in the life of Jeffã€‹ï¼Œæˆ‘å·²ç»å°†å…¶å½•éŸ³ææ–™å…è´¹åˆ†äº«åˆ°äº’è”ç½‘ä¸Šï¼ŒåŒæ—¶ä¹Ÿå°†å½•éŸ³å†…å®¹æ•´ç†æˆç”µå­ä¹¦ï¼Œå¤§å®¶å¯ä»¥å…è´¹ä¸‹è½½ï¼š&lt;/p&gt;

&lt;h4 id=&#34;å½•éŸ³ææ–™&#34;&gt;å½•éŸ³ææ–™&lt;/h4&gt;

&lt;p&gt;&lt;a id=&#34;download&#34; href=&#34;https://pan.baidu.com/s/1K0v274ULsghYmjjyWe93Bw&#34;&gt;&lt;i class=&#34;fa fa-download&#34;&gt;&lt;/i&gt;&lt;span&gt; Download Now&lt;/span&gt;
&lt;/a&gt;&lt;/p&gt;

&lt;h4 id=&#34;ç”µå­ä¹¦&#34;&gt;ç”µå­ä¹¦&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.yangcs.net/a-day-in-the-life-of-jeff/&#34; target=&#34;_blank&#34;&gt;åœ¨çº¿é˜…è¯»&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://default-1252251317.cossh.myqcloud.com/a-day-in-the-life-of-jeff.pdf&#34; target=&#34;_blank&#34;&gt;pdf&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://default-1252251317.cossh.myqcloud.com/a-day-in-the-life-of-jeff.epub&#34; target=&#34;_blank&#34;&gt;epub&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://default-1252251317.cossh.myqcloud.com/a-day-in-the-life-of-jeff.mobi&#34; target=&#34;_blank&#34;&gt;mobi&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å¦‚æœåç»­è¿˜æœ‰æ•´ç†å¥½çš„ç¦åˆ©ï¼Œå°†ä¼šåœ¨è¿™é‡Œè¡¥å…… ğŸ˜Š&lt;/p&gt;

&lt;style&gt;
#h2{
    margin-bottom:2em;
    margin-right: 5px;
    padding: 8px 15px;
    letter-spacing: 2px;
    background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181));
    background-color: rgb(63, 81, 181);
    color: rgb(255, 255, 255);
    border-left: 10px solid rgb(51, 51, 51);
    border-radius:5px;
    text-shadow: rgb(102, 102, 102) 1px 1px 1px;
    box-shadow: rgb(102, 102, 102) 1px 1px 2px;
}
#note {
    font-size: 1.5rem;
    font-style: italic;
    padding: 0 1rem;
    margin: 2.5rem 0;
    position: relative;
    background-color: #fafeff;
    border-top: 1px dotted #9954bb;
    border-bottom: 1px dotted #9954bb;
}
#note-title {
    padding: 0.2rem 0.5rem;
    background: #9954bb;
    color: #FFF;
    position: absolute;
    left: 0;
    top: 0.25rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    border-radius: 4px;
    -webkit-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    -moz-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    -ms-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    -o-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    transform: rotate(-5deg) translateX(-10px) translateY(-25px);
}
#inline-yellow {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #f0ad4e;
}
#inline-green {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #5cb85c;
}
#inline-blue {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #2780e3;
}
#inline-purple {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #9954bb;
}
#div-border-left-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #df3e3e;
}
#div-border-left-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #f0ad4e;
}
#div-border-left-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #5cb85c;
}
#div-border-left-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #2780e3;
}
#div-border-left-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #9954bb;
}
#div-border-right-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #df3e3e;
}
#div-border-right-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #f0ad4e;
}
#div-border-right-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #5cb85c;
}
#div-border-right-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #2780e3;
}
#div-border-right-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #9954bb;
}
#div-border-top-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #df3e3e;
}
#div-border-top-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #f0ad4e;
}
#div-border-top-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #5cb85c;
}
#div-border-top-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #2780e3;
}
#div-border-top-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #9954bb;
}
&lt;/style&gt;
</description>
    </item>
    
    <item>
      <title>èµ°è¿› Descheduler</title>
      <link>https://www.yangcs.net/posts/introduce-kubernetes-descheduler/</link>
      <pubDate>Wed, 23 May 2018 10:23:29 +0000</pubDate>
      
      <guid>https://www.yangcs.net/posts/introduce-kubernetes-descheduler/</guid>
      <description>&lt;p&gt;
&lt;code&gt;kube-scheduler&lt;/code&gt; æ˜¯ Kubernetes ä¸­è´Ÿè´£è°ƒåº¦çš„ç»„ä»¶ï¼Œå®ƒæœ¬èº«çš„è°ƒåº¦åŠŸèƒ½å·²ç»å¾ˆå¼ºå¤§äº†ã€‚ä½†ç”±äº Kubernetes é›†ç¾¤éå¸¸æ´»è·ƒï¼Œå®ƒçš„çŠ¶æ€ä¼šéšæ—¶é—´è€Œæ”¹å˜ï¼Œç”±äºå„ç§åŸå› ï¼Œä½ å¯èƒ½éœ€è¦å°†å·²ç»è¿è¡Œçš„ Pod ç§»åŠ¨åˆ°å…¶ä»–èŠ‚ç‚¹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;æŸäº›èŠ‚ç‚¹è´Ÿè½½è¿‡é«˜&lt;/li&gt;
&lt;li&gt;æŸäº›èµ„æºå¯¹è±¡è¢«æ·»åŠ äº† &lt;a href=&#34;https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#node-affinity-beta-feature&#34; target=&#34;_blank&#34;&gt;node äº²å’Œæ€§&lt;/a&gt; æˆ– &lt;a href=&#34;https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#inter-pod-affinity-and-anti-affinity-beta-feature&#34; target=&#34;_blank&#34;&gt;pod ï¼ˆåï¼‰äº²å’Œæ€§&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;é›†ç¾¤ä¸­åŠ å…¥äº†æ–°èŠ‚ç‚¹&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ä¸€æ—¦ Pod å¯åŠ¨ä¹‹å &lt;code&gt;kube-scheduler&lt;/code&gt; ä¾¿ä¸ä¼šå†å°è¯•é‡æ–°è°ƒåº¦å®ƒã€‚æ ¹æ®ç¯å¢ƒçš„ä¸åŒï¼Œä½ å¯èƒ½ä¼šæœ‰å¾ˆå¤šéœ€è¦æ‰‹åŠ¨è°ƒæ•´ Pod çš„åˆ†å¸ƒï¼Œä¾‹å¦‚ï¼šå¦‚æœé›†ç¾¤ä¸­æ–°åŠ å…¥äº†ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆå·²ç»è¿è¡Œçš„ Pod å¹¶ä¸ä¼šè¢«åˆ†æ‘Šåˆ°è¿™å°èŠ‚ç‚¹ä¸Šï¼Œè¿™å°èŠ‚ç‚¹å¯èƒ½åªè¿è¡Œäº†å°‘é‡çš„å‡ ä¸ª Podï¼Œè¿™å¹¶ä¸ç†æƒ³ï¼Œå¯¹å§ï¼Ÿ&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-1-descheduler-å¦‚ä½•å·¥ä½œ-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;1. Descheduler å¦‚ä½•å·¥ä½œï¼Ÿ&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/kubernetes-incubator/descheduler&#34; target=&#34;_blank&#34;&gt;Descheduler&lt;/a&gt; ä¼šæ£€æŸ¥ Pod çš„çŠ¶æ€ï¼Œå¹¶æ ¹æ®è‡ªå®šä¹‰çš„ç­–ç•¥å°†ä¸æ»¡è¶³è¦æ±‚çš„ Pod ä»è¯¥èŠ‚ç‚¹ä¸Šé©±é€å‡ºå»ã€‚Descheduler å¹¶ä¸æ˜¯ &lt;code&gt;kube-scheduler&lt;/code&gt; çš„æ›¿ä»£å“ï¼Œè€Œæ˜¯è¦ä¾èµ–äºå®ƒã€‚è¯¥é¡¹ç›®ç›®å‰æ”¾åœ¨ Kubernetes çš„å­µåŒ–é¡¹ç›®ä¸­ï¼Œè¿˜æ²¡å‡†å¤‡æŠ•å…¥ç”Ÿäº§ï¼Œä½†ç»è¿‡æˆ‘å®éªŒå‘ç°å®ƒçš„è¿è¡Œæ•ˆæœå¾ˆå¥½ï¼Œè€Œä¸”éå¸¸ç¨³å®šã€‚é‚£ä¹ˆè¯¥å¦‚ä½•å®‰è£…å‘¢ï¼Ÿ&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-2-éƒ¨ç½²æ–¹æ³•-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;2. éƒ¨ç½²æ–¹æ³•&lt;/p&gt;&lt;/h2&gt;

&lt;p&gt;ä½ å¯ä»¥é€šè¿‡ &lt;code&gt;Job&lt;/code&gt; æˆ– &lt;code&gt;CronJob&lt;/code&gt; æ¥è¿è¡Œ deschedulerã€‚æˆ‘å·²ç»åˆ›å»ºäº†ä¸€ä¸ªé•œåƒ &lt;code&gt;komljen/descheduler:v0.5.0-4-ga7ceb671&lt;/code&gt;ï¼ˆåŒ…å«åœ¨ä¸‹é¢çš„ yaml æ–‡ä»¶ä¸­ï¼‰ï¼Œä½†ç”±äºè¿™ä¸ªé¡¹ç›®çš„æ›´æ–°é€Ÿåº¦å¾ˆå¿«ï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹çš„å‘½ä»¤åˆ›å»ºä½ è‡ªå·±çš„é•œåƒï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ git clone https://github.com/kubernetes-incubator/descheduler
$ cd descheduler &amp;amp;&amp;amp; make image
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶åæ‰“å¥½æ ‡ç­¾ push åˆ°è‡ªå·±çš„é•œåƒä»“åº“ä¸­ã€‚&lt;/p&gt;

&lt;p&gt;é€šè¿‡æˆ‘åˆ›å»ºçš„ chart æ¨¡æ¿ï¼Œä½ å¯ä»¥ç”¨ &lt;code&gt;Helm&lt;/code&gt; æ¥éƒ¨ç½² deschedulerï¼Œè¯¥æ¨¡æ¿æ”¯æŒ RBAC å¹¶ä¸”å·²ç»åœ¨ Kubernetes v1.9 ä¸Šæµ‹è¯•é€šè¿‡ã€‚&lt;/p&gt;

&lt;p&gt;æ·»åŠ æˆ‘çš„ helm ç§æœ‰ä»“åº“ï¼Œç„¶åéƒ¨ç½² deschedulerï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ helm repo add akomljen-charts \
  https://raw.githubusercontent.com/komljen/helm-charts/master/charts/
  
$ helm install --name ds \
  --namespace kube-system \
  akomljen-charts/descheduler
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä½ ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨ helmï¼Œé€šè¿‡æ‰‹åŠ¨éƒ¨ç½²ã€‚é¦–å…ˆåˆ›å»º serviceaccount å’Œ clusterrolebindingï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# Create a cluster role
$ cat &amp;lt;&amp;lt; EOF| kubectl create -n kube-system -f -
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRole
metadata:
  name: descheduler
rules:
- apiGroups: [&amp;quot;&amp;quot;]
  resources: [&amp;quot;nodes&amp;quot;]
  verbs: [&amp;quot;get&amp;quot;, &amp;quot;watch&amp;quot;, &amp;quot;list&amp;quot;]
- apiGroups: [&amp;quot;&amp;quot;]
  resources: [&amp;quot;pods&amp;quot;]
  verbs: [&amp;quot;get&amp;quot;, &amp;quot;watch&amp;quot;, &amp;quot;list&amp;quot;, &amp;quot;delete&amp;quot;]
- apiGroups: [&amp;quot;&amp;quot;]
  resources: [&amp;quot;pods/eviction&amp;quot;]
  verbs: [&amp;quot;create&amp;quot;]
EOF

# Create a service account
$ kubectl create sa descheduler -n kube-system

# Bind the cluster role to the service account
$ kubectl create clusterrolebinding descheduler \
    -n kube-system \
    --clusterrole=descheduler \
    --serviceaccount=kube-system:descheduler
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶åé€šè¿‡ &lt;code&gt;configmap&lt;/code&gt; åˆ›å»º descheduler ç­–ç•¥ã€‚ç›®å‰åªæ”¯æŒå››ç§ç­–ç•¥ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/kubernetes-incubator/descheduler#removeduplicates&#34; target=&#34;_blank&#34;&gt;RemoveDuplicates&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/kubernetes-incubator/descheduler#lownodeutilization&#34; target=&#34;_blank&#34;&gt;LowNodeUtilization&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/kubernetes-incubator/descheduler#removepodsviolatinginterpodantiaffinity&#34; target=&#34;_blank&#34;&gt;RemovePodsViolatingInterPodAntiAffinity&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/kubernetes-incubator/descheduler#removepodsviolatingnodeaffinity&#34; target=&#34;_blank&#34;&gt;RemovePodsViolatingNodeAffinity&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;é»˜è®¤è¿™å››ç§ç­–ç•¥å…¨éƒ¨å¼€å¯ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦å…³é—­å®ƒä»¬ã€‚ä¸‹é¢åœ¨ &lt;code&gt;kube-suystem&lt;/code&gt; å‘½åç©ºé—´ä¸­åˆ›å»ºä¸€ä¸ª configmapï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;$ cat &amp;lt;&amp;lt; EOF| kubectl create -n kube-system -f -
apiVersion: v1
kind: ConfigMap
metadata:
  name: descheduler
data:
  policy.yaml: |-  
    apiVersion: descheduler/v1alpha1
    kind: DeschedulerPolicy
    strategies:
      RemoveDuplicates:
         enabled: false
      LowNodeUtilization:
         enabled: true
         params:
           nodeResourceUtilizationThresholds:
             thresholds:
               cpu: 20
               memory: 20
               pods: 20
             targetThresholds:
               cpu: 50
               memory: 50
               pods: 50
      RemovePodsViolatingInterPodAntiAffinity:
        enabled: true
      RemovePodsViolatingNodeAffinity:
        enabled: true
        params:
          nodeAffinityType:
          - requiredDuringSchedulingIgnoredDuringExecution
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨ &lt;code&gt;kube-system&lt;/code&gt; å‘½åç©ºé—´ä¸­åˆ›å»ºä¸€ä¸ª CronJobï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;$ cat &amp;lt;&amp;lt; EOF| kubectl create -n kube-system -f -
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: descheduler
spec:
  schedule: &amp;quot;*/30 * * * *&amp;quot;
  jobTemplate:
    metadata:
      name: descheduler
      annotations:
        scheduler.alpha.kubernetes.io/critical-pod: &amp;quot;true&amp;quot;
    spec:
      template:
        spec:
          serviceAccountName: descheduler
          containers:
          - name: descheduler
            image: komljen/descheduler:v0.5.0-4-ga7ceb671
            volumeMounts:
            - mountPath: /policy-dir
              name: policy-volume
            command:
            - /bin/descheduler
            - --v=4
            - --max-pods-to-evict-per-node=10
            - --policy-config-file=/policy-dir/policy.yaml
          restartPolicy: &amp;quot;OnFailure&amp;quot;
          volumes:
          - name: policy-volume
            configMap:
              name: descheduler
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl get cronjobs -n kube-system

NAME             SCHEDULE       SUSPEND   ACTIVE    LAST SCHEDULE   AGE
descheduler      */30 * * * *   False     0         2m              32m
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¯¥ CroJob æ¯ 30 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼Œå½“ CronJob å¼€å§‹å·¥ä½œåï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å·²ç»æˆåŠŸç»“æŸçš„ Podï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl get pods -n kube-system -a | grep Completed

descheduler-1525520700-297pq          0/1       Completed   0          1h
descheduler-1525521000-tz2ch          0/1       Completed   0          32m
descheduler-1525521300-mrw4t          0/1       Completed   0          2m
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¹Ÿå¯ä»¥æŸ¥çœ‹è¿™äº› Pod çš„æ—¥å¿—ï¼Œç„¶åæ ¹æ®éœ€è¦è°ƒæ•´ descheduler ç­–ç•¥ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl logs descheduler-1525521300-mrw4t -n kube-system

I0505 11:55:07.554195       1 reflector.go:202] Starting reflector *v1.Node (1h0m0s) from github.com/kubernetes-incubator/descheduler/pkg/descheduler/node/node.go:84
I0505 11:55:07.554255       1 reflector.go:240] Listing and watching *v1.Node from github.com/kubernetes-incubator/descheduler/pkg/descheduler/node/node.go:84
I0505 11:55:07.767903       1 lownodeutilization.go:147] Node &amp;quot;ip-10-4-63-172.eu-west-1.compute.internal&amp;quot; is appropriately utilized with usage: api.ResourceThresholds{&amp;quot;cpu&amp;quot;:41.5, &amp;quot;memory&amp;quot;:1.3635487207675927, &amp;quot;pods&amp;quot;:8.181818181818182}
I0505 11:55:07.767942       1 lownodeutilization.go:149] allPods:9, nonRemovablePods:9, bePods:0, bPods:0, gPods:0
I0505 11:55:07.768141       1 lownodeutilization.go:144] Node &amp;quot;ip-10-4-36-223.eu-west-1.compute.internal&amp;quot; is over utilized with usage: api.ResourceThresholds{&amp;quot;cpu&amp;quot;:48.75, &amp;quot;memory&amp;quot;:61.05259502942694, &amp;quot;pods&amp;quot;:30}
I0505 11:55:07.768156       1 lownodeutilization.go:149] allPods:33, nonRemovablePods:12, bePods:1, bPods:19, gPods:1
I0505 11:55:07.768376       1 lownodeutilization.go:144] Node &amp;quot;ip-10-4-41-14.eu-west-1.compute.internal&amp;quot; is over utilized with usage: api.ResourceThresholds{&amp;quot;cpu&amp;quot;:39.125, &amp;quot;memory&amp;quot;:98.19259268881142, &amp;quot;pods&amp;quot;:33.63636363636363}
I0505 11:55:07.768390       1 lownodeutilization.go:149] allPods:37, nonRemovablePods:8, bePods:0, bPods:29, gPods:0
I0505 11:55:07.768538       1 lownodeutilization.go:147] Node &amp;quot;ip-10-4-34-29.eu-west-1.compute.internal&amp;quot; is appropriately utilized with usage: api.ResourceThresholds{&amp;quot;memory&amp;quot;:43.19826999287199, &amp;quot;pods&amp;quot;:30.90909090909091, &amp;quot;cpu&amp;quot;:35.25}
I0505 11:55:07.768552       1 lownodeutilization.go:149] allPods:34, nonRemovablePods:11, bePods:8, bPods:15, gPods:0
I0505 11:55:07.768556       1 lownodeutilization.go:65] Criteria for a node under utilization: CPU: 20, Mem: 20, Pods: 20
I0505 11:55:07.768571       1 lownodeutilization.go:69] No node is underutilized, nothing to do here, you might tune your thersholds further
I0505 11:55:07.768576       1 pod_antiaffinity.go:45] Processing node: &amp;quot;ip-10-4-63-172.eu-west-1.compute.internal&amp;quot;
I0505 11:55:07.779313       1 pod_antiaffinity.go:45] Processing node: &amp;quot;ip-10-4-36-223.eu-west-1.compute.internal&amp;quot;
I0505 11:55:07.796766       1 pod_antiaffinity.go:45] Processing node: &amp;quot;ip-10-4-41-14.eu-west-1.compute.internal&amp;quot;
I0505 11:55:07.813303       1 pod_antiaffinity.go:45] Processing node: &amp;quot;ip-10-4-34-29.eu-west-1.compute.internal&amp;quot;
I0505 11:55:07.829109       1 node_affinity.go:40] Executing for nodeAffinityType: requiredDuringSchedulingIgnoredDuringExecution
I0505 11:55:07.829133       1 node_affinity.go:45] Processing node: &amp;quot;ip-10-4-63-172.eu-west-1.compute.internal&amp;quot;
I0505 11:55:07.840416       1 node_affinity.go:45] Processing node: &amp;quot;ip-10-4-36-223.eu-west-1.compute.internal&amp;quot;
I0505 11:55:07.856735       1 node_affinity.go:45] Processing node: &amp;quot;ip-10-4-41-14.eu-west-1.compute.internal&amp;quot;
I0505 11:55:07.945566       1 request.go:480] Throttling request took 88.738917ms, request: GET:https://100.64.0.1:443/api/v1/pods?fieldSelector=spec.nodeName%3Dip-10-4-41-14.eu-west-1.compute.internal%2Cstatus.phase%21%3DFailed%2Cstatus.phase%21%3DSucceeded
I0505 11:55:07.972702       1 node_affinity.go:45] Processing node: &amp;quot;ip-10-4-34-29.eu-west-1.compute.internal&amp;quot;
I0505 11:55:08.145559       1 request.go:480] Throttling request took 172.751657ms, request: GET:https://100.64.0.1:443/api/v1/pods?fieldSelector=spec.nodeName%3Dip-10-4-34-29.eu-west-1.compute.internal%2Cstatus.phase%21%3DFailed%2Cstatus.phase%21%3DSucceeded
I0505 11:55:08.160964       1 node_affinity.go:72] Evicted 0 pods
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å“‡å“¦ï¼Œç°åœ¨ä½ çš„é›†ç¾¤ä¸­å·²ç»è¿è¡Œäº†ä¸€ä¸ª deschedulerï¼&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-3-æ€»ç»“-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;3. æ€»ç»“&lt;/p&gt;&lt;/h2&gt;

&lt;p&gt;Kubernetes çš„é»˜è®¤è°ƒåº¦å™¨å·²ç»åšçš„å¾ˆå¥½ï¼Œä½†ç”±äºé›†ç¾¤å¤„äºä¸æ–­å˜åŒ–çš„çŠ¶æ€ä¸­ï¼ŒæŸäº› Pod å¯èƒ½è¿è¡Œåœ¨é”™è¯¯çš„èŠ‚ç‚¹ä¸Šï¼Œæˆ–è€…ä½ æƒ³è¦å‡è¡¡é›†ç¾¤èµ„æºçš„åˆ†é…ï¼Œè¿™æ—¶å€™å°±éœ€è¦ descheduler æ¥å¸®åŠ©ä½ å°†æŸäº›èŠ‚ç‚¹ä¸Šçš„ Pod é©±é€åˆ°æ­£ç¡®çš„èŠ‚ç‚¹ä¸Šå»ã€‚æˆ‘å¾ˆæœŸå¾…æ­£å¼ç‰ˆçš„å‘å¸ƒï¼&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-4-åŸæ–‡é“¾æ¥-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;4. åŸæ–‡é“¾æ¥&lt;/p&gt;&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://akomljen.com/meet-a-kubernetes-descheduler/&#34; target=&#34;_blank&#34;&gt;Meet a Kubernetes Descheduler&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;style&gt;
#h2{
    margin-bottom:2em;
    margin-right: 5px;
    padding: 8px 15px;
    letter-spacing: 2px;
    background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181));
    background-color: rgb(63, 81, 181);
    color: rgb(255, 255, 255);
    border-left: 10px solid rgb(51, 51, 51);
    border-radius:5px;
    text-shadow: rgb(102, 102, 102) 1px 1px 1px;
    box-shadow: rgb(102, 102, 102) 1px 1px 2px;
}
#note {
    font-size: 1.5rem;
    font-style: italic;
    padding: 0 1rem;
    margin: 2.5rem 0;
    position: relative;
    background-color: #fafeff;
    border-top: 1px dotted #9954bb;
    border-bottom: 1px dotted #9954bb;
}
#note-title {
    padding: 0.2rem 0.5rem;
    background: #9954bb;
    color: #FFF;
    position: absolute;
    left: 0;
    top: 0.25rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    border-radius: 4px;
    -webkit-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    -moz-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    -ms-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    -o-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    transform: rotate(-5deg) translateX(-10px) translateY(-25px);
}
#inline-yellow {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #f0ad4e;
}
#inline-green {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #5cb85c;
}
#inline-blue {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #2780e3;
}
#inline-purple {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #9954bb;
}
#div-border-left-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #df3e3e;
}
#div-border-left-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #f0ad4e;
}
#div-border-left-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #5cb85c;
}
#div-border-left-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #2780e3;
}
#div-border-left-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #9954bb;
}
#div-border-right-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #df3e3e;
}
#div-border-right-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #f0ad4e;
}
#div-border-right-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #5cb85c;
}
#div-border-right-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #2780e3;
}
#div-border-right-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #9954bb;
}
#div-border-top-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #df3e3e;
}
#div-border-top-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #f0ad4e;
}
#div-border-top-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #5cb85c;
}
#div-border-top-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #2780e3;
}
#div-border-top-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #9954bb;
}
&lt;/style&gt;</description>
    </item>
    
    <item>
      <title>Pod çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†</title>
      <link>https://www.yangcs.net/posts/pods-life/</link>
      <pubDate>Thu, 03 May 2018 12:08:01 +0000</pubDate>
      
      <guid>https://www.yangcs.net/posts/pods-life/</guid>
      <description>&lt;p&gt;&lt;/p&gt;

&lt;p&gt;æœ¬æ–‡æˆ‘ä»¬å°†ä»å®è·µè€…çš„è§’åº¦ä»”ç»†ç ”ç©¶æ•´ä¸ªpodç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬å¦‚ä½•å½±å“å¯åŠ¨å’Œå…³é—­è¡Œä¸ºï¼Œå¹¶é€šè¿‡å®è·µæ¥ç†è§£å¯¹åº”ç”¨ç¨‹åºå¥åº·çŠ¶å†µçš„æ£€æŸ¥ã€‚&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-1-pod-çš„ç”Ÿå‘½å‘¨æœŸ-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;1. Pod çš„ç”Ÿå‘½å‘¨æœŸ&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h3 id=&#34;pod-phase&#34;&gt;Pod phase&lt;/h3&gt;

&lt;p&gt;Pod çš„ status åœ¨ä¿¡æ¯ä¿å­˜åœ¨ &lt;a href=&#34;https://github.com/kubernetes/kubernetes/blob/3ae0b84e0b114692dc666d9486fb032d8a33bb58/pkg/api/types.go#L2471&#34; target=&#34;_blank&#34;&gt;PodStatus&lt;/a&gt; ä¸­å®šä¹‰ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ª phase å­—æ®µã€‚&lt;/p&gt;

&lt;p&gt;Pod çš„ç›¸ä½ï¼ˆphaseï¼‰æ˜¯ Pod åœ¨å…¶ç”Ÿå‘½å‘¨æœŸä¸­çš„ç®€å•å®è§‚æ¦‚è¿°ã€‚è¯¥é˜¶æ®µå¹¶ä¸æ˜¯å¯¹å®¹å™¨æˆ– Pod çš„ç»¼åˆæ±‡æ€»ï¼Œä¹Ÿä¸æ˜¯ä¸ºäº†åšä¸ºç»¼åˆçŠ¶æ€æœºã€‚&lt;/p&gt;

&lt;p&gt;Pod ç›¸ä½çš„æ•°é‡å’Œå«ä¹‰æ˜¯ä¸¥æ ¼æŒ‡å®šçš„ã€‚é™¤äº†æœ¬æ–‡æ¡£ä¸­åˆ—ä¸¾çš„çŠ¶æ€å¤–ï¼Œä¸åº”è¯¥å†å‡å®š Pod æœ‰å…¶ä»–çš„ phase å€¼ã€‚&lt;/p&gt;

&lt;p&gt;æ— è®ºä½ æ˜¯æ‰‹åŠ¨åˆ›å»º Podï¼Œè¿˜æ˜¯é€šè¿‡ &lt;code&gt;deployment&lt;/code&gt;ã€&lt;code&gt;daemonset&lt;/code&gt; æˆ– &lt;code&gt;statefulset&lt;/code&gt;æ¥åˆ›å»ºï¼ŒPod çš„ phase éƒ½æœ‰ä»¥ä¸‹å‡ ä¸ªå¯èƒ½çš„å€¼ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;æŒ‚èµ·ï¼ˆPendingï¼‰&lt;/strong&gt;ï¼šPod å·²è¢« Kubernetes ç³»ç»Ÿæ¥å—ï¼Œä½†æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨é•œåƒå°šæœªåˆ›å»ºã€‚ç­‰å¾…æ—¶é—´åŒ…æ‹¬è°ƒåº¦ Pod çš„æ—¶é—´å’Œé€šè¿‡ç½‘ç»œä¸‹è½½é•œåƒçš„æ—¶é—´ï¼Œè¿™å¯èƒ½éœ€è¦èŠ±ç‚¹æ—¶é—´ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;è¿è¡Œä¸­ï¼ˆRunningï¼‰&lt;/strong&gt;ï¼šè¯¥ Pod å·²ç»ç»‘å®šåˆ°äº†ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼ŒPod ä¸­æ‰€æœ‰çš„å®¹å™¨éƒ½å·²è¢«åˆ›å»ºã€‚è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨æ­£åœ¨è¿è¡Œï¼Œæˆ–è€…æ­£å¤„äºå¯åŠ¨æˆ–é‡å¯çŠ¶æ€ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;æˆåŠŸï¼ˆSuccessedï¼‰&lt;/strong&gt;ï¼šPod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½è¢«æˆåŠŸç»ˆæ­¢ï¼Œå¹¶ä¸”ä¸ä¼šå†é‡å¯ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å¤±è´¥ï¼ˆFailedï¼‰&lt;/strong&gt;ï¼šPod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½å·²ç»ˆæ­¢äº†ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨æ˜¯å› ä¸ºå¤±è´¥ç»ˆæ­¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®¹å™¨ä»¥é0çŠ¶æ€é€€å‡ºæˆ–è€…è¢«ç³»ç»Ÿç»ˆæ­¢ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;æœªçŸ¥ï¼ˆUnkonwnï¼‰&lt;/strong&gt;ï¼šå› ä¸ºæŸäº›åŸå› æ— æ³•å–å¾— Pod çš„çŠ¶æ€ï¼Œé€šå¸¸æ˜¯å› ä¸ºä¸ Pod æ‰€åœ¨ä¸»æœºé€šä¿¡å¤±è´¥ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ä¸‹å›¾æ˜¯ Pod çš„ç”Ÿå‘½å‘¨æœŸç¤ºæ„å›¾ï¼Œä»å›¾ä¸­å¯ä»¥çœ‹åˆ° Pod çŠ¶æ€çš„å˜åŒ–ã€‚&lt;/p&gt;

&lt;p&gt;&lt;center&gt;&lt;img src=&#34;https://jimmysong.io/kubernetes-handbook/images/kubernetes-pod-life-cycle.jpg&#34; alt=&#34;&#34; /&gt;&lt;/center&gt;
&lt;center&gt;å›¾ç‰‡ - Podçš„ç”Ÿå‘½å‘¨æœŸç¤ºæ„å›¾&lt;/center&gt;&lt;/p&gt;

&lt;h3 id=&#34;pod-çŠ¶æ€&#34;&gt;Pod çŠ¶æ€&lt;/h3&gt;

&lt;p&gt;Pod æœ‰ä¸€ä¸ª PodStatus å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ª &lt;a href=&#34;https://github.com/kubernetes/kubernetes/blob/3ae0b84e0b114692dc666d9486fb032d8a33bb58/pkg/api/types.go#L1964&#34; target=&#34;_blank&#34;&gt;PodCondition&lt;/a&gt; æ•°ç»„ã€‚ PodCondition æ•°ç»„çš„æ¯ä¸ªå…ƒç´ éƒ½æœ‰ä¸€ä¸ª type å­—æ®µå’Œä¸€ä¸ª status å­—æ®µã€‚type å­—æ®µæ˜¯å­—ç¬¦ä¸²ï¼Œå¯èƒ½çš„å€¼æœ‰ &lt;code&gt;PodScheduled&lt;/code&gt;ã€&lt;code&gt;Ready&lt;/code&gt;ã€&lt;code&gt;Initialized&lt;/code&gt; å’Œ &lt;code&gt;Unschedulable&lt;/code&gt;ã€‚status å­—æ®µæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¯èƒ½çš„å€¼æœ‰ &lt;code&gt;True&lt;/code&gt;ã€&lt;code&gt;False&lt;/code&gt; å’Œ &lt;code&gt;Unknown&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;å½“ä½ é€šè¿‡ &lt;code&gt;kubectl get pod&lt;/code&gt; æŸ¥çœ‹ Pod æ—¶ï¼Œ&lt;code&gt;STATUS&lt;/code&gt; è¿™ä¸€åˆ—å¯èƒ½ä¼šæ˜¾ç¤ºä¸ä¸Šè¿°5ä¸ªçŠ¶æ€ä¸åŒçš„å€¼ï¼Œä¾‹å¦‚ &lt;code&gt;Init:0/1&lt;/code&gt; å’Œ &lt;code&gt;CrashLoopBackOff&lt;/code&gt;ã€‚è¿™æ˜¯å› ä¸º Pod çŠ¶æ€çš„å®šä¹‰é™¤äº†åŒ…å« phase ä¹‹å¤–ï¼Œè¿˜æœ‰ &lt;code&gt;InitContainerStatuses&lt;/code&gt; å’Œ &lt;code&gt;containerStatuses&lt;/code&gt; ç­‰å…¶ä»–å­—æ®µï¼Œå…·ä½“ä»£ç å‚è€ƒ &lt;a href=&#34;https://github.com/kubernetes/kubernetes/blob/3ae0b84e0b114692dc666d9486fb032d8a33bb58/pkg/api/types.go#L2471&#34; target=&#34;_blank&#34;&gt;overall status of a pod&lt;/a&gt; .&lt;/p&gt;

&lt;p&gt;å¦‚æœæƒ³çŸ¥é“ç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤ &lt;code&gt;kubectl describe pod/$PODNAME&lt;/code&gt; æŸ¥çœ‹è¾“å‡ºä¿¡æ¯çš„ &lt;code&gt;Events&lt;/code&gt; æ¡ç›®ã€‚é€šè¿‡ Events æ¡ç›®å¯ä»¥çœ‹åˆ°ä¸€äº›å…·ä½“çš„ä¿¡æ¯ï¼Œæ¯”å¦‚æ­£åœ¨æ‹‰å–å®¹å™¨é•œåƒï¼ŒPod å·²ç»è¢«è°ƒåº¦ï¼Œæˆ–è€…æŸä¸ª container å¤„äº unhealthy çŠ¶æ€ã€‚&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-2-pod-çš„å¯åŠ¨å…³é—­æµç¨‹-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;2. Pod çš„å¯åŠ¨å…³é—­æµç¨‹&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;ä¸‹é¢é€šè¿‡ä¸€ä¸ªå…·ä½“çš„ç¤ºä¾‹æ¥æ¢ç©¶ä¸€ä¸‹ Pod çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸæµç¨‹ã€‚ä¸ºäº†ç¡®å®šäº‹æƒ…å‘ç”Ÿçš„é¡ºåºï¼Œé€šè¿‡ä¸‹é¢çš„ manifest æ¥éƒ¨ç½²ä¸€ä¸ª deploymentã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;kind:                   Deployment
apiVersion:             apps/v1beta1
metadata:
  name:                 loap
spec:
  replicas:             1
  template:
    metadata:
      labels:
        app:            loap
    spec:
      initContainers:
      - name:           init
        image:          busybox
        command:       [&#39;sh&#39;, &#39;-c&#39;, &#39;echo $(date +%s): INIT &amp;gt;&amp;gt; /loap/timing&#39;]
        volumeMounts:
        - mountPath:    /loap
          name:         timing
      containers:
      - name:           main
        image:          busybox
        command:       [&#39;sh&#39;, &#39;-c&#39;, &#39;echo $(date +%s): START &amp;gt;&amp;gt; /loap/timing;
sleep 10; echo $(date +%s): END &amp;gt;&amp;gt; /loap/timing;&#39;]
        volumeMounts:
        - mountPath:    /loap
          name:         timing
        livenessProbe:
          exec:
            command:   [&#39;sh&#39;, &#39;-c&#39;, &#39;echo $(date +%s): LIVENESS &amp;gt;&amp;gt; /loap/timing&#39;]
        readinessProbe:
          exec:
            command:   [&#39;sh&#39;, &#39;-c&#39;, &#39;echo $(date +%s): READINESS &amp;gt;&amp;gt; /loap/timing&#39;]
        lifecycle:
          postStart:
            exec:
              command:   [&#39;sh&#39;, &#39;-c&#39;, &#39;echo $(date +%s): POST-START &amp;gt;&amp;gt; /loap/timing&#39;]
          preStop:
            exec:
              command:  [&#39;sh&#39;, &#39;-c&#39;, &#39;echo $(date +%s): PRE-HOOK &amp;gt;&amp;gt; /loap/timing&#39;]
      volumes:
      - name:           timing
        hostPath:
          path:         /tmp/loap
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç­‰å¾… Pod çŠ¶æ€å˜ä¸º &lt;code&gt;Running&lt;/code&gt; ä¹‹åï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥å¼ºåˆ¶åœæ­¢ Podï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ kubectl scale deployment loap --replicas=0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŸ¥çœ‹ &lt;code&gt;/tmp/loap/timing&lt;/code&gt; æ–‡ä»¶çš„å†…å®¹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ cat /tmp/loap/timing

1525334577: INIT
1525334581: START
1525334581: POST-START
1525334584: READINESS
1525334584: LIVENESS
1525334588: PRE-HOOK
1525334589: END
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;/tmp/loap/timing&lt;/code&gt; æ–‡ä»¶çš„å†…å®¹å¾ˆå¥½åœ°ä½“ç°äº† Pod çš„å¯åŠ¨å’Œå…³é—­æµç¨‹ï¼Œå…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;p&gt;&lt;center&gt;&lt;img src=&#34;http://o7z41ciog.bkt.clouddn.com/loap.png&#34; alt=&#34;&#34; /&gt;&lt;/center&gt;
&lt;center&gt;å›¾ç‰‡ - Pod çš„å¯åŠ¨å’Œå…³é—­æµç¨‹&lt;/center&gt;&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;é¦–å…ˆå¯åŠ¨ä¸€ä¸ª Infra å®¹å™¨ï¼ˆåˆå« Pause å®¹å™¨ï¼‰ï¼Œç”¨æ¥å’Œ Pod ä¸­çš„å…¶ä»–å®¹å™¨å…±äº« linux å‘½åç©ºé—´ï¼Œå¹¶å¼€å¯ init è¿›ç¨‹ã€‚ï¼ˆä¸Šå›¾ä¸­å¿½ç•¥äº†è¿™ä¸€æ­¥ï¼‰&lt;/li&gt;
&lt;li&gt;ç„¶åå¯åŠ¨ Init å®¹å™¨ï¼Œå®ƒæ˜¯ä¸€ç§ä¸“ç”¨çš„å®¹å™¨ï¼Œåœ¨åº”ç”¨ç¨‹åºå®¹å™¨å¯åŠ¨ä¹‹å‰è¿è¡Œï¼Œç”¨æ¥å¯¹ Pod è¿›è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œå¹¶åŒ…æ‹¬ä¸€äº›åº”ç”¨é•œåƒä¸­ä¸å­˜åœ¨çš„å®ç”¨å·¥å…·å’Œå®‰è£…è„šæœ¬ã€‚&lt;/li&gt;
&lt;li&gt;4 ç§’ä¹‹åï¼Œåº”ç”¨ç¨‹åºå®¹å™¨å’Œ &lt;code&gt;post-start hook&lt;/code&gt; åŒæ—¶å¯åŠ¨ã€‚&lt;/li&gt;
&lt;li&gt;7 ç§’ä¹‹åå¼€å§‹å¯åŠ¨ &lt;a href=&#34;https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/&#34; target=&#34;_blank&#34;&gt;liveness å’Œ readiness æ¢é’ˆ&lt;/a&gt;ã€‚&lt;/li&gt;
&lt;li&gt;11 ç§’ä¹‹åï¼Œé€šè¿‡æ‰‹åŠ¨æ€æ‰ Podï¼Œ&lt;code&gt;pre-stop hook&lt;/code&gt; æ‰§è¡Œï¼Œä¼˜é›…åˆ é™¤æœŸé™è¿‡æœŸåï¼ˆé»˜è®¤æ˜¯ 30 ç§’ï¼‰ï¼Œåº”ç”¨ç¨‹åºå®¹å™¨åœæ­¢ã€‚å®é™…çš„ Pod ç»ˆæ­¢è¿‡ç¨‹è¦æ›´å¤æ‚ï¼Œå…·ä½“å‚è€ƒ &lt;a href=&#34;https://jimmysong.io/kubernetes-handbook/concepts/pod.html&#34; target=&#34;_blank&#34;&gt;Pod çš„ç»ˆæ­¢&lt;/a&gt;ã€‚&lt;/li&gt;
&lt;/ol&gt;

&lt;div id=&#34;note&#34;&gt;
&lt;p id=&#34;note-title&#34;&gt;Note&lt;/p&gt;
&lt;br /&gt;
&lt;p&gt;å¿…é¡»ä¸»åŠ¨æ€æ‰ Pod æ‰ä¼šè§¦å‘ &lt;code&gt;pre-stop hook&lt;/code&gt;ï¼Œå¦‚æœæ˜¯ Pod è‡ªå·± Down æ‰ï¼Œåˆ™ä¸ä¼šæ‰§è¡Œ &lt;code&gt;pre-stop hook&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-3-å¦‚ä½•å¿«é€Ÿ-debug-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;3. å¦‚ä½•å¿«é€Ÿ DEBUG&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;å½“ Pod å‡ºç°è‡´å‘½çš„é”™è¯¯æ—¶ï¼Œå¦‚æœèƒ½å¤Ÿå¿«é€Ÿ DEBUGï¼Œå°†ä¼šå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå®šä½é—®é¢˜ã€‚ä¸ºäº†å®ç°è¿™ä¸ªç›®çš„ï¼Œå¯ä»¥æŠŠæŠŠè‡´å‘½äº‹ä»¶çš„ä¿¡æ¯é€šè¿‡ &lt;code&gt;.spec.terminationMessagePath&lt;/code&gt; é…ç½®å†™å…¥æŒ‡å®šä½ç½®çš„æ–‡ä»¶ï¼Œå°±åƒæ‰“å°é”™è¯¯ã€å¼‚å¸¸å’Œå †æ ˆä¿¡æ¯ä¸€æ ·ã€‚è¯¥ä½ç½®çš„å†…å®¹å¯ä»¥å¾ˆæ–¹ä¾¿çš„é€šè¿‡ dashboardsã€ç›‘æ§è½¯ä»¶ç­‰å·¥å…·æ£€ç´¢å’Œå±•ç¤ºï¼Œé»˜è®¤è·¯å¾„ä¸º &lt;code&gt;/dev/termination-log&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;ä»¥ä¸‹æ˜¯ä¸€ä¸ªå°ä¾‹å­ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;# termination-demo.yaml
apiVersion: v1
kind: Pod
metadata:
  name: termination-demo
spec:
  containers:
  - name: termination-demo-container
    image: alpine
    command: [&amp;quot;/bin/sh&amp;quot;]
    args: [&amp;quot;-c&amp;quot;, &amp;quot;sleep 10 &amp;amp;&amp;amp; echo Sleep expired &amp;gt; /dev/termination-log&amp;quot;]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™äº›æ¶ˆæ¯çš„æœ€åéƒ¨åˆ†ä¼šä½¿ç”¨å…¶ä»–çš„è§„å®šæ¥å•ç‹¬å­˜å‚¨ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ kubectl create -f termination-demo.yaml

$ sleep 20

$ kubectl get pod termination-demo -o go-template=&#39;{{range .status.containerStatuses}}{{.lastState.terminated.message}}{{end}}&#39;

Sleep expired

$ kubectl get pod termination-demo -o go-template=&#39;{{range .status.containerStatuses}}{{.lastState.terminated.exitCode}}{{end}}&#39;

0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-4-å‚è€ƒ-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;4. å‚è€ƒ&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://jimmysong.io/kubernetes-handbook/concepts/pod-hook.html&#34; target=&#34;_blank&#34;&gt;Pod hook&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://blog.openshift.com/kubernetes-pods-life/&#34; target=&#34;_blank&#34;&gt;Kubernetes: A Podâ€™s Life&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://k8smeetup.github.io/docs/tasks/debug-application-cluster/determine-reason-pod-failure/&#34; target=&#34;_blank&#34;&gt;ç¡®å®š Pod å¤±è´¥çš„åŸå› &lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;style&gt;
#h2{
    margin-bottom:2em;
    margin-right: 5px;
    padding: 8px 15px;
    letter-spacing: 2px;
    background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181));
    background-color: rgb(63, 81, 181);
    color: rgb(255, 255, 255);
    border-left: 10px solid rgb(51, 51, 51);
    border-radius:5px;
    text-shadow: rgb(102, 102, 102) 1px 1px 1px;
    box-shadow: rgb(102, 102, 102) 1px 1px 2px;
}
#note {
    font-size: 1.5rem;
    font-style: italic;
    padding: 0 1rem;
    margin: 2.5rem 0;
    position: relative;
    background-color: #fafeff;
    border-top: 1px dotted #9954bb;
    border-bottom: 1px dotted #9954bb;
}
#note-title {
    padding: 0.2rem 0.5rem;
    background: #9954bb;
    color: #FFF;
    position: absolute;
    left: 0;
    top: 0.25rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    border-radius: 4px;
    -webkit-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    -moz-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    -ms-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    -o-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    transform: rotate(-5deg) translateX(-10px) translateY(-25px);
}
#inline-yellow {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #f0ad4e;
}
#inline-green {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #5cb85c;
}
#inline-blue {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #2780e3;
}
#inline-purple {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #9954bb;
}
#div-border-left-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #df3e3e;
}
#div-border-left-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #f0ad4e;
}
#div-border-left-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #5cb85c;
}
#div-border-left-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #2780e3;
}
#div-border-left-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #9954bb;
}
#div-border-right-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #df3e3e;
}
#div-border-right-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #f0ad4e;
}
#div-border-right-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #5cb85c;
}
#div-border-right-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #2780e3;
}
#div-border-right-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #9954bb;
}
#div-border-top-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #df3e3e;
}
#div-border-top-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #f0ad4e;
}
#div-border-top-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #5cb85c;
}
#div-border-top-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #2780e3;
}
#div-border-top-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #9954bb;
}
&lt;/style&gt;</description>
    </item>
    
    <item>
      <title>Kube-router å®æˆ˜</title>
      <link>https://www.yangcs.net/posts/kube-router/</link>
      <pubDate>Fri, 20 Apr 2018 04:36:40 +0000</pubDate>
      
      <guid>https://www.yangcs.net/posts/kube-router/</guid>
      <description>&lt;p&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/cloudnativelabs/kube-router&#34; target=&#34;_blank&#34;&gt;Kube-router&lt;/a&gt; æ˜¯ä¸€ä¸ªæŒºæœ‰æƒ³æ³•çš„é¡¹ç›®ï¼Œå…¼å¤‡äº† &lt;code&gt;calico&lt;/code&gt; å’Œ &lt;code&gt;kube-proxy&lt;/code&gt; çš„åŠŸèƒ½ï¼Œæ˜¯åŸºäº Kubernetes ç½‘ç»œè®¾è®¡çš„ä¸€ä¸ªé›†è´Ÿè½½å‡è¡¡å™¨ã€é˜²ç«å¢™å’Œå®¹å™¨ç½‘ç»œçš„ç»¼åˆæ–¹æ¡ˆã€‚&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-1-ä½“ç³»æ¶æ„-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;1. ä½“ç³»æ¶æ„&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;Kube-router æ˜¯å›´ç»• &lt;span id=&#34;inline-blue&#34;&gt;è§‚å¯Ÿè€…&lt;/span&gt; å’Œ &lt;span id=&#34;inline-blue&#34;&gt;æ§åˆ¶å™¨&lt;/span&gt; çš„æ¦‚å¿µè€Œå»ºç«‹çš„ã€‚&lt;/p&gt;

&lt;p&gt;&lt;span id=&#34;inline-blue&#34;&gt;è§‚å¯Ÿè€…&lt;/span&gt; ä½¿ç”¨ &lt;code&gt;Kubernetes watch API&lt;/code&gt; æ¥è·å–ä¸åˆ›å»ºï¼Œæ›´æ–°å’Œåˆ é™¤ Kubernetes å¯¹è±¡æœ‰å…³çš„äº‹ä»¶çš„é€šçŸ¥ã€‚ æ¯ä¸ªè§‚å¯Ÿè€…è·å–ä¸ç‰¹å®š API å¯¹è±¡ç›¸å…³çš„é€šçŸ¥ã€‚ åœ¨ä» API æœåŠ¡å™¨æ¥æ”¶äº‹ä»¶æ—¶ï¼Œè§‚å¯Ÿè€…å¹¿æ’­äº‹ä»¶ã€‚&lt;/p&gt;

&lt;p&gt;&lt;span id=&#34;inline-blue&#34;&gt;æ§åˆ¶å™¨&lt;/span&gt; æ³¨å†Œä»¥è·å–è§‚å¯Ÿè€…çš„äº‹ä»¶æ›´æ–°ï¼Œå¹¶å¤„ç†äº‹ä»¶ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;Kube-router&lt;/code&gt; ç”±3ä¸ªæ ¸å¿ƒæ§åˆ¶å™¨å’Œå¤šä¸ªè§‚å¯Ÿè€…ç»„æˆï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚&lt;/p&gt;

&lt;p&gt;&lt;center&gt;&lt;img src=&#34;http://o7z41ciog.bkt.clouddn.com/kube-router-arch.png&#34; alt=&#34;&#34; /&gt;&lt;/center&gt;&lt;/p&gt;

&lt;h3 id=&#34;æµç¨‹åˆ†æ&#34;&gt;æµç¨‹åˆ†æ&lt;/h3&gt;

&lt;p&gt;Kube-router å¯åŠ¨ä¹‹åï¼Œé¦–å…ˆåˆ›å»º &lt;code&gt;wathcer&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func (kr *KubeRouter) Run() error {
	...
	err = kr.startApiWatchers()
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨ &lt;code&gt;startApiWatchers&lt;/code&gt; ä¸­ï¼Œä¼šå¯åŠ¨ endpointã€namespaceã€podã€nodeã€networkpolicyã€service è¿™å…­ä¸ª watherã€‚&lt;/p&gt;

&lt;p&gt;è¿™å…­ä¸ª wathcer å°†ç›‘å¬çš„å˜åŒ–å‘é€åˆ° &lt;code&gt;Broadcaster&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func NewBroadcaster() *Broadcaster {
	return &amp;amp;Broadcaster{}
}

func (b *Broadcaster) Add(listener Listener) {
	b.listenerLock.Lock()
	defer b.listenerLock.Unlock()
	b.listeners = append(b.listeners, listener)
}

func (b *Broadcaster) Notify(instance interface{}) {
	b.listenerLock.RLock()
	listeners := b.listeners
	b.listenerLock.RUnlock()
	for _, listener := range listeners {
		go listener.OnUpdate(instance)
	}
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¹‹ååˆ›å»ºä¸‰ä¸ª controllerï¼š&lt;code&gt;NetworkPolicyController&lt;/code&gt;ã€&lt;code&gt;NetworkRoutingController&lt;/code&gt;ã€&lt;code&gt;NetworkServicesControllers&lt;/code&gt;ã€‚ æ¯ä¸ª controller ä¼šç›‘å¬æ‰€å…³å¿ƒçš„èµ„æºçš„å˜åŒ–ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func NewNetworkServicesController(clientset *kubernetes.Clientset,\
	config *options.KubeRouterConfig) (*NetworkServicesController, error) {
	...
	nsc := NetworkServicesController{}
	...
	watchers.EndpointsWatcher.RegisterHandler(&amp;amp;nsc)
	watchers.ServiceWatcher.RegisterHandler(&amp;amp;nsc)
	...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ¯ä¸ª &lt;a href=&#34;https://github.com/cloudnativelabs/kube-router/tree/master/pkg/controllers&#34; target=&#34;_blank&#34;&gt;controller&lt;/a&gt; éµå¾ªä»¥ä¸‹ç»“æ„ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func Run() {
    for {
        Sync() // control loop that runs for ever and perfom sync at periodic interval
    }
}

func OnUpdate() {
    Sync() // on receiving update of a watched API object (namespace, node, pod, network policy etc)
}

Sync() {
    //re-concile any state changes
}

Cleanup() {
    // cleanup any changes (to iptables, ipvs, network etc) done to the system
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;p-id-h2-2-ä¸»è¦åŠŸèƒ½-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;2. ä¸»è¦åŠŸèƒ½&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;h3 id=&#34;åŸºäº-ipvs-lvs-çš„è´Ÿè½½å‡è¡¡å™¨-run-service-proxy&#34;&gt;åŸºäº IPVS/LVS çš„è´Ÿè½½å‡è¡¡å™¨ | &lt;code&gt;--run-service-proxy&lt;/code&gt;&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;Kube-router&lt;/code&gt; é‡‡ç”¨ Linux å†…æ ¸çš„ &lt;code&gt;IPVS&lt;/code&gt; æ¨¡å—ä¸º K8s æä¾› &lt;code&gt;Service&lt;/code&gt; çš„ä»£ç†ã€‚&lt;/p&gt;

&lt;p&gt;Kube-router çš„è´Ÿè½½å‡è¡¡å™¨åŠŸèƒ½ï¼Œä¼šåœ¨ç‰©ç†æœºä¸Šåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿçš„ &lt;code&gt;kube-dummy-if&lt;/code&gt; ç½‘å¡ï¼Œç„¶ååˆ©ç”¨ k8s çš„ watch APi å®æ—¶æ›´æ–° &lt;code&gt;svc&lt;/code&gt; å’Œ &lt;code&gt;ep&lt;/code&gt; çš„ä¿¡æ¯ã€‚svc çš„ &lt;code&gt;cluster_ip&lt;/code&gt; ä¼šç»‘å®šåœ¨ kube-dummy-if ç½‘å¡ä¸Šï¼Œä½œä¸º lvs çš„ &lt;code&gt;virtual server&lt;/code&gt; çš„åœ°å€ã€‚&lt;code&gt;realserver&lt;/code&gt; çš„ ip åˆ™é€šè¿‡ ep è·å–åˆ°å®¹å™¨çš„IPåœ°å€ã€‚&lt;/p&gt;

&lt;p&gt;åŸºäº Kubernetes ç½‘ç»œæœåŠ¡ä»£ç†çš„ Kube-router IPVS æ¼”ç¤º&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://asciinema.org/a/120312&#34; target=&#34;_blank&#34;&gt;&lt;img src=&#34;https://asciinema.org/a/120312.png&#34; alt=&#34;asciicast&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;ç‰¹å¾ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;è½®è¯¢è´Ÿè½½å‡è¡¡&lt;/li&gt;
&lt;li&gt;åŸºäºå®¢æˆ·ç«¯IPçš„ä¼šè¯ä¿æŒ&lt;/li&gt;
&lt;li&gt;å¦‚æœæœåŠ¡æ§åˆ¶å™¨ä¸ç½‘ç»œè·¯ç”±æ§åˆ¶å™¨ï¼ˆå¸¦æœ‰ &lt;code&gt;â€“-run-router&lt;/code&gt; æ ‡å¿—çš„ kube-routerï¼‰ä¸€èµ·ä½¿ç”¨ï¼ŒæºIPå°†è¢«ä¿ç•™&lt;/li&gt;
&lt;li&gt;ç”¨ &lt;code&gt;â€“-masquerade-all&lt;/code&gt; å‚æ•°æ˜ç¡®æ ‡è®°ä¼ªè£…(SNAT)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æ›´å¤šè¯¦æƒ…å¯ä»¥å‚è€ƒï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://link.jianshu.com/?t=https://cloudnativelabs.github.io/post/2017-05-10-kube-network-service-proxy/&#34; target=&#34;_blank&#34;&gt;Kubernetes network services prox with IPVS/LVS&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://link.jianshu.com/?t=https://blog.codeship.com/kernel-load-balancing-for-docker-containers-using-ipvs/&#34; target=&#34;_blank&#34;&gt;Kernel Load-Balancing for Docker Containers Using IPVS&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.yangcs.net/posts/lvs-persistent-connection/&#34; target=&#34;_blank&#34;&gt;LVSè´Ÿè½½å‡è¡¡ä¹‹æŒä¹…æ€§è¿æ¥ä»‹ç»&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;å®¹å™¨ç½‘ç»œ-run-router&#34;&gt;å®¹å™¨ç½‘ç»œ | &lt;code&gt;--run-router&lt;/code&gt;&lt;/h3&gt;

&lt;p&gt;Kube-router åˆ©ç”¨ BGP åè®®å’Œ Go çš„ &lt;code&gt;GoBGP&lt;/code&gt; åº“å’Œä¸ºå®¹å™¨ç½‘ç»œæä¾›ç›´è¿çš„æ–¹æ¡ˆã€‚å› ä¸ºç”¨äº†åŸç”Ÿçš„ Kubernetes API å»æ„å»ºå®¹å™¨ç½‘ç»œï¼Œæ„å‘³ç€åœ¨ä½¿ç”¨ kube-router æ—¶ï¼Œä¸éœ€è¦åœ¨ä½ çš„é›†ç¾¤é‡Œé¢å¼•å…¥å…¶ä»–ä¾èµ–ã€‚&lt;/p&gt;

&lt;p&gt;åŒæ ·çš„ï¼Œkube-router åœ¨å¼•å…¥å®¹å™¨ CNI æ—¶ä¹Ÿæ²¡æœ‰å…¶å®ƒçš„ä¾èµ–ï¼Œå®˜æ–¹çš„ &lt;code&gt;bridge&lt;/code&gt; æ’ä»¶å°±èƒ½æ»¡è¶³ kube-rouetr çš„éœ€æ±‚ã€‚&lt;/p&gt;

&lt;p&gt;æ›´å¤šå…³äº BGP åè®®åœ¨ Kubernetes ä¸­çš„ä½¿ç”¨å¯ä»¥å‚è€ƒï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://link.jianshu.com/?t=https://cloudnativelabs.github.io/post/2017-05-22-kube-pod-networking/&#34; target=&#34;_blank&#34;&gt;Kubernetes pod networking and beyond with BGP&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;ç½‘ç»œç­–ç•¥ç®¡ç†-run-firewall&#34;&gt;ç½‘ç»œç­–ç•¥ç®¡ç† | &lt;code&gt;--run-firewall&lt;/code&gt;&lt;/h3&gt;

&lt;p&gt;ç½‘ç»œç­–ç•¥æ§åˆ¶å™¨è´Ÿè´£ä» Kubernetes API æœåŠ¡å™¨è¯»å–å‘½åç©ºé—´ã€ç½‘ç»œç­–ç•¥å’Œ pod ä¿¡æ¯ï¼Œå¹¶ç›¸åº”åœ°ä½¿ç”¨ &lt;code&gt;ipset&lt;/code&gt; é…ç½® iptables ä»¥å‘ pod æä¾›å…¥å£è¿‡æ»¤ï¼Œä¿è¯é˜²ç«å¢™çš„è§„åˆ™å¯¹ç³»ç»Ÿæ€§èƒ½æœ‰è¾ƒä½çš„å½±å“ã€‚&lt;/p&gt;

&lt;p&gt;Kube-router æ”¯æŒ &lt;code&gt;networking.k8s.io/NetworkPolicy&lt;/code&gt; æ¥å£æˆ–ç½‘ç»œç­–ç•¥ V1/GA &lt;a href=&#34;https://github.com/kubernetes/kubernetes/pull/39164#issue-197243974&#34; target=&#34;_blank&#34;&gt;semantics&lt;/a&gt; ä»¥åŠç½‘ç»œç­–ç•¥çš„ beta è¯­ä¹‰ã€‚&lt;/p&gt;

&lt;p&gt;æ›´å¤šå…³äº kube-router é˜²ç«å¢™çš„åŠŸèƒ½å¯ä»¥å‚è€ƒï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://link.jianshu.com/?t=https://cloudnativelabs.github.io/post/2017-05-1-kube-network-policies/&#34; target=&#34;_blank&#34;&gt;Enforcing Kubernetes network policies with iptables&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;p-id-h2-3-ä½¿ç”¨-kube-router-æ›¿ä»£-kube-proxy-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;3. ä½¿ç”¨ kube-router æ›¿ä»£ kube-proxy&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;ä¸‹é¢è¿›å…¥å®æˆ˜é˜¶æ®µï¼Œæœ¬æ–¹æ¡ˆåªä½¿ç”¨ kube-router çš„ &lt;code&gt;service-proxy&lt;/code&gt; åŠŸèƒ½ï¼Œç½‘ç»œæ’ä»¶ä»ç„¶ä½¿ç”¨ &lt;code&gt;calico&lt;/code&gt;ï¼ˆä¼°è®¡åªæœ‰æˆ‘èƒ½æƒ³åˆ°è¿™ä¹ˆå¥‡è‘©çš„ç»„åˆäº† âœŒï¸ï¼‰&lt;/p&gt;

&lt;h3 id=&#34;å‰æ&#34;&gt;å‰æ&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;å·²æœ‰ä¸€ä¸ª k8s é›†ç¾¤&lt;/li&gt;
&lt;li&gt;kube-router èƒ½å¤Ÿè¿æ¥ &lt;code&gt;apiserver&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;å¦‚æœæ‚¨é€‰æ‹©ä»¥ &lt;code&gt;daemonset&lt;/code&gt; è¿è¡Œ kube-routerï¼Œé‚£ä¹ˆ kube-apiserver å’Œ kubelet å¿…é¡»ä»¥ &lt;code&gt;â€“allow-privileged=true&lt;/code&gt; é€‰é¡¹è¿è¡Œ&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;é›†ç¾¤ç¯å¢ƒ&#34;&gt;é›†ç¾¤ç¯å¢ƒ&lt;/h3&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&#34;left&#34;&gt;è§’è‰²&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;IP åœ°å€&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;ä¸»æœºå&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&#34;left&#34;&gt;k8s master&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;192.168.123.250&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;node1&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;left&#34;&gt;k8s node&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;192.168.123.248&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;node2&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;left&#34;&gt;k8s node&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;192.168.123.249&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;node3&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&#34;å®‰è£…æ­¥éª¤&#34;&gt;å®‰è£…æ­¥éª¤&lt;/h3&gt;

&lt;p&gt;å¦‚æœä½ æ­£åœ¨ä½¿ç”¨ &lt;code&gt;kube-proxy&lt;/code&gt;ï¼Œéœ€è¦å…ˆåœæ­¢ kube-proxy æœåŠ¡ï¼Œå¹¶ä¸”åˆ é™¤ç›¸å…³ iptables è§„åˆ™ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ systemctl stop kube-proxy
$ kube-proxy --cleanup-iptables
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ¥ä¸‹æ¥ä»¥ &lt;code&gt;daemonset&lt;/code&gt; è¿è¡Œ kube-routerï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ DR æ¨¡å¼ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl --namespace=kube-system create configmap kube-proxy  --from-file=kubeconfig.conf=/root/.kube/config
$ wget https://raw.githubusercontent.com/cloudnativelabs/kube-router/master/daemonset/kubeadm-kuberouter-all-features-dsr.yaml

# å°† kubeadm-kuberouter-all-features-dsr.yaml é‡Œçš„ --run-router å‚æ•°å’Œ --run-firewall å‚æ•°çš„å€¼æ”¹ä¸º false
$ kubectl create -f kubeadm-kuberouter-all-features-dsr.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨æ¯å°æœºå™¨ä¸ŠæŸ¥çœ‹ lvs æ¡ç›®&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ipvsadm -Ln

IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -&amp;gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.254.0.1:443 rr persistent 10800
  -&amp;gt; 192.168.123.250:6443         Masq    1      0          0
  
$ ipvsadm -S -n

-A -t 10.254.0.1:443 -s rr -p 10800
-a -t 10.254.0.1:443 -r 192.168.123.250:6443 -m -w 1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹å‡ºï¼Œkube-router ä½¿ç”¨çš„æ˜¯ lvs çš„ nat æ¨¡å¼ã€‚&lt;/p&gt;

&lt;h3 id=&#34;åˆ›å»ºä¸€ä¸ªåº”ç”¨æµ‹è¯•-kube-router&#34;&gt;åˆ›å»ºä¸€ä¸ªåº”ç”¨æµ‹è¯• kube-router&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl run whats-my-ip --image=cloudnativelabs/whats-my-ip --replicas=3

# æš´éœ²æœåŠ¡
$ kubectl expose deploy whats-my-ip --target-port=8080 --port=8080
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŸ¥çœ‹åˆ›å»ºå¥½çš„æœåŠ¡&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl get pods -owide

NAME                           READY     STATUS    RESTARTS   AGE       IP               NODE
whats-my-ip-845d4ff4f6-d2ptz   1/1       Running   0          23h       172.20.135.8     192.168.123.249
whats-my-ip-845d4ff4f6-jxzzn   1/1       Running   0          23h       172.20.166.130   192.168.123.250
whats-my-ip-845d4ff4f6-szhhd   1/1       Running   0          34s       172.20.104.9     192.168.123.248

$ kubectl get svc

NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
kubernetes    ClusterIP   10.254.0.1       &amp;lt;none&amp;gt;        443/TCP    45d
whats-my-ip   ClusterIP   10.254.108.117   &amp;lt;none&amp;gt;        8080/TCP   16s
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŸ¥çœ‹ lvs è§„åˆ™æ¡ç›®&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ipvsadm -Ln

IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -&amp;gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.254.0.1:443 rr persistent 10800
  -&amp;gt; 192.168.123.250:6443         Masq    1      0          0
TCP  10.254.175.147:8080 rr
  -&amp;gt; 172.20.104.9:8080            Masq    1      0          0
  -&amp;gt; 172.20.135.8:8080            Masq    1      0          0
  -&amp;gt; 172.20.166.130:8080          Masq    1      0          0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥å‘ç°æœ¬æœºçš„ &lt;code&gt;Cluster IP&lt;/code&gt; ä»£ç†åç«¯çœŸå® &lt;code&gt;Pod IP&lt;/code&gt;ï¼Œä½¿ç”¨ rr ç®—æ³•ã€‚&lt;/p&gt;

&lt;p&gt;é€šè¿‡ &lt;code&gt;ip a&lt;/code&gt; å¯ä»¥çœ‹åˆ°ï¼Œæ¯æ·»åŠ ä¸€ä¸ªæœåŠ¡ï¼Œnode èŠ‚ç‚¹ä¸Šé¢çš„ &lt;code&gt;kube-dummy-if&lt;/code&gt; ç½‘å¡å°±ä¼šå¢åŠ ä¸€ä¸ªè™šIPã€‚&lt;/p&gt;

&lt;h3 id=&#34;session-affinity&#34;&gt;session affinity&lt;/h3&gt;

&lt;p&gt;Service é»˜è®¤çš„ç­–ç•¥æ˜¯ï¼Œé€šè¿‡ round-robin ç®—æ³•æ¥é€‰æ‹© backend Podã€‚ è¦å®ç°åŸºäºå®¢æˆ·ç«¯ IP çš„ä¼šè¯äº²å’Œæ€§ï¼Œå¯ä»¥é€šè¿‡è®¾ç½® &lt;code&gt;service.spec.sessionAffinity&lt;/code&gt; çš„å€¼ä¸º &lt;code&gt;ClientIP&lt;/code&gt; ï¼ˆé»˜è®¤å€¼ä¸º &amp;ldquo;None&amp;rdquo;ï¼‰ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl delete svc whats-my-ip
$ kubectl expose deploy whats-my-ip --target-port=8080 --port=8080 --session-affinity=ClientIP

$ ipvsadm -Ln

IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -&amp;gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.254.0.1:443 rr persistent 10800
  -&amp;gt; 192.168.123.250:6443         Masq    1      0          0
TCP  10.254.226.105:8080 rr persistent 10800
  -&amp;gt; 172.20.135.8:8080            Masq    1      0          0
  -&amp;gt; 172.20.166.130:8080          Masq    1      0          0
  -&amp;gt; 172.20.104.9:8080            Masq    1      0          0
  
$ ipvsadm -S -n

-A -t 10.254.0.1:443 -s rr -p 10800
-a -t 10.254.0.1:443 -r 192.168.123.250:6443 -m -w 1
-A -t 10.254.226.105:8080 -s rr -p 10800
-a -t 10.254.226.105:8080 -r 172.20.135.8:8080 -m -w 1
-a -t 10.254.226.105:8080 -r 172.20.166.130:8080 -m -w 1
-a -t 10.254.226.105:8080 -r 172.20.104.9:8080 -m -w 1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ° lvs çš„è§„åˆ™æ¡ç›®é‡Œå¤šäº†ä¸ª &lt;code&gt;persistent&lt;/code&gt;ï¼Œå³ lvs çš„æŒä¹…è¿æ¥ï¼Œå…³äº lvs æŒä¹…è¿æ¥çš„å…·ä½“å†…å®¹å¯ä»¥å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡åšæ–‡ &lt;a href=&#34;https://www.yangcs.net/posts/lvs-persistent-connection/&#34; target=&#34;_blank&#34;&gt;LVSè´Ÿè½½å‡è¡¡ä¹‹æŒä¹…æ€§è¿æ¥ä»‹ç»&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;p&gt;å¯ä»¥é€šè¿‡è®¾ç½® &lt;code&gt;service.spec.sessionAffinityConfig.clientIP.timeoutSeconds&lt;/code&gt; çš„å€¼æ¥ä¿®æ”¹ lvs çš„ &lt;code&gt;persistence_timeout&lt;/code&gt; è¶…æ—¶æ—¶é—´ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;$ kubectl get svc whats-my-ip -o yaml

apiVersion: v1
kind: Service
metadata:
  creationTimestamp: 2018-04-20T08:16:38Z
  labels:
    run: whats-my-ip
  name: whats-my-ip
  namespace: default
  resourceVersion: &amp;quot;6323769&amp;quot;
  selfLink: /api/v1/namespaces/default/services/whats-my-ip
  uid: 26315fdf-4473-11e8-8388-005056a1bc83
spec:
  clusterIP: 10.254.226.105
  ports:
  - port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    run: whats-my-ip
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800
  type: ClusterIP
status:
  loadBalancer: {}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;nodeport&#34;&gt;NodePort&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ kubectl delete svc whats-my-ip
$ kubectl expose deploy whats-my-ip --target-port=8080 --port=8080 --type=NodePort

$ ipvsadm -Ln

IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -&amp;gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  192.168.123.249:34507 rr
  -&amp;gt; 172.20.135.8:8080            Masq    1      0          0
  -&amp;gt; 172.20.166.130:8080          Masq    1      0          0
  -&amp;gt; 172.20.104.9:8080            Masq    1      0          0
TCP  10.254.0.1:443 rr persistent 10800
  -&amp;gt; 192.168.123.250:6443         Masq    1      0          0
TCP  10.254.175.147:8080 rr
  -&amp;gt; 172.20.135.8:8080            Masq    1      0          0
  -&amp;gt; 172.20.166.130:8080          Masq    1      0          0
  -&amp;gt; 172.20.104.9:8080            Masq    1      0          0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ä¸ä»…æœ‰è™šæ‹ŸIPæ¡ç›®ï¼Œè¿˜å¤šäº†å¯¹åº”ä¸»æœºçš„ lvs æ¡ç›®ã€‚&lt;/p&gt;

&lt;h3 id=&#34;æ›´æ”¹ç®—æ³•&#34;&gt;æ›´æ”¹ç®—æ³•&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;æœ€å°‘è¿æ¥æ•°&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl annotate service my-service &amp;quot;kube-router.io/service.scheduler=lc&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;è½®è¯¢&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl annotate service my-service &amp;quot;kube-router.io/service.scheduler=rr&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;æºåœ°å€å“ˆå¸Œ&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl annotate service my-service &amp;quot;kube-router.io/service.scheduler=sh&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;ç›®çš„åœ°å€å“ˆå¸Œ&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl annotate service my-service &amp;quot;kube-router.io/service.scheduler=dh&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;p-id-h2-4-é—®é¢˜è§£å†³-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;4. é—®é¢˜è§£å†³&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;æ¥ä¸‹æ¥éœ€è¦é¢å¯¹ä¸€äº›éå¸¸æ£˜æ‰‹çš„é—®é¢˜ï¼Œæˆ‘å°½å¯èƒ½å°†é—®é¢˜æè¿°æ¸…æ¥šã€‚&lt;/p&gt;

&lt;p id=&#34;div-border-top-red&#34;&gt;
&lt;strong&gt;é—®é¢˜1ï¼š&lt;/strong&gt;åœ¨é›†ç¾¤å†…æŸä¸ªèŠ‚ç‚¹ä¸»æœºä¸Šé€šè¿‡ &lt;code&gt;SVC IP+Port&lt;/code&gt; è®¿é—®æŸä¸ªåº”ç”¨æ—¶ï¼Œå¦‚æœ lvs è½¬åˆ°åç«¯çš„ pod åœ¨æœ¬ä¸»æœºä¸Šï¼Œé‚£ä¹ˆå¯ä»¥è®¿é—®ï¼Œå¦‚æœè¯¥ pod ä¸åœ¨æœ¬ä¸»æœºä¸Šï¼Œé‚£ä¹ˆæ— æ³•è®¿é—®ã€‚
&lt;/p&gt;

&lt;p&gt;å¯ä»¥é€šè¿‡æŠ“åŒ…æ¥çœ‹ä¸€ä¸‹ï¼Œç°åœ¨ &lt;code&gt;service whats-my-ip&lt;/code&gt; åç«¯æœ‰ä¸‰ä¸ª podï¼Œåˆ†åˆ«è¿è¡Œåœ¨ &lt;code&gt;node1&lt;/code&gt;ã€&lt;code&gt;node2&lt;/code&gt; å’Œ &lt;code&gt;node3&lt;/code&gt; ä¸Šã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ kubectl get pods -owide

NAME                           READY     STATUS    RESTARTS   AGE       IP               NODE
whats-my-ip-845d4ff4f6-d2ptz   1/1       Running   0          23h       172.20.135.8     192.168.123.249
whats-my-ip-845d4ff4f6-jxzzn   1/1       Running   0          23h       172.20.166.130   192.168.123.250
whats-my-ip-845d4ff4f6-szhhd   1/1       Running   0          34s       172.20.104.9     192.168.123.248
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨ &lt;code&gt;node3&lt;/code&gt; ä¸Šè®¿é—® &lt;code&gt;whats-my-ip&lt;/code&gt; æœåŠ¡ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ ip a show|grep 10.254.175.147

    inet 10.254.175.147/32 brd 10.254.175.147 scope link kube-dummy-if

$ ipvsadm -Ln -t 10.254.175.147:8080

Prot LocalAddress:Port Scheduler Flags
  -&amp;gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.254.175.147:8080 rr
  -&amp;gt; 172.20.104.9:8080            Masq    1      0          0
  -&amp;gt; 172.20.135.8:8080            Masq    1      0          0
  -&amp;gt; 172.20.166.130:8080          Masq    1      0          0

# ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œä¸é€š
$ curl 10.254.175.147:8080

# ç¬¬äºŒæ¬¡è®¿é—®
$ curl 10.254.175.147:8080

HOSTNAME:whats-my-ip-845d4ff4f6-d2ptz IP:172.20.135.8

# ç¬¬ä¸‰æ¬¡è®¿é—®ï¼Œä¸é€š
$ curl 10.254.175.147:8080
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åŒæ—¶åœ¨ &lt;code&gt;node1&lt;/code&gt; ä¸ŠæŠ“åŒ…ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ tcpdump -i ens160 host 172.20.166.130 -nn

tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on ens160, link-type EN10MB (Ethernet), capture size 262144 bytes
03:27:26.337553 IP 10.254.175.147.42036 &amp;gt; 172.20.166.130.8080: Flags [S], seq 405854371, win 43690, options [mss 65495,sackOK,TS val 359417229 ecr 0,nop,wscale 7], length 0
03:27:27.340131 IP 10.254.175.147.42036 &amp;gt; 172.20.166.130.8080: Flags [S], seq 405854371, win 43690, options [mss 65495,sackOK,TS val 359418232 ecr 0,nop,wscale 7], length 0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ° &lt;code&gt;node1&lt;/code&gt; å°†æ•°æ®åŒ…ä¸¢å¼ƒäº†ï¼Œå› ä¸ºæºIPæ˜¯ &lt;code&gt;10.254.175.147&lt;/code&gt;ï¼Œç³»ç»Ÿè®¤ä¸ºè¿™æ˜¯ node1 è‡ªå·±æœ¬èº«ã€‚&lt;/p&gt;

&lt;p&gt;æ ¹æœ¬åŸå› å¯ä»¥æŸ¥çœ‹ &lt;code&gt;node3&lt;/code&gt; çš„è·¯ç”±è¡¨ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ ip route show table local|grep 10.254.175.147

local 10.254.175.147 dev kube-dummy-if proto kernel scope host src 10.254.175.147
broadcast 10.254.175.147 dev kube-dummy-if proto kernel scope link src 10.254.175.147
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;src&lt;/code&gt; çš„å€¼ç”¨æ¥å‘Šè¯‰è¯¥ host ä½¿ç”¨ &lt;code&gt;10.254.175.147&lt;/code&gt; ä½œä¸º &lt;code&gt;source address&lt;/code&gt;ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹è·¯ç”±è¡¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ ip route replace local 10.254.175.147 dev kube-dummy-if proto kernel scope host src 192.168.123.249 table local
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å†æ¬¡åœ¨ &lt;code&gt;node1&lt;/code&gt; ä¸ŠæŠ“åŒ…å¯ä»¥å‘ç°æºIPå·²ç»å˜æˆäº† &lt;code&gt;192.168.123.249&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ tcpdump -i ens160 host 172.20.166.130 -nn

tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on ens160, link-type EN10MB (Ethernet), capture size 262144 bytes
03:39:42.824412 IP 192.168.123.249.52684 &amp;gt; 172.20.166.130.8080: Flags [S], seq 3520353543, win 43690, options [mss 65495,sackOK,TS val 360153716 ecr 0,nop,wscale 7], length 0
03:39:42.824542 IP 172.20.166.130.8080 &amp;gt; 192.168.123.249.52684: Flags [S.], seq 4057001749, ack 3520353544, win 28960, options [mss 1460,sackOK,TS val 360143668 ecr 360153716,nop,wscale 7], length 0
03:39:42.824706 IP 192.168.123.249.52684 &amp;gt; 172.20.166.130.8080: Flags [.], ack 1, win 342, options [nop,nop,TS val 360153716 ecr 360143668], length 0
03:39:42.825066 IP 192.168.123.249.52684 &amp;gt; 172.20.166.130.8080: Flags [P.], seq 1:84, ack 1, win 342, options [nop,nop,TS val 360153716 ecr 360143668], length 83: HTTP: GET / HTTP/1.1
03:39:42.825112 IP 172.20.166.130.8080 &amp;gt; 192.168.123.249.52684: Flags [.], ack 84, win 227, options [nop,nop,TS val 360143669 ecr 360153716], length 0
03:39:42.825589 IP 172.20.166.130.8080 &amp;gt; 192.168.123.249.52684: Flags [P.], seq 1:174, ack 84, win 227, options [nop,nop,TS val 360143669 ecr 360153716], length 173: HTTP: HTTP/1.1 200 OK
03:39:42.825735 IP 192.168.123.249.52684 &amp;gt; 172.20.166.130.8080: Flags [.], ack 174, win 350, options [nop,nop,TS val 360153717 ecr 360143669], length 0
03:39:42.825787 IP 192.168.123.249.52684 &amp;gt; 172.20.166.130.8080: Flags [F.], seq 84, ack 174, win 350, options [nop,nop,TS val 360153717 ecr 360143669], length 0
03:39:42.825882 IP 172.20.166.130.8080 &amp;gt; 192.168.123.249.52684: Flags [F.], seq 174, ack 85, win 227, options [nop,nop,TS val 360143669 ecr 360153717], length 0
03:39:42.826002 IP 192.168.123.249.52684 &amp;gt; 172.20.166.130.8080: Flags [.], ack 175, win 350, options [nop,nop,TS val 360153718 ecr 360143669], length 0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br /&gt;
&lt;p id=&#34;div-border-top-red&#34;&gt;
&lt;strong&gt;é—®é¢˜2ï¼š&lt;/strong&gt;åœ¨é›†ç¾¤å†…æŸä¸ªèŠ‚ç‚¹ä¸»æœºä¸Šé€šè¿‡ &lt;code&gt;SVC IP+Port&lt;/code&gt; è®¿é—® &lt;code&gt;service kubernetes&lt;/code&gt; æ—¶ï¼Œå¦‚æœè¯¥èŠ‚ç‚¹æ˜¯ master èŠ‚ç‚¹ï¼ˆå³ kube-apiserver è¿è¡Œåœ¨è¯¥èŠ‚ç‚¹ä¸Šï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥è®¿é—®ï¼Œå¦‚æœè¯¥èŠ‚ç‚¹ä¸æ˜¯ master èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæ— æ³•è®¿é—®ã€‚
&lt;/p&gt;&lt;/p&gt;

&lt;p&gt;åŸå› å’Œé—®é¢˜1ç±»ä¼¼ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹è·¯ç”±è¡¨è§£å†³ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;# ä¾‹å¦‚åœ¨ node3 èŠ‚ç‚¹ä¸Š
$ ip route replace local 10.254.0.1 dev kube-dummy-if proto kernel scope host src 192.168.123.249 table local
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br /&gt;
&lt;p id=&#34;div-border-top-red&#34;&gt;
&lt;strong&gt;é—®é¢˜3ï¼š&lt;/strong&gt;åœ¨æŸä¸ª pod å†…è®¿é—®è¯¥ pod æœ¬èº«çš„ &lt;code&gt;ClusterIP:Port&lt;/code&gt;ï¼Œå¦‚æœ lvs è½¬åˆ°åç«¯çš„ IP æ˜¯è¯¥ pod çš„ IPï¼Œé‚£ä¹ˆæ— æ³•è®¿é—®ï¼Œå¦‚æœä¸æ˜¯åˆ™å¯ä»¥è®¿é—®ã€‚
&lt;/p&gt;&lt;/p&gt;

&lt;p&gt;&lt;code&gt;kube-proxy&lt;/code&gt; çš„ iptables æ¨¡å¼ä¹Ÿæœ‰åŒæ ·çš„é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥å¿½ç•¥ã€‚&lt;/p&gt;

&lt;h3 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h3&gt;

&lt;p&gt;é—®é¢˜1å’Œé—®é¢˜2ä¿®æ”¹è·¯ç”±è¡¨å¯ä»¥é€šè¿‡æ‰¹é‡ shell è„šæœ¬æ¥è§£å†³ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;#!/bin/sh

default_if=$(ip route|grep default|awk &#39;{print $5}&#39;)
localip=$(ip a show ${default_if}|egrep -v inet6|grep inet|awk &#39;{print $2}&#39;|awk -F&amp;quot;/&amp;quot; &#39;{print $1}&#39;)
svc_ip=$(ip route show table local|egrep -v broadcast|grep kube-dummy-if|awk &#39;{print $2}&#39;)

for ip in $svc_ip; do
ip route replace local $ip dev kube-dummy-if proto kernel scope host src $localip table local;
done
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¦‚æœæƒ³è¦åœ¨åˆ›å»º &lt;code&gt;service&lt;/code&gt; æ—¶è‡ªåŠ¨ä¿®æ”¹è·¯ç”±è¡¨ï¼Œæœ€å¥½è¿˜æ˜¯å°†è¯¥ fix æ•´åˆè¿› kube-router çš„æºç ä¸­ã€‚&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-5-å‚è€ƒ-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;5. å‚è€ƒ&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/cloudnativelabs/kube-router/blob/master/docs/README.md&#34; target=&#34;_blank&#34;&gt;Kube-router Documentation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.jianshu.com/p/d69b40580c87&#34; target=&#34;_blank&#34;&gt;kube-routerä¹‹è´Ÿè½½å‡è¡¡å™¨&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/cloudnativelabs/kube-router/issues/376&#34; target=&#34;_blank&#34;&gt;bad routing from host to service IP on same host&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;style&gt;
#h2{
    margin-bottom:2em;
    margin-right: 5px;
    padding: 8px 15px;
    letter-spacing: 2px;
    background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181));
    background-color: rgb(63, 81, 181);
    color: rgb(255, 255, 255);
    border-left: 10px solid rgb(51, 51, 51);
    border-radius:5px;
    text-shadow: rgb(102, 102, 102) 1px 1px 1px;
    box-shadow: rgb(102, 102, 102) 1px 1px 2px;
}
#note {
    font-size: 1.5rem;
    font-style: italic;
    padding: 0 1rem;
    margin: 2.5rem 0;
    position: relative;
    background-color: #fafeff;
    border-top: 1px dotted #9954bb;
    border-bottom: 1px dotted #9954bb;
}
#note-title {
    padding: 0.2rem 0.5rem;
    background: #9954bb;
    color: #FFF;
    position: absolute;
    left: 0;
    top: 0.25rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    border-radius: 4px;
    -webkit-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    -moz-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    -ms-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    -o-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    transform: rotate(-5deg) translateX(-10px) translateY(-25px);
}
#inline-yellow {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #f0ad4e;
}
#inline-green {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #5cb85c;
}
#inline-blue {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #2780e3;
}
#inline-purple {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #9954bb;
}
#div-border-left-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #df3e3e;
}
#div-border-left-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #f0ad4e;
}
#div-border-left-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #5cb85c;
}
#div-border-left-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #2780e3;
}
#div-border-left-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #9954bb;
}
#div-border-right-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #df3e3e;
}
#div-border-right-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #f0ad4e;
}
#div-border-right-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #5cb85c;
}
#div-border-right-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #2780e3;
}
#div-border-right-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #9954bb;
}
#div-border-top-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #df3e3e;
}
#div-border-top-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #f0ad4e;
}
#div-border-top-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #5cb85c;
}
#div-border-top-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #2780e3;
}
#div-border-top-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #9954bb;
}
&lt;/style&gt;</description>
    </item>
    
    <item>
      <title>LVSè´Ÿè½½å‡è¡¡ä¹‹æŒä¹…æ€§è¿æ¥ä»‹ç»</title>
      <link>https://www.yangcs.net/posts/lvs-persistent-connection/</link>
      <pubDate>Wed, 18 Apr 2018 11:18:06 +0000</pubDate>
      
      <guid>https://www.yangcs.net/posts/lvs-persistent-connection/</guid>
      <description>&lt;p&gt;&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-1-å‰è¨€-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;1. å‰è¨€&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¾€å¾€éœ€è¦æ ¹æ®ä¸šåŠ¡åº”ç”¨åœºæ™¯æ¥è®¾ç½® &lt;code&gt;lvs&lt;/code&gt; çš„ä¼šè¯è¶…æ—¶æ—¶é—´ä»¥åŠé˜² &lt;code&gt;session&lt;/code&gt; è¿æ¥ä¸¢å¤±çš„é—®é¢˜æï¼Œå¦‚åœ¨ä¸šåŠ¡æ”¯ä»˜ç¯èŠ‚ï¼Œå¦‚è‹¥ &lt;code&gt;session&lt;/code&gt; ä¸¢å¤±ä¼šå¯¼è‡´é‡å¤æ‰£æ¬¾é—®é¢˜ï¼Œä¸¥é‡å½±å“åˆ°å®‰å…¨æ€§ï¼Œæœ¬å°èŠ‚è§£å°†ä¼šè®²åˆ°å…³äº &lt;code&gt;lvs&lt;/code&gt; æŒä¹…æ€§è¿æ¥é—®é¢˜ã€‚&lt;/p&gt;

&lt;h3 id=&#34;ä¸ºä»€ä¹ˆç”¨åˆ°æŒä¹…è¿æ¥&#34;&gt;ä¸ºä»€ä¹ˆç”¨åˆ°æŒä¹…è¿æ¥ï¼Ÿ&lt;/h3&gt;

&lt;p&gt;åœ¨ Web æœåŠ¡é€šä¿¡ä¸­ï¼Œå½“ç”¨æˆ·åœ¨ä¸€ä¸ªç½‘ç«™æµè§ˆäº†Aç½‘é¡µå¹¶è·³è½¬åˆ°Bç½‘é¡µï¼Œæ­¤æ—¶æœåŠ¡å™¨å°±è®¤ä¸ºBç½‘é¡µæ˜¯ä¸€ä¸ªæ–°çš„ç”¨æˆ·è¯·æ±‚ï¼Œä½ ä¹‹å‰çš„ç™»é™†çš„ä¿¡æ¯å°±éƒ½ä¸¢å¤±äº†ã€‚&lt;/p&gt;

&lt;p&gt;ä¸ºäº†è®°å½•ç”¨æˆ·çš„ä¼šè¯ä¿¡æ¯ï¼Œæˆ‘ä»¬çš„å¼€å‘è€…å°±åœ¨å®¢æˆ·ç«¯/æœåŠ¡å™¨ç«¯è½¯ä»¶æä¾›äº† &lt;code&gt;cookie/session&lt;/code&gt; æœºåˆ¶ï¼Œå½“ä½ è®¿é—®ç½‘ç«™æ—¶ï¼ŒæœåŠ¡å™¨ç«¯å»ºç«‹ä¸€ä¸ª session ä¼šè¯åŒºï¼Œå¹¶å»ºç«‹ä¸€ä¸ª cookie ä¸è¿™ä¸ª session ç»‘å®šï¼Œå°†ä¿¡æ¯å‘é€ç»™ä½ çš„æµè§ˆå™¨ã€‚&lt;/p&gt;

&lt;p&gt;è¿™æ ·ï¼Œåªè¦ä½ çš„ cookie å­˜åœ¨ï¼ŒæœåŠ¡å™¨ç«¯çš„ session å­˜åœ¨ï¼Œé‚£ä¹ˆå½“ä½ æ‰“å¼€æ–°é¡µé¢çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨ä¾ç„¶ä¼šè®¤è¯†ä½ ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;åœ¨åšäº†è´Ÿè½½å‡è¡¡çš„æ—¶å€™ï¼Œä¸Šé¢çš„æœºåˆ¶å°±å‡ºç°äº†é—®é¢˜ã€‚å‡è®¾æœ‰ä»¥ä¸‹åœºæ™¯ï¼š&lt;/strong&gt;&lt;/p&gt;

&lt;p id=&#34;div-border-top-red&#34;&gt;æŸç”µå•†ç½‘ç«™ä¸ºäº†å®ç°æ›´å¤šç”¨æˆ·çš„è®¿é—®ï¼Œæä¾›äº†Aã€Bä¸¤å°æœåŠ¡å™¨ï¼Œå¹¶åœ¨å‰é¢åšäº† LVS è´Ÿè½½å‡è¡¡ã€‚äºæ˜¯æŸç”¨æˆ·æ‰“å¼€äº†è¯¥è´­ç‰©ç½‘ç«™ï¼Œé€‰ä¸­äº†ä¸€ä»¶è¡£æœï¼Œå¹¶åŠ å…¥äº†è´­ç‰©è½¦(æ­¤æ—¶èƒŒåçš„æ“ä½œæ˜¯ï¼šLVS è´Ÿè½½å‡è¡¡å™¨æ¥å—äº†ç”¨æˆ·è¯·æ±‚ï¼Œå¹¶å°†å…¶åˆ†å‘åˆ°äº†é€‰ä¸­çš„æœåŠ¡å™¨ï¼Œå¹¶å°†ç”¨æˆ·æ·»åŠ äº†ä¸€ä»¶è¡£æœè®°å½•åˆ°è¿™ä¸ªä¼šè¯çš„ session ä¸­)ã€‚è¿™æ—¶å½“ç”¨æˆ·æ‰“å¼€äº†ç¬¬äºŒä¸ªç½‘é¡µï¼Œåˆé€‰ä¸­äº†ä¸€ä»¶å¸½å­å¹¶åŠ å…¥è´­ç‰©è½¦(æ­¤æ—¶èƒŒåçš„æ“ä½œæ˜¯ï¼šLVS è´Ÿè½½å‡è¡¡å™¨æ¥å—äº†ç”¨æˆ·è¯·æ±‚ï¼Œè¿›è¡Œè®¡ç®—ï¼Œå°†å…¶å‘é€åˆ°é€‰ä¸­çš„æœåŠ¡å™¨ä¸Šï¼Œè¯¥æœåŠ¡å™¨å°†ç”¨æˆ·æ·»åŠ äº†ä¸€ä»¶å¸½å­è®°å½•åˆ° session ä¸­)ã€‚&lt;br /&gt;&lt;br /&gt;ç”±äº LVS æ˜¯ä¸€ä¸ªå››å±‚è´Ÿè½½å‡è¡¡å™¨ï¼Œä»…èƒ½æ ¹æ® &lt;code&gt;IP:Port&lt;/code&gt; å¯¹æ•°æ®æŠ¥æ–‡è¿›è¡Œåˆ†å‘ï¼Œä¸èƒ½ç¡®ä¿å°†åŒä¸€ç”¨æˆ·æ ¹æ® session å‘å¾€åŒä¸€ä¸ªæœåŠ¡å™¨ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·ç¬¬ä¸€æ¬¡è¢«åˆ†é…åˆ°äº†AæœåŠ¡å™¨ï¼Œè€Œç¬¬äºŒæ¬¡å¯èƒ½åˆ†é…åˆ°äº†BæœåŠ¡å™¨ï¼Œä½†æ˜¯BæœåŠ¡å™¨å¹¶æ²¡æœ‰AæœåŠ¡å™¨ç”¨æˆ·çš„ session è®°å½•ï¼Œç›´æ¥å¯¼è‡´è¿™ä¸ªä¾‹å­é‡Œçš„ç”¨æˆ·å‘ç°è‡ªå·±çš„è´­ç‰©è½¦æ²¡æœ‰äº†ä¹‹å‰çš„è¡£æœï¼Œè€Œä»…æœ‰å¸½å­ã€‚è¿™æ˜¯ä¸å¯æ¥å—çš„ã€‚&lt;/p&gt;

&lt;p&gt;ä¸ºäº†é¿å…ä¸Šé¢çš„é—®é¢˜ï¼Œä¸€èˆ¬ç«™ç‚¹ä¼šæœ‰ä¸¤ç§æ–¹æ³•è§£å†³è¯¥é—®é¢˜ï¼š&lt;/p&gt;

&lt;p&gt;&lt;font color=&#34;#2780e3&#34;&gt;
1. å°†æ¥è‡ªäºåŒä¸€ä¸ªç”¨æˆ·çš„è¯·æ±‚å‘å¾€åŒä¸€ä¸ªæœåŠ¡å™¨&lt;br /&gt;
2. å°† session ä¿¡æ¯åœ¨æœåŠ¡å™¨é›†ç¾¤å†…å…±äº«ï¼Œæ¯ä¸ªæœåŠ¡å™¨éƒ½ä¿å­˜æ•´ä¸ªé›†ç¾¤çš„ session ä¿¡æ¯&lt;br /&gt;
3. å»ºç«‹ä¸€ä¸ª session å­˜å‚¨æ± ï¼Œæ‰€æœ‰ session ä¿¡æ¯éƒ½ä¿å­˜åˆ°å­˜å‚¨æ± ä¸­
&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;
å½“ç„¶é€šè¿‡ session å…±äº«è§£å†³æ˜¯æ¯”è¾ƒå®Œç¾çš„ï¼Œä½†å®ç°èµ·æ¥ç›¸å¯¹å¤æ‚ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ä¸€éœ€è¦é¢å¤–å¢åŠ æœåŠ¡å™¨è®¾å¤‡&lt;/li&gt;
&lt;li&gt;äºŒéœ€è¦ä»£ç æ”¹åŠ¨ï¼Œåœ¨ç”¨æˆ·æ“ä½œå‰ï¼Œéœ€è¦å…ˆè·å–è¯¥ç”¨æˆ·çš„sessionä¿¡æ¯&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æ€»ç»“ä¸‹æ¥ï¼Œç¬¬ä¸€ç§æ–¹æ³•æ˜¯æœ€ç®€å•çš„ã€‚&lt;/p&gt;

&lt;h3 id=&#34;hashç®—æ³•ä¸æŒä¹…è¿æ¥&#34;&gt;hashç®—æ³•ä¸æŒä¹…è¿æ¥&lt;/h3&gt;

&lt;p&gt;LVS çš„å…«ç§è½®è¯¢ç®—æ³•ä¸­æœ‰ï¼ˆSource Hashingï¼‰æºåœ°å€ hashï¼Œå®ƒå’ŒæŒä¹…è¿æ¥çš„ä½œç”¨éƒ½æ˜¯&lt;font color=&#34;#df3e3e&#34;&gt;å°†æ¥è‡ªåŒä¸€ä¸ªIPçš„è¯·æ±‚éƒ½è½¬å‘åˆ°åŒä¸€ä¸ª Server&lt;/font&gt;ï¼Œä»è€Œä¿è¯äº† session ä¼šè¯å®šä½çš„é—®é¢˜ã€‚ä¸¤è€…çš„ä¸åŒæ˜¯ï¼š&lt;/p&gt;

&lt;h4 id=&#34;source-hashing-ç®—æ³•&#34;&gt;Source Hashing ç®—æ³•&lt;/h4&gt;

&lt;p&gt;è¯¥ç®—æ³•åœ¨å†…æ ¸ä¸­ä¼šè‡ªåŠ¨ç»´æŠ¤ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œæ­¤å“ˆå¸Œè¡¨ä¸­ç”¨æ¯ä¸€ä¸ªè¯·æ±‚çš„æºIPåœ°å€ç»è¿‡å“ˆå¸Œè®¡ç®—å¾—å‡ºçš„å€¼ä½œä¸ºé”®ï¼ŒæŠŠè¯·æ±‚æ‰€åˆ°è¾¾çš„ RS çš„åœ°å€ä½œä¸ºå€¼ã€‚&lt;/p&gt;

&lt;p&gt;åœ¨åé¢çš„è¯·æ±‚ä¸­ï¼Œæ¯ä¸€ä¸ªè¯·æ±‚ä¼šå…ˆç»è¿‡æ­¤å“ˆå¸Œè¡¨ï¼Œå¦‚æœè¯·æ±‚åœ¨æ­¤å“ˆå¸Œè¡¨ä¸­æœ‰é”®å€¼ï¼Œé‚£ä¹ˆç›´æ¥å®šå‘è‡³ç‰¹å®š RSï¼Œå¦‚æ²¡æœ‰ï¼Œåˆ™ä¼šæ–°ç”Ÿæˆä¸€ä¸ªé”®å€¼ï¼Œä»¥ä¾¿åç»­è¯·æ±‚çš„å®šå‘ã€‚&lt;/p&gt;

&lt;p&gt;ä½†æ˜¯æ­¤ç§æ–¹æ³•åœ¨æ—¶é—´çš„è®°å½•ä¸Šæ¯”è¾ƒæ¨¡ç³Šï¼ˆä¾æ®TCPçš„è¿æ¥æ—¶é•¿è®¡ç®—ï¼‰ã€‚è€Œä¸”é€šè¿‡ hash ç®—æ³•æ— æ³•å…¬å¹³å‡æ‹…åç«¯ real server çš„è¯·æ±‚ï¼Œå³ä¸èƒ½ä¸ rr ç­‰ç®—æ³•åŒæ—¶ä½¿ç”¨ã€‚&lt;/p&gt;

&lt;h4 id=&#34;æŒä¹…è¿æ¥&#34;&gt;æŒä¹…è¿æ¥&lt;/h4&gt;

&lt;p&gt;æ­¤ç§æ–¹æ³•å®ç°äº†æ— è®ºä½¿ç”¨å“ªä¸€ç§è°ƒåº¦æ–¹æ³•ï¼ŒæŒä¹…è¿æ¥åŠŸèƒ½éƒ½èƒ½ä¿è¯åœ¨æŒ‡å®šæ—¶é—´èŒƒå›´ä¹‹å†…ï¼Œæ¥è‡ªäºåŒä¸€ä¸ªIPçš„è¯·æ±‚å°†å§‹ç»ˆè¢«å®šå‘è‡³åŒä¸€ä¸ª RSï¼Œè¿˜å¯ä»¥æŠŠå¤šç§æœåŠ¡ç»‘å®šåç»Ÿä¸€è¿›è¡Œè°ƒåº¦ã€‚&lt;/p&gt;

&lt;p&gt;åœ¨ director å†…æœ‰ä¸€ä¸ª LVS æŒä¹…è¿æ¥æ¨¡æ¿ï¼Œæ¨¡æ¿ä¸­è®°å½•äº†æ¯ä¸€ä¸ªè¯·æ±‚çš„æ¥æºã€è°ƒåº¦è‡³çš„ RSã€ç»´æŠ¤æ—¶é•¿ç­‰ç­‰ï¼Œæ‰€ä»¥ï¼Œåœ¨æ–°çš„è¯·æ±‚è¿›å…¥æ—¶ï¼Œé¦–å…ˆåœ¨æ­¤æ¨¡æ¿ä¸­æ£€æŸ¥æ˜¯å¦æœ‰è®°å½•ï¼ˆæœ‰å†…ç½®çš„æ—¶é—´é™åˆ¶ï¼Œæ¯”å¦‚é™åˆ¶æ˜¯300ç§’ï¼Œå½“åœ¨åˆ°è¾¾300ç§’æ—¶ä¾ç„¶æœ‰ç”¨æˆ·è®¿é—®ï¼Œé‚£ä¹ˆæŒä¹…è¿æ¥æ¨¡æ¿å°±ä¼šå°†æ—¶é—´å¢åŠ ä¸¤åˆ†é’Ÿï¼Œå†è®¡æ•°ï¼Œä¾æ¬¡ç±»æ¨ï¼Œæ¯æ¬¡åªå»¶é•¿2åˆ†é’Ÿï¼‰ï¼Œå¦‚æœè¯¥è®°å½•æœªè¶…æ—¶ï¼Œåˆ™ä½¿ç”¨è¯¥è®°å½•æ‰€æŒ‡å‘çš„ RSï¼Œå¦‚æœæ˜¯è¶…æ—¶è®°å½•æˆ–è€…æ˜¯æ–°è¯·æ±‚ï¼Œåˆ™ä¼šæ ¹æ®è°ƒåº¦ç®—æ³•å…ˆè°ƒåº¦è‡³ç‰¹å®š RSï¼Œå†å°†è°ƒåº¦çš„è®°å½•æ·»åŠ è‡³æ­¤è¡¨ä¸­ã€‚&lt;/p&gt;

&lt;p&gt;è¿™å¹¶ä¸ä¸ SH ç®—æ³•å†²çªï¼Œlvs æŒä¹…è¿æ¥ä¼šåœ¨æ–°è¯·æ±‚è¾¾åˆ°æ—¶ï¼Œæ£€æŸ¥åç«¯ RS çš„è´Ÿè½½çŠ¶å†µï¼Œè¿™å°±æ˜¯æ¯”è¾ƒç²¾ç»†çš„è°ƒåº¦å’Œä¼šè¯ä¿æŒæ–¹æ³•ã€‚&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-2-lvs-çš„æŒä¹…æ€§è¿æ¥æœ‰ä¸¤æ–¹é¢-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;2. lvs çš„æŒä¹…æ€§è¿æ¥æœ‰ä¸¤æ–¹é¢&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;strong&gt;1ã€æŠŠåŒä¸€ä¸ª &lt;code&gt;client&lt;/code&gt; çš„è¯·æ±‚ä¿¡æ¯è®°å½•åˆ° lvs çš„ &lt;code&gt;hash&lt;/code&gt; è¡¨é‡Œï¼Œä¿å­˜æ—¶é—´ä½¿ç”¨ &lt;code&gt;persistence_timeout&lt;/code&gt; æ§åˆ¶ï¼Œå•ä½ä¸ºç§’ã€‚&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;code&gt;persistence_granularity&lt;/code&gt; å‚æ•°æ˜¯é…åˆ &lt;code&gt;persistence_timeout&lt;/code&gt; çš„ï¼Œåœ¨æŸäº›æƒ…å†µç‰¹åˆ«æœ‰ç”¨ã€‚ä»–çš„å€¼æ˜¯å­ç½‘æ©ç ï¼Œè¡¨ç¤ºæŒä¹…è¿æ¥çš„ç²’åº¦ï¼Œé»˜è®¤æ˜¯ &lt;code&gt;255.255.255.255&lt;/code&gt;ï¼Œä¹Ÿå°±æ˜¯å•ç‹¬çš„ client ipï¼Œå¦‚æœæ”¹æˆ &lt;code&gt;255.255.255.0&lt;/code&gt;ï¼Œå’Œ client ip åœ¨åŒä¸€ä¸ªç½‘æ®µçš„éƒ½ä¼šè¢«åˆ†é…åˆ°åŒä¸€ä¸ª &lt;code&gt;real server&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;2ã€ä¸€ä¸ªè¿æ¥åˆ›å»ºåç©ºé—²æ—¶çš„è¶…æ—¶æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´ä¸º3ç§ã€‚&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;tcp:&lt;/strong&gt; tcpçš„ç©ºé—²è¶…æ—¶æ—¶é—´&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;tcpfin:&lt;/strong&gt; lvsæ”¶åˆ°å®¢æˆ·ç«¯tcp finçš„è¶…æ—¶æ—¶é—´&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;udp:&lt;/strong&gt; udpçš„è¶…æ—¶æ—¶é—´&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;p-id-h2-3-lvs-ç›¸å…³è¶…æ—¶æ—¶é—´æŸ¥çœ‹-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;3. lvs ç›¸å…³è¶…æ—¶æ—¶é—´æŸ¥çœ‹&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;é€šè¿‡ &lt;code&gt;ipvsadm -Ln&lt;/code&gt; å¯ä»¥æŸ¥çœ‹ persistence_timeout è¶…æ—¶æ—¶é—´(é»˜è®¤è¶…æ—¶æ—¶é—´ 360s)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ipvsadm -Ln

IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -&amp;gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.254.66.97:8080 rr persistent 10800
  -&amp;gt; 172.20.104.7:8080            Masq    1      0          0
  -&amp;gt; 172.20.135.6:8080            Masq    1      0          0
  -&amp;gt; 172.20.135.7:8080            Masq    1      0          0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é€šè¿‡ &lt;code&gt;ipvsadm -Ln --timeout&lt;/code&gt; å¯ä»¥æŸ¥çœ‹ &lt;code&gt;tcp tcpfin udp&lt;/code&gt; çš„è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤: 900 120 300)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ipvsadm -Ln --timeout

Timeout (tcp tcpfin udp): 900 120 300
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;p-id-h2-4-lvs-å¦‚ä½•æ§åˆ¶è¿™äº›è¶…æ—¶æ—¶é—´å·¥ä½œ-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;4. lvs å¦‚ä½•æ§åˆ¶è¿™äº›è¶…æ—¶æ—¶é—´å·¥ä½œ&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ipvsadm -Lnc

IPVS connection entries
pro expire state       source             virtual            destination
TCP 01:54  TIME_WAIT   192.168.123.248:35672 10.254.66.97:8080  172.20.135.6:8080
TCP 180:03 NONE        192.168.123.248:0  10.254.66.97:8080  172.20.135.6:8080
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;å½“ä¸€ä¸ª client è®¿é—® vip çš„æ—¶å€™ï¼Œè¿™æ—¶ ipvs å°±ä¼šè®°å½•ä¸€æ¡çŠ¶æ€ä¸º &lt;code&gt;NONE&lt;/code&gt; çš„ä¿¡æ¯ï¼Œå¦‚è¿°ä¸Šæ‰€ç¤ºï¼Œ&lt;code&gt;expire&lt;/code&gt; åˆå§‹å€¼ä¸º &lt;code&gt;persistence_timeout&lt;/code&gt; çš„å€¼ï¼Œç„¶åæ ¹æ®æ—¶é’Ÿä¸»é”®å˜å°ï¼Œåœ¨ä»¥ä¸‹è®°å½•å­˜åœ¨æœŸé—´ï¼ŒåŒä¸€ client ip è¿æ¥ä¸Šæ¥ï¼Œéƒ½ä¼šè¢«åˆ†é…åˆ°åŒä¸€ä¸ªåç«¯ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;code&gt;TIME_WAIT&lt;/code&gt; çš„å€¼å°±æ˜¯ tcp tcpfin udp ä¸­çš„ &lt;code&gt;tcpfin&lt;/code&gt; çš„è¶…æ—¶æ—¶é—´ï¼Œå½“ &lt;code&gt;NONE&lt;/code&gt; çš„å€¼ä¸º0æ—¶ï¼Œå¦‚æœ TIME_WAIT è¿˜å­˜åœ¨ï¼Œé‚£ä¹ˆ NONE çš„å€¼ä¼šä»æ–°å˜æˆ &lt;code&gt;persistence_timeout&lt;/code&gt; çš„å€¼ï¼Œå†å‡å°‘ï¼Œç›´åˆ° TIME_WAIT æ¶ˆå¤±ä»¥åï¼ŒNONE æ‰ä¼šæ¶ˆå¤±ï¼Œåªè¦ NONE å­˜åœ¨ï¼ŒåŒä¸€ client çš„è®¿é—®ï¼Œéƒ½ä¼šåˆ†é…åˆ°ç»Ÿä¸€ real serverã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;p-id-h2-5-lvs-å…³äºç›¸å…³è¶…æ—¶æ—¶é—´çš„è®¾ç½®-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;5. lvs å…³äºç›¸å…³è¶…æ—¶æ—¶é—´çš„è®¾ç½®&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;code&gt;persistence_timeout&lt;/code&gt; å¯ä»¥é€šè¿‡ &lt;code&gt;ipvsadm -p timeout&lt;/code&gt; æ¥è®¾ç½®ï¼Œé»˜è®¤ 360 ç§’ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ipvsadm -A -t 192.168.20.154:80 -s rr -p 60
&lt;/code&gt;&lt;/pre&gt;

&lt;p id=&#34;div-border-top-purple&#34;&gt;ä¸Šé¢å‘½ä»¤ä¸­çº¢è‰²æ ‡è®°çš„ 80 ç«¯å£ï¼Œè¡¨ç¤ºå¦‚æœæ˜¯åŒä¸€å®¢æˆ·ç«¯è®¿é—®æœåŠ¡å™¨çš„ 80 ç«¯å£ï¼Œä¼šè¢«å®šä¹‰åˆ°åŒä¸€ä¸ª real serverï¼Œå¦‚æœæŠŠ 80 ç«¯å£æ”¹ä¸º &lt;code&gt;0&lt;/code&gt;ï¼Œé‚£ä¹ˆåŒä¸€å®¢æˆ·ç«¯è®¿é—®æœåŠ¡å™¨çš„ä»»ä½•æœåŠ¡éƒ½ä¼šè¢«è½¬å‘åˆ°åŒä¸€ä¸ª real serverã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;tcp tcpfin udp&lt;/code&gt; å¯ä»¥é€šè¿‡ &lt;code&gt;ipvsadm --set å¯¹åº”è¶…æ—¶æ—¶é—´&lt;/code&gt; æ¥è®¾ç½®ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ipvsadm --set tcp tcpfin udp
&lt;/code&gt;&lt;/pre&gt;

&lt;div id=&#34;note&#34;&gt;
&lt;p id=&#34;note-title&#34;&gt;Note&lt;/p&gt;
&lt;br /&gt;
&lt;p&gt;&lt;code&gt;tcpfin&lt;/code&gt; çš„å€¼æœ€å¥½å°äº &lt;code&gt;persistence_timeout&lt;/code&gt; çš„å€¼ï¼Œè¿™æ ·æ¯”è¾ƒæ–¹ä¾¿è®¡ç®—ï¼Œä¹Ÿæœ‰åˆ©äº &lt;code&gt;tcpfin&lt;/code&gt; å›æ”¶&lt;/p&gt;
&lt;/div&gt;

&lt;h2 id=&#34;p-id-h2-6-æŒä¹…è¿æ¥å®šä¹‰ä¸åŸç†-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;6. æŒä¹…è¿æ¥å®šä¹‰ä¸åŸç†&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;h3 id=&#34;å®šä¹‰&#34;&gt;å®šä¹‰&lt;/h3&gt;

&lt;blockquote&gt;
&lt;p&gt;æŒä¹…è¿æ¥æ˜¯æŒ‡æ— è®ºä½¿ç”¨ä»€ä¹ˆç®—æ³•ï¼ŒLVS æŒä¹…éƒ½èƒ½å®ç°åœ¨ä¸€å®šæ—¶é—´å†…ï¼Œå°†æ¥è‡ªåŒä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚æ´¾å‘è‡³æ­¤å‰é€‰å®šçš„ &lt;code&gt;RS&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&#34;åŸç†&#34;&gt;åŸç†&lt;/h3&gt;

&lt;p&gt;å½“ä½¿ç”¨ LVS æŒä¹…æ€§çš„æ—¶å€™ï¼ŒDirector åœ¨å†…éƒ¨ä½¿ç”¨ä¸€ä¸ªè¿æ¥æ ¹æ®è®°å½•ç§°ä¹‹ä¸º &lt;code&gt;æŒä¹…è¿æ¥æ¨¡æ¿&lt;/code&gt; æ¥ç¡®ä¿æ‰€æœ‰æ¥è‡ªåŒä¸€ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚è¢«åˆ†å‘åˆ°åŒä¸€å° &lt;code&gt;Real Server&lt;/code&gt; ä¸Šã€‚&lt;/p&gt;

&lt;div id=&#34;note&#34;&gt;
&lt;p id=&#34;note-title&#34;&gt;Note&lt;/p&gt;
&lt;br /&gt;
&lt;p&gt;æŒä¹…è¿æ¥æ¨¡æ¿æ˜¯æŒ‡æ¯ä¸€ä¸ªå®¢æˆ·ç«¯åŠåˆ†é…ç»™å®ƒçš„ &lt;code&gt;RS&lt;/code&gt; çš„æ˜ å°„å…³ç³»ã€‚&lt;/p&gt;
&lt;/div&gt;

&lt;h3 id=&#34;æŒä¹…è¿æ¥åˆ†ç±»&#34;&gt;æŒä¹…è¿æ¥åˆ†ç±»&lt;/h3&gt;

&lt;p&gt;&lt;strong&gt;1ã€ &lt;font color=&#34;red&#34;&gt;æŒä¹…ç«¯å£è¿æ¥ï¼Œ&lt;/font&gt;ç®€ç§° PPCï¼ˆPersistent Port Connectionsï¼‰&lt;/strong&gt;ï¼šå°†æ¥è‡ªäºåŒä¸€ä¸ªå®¢æˆ·ç«¯å¯¹åŒä¸€ä¸ªé›†ç¾¤æŸä¸ªæœåŠ¡çš„è¯·æ±‚ï¼Œå§‹ç»ˆå®šå‘è‡³æ­¤å‰é€‰å®šçš„ &lt;code&gt;RS&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;ä¾‹å¦‚ï¼š&lt;/strong&gt;&lt;code&gt;client----&amp;gt;LVS(80)----&amp;gt;RS1 æˆ– client----&amp;gt;LVS(23)----&amp;gt;RS2&lt;/code&gt;&lt;br /&gt;
&lt;strong&gt;ç¼ºé™·ï¼š&lt;/strong&gt;æœŸæœ›è®¿é—®ä¸åŒçš„ç«¯å£åˆ°åŒä¸€å° &lt;code&gt;RS&lt;/code&gt; ä¸Šï¼Œæ— æ³•å®ç°ã€‚&lt;/p&gt;

&lt;p&gt;é…ç½®ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ipvsadm -A -t 172.16.100.1:80 -s rr -p 3600
$ ipvsadm -a -t 172.16.100.1:80 -r 172.16.100.10 -g -w 2
$ ipvsadm -a -t 172.16.100.1:80 -r 172.16.100.11 -g -w 2
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;2ã€&lt;font color=&#34;red&#34;&gt;æŒä¹…å®¢æˆ·ç«¯è¿æ¥ï¼Œ&lt;/font&gt;ç®€ç§° PCCï¼ˆPersistent Client Connectionsï¼‰ï¼š&lt;/strong&gt;å°†æ¥è‡ªäºåŒä¸€ä¸ªå®¢æˆ·ç«¯å¯¹æ‰€æœ‰ç«¯å£çš„è¯·æ±‚ï¼Œå§‹ç»ˆå®šå‘è‡³æ­¤å‰é€‰å®šçš„ &lt;code&gt;RS&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;è¯´æ˜ï¼š&lt;/strong&gt;&lt;code&gt;PCC&lt;/code&gt; æ˜¯ä¸€ä¸ªè™šæ‹ŸæœåŠ¡æ²¡æœ‰ç«¯å£å·ï¼ˆæˆ–è€…ç«¯å£å·ä¸º 0ï¼‰ï¼Œä»¥ &lt;code&gt;-p&lt;/code&gt; æ¥æ ‡è¯†æœåŠ¡ã€‚&lt;br /&gt;
&lt;strong&gt;ç¼ºé™·ï¼š&lt;/strong&gt;å®šå‘æ‰€æœ‰æœåŠ¡ï¼ŒæœŸæœ›è®¿é—®ä¸åŒçš„ Real Server æ— æ³•å®ç°ã€‚&lt;/p&gt;

&lt;p&gt;é…ç½®ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ipvsadm -A -t 172.16.100.1:0 -s rr -p 3600
$ ipvsadm -a -t 172.16.100.1:0 -r 172.16.100.10 -g -w 2
$ ipvsadm -a -t 172.16.100.1:0 -r 172.16.100.11 -g -w 2
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;3ã€&lt;font color=&#34;red&#34;&gt;åŸºäºé˜²ç«å¢™è®¾ç½®ç«¯å£ç»‘å®šçš„æŒä¹…è¿æ¥ï¼Œ&lt;/font&gt;ç®€ç§° PNMPPï¼ˆPersistent Netfilter Marked Packet Persistenceï¼‰ï¼š&lt;/strong&gt;ä¾‹å¦‚åå° real server åŒæ—¶æä¾› &lt;code&gt;80&lt;/code&gt; å’Œ &lt;code&gt;443&lt;/code&gt; ç«¯å£çš„æœåŠ¡ï¼Œå¹¶ä¸”ä¸¤ä¸ªæœåŠ¡ä¹‹é—´æœ‰è”ç³»ï¼Œè¿™æ—¶å°±è¦ç”¨åˆ° PNMPC&lt;/p&gt;

&lt;p&gt;å…ˆå¯¹æŸä¸€ç‰¹å®šç±»å‹çš„æ•°æ®åŒ…æ‰“ä¸Šæ ‡è®°ï¼Œç„¶åå†å°†åŸºäºæŸä¸€ç±»æ ‡è®°çš„æœåŠ¡é€åˆ°åå°çš„ &lt;code&gt;Real Server&lt;/code&gt; ä¸Šå»ï¼Œåå°çš„ Real Server å¹¶ä¸è¯†åˆ«è¿™äº›æ ‡è®°ã€‚å°†&lt;code&gt;æŒä¹…è¿æ¥&lt;/code&gt;å’Œ&lt;code&gt;é˜²ç«å¢™æ ‡è®°&lt;/code&gt;ç»“åˆèµ·æ¥å°±èƒ½å¤Ÿå®ç°ç«¯å£å§»äº²åŠŸèƒ½ï¼Œåªè¦æ˜¯æ¥è‡ªæŸä¸€å®¢æˆ·ç«¯çš„å¯¹æŸä¸€ç‰¹å®šæœåŠ¡ï¼ˆéœ€è¦ä¸åŒçš„ç«¯å£ï¼‰çš„è®¿é—®éƒ½å®šä¹‰åˆ°åŒä¸€å° Real Server ä¸Šå»ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;æ¡ˆä¾‹ï¼š&lt;/strong&gt;ä¸€ä¸ªç”¨æˆ·åœ¨è®¿é—®è´­ç‰©ç½‘ç«™æ—¶åŒæ—¶ä½¿ç”¨ &lt;code&gt;HTTPï¼ˆ80ï¼‰&lt;/code&gt;å’Œ &lt;code&gt;HTTPSï¼ˆ443ï¼‰&lt;/code&gt;ä¸¤ç§åè®®ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶å®šä¹‰åˆ°åŒä¸€å° Real Server ä¸Šï¼Œè€Œå…¶ä»–çš„æœåŠ¡ä¸å—é™åˆ¶ã€‚&lt;/p&gt;

&lt;p&gt;é…ç½®ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ iptables -t mangle -A PREROUTING -d 172.16.100.1 -i eth0 -p tcp --dport 80 -j MARK --set-mark 8
$ iptables -t mangle -A PREROUTING -d 172.16.100.1 -i eth0 -p tcp --dport 443 -j MARK --set-mark 8
$ ipvsadm -A -f 8 -s rr -p 600
$ ipvsadm -a -f 8 -r 172.16.100.10 -g -w 2
$ ipvsadm -a -f 8 -r 172.16.100.11 -g -w 1
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;p-id-h2-7-æ€»ç»“-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;7. æ€»ç»“&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;å¦‚ä½•è®¾ç½® &lt;code&gt;lvs&lt;/code&gt; æŒä¹…æ€§è¿æ¥éœ€è¦æ ¹æ®ä¸šåŠ¡åœºæ™¯æ¥é€‰æ‹©ï¼Œæ¯”å¦‚ç”µå•†å¹³å°ï¼Œå¯¹åº”çš„æŒä¹…æ€§è¿æ¥åº”è¯¥æ˜¯ &lt;code&gt;PNMPP&lt;/code&gt;ï¼Œå¦å¤–è¿˜éœ€è¦æ ¹æ®è¿æ¥ç±»å‹ï¼Œæ¯”å¦‚é•¿è¿æ¥å’ŒçŸ­è¿æ¥ï¼Œæ¥è®¾ç½®ç›¸å…³è¶…æ—¶æ—¶é—´ï¼Œæ€»ä¹‹,æ ¹æ®åº”ç”¨åœºæ™¯æ¥é€‰æ‹©ï¼&lt;/p&gt;

&lt;style&gt;
#h2{
    margin-bottom:2em;
    margin-right: 5px;
    padding: 8px 15px;
    letter-spacing: 2px;
    background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181));
    background-color: rgb(63, 81, 181);
    color: rgb(255, 255, 255);
    border-left: 10px solid rgb(51, 51, 51);
    border-radius:5px;
    text-shadow: rgb(102, 102, 102) 1px 1px 1px;
    box-shadow: rgb(102, 102, 102) 1px 1px 2px;
}
#note {
    font-size: 1.5rem;
    font-style: italic;
    padding: 0 1rem;
    margin: 2.5rem 0;
    position: relative;
    background-color: #fafeff;
    border-top: 1px dotted #9954bb;
    border-bottom: 1px dotted #9954bb;
}
#note-title {
    padding: 0.2rem 0.5rem;
    background: #9954bb;
    color: #FFF;
    position: absolute;
    left: 0;
    top: 0.25rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    border-radius: 4px;
    -webkit-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    -moz-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    -ms-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    -o-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    transform: rotate(-5deg) translateX(-10px) translateY(-25px);
}
#inline-yellow {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #f0ad4e;
}
#inline-green {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #5cb85c;
}
#inline-blue {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #2780e3;
}
#inline-purple {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #9954bb;
}
#div-border-left-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #df3e3e;
}
#div-border-left-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #f0ad4e;
}
#div-border-left-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #5cb85c;
}
#div-border-left-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #2780e3;
}
#div-border-left-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #9954bb;
}
#div-border-right-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #df3e3e;
}
#div-border-right-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #f0ad4e;
}
#div-border-right-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #5cb85c;
}
#div-border-right-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #2780e3;
}
#div-border-right-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #9954bb;
}
#div-border-top-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #df3e3e;
}
#div-border-top-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #f0ad4e;
}
#div-border-top-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #5cb85c;
}
#div-border-top-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #2780e3;
}
#div-border-top-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #9954bb;
}
&lt;/style&gt;</description>
    </item>
    
    <item>
      <title>CRI-O ç®€ä»‹</title>
      <link>https://www.yangcs.net/posts/cri-o/</link>
      <pubDate>Tue, 03 Apr 2018 08:11:38 +0000</pubDate>
      
      <guid>https://www.yangcs.net/posts/cri-o/</guid>
      <description>&lt;p&gt;&lt;/p&gt;

&lt;p&gt;ä¸Šä¸€ç¯‡ &lt;a href=&#34;https://www.yangcs.net/posts/container-runtime&#34; target=&#34;_blank&#34;&gt;https://www.yangcs.net/posts/container-runtime/&lt;/a&gt; ä»‹ç»äº†ä»€ä¹ˆæ˜¯å®¹å™¨è¿è¡Œæ—¶ï¼Œå¹¶åˆ—å‡ºäº†ä¸åŒçš„å®¹å™¨è¿è¡Œæ—¶ã€‚æœ¬ç¯‡é‡ç‚¹ä»‹ç»å…¶ä¸­çš„ä¸€ç§å®¹å™¨è¿è¡Œæ—¶ &lt;code&gt;CRI-O&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-1-cri-o-çš„è¯ç”Ÿ-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;1. CRI-O çš„è¯ç”Ÿ&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;å½“å®¹å™¨è¿è¡Œæ—¶ï¼ˆContainer Runtimeï¼‰çš„æ ‡å‡†è¢«æå‡ºä»¥åï¼ŒRed Hat çš„ä¸€äº›äººå¼€å§‹æƒ³ä»–ä»¬å¯ä»¥æ„å»ºä¸€ä¸ªæ›´ç®€å•çš„è¿è¡Œæ—¶ï¼Œè€Œä¸”è¿™ä¸ªè¿è¡Œæ—¶ä»…ä»…ä¸º Kubernetes æ‰€ç”¨ã€‚è¿™æ ·å°±æœ‰äº† &lt;code&gt;skunkworks&lt;/code&gt;é¡¹ç›®ï¼Œæœ€åå®šåä¸º &lt;code&gt;CRI-O&lt;/code&gt;ï¼Œ å®ƒå®ç°äº†ä¸€ä¸ªæœ€å°çš„ CRI æ¥å£ã€‚åœ¨ 2017 Kubecon Austin çš„ä¸€ä¸ªæ¼”è®²ä¸­ï¼Œ Walsh è§£é‡Šè¯´ï¼Œ â€CRI-O è¢«è®¾è®¡ä¸ºæ¯”å…¶ä»–çš„æ–¹æ¡ˆéƒ½è¦å°ï¼Œéµä» Unix åªåšä¸€ä»¶äº‹å¹¶æŠŠå®ƒåšå¥½çš„è®¾è®¡å“²å­¦ï¼Œå®ç°ç»„ä»¶é‡ç”¨â€œã€‚&lt;/p&gt;

&lt;p&gt;æ ¹æ® Red Hat çš„ CRI-O å¼€å‘è€… Mrunal Patel åœ¨ç ”ç©¶é‡Œé¢è¯´çš„ï¼Œ æœ€å¼€å§‹ Red Hat åœ¨ 2016 å¹´åº•ä¸ºå®ƒçš„ OpenShift å¹³å°å¯åŠ¨äº†è¿™ä¸ªé¡¹ç›®ï¼ŒåŒæ—¶é¡¹ç›®ä¹Ÿå¾—åˆ°äº† &lt;code&gt;Intel&lt;/code&gt; å’Œ &lt;code&gt;SUSE&lt;/code&gt; çš„æ”¯æŒã€‚CRI-O ä¸ &lt;code&gt;CRI&lt;/code&gt; è§„èŒƒå…¼å®¹ï¼Œå¹¶ä¸”ä¸ &lt;code&gt;OCI&lt;/code&gt; å’Œ Docker é•œåƒçš„æ ¼å¼ä¹Ÿå…¼å®¹ã€‚å®ƒä¹Ÿæ”¯æŒæ ¡éªŒé•œåƒçš„ GPG ç­¾åã€‚ å®ƒä½¿ç”¨å®¹å™¨ç½‘ç»œæ¥å£ Container Network Interfaceï¼ˆCNIï¼‰å¤„ç†ç½‘ç»œï¼Œä»¥ä¾¿ä»»ä½•å…¼å®¹ CNI çš„ç½‘ç»œæ’ä»¶å¯ä¸è¯¥é¡¹ç›®ä¸€èµ·ä½¿ç”¨ï¼ŒOpenShift ä¹Ÿç”¨å®ƒæ¥åšè½¯ä»¶å®šä¹‰å­˜å‚¨å±‚ã€‚ å®ƒæ”¯æŒå¤šä¸ª CoW æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯”å¦‚å¸¸è§çš„ overlayï¼Œaufsï¼Œä¹Ÿæ”¯æŒä¸å¤ªå¸¸è§çš„ Btrfsã€‚&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-2-cri-o-çš„åŸç†åŠæ¶æ„-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;2. CRI-O çš„åŸç†åŠæ¶æ„&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;CRI-O æœ€å‡ºåçš„ç‰¹ç‚¹æ˜¯å®ƒæ”¯æŒâ€œå—ä¿¡å®¹å™¨â€å’Œâ€œéå—ä¿¡å®¹å™¨â€çš„æ··åˆå·¥ä½œè´Ÿè½½ã€‚æ¯”å¦‚ï¼ŒCRI-O å¯ä»¥ä½¿ç”¨ &lt;a href=&#34;https://clearlinux.org/containers&#34; target=&#34;_blank&#34;&gt;Clear Containers&lt;/a&gt; åšå¼ºéš”ç¦»ï¼Œè¿™æ ·åœ¨å¤šç§Ÿæˆ·é…ç½®æˆ–è€…è¿è¡Œéä¿¡ä»»ä»£ç æ—¶å¾ˆæœ‰ç”¨ã€‚è¿™ä¸ªåŠŸèƒ½å¦‚ä½•é›†æˆè¿› Kubernetes ç°åœ¨è¿˜ä¸å¤ªæ¸…æ¥šï¼ŒKubernetes ç°åœ¨è®¤ä¸ºæ‰€æœ‰çš„åç«¯éƒ½æ˜¯ä¸€æ ·çš„ã€‚&lt;/p&gt;

&lt;p&gt;å½“ Kubernetes éœ€è¦è¿è¡Œå®¹å™¨æ—¶ï¼Œå®ƒä¼šä¸ CRI-O è¿›è¡Œé€šä¿¡ï¼ŒCRI-O å®ˆæŠ¤ç¨‹åºä¸ &lt;code&gt;runc&lt;/code&gt;ï¼ˆæˆ–å¦ä¸€ä¸ªç¬¦åˆ OCI æ ‡å‡†çš„è¿è¡Œæ—¶ï¼‰ä¸€èµ·å¯åŠ¨å®¹å™¨ã€‚å½“ Kubernetes éœ€è¦åœæ­¢å®¹å™¨æ—¶ï¼ŒCRI-O ä¼šæ¥å¤„ç†ï¼Œå®ƒåªæ˜¯åœ¨å¹•åç®¡ç† Linux å®¹å™¨ï¼Œä»¥ä¾¿ç”¨æˆ·ä¸éœ€è¦æ‹…å¿ƒè¿™ä¸ªå…³é”®çš„å®¹å™¨ç¼–æ’ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://dn-linuxcn.qbox.me/data/attachment/album/201710/31/234945ee5euzn7hu0cnu4u.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;CRI-O æœ‰ä¸€ä¸ªæœ‰è¶£çš„æ¶æ„ï¼ˆè§ä¸‹å›¾ï¼‰ï¼Œå®ƒé‡ç”¨äº†å¾ˆå¤šåŸºç¡€ç»„ä»¶ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å„ä¸ªç»„ä»¶çš„åŠŸèƒ½åŠå·¥ä½œæµç¨‹ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://o7z41ciog.bkt.clouddn.com/crio-architecture.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Kubernetes é€šçŸ¥ &lt;code&gt;kubelet&lt;/code&gt; å¯åŠ¨ä¸€ä¸ª podã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;kubelet é€šè¿‡ &lt;code&gt;CRI&lt;/code&gt;(Container runtime interface) å°†è¯·æ±‚è½¬å‘ç»™ &lt;code&gt;CRI-O daemon&lt;/code&gt;ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;CRI-O åˆ©ç”¨ &lt;code&gt;containers/image&lt;/code&gt; åº“ä»é•œåƒä»“åº“æ‹‰å–é•œåƒã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;ä¸‹è½½å¥½çš„é•œåƒè¢«è§£å‹åˆ°å®¹å™¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œå¹¶é€šè¿‡ &lt;code&gt;containers/storage&lt;/code&gt; åº“å­˜å‚¨åˆ° COW æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;åœ¨ä¸ºå®¹å™¨åˆ›å»º &lt;code&gt;rootfs&lt;/code&gt; ä¹‹åï¼ŒCRI-O é€šè¿‡ &lt;a href=&#34;https://github.com/opencontainers/runtime-tools&#34; target=&#34;_blank&#34;&gt;oci-runtime-tool&lt;/a&gt; ç”Ÿæˆä¸€ä¸ª OCI è¿è¡Œæ—¶è§„èŒƒ json æ–‡ä»¶ï¼Œæè¿°å¦‚ä½•ä½¿ç”¨ OCI Generate tools è¿è¡Œå®¹å™¨ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;ç„¶å CRI-O ä½¿ç”¨è§„èŒƒå¯åŠ¨ä¸€ä¸ªå…¼å®¹ CRI çš„è¿è¡Œæ—¶æ¥è¿è¡Œå®¹å™¨è¿›ç¨‹ã€‚é»˜è®¤çš„è¿è¡Œæ—¶æ˜¯ &lt;code&gt;runc&lt;/code&gt;ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;æ¯ä¸ªå®¹å™¨éƒ½ç”±ä¸€ä¸ªç‹¬ç«‹çš„ &lt;code&gt;conmon&lt;/code&gt; è¿›ç¨‹ç›‘æ§ï¼Œconmon ä¸ºå®¹å™¨ä¸­ pid ä¸º 1 çš„è¿›ç¨‹æä¾›ä¸€ä¸ª &lt;code&gt;pty&lt;/code&gt;ã€‚åŒæ—¶å®ƒè¿˜è´Ÿè´£å¤„ç†å®¹å™¨çš„æ—¥å¿—è®°å½•å¹¶è®°å½•å®¹å™¨è¿›ç¨‹çš„é€€å‡ºä»£ç ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;ç½‘ç»œæ˜¯é€šè¿‡ CNI æ¥å£è®¾ç½®çš„ï¼Œæ‰€ä»¥ä»»ä½• CNI æ’ä»¶éƒ½å¯ä»¥ä¸ CRI-O ä¸€èµ·ä½¿ç”¨ã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;éš†é‡ä»‹ç»ä¸€ä¸‹-conmon&#34;&gt;éš†é‡ä»‹ç»ä¸€ä¸‹ conmon&lt;/h3&gt;

&lt;p&gt;æ ¹æ® Patel æ‰€è¯´ï¼Œconmon ç¨‹åºæ˜¯â€œçº¯Cç¼–å†™çš„ï¼Œç”¨æ¥æé«˜ç¨³å®šæ€§å’Œæ€§èƒ½â€ï¼Œconmon è´Ÿè´£ç›‘æ§ï¼Œæ—¥å¿—ï¼ŒTTY åˆ†é…ï¼Œä»¥åŠç±»ä¼¼ &lt;code&gt;out-of-memory&lt;/code&gt; æƒ…å†µçš„æ‚äº‹ã€‚&lt;/p&gt;

&lt;p&gt;conmon éœ€è¦å»åšæ‰€æœ‰ &lt;code&gt;systemd&lt;/code&gt; ä¸åšæˆ–è€…ä¸æƒ³åšçš„äº‹æƒ…ã€‚å³ä½¿ CRI-O ä¸ç›´æ¥ä½¿ç”¨ systemd æ¥ç®¡ç†å®¹å™¨ï¼Œå®ƒä¹Ÿå°†å®¹å™¨åˆ†é…åˆ° sytemd å…¼å®¹çš„ &lt;code&gt;cgroup&lt;/code&gt; ä¸­ï¼Œè¿™æ ·å¸¸è§„çš„ systemd å·¥å…·æ¯”å¦‚ &lt;code&gt;systemctl&lt;/code&gt; å°±å¯ä»¥çœ‹è§å®¹å™¨èµ„æºä½¿ç”¨æƒ…å†µäº†ã€‚&lt;/p&gt;

&lt;p&gt;å› ä¸º conmonï¼ˆä¸æ˜¯CRI daemonï¼‰æ˜¯å®¹å™¨çš„çˆ¶è¿›ç¨‹ï¼Œå®ƒå…è®¸ CRI-O çš„éƒ¨åˆ†ç»„ä»¶é‡å¯è€Œä¸ä¼šå½±å“å®¹å™¨ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ›´åŠ å¹³æ»‘çš„å‡çº§ã€‚&lt;strong&gt;ç°åœ¨ Docker éƒ¨ç½²çš„é—®é¢˜å°±æ˜¯ Docker å‡çº§éœ€è¦é‡èµ·æ‰€æœ‰çš„å®¹å™¨&lt;/strong&gt;ã€‚ é€šå¸¸è¿™å¯¹äº Kubernetes é›†ç¾¤æ¥è¯´ä¸æ˜¯é—®é¢˜ï¼Œä½†å› ä¸ºå®ƒå¯ä»¥å°†å®¹å™¨è¿ç§»æ¥æ»šåŠ¨å‡çº§ã€‚&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-3-ä¸‹ä¸€æ­¥-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;3. ä¸‹ä¸€æ­¥&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;code&gt;CRI-O 1.0&lt;/code&gt; åœ¨2017å¹´10æœˆå‘å¸ƒï¼Œæ”¯æŒ Kubernetes 1.7ï¼Œåæ¥ CRI-O 1.8ï¼Œ1.9 ç›¸ç»§å‘å¸ƒï¼Œæ”¯æŒ Kubernetes çš„ 1.8ï¼Œ 1.9ï¼ˆæ­¤æ—¶ç‰ˆæœ¬å‘½åè§„åˆ™æ”¹ä¸ºä¸Kubernetesä¸€è‡´ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;CRI-O åœ¨ &lt;code&gt;Openshift 3.7&lt;/code&gt; ä¸­ä½œä¸º beta ç‰ˆæä¾›ï¼ŒPatel è€ƒè™‘åœ¨ &lt;code&gt;Openshift 3.9&lt;/code&gt; ä¸­è®©å®ƒè¿›æ­¥ä¸€æ­¥ç¨³å®šï¼Œåœ¨ 3.10 ä¸­æˆä¸ºç¼ºçœçš„è¿è¡Œæ—¶ï¼ŒåŒæ—¶è®© Docker ä½œä¸ºå€™é€‰çš„è¿è¡Œæ—¶ã€‚&lt;/p&gt;

&lt;p&gt;ä¸‹ä¸€æ­¥çš„å·¥ä½œåŒ…æ‹¬é›†æˆæ–°çš„ &lt;code&gt;Kata Containers&lt;/code&gt; çš„è¿™ä¸ªåŸºäº VM çš„è¿è¡Œæ—¶ï¼Œå¢åŠ  &lt;code&gt;kube-spawn&lt;/code&gt; çš„æ”¯æŒï¼Œæ”¯æŒæ›´å¤šç±»ä¼¼ NFSï¼Œ GlusterFS çš„å­˜å‚¨åç«¯ç­‰ã€‚ å›¢é˜Ÿä¹Ÿåœ¨è®¨è®ºå¦‚ä½•é€šè¿‡æ”¯æŒ &lt;code&gt;casync&lt;/code&gt; æˆ–è€… &lt;code&gt;libtorrent&lt;/code&gt; æ¥ä¼˜åŒ–å¤šèŠ‚ç‚¹é—´çš„é•œåƒåŒæ­¥ã€‚&lt;/p&gt;

&lt;p&gt;å¦‚æœä½ æƒ³è´¡çŒ®æˆ–è€…å…³æ³¨å¼€å‘ï¼Œå°±å» &lt;a href=&#34;https://github.com/kubernetes-incubator/cri-o&#34; target=&#34;_blank&#34;&gt;CRI-O é¡¹ç›®çš„ GitHub ä»“åº“&lt;/a&gt;ï¼Œç„¶åå…³æ³¨ &lt;a href=&#34;https://medium.com/cri-o&#34; target=&#34;_blank&#34;&gt;CRI-O åšå®¢&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-4-å‚è€ƒ-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;4. å‚è€ƒ&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.projectatomic.io/blog/2017/02/crio-runtimes/&#34; target=&#34;_blank&#34;&gt;CRI-O and Alternative Runtimes in Kubernetes&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://cri-o.io/&#34; target=&#34;_blank&#34;&gt;Lightweight Container Runtime for Kubernetes&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://medium.com/cri-o/cri-o-support-for-kubernetes-4934830eb98e&#34; target=&#34;_blank&#34;&gt;CRI-O Support for Kubernetes&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://linux.cn/article-9015-1.html&#34; target=&#34;_blank&#34;&gt;CRI-O 1.0 ç®€ä»‹&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;style&gt;
#h2{
    margin-bottom:2em; 
    margin-right: 5px; 
    padding: 8px 15px; 
    letter-spacing: 2px; 
    background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); 
    background-color: rgb(63, 81, 181); 
    color: rgb(255, 255, 255); 
    border-left: 10px solid rgb(51, 51, 51); 
    border-radius:5px; 
    text-shadow: rgb(102, 102, 102) 1px 1px 1px; 
    box-shadow: rgb(102, 102, 102) 1px 1px 2px;
}
#inline-yellow {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #f0ad4e;
}
#inline-green {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #5cb85c;
}
#inline-blue {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #2780e3;
}
#inline-purple {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #9954bb;
}
#div-border-left-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #df3e3e;
}
#div-border-left-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #f0ad4e;
}
#div-border-left-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #5cb85c;
}
#div-border-left-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #2780e3;
}
#div-border-left-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #9954bb;
}
#div-border-right-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #df3e3e;
}
#div-border-right-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #f0ad4e;
}
#div-border-right-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #5cb85c;
}
#div-border-right-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #2780e3;
}
#div-border-right-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #9954bb;
}
#div-border-top-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #df3e3e;
}
#div-border-top-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #f0ad4e;
}
#div-border-top-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #5cb85c;
}
#div-border-top-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #2780e3;
}
#div-border-top-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #9954bb;
}
&lt;/style&gt;</description>
    </item>
    
    <item>
      <title>Kubernetes ä¸­çš„å®¹å™¨è¿è¡Œæ—¶</title>
      <link>https://www.yangcs.net/posts/container-runtime/</link>
      <pubDate>Tue, 03 Apr 2018 06:50:43 +0000</pubDate>
      
      <guid>https://www.yangcs.net/posts/container-runtime/</guid>
      <description>&lt;p&gt;&lt;/p&gt;

&lt;p&gt;å®¹å™¨è¿è¡Œæ—¶ï¼ˆContainer Runtimeï¼‰æ˜¯ Kubernetes æœ€é‡è¦çš„ç»„ä»¶ä¹‹ä¸€ï¼Œè´Ÿè´£çœŸæ­£ç®¡ç†é•œåƒå’Œå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸã€‚Kubelet é€šè¿‡ &lt;code&gt;Container Runtime Interface (CRI)&lt;/code&gt; ä¸å®¹å™¨è¿è¡Œæ—¶äº¤äº’ï¼Œä»¥ç®¡ç†é•œåƒå’Œå®¹å™¨ã€‚&lt;/p&gt;

&lt;p&gt;å®¹å™¨è¿è¡Œæ—¶æ¥å£(&lt;code&gt;Container Runtime Interface (CRI)&lt;/code&gt;) æ˜¯ Kubelet 1.5 å’Œ kubelet 1.6 ä¸­ä¸»è¦è´Ÿè´£çš„ä¸€å—é¡¹ç›®ï¼Œå®ƒé‡æ–°å®šä¹‰äº† Kubelet Container Runtime APIï¼Œå°†åŸæ¥å®Œå…¨é¢å‘ Pod çº§åˆ«çš„ API æ‹†åˆ†æˆé¢å‘ &lt;code&gt;Sandbox&lt;/code&gt; å’Œ &lt;code&gt;Container&lt;/code&gt; çš„ APIï¼Œå¹¶åˆ†ç¦»é•œåƒç®¡ç†å’Œå®¹å™¨å¼•æ“åˆ°ä¸åŒçš„æœåŠ¡ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://kubernetes.feisky.xyz/zh/plugins/images/cri.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;CRI æœ€æ—©ä»ä» 1.4 ç‰ˆå°±å¼€å§‹è®¾è®¡è®¨è®ºå’Œå¼€å‘ï¼Œåœ¨ v1.5 ä¸­å‘å¸ƒç¬¬ä¸€ä¸ªæµ‹è¯•ç‰ˆã€‚åœ¨ v1.6 æ—¶å·²ç»æœ‰äº†å¾ˆå¤šå¤–éƒ¨å®¹å™¨è¿è¡Œæ—¶ï¼Œå¦‚ fraktiã€cri-o çš„ alpha æ”¯æŒã€‚v1.7 ç‰ˆæœ¬æ–°å¢äº† &lt;code&gt;cri-containerd&lt;/code&gt; çš„ alpha æ”¯æŒï¼Œè€Œ &lt;code&gt;frakti&lt;/code&gt; å’Œ &lt;code&gt;cri-o&lt;/code&gt; åˆ™å‡çº§åˆ° beta æ”¯æŒã€‚&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-1-cri-æ¥å£-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;1. CRI æ¥å£&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;CRI åŸºäº &lt;code&gt;gRPC&lt;/code&gt; å®šä¹‰äº† &lt;code&gt;RuntimeService&lt;/code&gt; å’Œ &lt;code&gt;ImageService&lt;/code&gt;ï¼Œåˆ†åˆ«ç”¨äºå®¹å™¨è¿è¡Œæ—¶å’Œé•œåƒçš„ç®¡ç†ã€‚å…¶å®šä¹‰åœ¨&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;v1.10+:&lt;/strong&gt; &lt;a href=&#34;https://github.com/kubernetes/kubernetes/blob/release-1.10/pkg/kubelet/apis/cri/runtime/v1alpha2&#34; target=&#34;_blank&#34;&gt;pkg/kubelet/apis/cri/v1alpha2/runtime&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;v1.7~v1.9:&lt;/strong&gt; &lt;a href=&#34;https://github.com/kubernetes/kubernetes/tree/release-1.9/pkg/kubelet/apis/cri/v1alpha1/runtime&#34; target=&#34;_blank&#34;&gt;pkg/kubelet/apis/cri/v1alpha1/runtime&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;v1.6:&lt;/strong&gt; &lt;a href=&#34;https://github.com/kubernetes/kubernetes/tree/release-1.6/pkg/kubelet/api/v1alpha1/runtime&#34; target=&#34;_blank&#34;&gt;pkg/kubelet/api/v1alpha1/runtime&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Kubelet ä½œä¸º CRI çš„å®¢æˆ·ç«¯ï¼Œè€Œ Runtime ç»´æŠ¤è€…åˆ™éœ€è¦å®ç° CRI æœåŠ¡ç«¯ï¼Œå¹¶åœ¨å¯åŠ¨ kubelet æ—¶å°†å…¶ä¼ å…¥ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubelet --container-runtime=remote --container-runtime-endpoint=unix:///var/run/crio/crio.sock ..
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;p-id-h2-2-å¦‚ä½•å¼€å‘æ–°çš„-container-runtime-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;2. å¦‚ä½•å¼€å‘æ–°çš„ Container Runtime&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;å¼€å‘æ–°çš„ Container Runtime åªéœ€è¦å®ç° &lt;code&gt;CRI gRPC Server&lt;/code&gt;ï¼ŒåŒ…æ‹¬ &lt;code&gt;RuntimeService&lt;/code&gt; å’Œ &lt;code&gt;ImageService&lt;/code&gt;ã€‚è¯¥ gRPC Server éœ€è¦ç›‘å¬åœ¨æœ¬åœ°çš„ &lt;code&gt;unix socket&lt;/code&gt;ï¼ˆLinux æ”¯æŒ unix socket æ ¼å¼ï¼ŒWindows æ”¯æŒ tcp æ ¼å¼ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;å…·ä½“çš„å®ç°æ–¹æ³•å¯ä»¥å‚è€ƒä¸‹é¢å·²ç»æ”¯æŒçš„ Container Runtime åˆ—è¡¨ã€‚&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-3-ç›®å‰æ”¯æŒçš„-container-runtime-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;3. ç›®å‰æ”¯æŒçš„ Container Runtime&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;ç›®å‰ï¼Œæœ‰å¤šå®¶å‚å•†éƒ½åœ¨åŸºäº CRI é›†æˆè‡ªå·±çš„å®¹å™¨å¼•æ“ï¼Œå…¶ä¸­åŒ…æ‹¬:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;Docker:&lt;/strong&gt; æ ¸å¿ƒä»£ç ä¾ç„¶ä¿ç•™åœ¨ kubelet å†…éƒ¨ï¼ˆ&lt;code&gt;pkg/kubelet/dockershim&lt;/code&gt;ï¼‰ï¼Œä¾ç„¶æ˜¯æœ€ç¨³å®šå’Œç‰¹æ€§æ”¯æŒæœ€å¥½çš„ Runtime&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;&lt;a href=&#34;https://github.com/kubernetes/frakti&#34; target=&#34;_blank&#34;&gt;HyperContainer&lt;/a&gt;:&lt;/strong&gt; æ”¯æŒ Kubernetes v1.6+ï¼Œæä¾›åŸºäº &lt;code&gt;hypervisor&lt;/code&gt; å’Œ docker çš„æ··åˆè¿è¡Œæ—¶ï¼Œé€‚ç”¨äºè¿è¡Œéå¯ä¿¡åº”ç”¨ï¼Œå¦‚å¤šç§Ÿæˆ·å’Œ &lt;code&gt;NFV&lt;/code&gt; ç­‰åœºæ™¯&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;Runc&lt;/strong&gt; æœ‰ä¸¤ä¸ªå®ç°ï¼Œcri-o å’Œ cri-containerd&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/kubernetes-incubator/cri-containerd&#34; target=&#34;_blank&#34;&gt;cri-containerd&lt;/a&gt;: æ”¯æŒ kubernetes v1.7+&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/kubernetes-incubator/cri-o&#34; target=&#34;_blank&#34;&gt;cri-o&lt;/a&gt;: æ”¯æŒ Kubernetes v1.6+ï¼Œåº•å±‚è¿è¡Œæ—¶æ”¯æŒ runc å’Œ intel clear container&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;&lt;a href=&#34;https://github.com/kubernetes-incubator/rktlet&#34; target=&#34;_blank&#34;&gt;Rkt&lt;/a&gt;:&lt;/strong&gt; å¼€å‘ä¸­&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;&lt;a href=&#34;https://github.com/Mirantis/virtlet&#34; target=&#34;_blank&#34;&gt;Mirantis&lt;/a&gt;:&lt;/strong&gt; ç›´æ¥ç®¡ç† &lt;code&gt;libvirt&lt;/code&gt; è™šæ‹Ÿæœºï¼Œé•œåƒé¡»æ˜¯ &lt;code&gt;qcow2&lt;/code&gt; æ ¼å¼&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;&lt;a href=&#34;https://github.com/apporbit/infranetes&#34; target=&#34;_blank&#34;&gt;Infranetes&lt;/a&gt;:&lt;/strong&gt; ç›´æ¥ç®¡ç† IaaS å¹³å°è™šæ‹Ÿæœºï¼Œå¦‚ GCEã€AWS ç­‰&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;cri-containerd&#34;&gt;cri-containerd&lt;/h3&gt;

&lt;p&gt;ä»¥ containerd ä¸ºä¾‹ï¼Œå®ƒå°† &lt;code&gt;dockershim&lt;/code&gt; å’Œ &lt;code&gt;docker daemon&lt;/code&gt; æ›¿æ¢ä¸º &lt;code&gt;cri-containerd&lt;/code&gt; æœåŠ¡ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://kubernetes.feisky.xyz/zh/plugins/images/cri-containerd.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;è€Œ cri-containerd åˆ™å®ç°äº† Kubelet CRI æ¥å£ï¼Œå¯¹ Kubelet æš´éœ² Image Service å’Œ Runtime Serviceã€‚åœ¨å†…éƒ¨ï¼Œå®ƒé€šè¿‡ containerd çš„ gRPC æ¥å£ç®¡ç†å®¹å™¨å’Œé•œåƒï¼Œå¹¶é€šè¿‡ CNI æ’ä»¶ç»™ Pod é…ç½®ç½‘ç»œã€‚
&lt;img src=&#34;https://kubernetes.feisky.xyz/zh/plugins/images/containerd.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-4-cri-tools-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;4. CRI Tools&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;ä¸ºäº†æ–¹ä¾¿å¼€å‘ã€è°ƒè¯•å’ŒéªŒè¯æ–°çš„ Container Runtimeï¼Œç¤¾åŒºè¿˜ç»´æŠ¤äº†ä¸€ä¸ª &lt;a href=&#34;https://github.com/kubernetes-incubator/cri-tools&#34; target=&#34;_blank&#34;&gt;cri-tools&lt;/a&gt; å·¥å…·ï¼Œå®ƒæä¾›ä¸¤ä¸ªç»„ä»¶&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;crictl:&lt;/code&gt; ç±»ä¼¼äº docker çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œä¸éœ€è¦é€šè¿‡ Kubelet å°±å¯ä»¥è·Ÿ Container Runtime é€šä¿¡ï¼Œå¯ç”¨æ¥è°ƒè¯•æˆ–æ’æŸ¥é—®é¢˜&lt;/li&gt;
&lt;li&gt;&lt;code&gt;critest:&lt;/code&gt; CRI çš„éªŒè¯æµ‹è¯•å·¥å…·ï¼Œç”¨æ¥éªŒè¯æ–°çš„ Container Runtime æ˜¯å¦å®ç°äº† CRI éœ€è¦çš„åŠŸèƒ½&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å¦å¤–ä¸€ä¸ªå·¥å…·æ˜¯ &lt;a href=&#34;https://github.com/projectatomic/libpod&#34; target=&#34;_blank&#34;&gt;libpod&lt;/a&gt;ï¼Œå®ƒä¹Ÿæä¾›äº†ä¸€ä¸ªç»„ä»¶ï¼š&lt;a href=&#34;https://github.com/projectatomic/libpod/blob/master/cmd/podman&#34; target=&#34;_blank&#34;&gt;podman&lt;/a&gt;ï¼ŒåŠŸèƒ½å’Œ &lt;code&gt;crictl&lt;/code&gt; ç±»ä¼¼ã€‚&lt;/p&gt;

&lt;p&gt;å¦‚æœæƒ³æ„å»º oci æ ¼å¼çš„é•œåƒï¼Œå¯ä»¥ä½¿ç”¨å·¥å…·ï¼š&lt;a href=&#34;https://github.com/projectatomic/buildah&#34; target=&#34;_blank&#34;&gt;buildah&lt;/a&gt;&lt;/p&gt;

&lt;style&gt;
#h2{
    margin-bottom:2em; 
    margin-right: 5px; 
    padding: 8px 15px; 
    letter-spacing: 2px; 
    background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); 
    background-color: rgb(63, 81, 181); 
    color: rgb(255, 255, 255); 
    border-left: 10px solid rgb(51, 51, 51); 
    border-radius:5px; 
    text-shadow: rgb(102, 102, 102) 1px 1px 1px; 
    box-shadow: rgb(102, 102, 102) 1px 1px 2px;
}
#inline-yellow {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #f0ad4e;
}
#inline-green {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #5cb85c;
}
#inline-blue {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #2780e3;
}
#inline-purple {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #9954bb;
}
#div-border-left-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #df3e3e;
}
#div-border-left-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #f0ad4e;
}
#div-border-left-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #5cb85c;
}
#div-border-left-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #2780e3;
}
#div-border-left-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #9954bb;
}
#div-border-right-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #df3e3e;
}
#div-border-right-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #f0ad4e;
}
#div-border-right-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #5cb85c;
}
#div-border-right-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #2780e3;
}
#div-border-right-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #9954bb;
}
#div-border-top-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #df3e3e;
}
#div-border-top-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #f0ad4e;
}
#div-border-top-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #5cb85c;
}
#div-border-top-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #2780e3;
}
#div-border-top-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #9954bb;
}
&lt;/style&gt;</description>
    </item>
    
    <item>
      <title>docker åœ¨æœ¬åœ°å¦‚ä½•ç®¡ç† imageï¼ˆé•œåƒï¼‰?</title>
      <link>https://www.yangcs.net/posts/how-manage-image/</link>
      <pubDate>Mon, 02 Apr 2018 05:12:18 +0000</pubDate>
      
      <guid>https://www.yangcs.net/posts/how-manage-image/</guid>
      <description>&lt;p&gt;&lt;/p&gt;

&lt;p&gt;docker é‡Œé¢å¯ä»¥é€šè¿‡ &lt;code&gt;docker pull&lt;/code&gt;ã€&lt;code&gt;docker build&lt;/code&gt;ã€&lt;code&gt;docker commit&lt;/code&gt;ã€&lt;code&gt;docker load&lt;/code&gt;ã€&lt;code&gt;docker import&lt;/code&gt; ç­‰æ–¹å¼å¾—åˆ°ä¸€ä¸ª imageï¼Œå¾—åˆ° image ä¹‹å docker åœ¨æœ¬åœ°æ˜¯æ€ä¹ˆå­˜å‚¨çš„å‘¢ï¼Ÿæœ¬ç¯‡å°†ä»¥ &lt;code&gt;docker pull&lt;/code&gt; ä¸ºä¾‹ï¼Œç®€è¿° image çš„è·å–å’Œå­˜å‚¨æ–¹å¼ã€‚&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-1-é•œåƒç›¸å…³çš„é…ç½®-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;1. é•œåƒç›¸å…³çš„é…ç½®&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;docker é‡Œé¢å’Œ image æœ‰å…³çš„ç›®å½•ä¸º &lt;code&gt;/var/lib/docker&lt;/code&gt;ï¼Œé‡Œé¢å­˜æ”¾ç€ image çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢è¿™ä¸ª dockerd çš„å¯åŠ¨å‚æ•°æ¥ä¿®æ”¹è¿™ä¸ªç›®å½•çš„è·¯å¾„ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;--graph, -g /var/lib/docker Root of the Docker runtime
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;p-id-h2-2-é•œåƒçš„å¼•ç”¨æ–¹å¼-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;2. é•œåƒçš„å¼•ç”¨æ–¹å¼&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;åœ¨éœ€è¦å¼•ç”¨ image çš„æ—¶å€™ï¼Œæ¯”å¦‚ docker pull çš„æ—¶å€™ï¼Œæˆ–è€…è¿è¡Œå®¹å™¨çš„æ—¶å€™ï¼Œéƒ½éœ€è¦æŒ‡å®šä¸€ä¸ªimageåç§°ï¼Œå¼•ç”¨ä¸€ä¸ªé•œåƒæœ‰å¤šç§æ–¹å¼ï¼Œä¸‹é¢ä»¥ &lt;code&gt;alpine&lt;/code&gt; ä¸ºä¾‹è¿›è¡Œè¯´æ˜.&lt;/p&gt;

&lt;div id=&#34;note&#34;&gt;
&lt;p id=&#34;note-title&#34;&gt;Note&lt;/p&gt;
&lt;br /&gt;
&lt;p&gt;ç”±äº sha256 ç å¤ªé•¿ï¼Œæ‰€ä»¥ç”¨ abcdef... æ¥è¡¨ç¤ºå®Œæ•´çš„ sha256ï¼ŒèŠ‚çº¦ç©ºé—´&lt;/p&gt;
&lt;/div&gt;

&lt;h3 id=&#34;docker-hub-ä¸Šçš„å®˜æ–¹é•œåƒ&#34;&gt;docker hub ä¸Šçš„å®˜æ–¹é•œåƒ&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;alpine:&lt;/strong&gt; å®˜æ–¹æä¾›çš„æœ€æ–° alpine é•œåƒï¼Œå¯¹åº”çš„å®Œæ•´åç§°ä¸º &lt;code&gt;docker.io/library/alpine:latest&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;alpine:3.7:&lt;/strong&gt; å®˜æ–¹æä¾›çš„ alpine 3.7 é•œåƒï¼Œå¯¹åº”çš„å®Œæ•´åç§°ä¸º &lt;code&gt;docker.io/library/alpine:3.7&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;alpine:@sha256:abcdef&amp;hellip;:&lt;/strong&gt; å®˜æ–¹æä¾›çš„ digest ç ä¸º sha256:abcdef&amp;hellip; çš„ alpine é•œåƒï¼Œå¯¹åº”çš„å®Œæ•´åç§°ä¸º &lt;code&gt;docker.io/library/alpine@sha256:abcdef...&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;docker-hub-ä¸Šçš„éå®˜æ–¹-ä¸ªäºº-é•œåƒ&#34;&gt;docker hub ä¸Šçš„éå®˜æ–¹ï¼ˆä¸ªäººï¼‰é•œåƒ&lt;/h3&gt;

&lt;p&gt;å¼•ç”¨æ–¹å¼å’Œå®˜æ–¹é•œåƒä¸€æ ·ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯éœ€è¦åœ¨é•œåƒåç§°å‰é¢å¸¦ä¸Šç”¨æˆ·å‰ç¼€ï¼Œå¦‚ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;user1/alpine:&lt;/strong&gt; ç”± user1 æä¾›çš„æœ€æ–° alpine é•œåƒï¼Œ å¯¹åº”çš„å®Œæ•´åç§°ä¸º &lt;code&gt;docker.io/user1/alpine:latest&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;code&gt;user1/alpine:3.7&lt;/code&gt; å’Œ &lt;code&gt;user1/alpine:@sha256:abcdef...&lt;/code&gt; è¿™ä¸¤ç§æ–¹å¼ä¹Ÿæ˜¯å’Œä¸Šé¢ä¸€æ ·ï¼Œç­‰åŒäº &lt;code&gt;docker.io/user1/alpine:3.7&lt;/code&gt; å’Œ &lt;code&gt;docker.io/user1/alpine:@sha256:abcdef...&lt;/code&gt;&lt;/p&gt;

&lt;h3 id=&#34;è‡ªå·±æ­å»ºçš„-registry-é‡Œçš„é•œåƒ&#34;&gt;è‡ªå·±æ­å»ºçš„ registry é‡Œçš„é•œåƒ&lt;/h3&gt;

&lt;p&gt;å¼•ç”¨æ–¹å¼å’Œ &lt;code&gt;docker hub&lt;/code&gt; ä¸€æ ·ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯éœ€è¦åœ¨é•œåƒåç§°æœ€å‰é¢å¸¦ä¸Šåœ°å€ï¼Œå¦‚ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;localhost:5000/alpine:&lt;/strong&gt; æœ¬åœ°è‡ªå·±æ­å»ºçš„ registryï¼ˆlocalhost:5000ï¼‰é‡Œé¢çš„å®˜æ–¹ alpine çš„æœ€æ–°é•œåƒï¼Œå¯¹åº”çš„å®Œæ•´åç§°ä¸º &lt;code&gt;localhost:5000/library/alpine:latest&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;localhost:5000/user1/alpine@sha256:a123def&amp;hellip;:&lt;/strong&gt; æœ¬åœ°è‡ªå·±æ­å»ºçš„ registryï¼ˆlocalhost:5000ï¼‰é‡Œé¢ç”±ç”¨æˆ· user1 æä¾›çš„ digest ä¸º sha256:a123def çš„ alpine é•œåƒ&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å…¶å®ƒçš„å‡ ç§æƒ…å†µå’Œä¸Šé¢çš„ç±»ä¼¼ã€‚&lt;/p&gt;

&lt;h3 id=&#34;ä¸ºä»€ä¹ˆéœ€è¦é•œåƒçš„-digest&#34;&gt;ä¸ºä»€ä¹ˆéœ€è¦é•œåƒçš„ digestï¼Ÿ&lt;/h3&gt;

&lt;p&gt;å¯¹äºæŸäº› &lt;code&gt;image&lt;/code&gt; æ¥è¯´ï¼Œå¯èƒ½åœ¨å‘å¸ƒä¹‹åè¿˜ä¼šåšä¸€äº›æ›´æ–°ï¼Œæ¯”å¦‚å®‰å…¨æ–¹é¢çš„ï¼Œè¿™æ—¶è™½ç„¶é•œåƒçš„å†…å®¹å˜äº†ï¼Œä½†é•œåƒçš„åç§°å’Œ &lt;code&gt;tag&lt;/code&gt; æ²¡æœ‰å˜ï¼Œæ‰€ä»¥ä¼šé€ æˆå‰åä¸¤æ¬¡é€šè¿‡åŒæ ·çš„åç§°å’Œ &lt;code&gt;tag&lt;/code&gt; ä»æœåŠ¡å™¨å¾—åˆ°ä¸åŒçš„ä¸¤ä¸ªé•œåƒçš„é—®é¢˜ï¼Œäºæ˜¯ docker å¼•å…¥äº†é•œåƒçš„ &lt;code&gt;digest&lt;/code&gt; çš„æ¦‚å¿µï¼Œä¸€ä¸ªé•œåƒçš„ &lt;code&gt;digest&lt;/code&gt; å°±æ˜¯é•œåƒçš„ &lt;code&gt;manifes&lt;/code&gt; æ–‡ä»¶çš„ &lt;code&gt;sha256&lt;/code&gt; ç ï¼Œå½“é•œåƒçš„å†…å®¹å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œå³é•œåƒçš„ &lt;code&gt;layer&lt;/code&gt; å‘ç”Ÿå˜åŒ–ï¼Œä»è€Œ &lt;code&gt;layer&lt;/code&gt; çš„ &lt;code&gt;sha256&lt;/code&gt; å‘ç”Ÿå˜åŒ–ï¼Œè€Œ &lt;code&gt;manifest&lt;/code&gt; é‡Œé¢åŒ…å«äº†æ¯ä¸€ä¸ª &lt;code&gt;layer&lt;/code&gt; çš„ &lt;code&gt;sha256&lt;/code&gt;ï¼Œæ‰€ä»¥ &lt;code&gt;manifest&lt;/code&gt; çš„ &lt;code&gt;sha256&lt;/code&gt; ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ï¼Œå³é•œåƒçš„ &lt;code&gt;digest&lt;/code&gt; å‘ç”Ÿå˜åŒ–ï¼Œè¿™æ ·å°±ä¿è¯äº† &lt;code&gt;digest&lt;/code&gt; èƒ½å”¯ä¸€çš„å¯¹åº”ä¸€ä¸ªé•œåƒã€‚&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-3-docker-pullçš„å¤§æ¦‚è¿‡ç¨‹-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;3. docker pullçš„å¤§æ¦‚è¿‡ç¨‹&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;å¦‚æœå¯¹ Image manifestï¼ŒImage Config å’Œ Filesystem Layers ç­‰æ¦‚å¿µä¸æ˜¯å¾ˆäº†è§£ï¼Œè¯·å…ˆå‚è€ƒ &lt;a href=&#34;https://segmentfault.com/a/1190000009309347&#34; target=&#34;_blank&#34;&gt;image(é•œåƒ)æ˜¯ä»€ä¹ˆ&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;p&gt;å– image çš„å¤§æ¦‚è¿‡ç¨‹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;docker å‘é€ &lt;code&gt;image&lt;/code&gt; çš„åç§°+tagï¼ˆæˆ–è€… digestï¼‰ç»™ &lt;code&gt;registry&lt;/code&gt; æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨æ ¹æ®æ”¶åˆ°çš„ image çš„åç§°+tagï¼ˆæˆ–è€… digestï¼‰ï¼Œæ‰¾åˆ°ç›¸åº” image çš„ &lt;code&gt;manifest&lt;/code&gt;ï¼Œç„¶åå°† manifest è¿”å›ç»™ docker&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;docker å¾—åˆ° &lt;code&gt;manifest&lt;/code&gt; åï¼Œè¯»å–é‡Œé¢ image é…ç½®æ–‡ä»¶çš„ &lt;code&gt;digest&lt;/code&gt;(sha256)ï¼Œè¿™ä¸ª sha256 ç å°±æ˜¯ image çš„ &lt;code&gt;ID&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;æ ¹æ® &lt;code&gt;ID&lt;/code&gt; åœ¨æœ¬åœ°æ‰¾æœ‰æ²¡æœ‰å­˜åœ¨åŒæ · &lt;code&gt;ID&lt;/code&gt; çš„ imageï¼Œæœ‰çš„è¯å°±ä¸ç”¨ç»§ç»­ä¸‹è½½äº†&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;å¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆä¼šç»™ registry æœåŠ¡å™¨å‘è¯·æ±‚ï¼ˆé‡Œé¢åŒ…å«é…ç½®æ–‡ä»¶çš„ &lt;code&gt;sha256&lt;/code&gt; å’Œ &lt;code&gt;media type&lt;/code&gt;ï¼‰ï¼Œæ‹¿åˆ° image çš„é…ç½®æ–‡ä»¶ï¼ˆ&lt;code&gt;Image Config&lt;/code&gt;ï¼‰&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;æ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„ &lt;code&gt;diff_ids&lt;/code&gt;ï¼ˆæ¯ä¸ª diffid å¯¹åº”ä¸€ä¸ª layer tar åŒ…çš„ sha256ï¼Œtar åŒ…ç›¸å½“äº layer çš„åŸå§‹æ ¼å¼ï¼‰ï¼Œåœ¨æœ¬åœ°æ‰¾å¯¹åº”çš„ layer æ˜¯å¦å­˜åœ¨&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;å¦‚æœ layer ä¸å­˜åœ¨ï¼Œåˆ™æ ¹æ® &lt;code&gt;manifest&lt;/code&gt; é‡Œé¢ layer çš„ &lt;code&gt;sha256&lt;/code&gt; å’Œ &lt;code&gt;media type&lt;/code&gt; å»æœåŠ¡å™¨æ‹¿ç›¸åº”çš„ layerï¼ˆç›¸å½“å»æ‹¿å‹ç¼©æ ¼å¼çš„åŒ…ï¼‰ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;æ‹¿åˆ°åè¿›è¡Œè§£å‹ï¼Œå¹¶æ£€æŸ¥è§£å‹å tar åŒ…çš„ sha256 èƒ½å¦å’Œé…ç½®æ–‡ä»¶ï¼ˆ&lt;code&gt;Image Config&lt;/code&gt;ï¼‰ä¸­çš„ &lt;code&gt;diff_id&lt;/code&gt; å¯¹çš„ä¸Šï¼Œå¯¹ä¸ä¸Šè¯´æ˜æœ‰é—®é¢˜ï¼Œä¸‹è½½å¤±è´¥&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;æ ¹æ® docker æ‰€ç”¨çš„åå°æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼Œè§£å‹ tar åŒ…å¹¶æ”¾åˆ°æŒ‡å®šçš„ç›®å½•&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;ç­‰æ‰€æœ‰çš„ layer éƒ½ä¸‹è½½å®Œæˆåï¼Œæ•´ä¸ª image ä¸‹è½½å®Œæˆï¼Œå°±å¯ä»¥ä½¿ç”¨äº†&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;div id=&#34;note&#34;&gt;
&lt;p id=&#34;note-title&#34;&gt;Note&lt;/p&gt;
&lt;br /&gt;
&lt;p&gt;å¯¹äº layer æ¥è¯´ï¼Œ&lt;code&gt;config&lt;/code&gt; æ–‡ä»¶ä¸­ diffid æ˜¯ layer çš„ &lt;code&gt;tar&lt;/code&gt; åŒ…çš„ sha256ï¼Œè€Œ &lt;code&gt;manifest&lt;/code&gt; æ–‡ä»¶ä¸­çš„ digest ä¾èµ–äº media typeï¼Œæ¯”å¦‚ media type æ˜¯ &lt;code&gt;tar+gzip&lt;/code&gt;ï¼Œé‚£ digest å°±æ˜¯ layer çš„ tar åŒ…ç»è¿‡ gzip å‹ç¼©åçš„å†…å®¹çš„ sha256ï¼Œå¦‚æœ media type å°±æ˜¯ tar çš„è¯ï¼Œdiffid å’Œ digest å°±ä¼šä¸€æ ·ã€‚&lt;/p&gt;
&lt;/div&gt;

&lt;blockquote&gt;
&lt;p&gt;dockerd å’Œ registry æœåŠ¡å™¨ä¹‹é—´çš„åè®®ä¸º &lt;a href=&#34;https://docs.docker.com/registry/spec/api/&#34; target=&#34;_blank&#34;&gt;Registry HTTP API V2&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;p-id-h2-4-image-æœ¬åœ°å­˜æ”¾ä½ç½®-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;4. image æœ¬åœ°å­˜æ”¾ä½ç½®&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;è¿™é‡Œä»¥ &lt;code&gt;ubuntu&lt;/code&gt; çš„ image ä¸ºä¾‹ï¼Œå±•ç¤º docker çš„ image å­˜å‚¨æ–¹å¼ã€‚&lt;/p&gt;

&lt;p&gt;å…ˆçœ‹çœ‹ ubuntu çš„ &lt;code&gt;image id&lt;/code&gt; å’Œ &lt;code&gt;digest&lt;/code&gt;ï¼Œç„¶åå†åˆ†æ image æ•°æ®éƒ½å­˜åœ¨å“ªé‡Œã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ docker images --digests

REPOSITORY                                           TAG                 DIGEST                                                                    IMAGE ID            CREATED             SIZE
ubuntu                                               latest              sha256:e348fbbea0e0a0e73ab0370de151e7800684445c509d46195aef73e090a49bd6   f975c5035748        3 weeks ago         112MB
......
&lt;/code&gt;&lt;/pre&gt;

&lt;div id=&#34;note&#34;&gt;
&lt;p id=&#34;note-title&#34;&gt;Note&lt;/p&gt;
&lt;br /&gt;
&lt;p&gt;å¯¹äºæœ¬åœ°ç”Ÿæˆçš„é•œåƒæ¥è¯´ï¼Œç”±äºæ²¡æœ‰ä¸Šä¼ åˆ° registry ä¸Šå»ï¼Œæ‰€ä»¥æ²¡æœ‰ digestï¼Œå› ä¸ºé•œåƒçš„ manifest ç”± registry ç”Ÿæˆã€‚&lt;/p&gt;
&lt;/div&gt;

&lt;h3 id=&#34;repositories-json&#34;&gt;repositories.json&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;repositories.json&lt;/code&gt; ä¸­è®°å½•äº†å’Œæœ¬åœ° image ç›¸å…³çš„ &lt;code&gt;repository&lt;/code&gt; ä¿¡æ¯ï¼Œä¸»è¦æ˜¯ &lt;code&gt;name&lt;/code&gt; å’Œ &lt;code&gt;image id&lt;/code&gt; çš„å¯¹åº”å…³ç³»ï¼Œå½“ image ä» registry ä¸Šè¢« pull ä¸‹æ¥åï¼Œå°±ä¼šæ›´æ–°è¯¥æ–‡ä»¶ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#è¿™é‡Œç›®å½•ä¸­çš„ overlay2 ä¸º docker åå°æ‰€é‡‡ç”¨çš„å­˜å‚¨æ–‡ä»¶ç³»ç»Ÿåç§°ï¼Œ
#å¦‚æœæ˜¯å…¶ä»–çš„æ–‡ä»¶ç³»ç»Ÿçš„è¯ï¼Œåå­—ä¼šæ˜¯å…¶ä»–çš„ï¼Œæ¯”å¦‚btrfsã€aufsã€devicemapperç­‰ã€‚
$ cat /var/lib/docker/image/overlay2/repositories.json|jq .

{
    &amp;quot;Repositories&amp;quot;: {
        &amp;quot;ubuntu&amp;quot;: {
            &amp;quot;ubuntu:latest&amp;quot;: &amp;quot;sha256:f975c50357489439eb9145dbfa16bb7cd06c02c31aa4df45c77de4d2baa4e232&amp;quot;,
            &amp;quot;ubuntu@sha256:e348fbbea0e0a0e73ab0370de151e7800684445c509d46195aef73e090a49bd6&amp;quot;: &amp;quot;sha256:f975c50357489439eb9145dbfa16bb7cd06c02c31aa4df45c77de4d2baa4e232&amp;quot;
        }
        ......
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;ubuntu:&lt;/strong&gt; &lt;code&gt;repository&lt;/code&gt; çš„åç§°ï¼Œå‰é¢æ²¡æœ‰æœåŠ¡å™¨ä¿¡æ¯çš„è¡¨ç¤ºè¿™æ˜¯å®˜æ–¹ registry(docker hub) é‡Œé¢çš„ repositoryï¼Œé‡Œé¢åŒ…å«çš„éƒ½æ˜¯ image æ ‡è¯†å’Œ image ID çš„å¯¹åº”å…³ç³»&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;ubuntu:latest å’Œ ubuntu@sha256:e348fbb&amp;hellip;:&lt;/strong&gt; ä»–ä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ªimageï¼ˆ&lt;code&gt;sha256:f975c5...&lt;/code&gt;ï¼‰&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;é…ç½®æ–‡ä»¶-image-config&#34;&gt;é…ç½®æ–‡ä»¶ï¼ˆimage configï¼‰&lt;/h3&gt;

&lt;p&gt;docker æ ¹æ®åå°æ‰€é‡‡ç”¨çš„æ–‡ä»¶ç³»ç»Ÿä¸åŒï¼Œåœ¨ &lt;code&gt;/var/lib/docker&lt;/code&gt; ç›®å½•ä¸‹åˆ›å»ºäº†ä¸åŒçš„å­ç›®å½•ï¼Œå¯¹äº &lt;code&gt;CentOS&lt;/code&gt; æ¥è¯´ï¼Œé»˜è®¤æ–‡ä»¶ç³»ç»Ÿæ˜¯ &lt;code&gt;overlay2&lt;/code&gt;ã€‚æœ¬æ–‡ä»¥ &lt;span id=&#34;inline-purple&#34;&gt;CentOS&lt;/span&gt; ä¸ºä¾‹ã€‚&lt;/p&gt;

&lt;p&gt;docker æ ¹æ®ç¬¬ä¸€æ­¥å¾—åˆ°çš„ manifestï¼Œä» registry æ‹¿åˆ° config æ–‡ä»¶ï¼Œç„¶åä¿å­˜åœ¨ &lt;code&gt;image/overlay2/imagedb/content/sha256/&lt;/code&gt; ç›®å½•ä¸‹ï¼Œæ–‡ä»¶åç§°å°±æ˜¯æ–‡ä»¶å†…å®¹çš„ &lt;code&gt;sha256&lt;/code&gt; ç ï¼Œå³ &lt;code&gt;image id&lt;/code&gt;ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ sha256sum /var/lib/docker/image/overlay2/imagedb/content/sha256/f975c50357489439eb9145dbfa16bb7cd06c02c31aa4df45c77de4d2baa4e232

f975c50357489439eb9145dbfa16bb7cd06c02c31aa4df45c77de4d2baa4e232  /var/lib/docker/image/overlay2/imagedb/content/sha256/f975c50357489439eb9145dbfa16bb7cd06c02c31aa4df45c77de4d2baa4e232

#è¿™é‡Œæˆ‘ä»¬åªå…³æ³¨è¿™ä¸ª image çš„ rootfsï¼Œ
#ä» diff_ids é‡Œå¯ä»¥çœ‹å‡º ubuntu:latest è¿™ä¸ª image åŒ…å«äº† 5 ä¸ª layerï¼Œ
#ä»ä¸Šåˆ°ä¸‹ä¾æ¬¡æ˜¯ä»åº•å±‚åˆ°é¡¶å±‚ï¼Œa94e0d...æ˜¯æœ€åº•å±‚ï¼Œdb584c...æ˜¯æœ€é¡¶å±‚
$ cat /var/lib/docker/image/overlay2/imagedb/content/sha256/f975c50357489439eb9145dbfa16bb7cd06c02c31aa4df45c77de4d2baa4e232|jq .

......
  &amp;quot;rootfs&amp;quot;: {
    &amp;quot;type&amp;quot;: &amp;quot;layers&amp;quot;,
    &amp;quot;diff_ids&amp;quot;: [
      &amp;quot;sha256:a94e0d5a7c404d0e6fa15d8cd4010e69663bd8813b5117fbad71365a73656df9&amp;quot;,
      &amp;quot;sha256:88888b9b1b5b7bce5db41267e669e6da63ee95736cb904485f96f29be648bfda&amp;quot;,
      &amp;quot;sha256:52f389ea437ebf419d1c9754d0184b57edb45c951666ee86951d9f6afd26035e&amp;quot;,
      &amp;quot;sha256:52a7ea2bb533dc2a91614795760a67fb807561e8a588204c4858a300074c082b&amp;quot;,
      &amp;quot;sha256:db584c622b50c3b8f9b8b94c270cc5fe235e5f23ec4aacea8ce67a8c16e0fbad&amp;quot;
    ]
  }

......
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;layer-çš„-diff-id-å’Œ-digest-çš„å¯¹åº”å…³ç³»&#34;&gt;layer çš„ diff_id å’Œ digest çš„å¯¹åº”å…³ç³»&lt;/h3&gt;

&lt;p&gt;layer çš„ &lt;code&gt;diff_id&lt;/code&gt; å­˜åœ¨ image çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œè€Œ layer çš„ &lt;code&gt;digest&lt;/code&gt; å­˜åœ¨ image çš„ manifest ä¸­ï¼Œä»–ä»¬çš„å¯¹åº”å…³ç³»è¢«å­˜å‚¨åœ¨äº† &lt;code&gt;image/overlay2/distribution&lt;/code&gt; ç›®å½•ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ tree -d /var/lib/docker/image/overlay2/distribution

/var/lib/docker/image/overlay2/distribution
â”œâ”€â”€ diffid-by-digest
â”‚Â Â  â””â”€â”€ sha256
â””â”€â”€ v2metadata-by-diffid
    â””â”€â”€ sha256
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;diffid-by-digestï¼š&lt;/strong&gt; å­˜æ”¾ &lt;code&gt;digest&lt;/code&gt; åˆ° &lt;code&gt;diffid&lt;/code&gt; çš„å¯¹åº”å…³ç³»&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;v2metadata-by-diffidï¼š&lt;/strong&gt; å­˜æ”¾ &lt;code&gt;diffid&lt;/code&gt; åˆ° &lt;code&gt;digest&lt;/code&gt; çš„å¯¹åº”å…³ç³»&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#è¿™é‡Œä»¥æœ€åº•å±‚ layer(a94e0d...) ä¸ºä¾‹ï¼ŒæŸ¥çœ‹å…¶ digest ä¿¡æ¯
$ cat /var/lib/docker/image/overlay2/distribution/v2metadata-by-diffid/sha256/db584c622b50c3b8f9b8b94c270cc5fe235e5f23ec4aacea8ce67a8c16e0fbad|jq .

[
  {
    &amp;quot;Digest&amp;quot;: &amp;quot;sha256:b78396653dae2bc0d9c02c0178bd904bb12195b2b4e541a92cd8793ac7d7d689&amp;quot;,
    &amp;quot;SourceRepository&amp;quot;: &amp;quot;docker.io/library/ubuntu&amp;quot;,
    &amp;quot;HMAC&amp;quot;: &amp;quot;&amp;quot;
  }
]

#æ ¹æ® digest å¾—åˆ° diffid
$ cat /var/lib/docker/image/overlay2/distribution/diffid-by-digest/sha256/b78396653dae2bc0d9c02c0178bd904bb12195b2b4e541a92cd8793ac7d7d689

sha256:db584c622b50c3b8f9b8b94c270cc5fe235e5f23ec4aacea8ce67a8c16e0fbad
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;layer-çš„å…ƒæ•°æ®&#34;&gt;layer çš„å…ƒæ•°æ®&lt;/h3&gt;

&lt;p&gt;layer çš„å±æ€§ä¿¡æ¯éƒ½æ”¾åœ¨äº† &lt;code&gt;image/overlay2/layerdb&lt;/code&gt; ç›®å½•ä¸‹ï¼Œç›®å½•åç§°æ˜¯ layer çš„ &lt;code&gt;chainid&lt;/code&gt;ï¼Œç”±äºæœ€åº•å±‚çš„ layer çš„ chainid å’Œ diffid ç›¸åŒï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ç”¨ç¬¬äºŒå±‚ï¼ˆfe9a3f&amp;hellip;ï¼‰ä½œä¸ºç¤ºä¾‹ï¼š&lt;/p&gt;

&lt;div id=&#34;note&#34;&gt;
&lt;p id=&#34;note-title&#34;&gt;Note&lt;/p&gt;
&lt;br /&gt;
&lt;p&gt;è®¡ç®— chainid æ—¶ï¼Œç”¨åˆ°äº†æ‰€æœ‰ç¥–å…ˆ layer çš„ä¿¡æ¯ï¼Œä»è€Œèƒ½ä¿è¯æ ¹æ® chainid å¾—åˆ°çš„ rootfs æ˜¯å”¯ä¸€çš„ã€‚æ¯”å¦‚æˆ‘åœ¨ debian å’Œ ubuntu çš„ image åŸºç¡€ä¸Šéƒ½æ·»åŠ äº†ä¸€ä¸ªåŒæ ·çš„æ–‡ä»¶ï¼Œé‚£ä¹ˆ commit ä¹‹åæ–°å¢åŠ çš„è¿™ä¸¤ä¸ª layer å…·æœ‰ç›¸åŒçš„å†…å®¹ï¼Œç›¸åŒçš„ diffidï¼Œä½†ç”±äºä»–ä»¬çš„çˆ¶ layer ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ä»–ä»¬çš„ chainid ä¼šä¸ä¸€æ ·ï¼Œä»è€Œæ ¹æ® chainid èƒ½æ‰¾åˆ°å”¯ä¸€çš„ rootfsã€‚è®¡ç®— chainid çš„æ–¹æ³•è¯·å‚è€ƒ &lt;a href=&#34;https://github.com/opencontainers/image-spec/blob/master/config.md&#34; target=&#34;_blank&#34;&gt;image spec&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#è®¡ç®— chainid
#è¿™é‡Œ 88888b... æ˜¯ç¬¬äºŒå±‚çš„ diffidï¼Œè€Œ a94e0d... æ˜¯ 88888b... çˆ¶å±‚çš„ chainidï¼Œ
#ç”±äºa94e0d...æ˜¯æœ€åº•å±‚ï¼Œå®ƒæ²¡æœ‰çˆ¶å±‚ï¼Œæ‰€ä»¥ a94e0d... çš„ chainid å°±æ˜¯ a94e0d...
$ echo -n &amp;quot;sha256:a94e0d5a7c404d0e6fa15d8cd4010e69663bd8813b5117fbad71365a73656df9 sha256:88888b9b1b5b7bce5db41267e669e6da63ee95736cb904485f96f29be648bfda&amp;quot;|sha256sum -

14a40a140881d18382e13b37588b3aa70097bb4f3fb44085bc95663bdc68fe20  -

#æ ¹æ® chainid æ¥çœ‹çœ‹ç›¸åº”ç›®å½•çš„å†…å®¹
$ ll /var/lib/docker/image/overlay2/layerdb/sha256/14a40a140881d18382e13b37588b3aa70097bb4f3fb44085bc95663bdc68fe20

total 20K
-rw-r--r-- 1 root root   64 Apr  1 22:16 cache-id
-rw-r--r-- 1 root root   71 Apr  1 22:16 diff
-rw-r--r-- 1 root root   71 Apr  1 22:16 parent
-rw-r--r-- 1 root root    3 Apr  1 22:16 size
-rw-r--r-- 1 root root 1.5K Apr  1 22:16 tar-split.json.gz

#æ¯ä¸ª layer éƒ½æœ‰è¿™æ ·ä¸€ä¸ªå¯¹åº”çš„æ–‡ä»¶å¤¹
#cache-id æ˜¯ docker ä¸‹è½½ layer çš„æ—¶å€™åœ¨æœ¬åœ°ç”Ÿæˆçš„ä¸€ä¸ªéšæœº uuidï¼Œ
#æŒ‡å‘çœŸæ­£å­˜æ”¾ layer æ–‡ä»¶çš„åœ°æ–¹
$ cat /var/lib/docker/image/overlay2/layerdb/sha256/14a40a140881d18382e13b37588b3aa70097bb4f3fb44085bc95663bdc68fe20/cache-id

658299560be0fd7eaf4a14b0927e134049d13eb31070a9902b0d275836a13cfb

#diff æ–‡ä»¶å­˜æ”¾ layer çš„ diffid
$ cat /var/lib/docker/image/overlay2/layerdb/sha256/14a40a140881d18382e13b37588b3aa70097bb4f3fb44085bc95663bdc68fe20/diff

sha256:88888b9b1b5b7bce5db41267e669e6da63ee95736cb904485f96f29be648bfda

#parent æ–‡ä»¶å­˜æ”¾å½“å‰ layer çš„çˆ¶ layer çš„ diffidï¼Œ
#æ³¨æ„ï¼šå¯¹äºæœ€åº•å±‚çš„ layer æ¥è¯´ï¼Œç”±äºæ²¡æœ‰çˆ¶ layerï¼Œæ‰€ä»¥æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶
$ cat /var/lib/docker/image/overlay2/layerdb/sha256/14a40a140881d18382e13b37588b3aa70097bb4f3fb44085bc95663bdc68fe20/parent

sha256:a94e0d5a7c404d0e6fa15d8cd4010e69663bd8813b5117fbad71365a73656df9

#å½“å‰ layer çš„å¤§å°ï¼Œå•ä½æ˜¯å­—èŠ‚
$ cat /var/lib/docker/image/overlay2/layerdb/sha256/14a40a140881d18382e13b37588b3aa70097bb4f3fb44085bc95663bdc68fe20/size

745

#tar-split.json.gzï¼Œlayer å‹ç¼©åŒ…çš„ split æ–‡ä»¶ï¼Œé€šè¿‡è¿™ä¸ªæ–‡ä»¶å¯ä»¥è¿˜åŸ layer çš„ tar åŒ…ï¼Œ
#åœ¨ docker save å¯¼å‡º image çš„æ—¶å€™ä¼šç”¨åˆ°
#è¯¦æƒ…å¯å‚è€ƒ https://github.com/vbatts/tar-split
$ ll /var/lib/docker/image/overlay2/layerdb/sha256/14a40a140881d18382e13b37588b3aa70097bb4f3fb44085bc95663bdc68fe20/tar-split.json.gz

-rw-r--r-- 1 root root 1.5K Apr  1 22:16 /var/lib/docker/image/overlay2/layerdb/sha256/14a40a140881d18382e13b37588b3aa70097bb4f3fb44085bc95663bdc68fe20/tar-split.json.gz
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;p-id-h2-5-layeræ•°æ®-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;5. layeræ•°æ®&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;ä»¥ &lt;code&gt;CentOS&lt;/code&gt; ä¸ºä¾‹ï¼Œæ‰€æœ‰ layer çš„æ–‡ä»¶éƒ½æ”¾åœ¨äº† &lt;code&gt;/var/lib/docker/overlay2&lt;/code&gt; ç›®å½•ä¸‹ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ tree -d -L 2 /var/lib/docker/overlay2

â”œâ”€â”€ 658299560be0fd7eaf4a14b0927e134049d13eb31070a9902b0d275836a13cfb
â”‚Â Â  â”œâ”€â”€ diff
â”‚Â Â  â””â”€â”€ work
â”œâ”€â”€ 66ce99b5da081f65afea7ebaf612229179b620dc728b7407adcb44a51a27ae24
â”‚Â Â  â”œâ”€â”€ diff
â”‚Â Â  â””â”€â”€ work
...
â””â”€â”€ l
    â”œâ”€â”€ DYWQJVCIPQ2P2VFWZ4KBCV2JFW -&amp;gt; ../658299560be0fd7eaf4a14b0927e134049d13eb31070a9902b0d275836a13cfb/diff
    â”œâ”€â”€ 27O3MGWIL6SIN7K4GLVU4DLPSQ -&amp;gt; ../9028bae38f520a09220f67fbcf698aae2326c8318390a1d6005457d51ad97369/diff
...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;â€lâ€œ&lt;/code&gt; ç›®å½•åŒ…å«ä¸€äº›ç¬¦å·é“¾æ¥ä½œä¸ºç¼©çŸ­çš„å±‚æ ‡è¯†ç¬¦. è¿™äº›ç¼©çŸ­çš„æ ‡è¯†ç¬¦ç”¨æ¥é¿å…æŒ‚è½½æ—¶è¶…å‡ºé¡µé¢å¤§å°çš„é™åˆ¶ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ll /var/lib/docker/overlay2/l/

total 0
lrwxrwxrwx 1 root root 72 Mar 29 06:25 27O3MGWIL6SIN7K4GLVU4DLPSQ -&amp;gt; ../9028bae38f520a09220f67fbcf698aae2326c8318390a1d6005457d51ad97369/diff/
lrwxrwxrwx 1 root root 72 Mar 21 00:55 2AYPFAXSXLNCCEA6WRFCAPFPX3 -&amp;gt; ../23eb8415aec245a0291cca62d2da322de241263b8cbdfc690c0a77b353530b10/diff/
lrwxrwxrwx 1 root root 72 Mar 29 02:55 2H2XLZTCOYYSDT3XU2BDJRC2SB -&amp;gt; ../6b27128471bdfc742696ff9820bdfcdda73020753c26efeecea29b98096f0c5d/diff/
lrwxrwxrwx 1 root root 77 Mar 29 05:44 2JQ3OQVJBRYD75J4WTG4CSWA4Z -&amp;gt; ../641300d147b30f162167fed340cebcaae25f46db608939f6af09dbdb7078dcd4-init/diff/
lrwxrwxrwx 1 root root 72 Mar 21 00:55 2TCUOOM7Y7HMGIERRS4CX4YHVA -&amp;gt; ../cd3a3bd11269dc846ee9f79fca86c05336b8dd475d5ca8151991dc5d9fd7261f/diff/
lrwxrwxrwx 1 root root 77 Mar 29 06:24 36WQQRTYLT4P3J7DYLQAUMUPJE -&amp;gt; ../7ee9cc176abeb603ab0461650edd87890d167c579011813d0e864b7524f9fe24-init/diff/
...
&lt;/code&gt;&lt;/pre&gt;

&lt;div id=&#34;note&#34;&gt;
&lt;p id=&#34;note-title&#34;&gt;Note&lt;/p&gt;
&lt;br /&gt;
&lt;p&gt;æ³¨æ„ï¼šç”±äº docker æ‰€é‡‡ç”¨çš„æ–‡ä»¶ç³»ç»Ÿä¸åŒï¼Œ&lt;code&gt;/var/lib/docker/&lt;storage-driver&gt;&lt;/code&gt; ç›®å½•ä¸‹çš„ç›®å½•ç»“æ„åŠç»„ç»‡æ–¹å¼ä¹Ÿä¼šä¸ä¸€æ ·ï¼Œè¦å…·ä½“æ–‡ä»¶ç³»ç»Ÿå…·ä½“åˆ†æï¼Œæœ¬æ–‡åªä»‹ç» overlay2 è¿™ç§æƒ…å†µã€‚
å…³äº aufs å’Œ btrfs çš„ç›¸å…³ç‰¹æ€§å¯ä»¥å‚è€ƒ &lt;a href=&#34;https://segmentfault.com/a/1190000008489207&#34; target=&#34;_blank&#34;&gt;Linux æ–‡ä»¶ç³»ç»Ÿä¹‹ aufs&lt;/a&gt; å’Œ &lt;a href=&#34;https://segmentfault.com/a/1190000008605135&#34; target=&#34;_blank&#34;&gt;Btrfs æ–‡ä»¶ç³»ç»Ÿä¹‹ subvolume ä¸ snapshot&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;

&lt;p&gt;è¿˜æ˜¯ä»¥åˆšæ‰çš„ç¬¬äºŒå±‚ layerï¼ˆ88888b&amp;hellip;ï¼‰ä¸ºä¾‹ï¼Œçœ‹çœ‹å®é™…çš„æ•°æ®ï¼š&lt;/p&gt;

&lt;p&gt;æœ€åº•å±‚åŒ…å« &lt;code&gt;link&lt;/code&gt; æ–‡ä»¶(ä¸åŒ…å« lower æ–‡ä»¶ï¼Œå› ä¸ºæ˜¯æœ€åº•å±‚)ï¼Œåœ¨ä¸Šé¢çš„ç»“æœä¸­ &lt;code&gt;a94e0d...&lt;/code&gt; ä¸ºæœ€åº•å±‚ã€‚ è¿™ä¸ªæ–‡ä»¶è®°å½•ç€ä½œä¸ºæ ‡è¯†ç¬¦çš„æ›´çŸ­çš„ç¬¦å·é“¾æ¥çš„åå­—ã€æœ€åº•å±‚è¿˜æœ‰ä¸€ä¸ª &lt;code&gt;diff&lt;/code&gt; ç›®å½•(åŒ…å«å®é™…å†…å®¹)ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# æŸ¥çœ‹åº•å±‚ a94e0d... çš„ layer å­˜æ”¾çš„åœ°æ–¹
$ cat /var/lib/docker/image/overlay2/layerdb/sha256/a94e0d5a7c404d0e6fa15d8cd4010e69663bd8813b5117fbad71365a73656df9/cache-id

8feee71ff338d03a22ef090f8e5a49771ca8c1f418db345782ff0fb9b9fff3ce

$ ll /var/lib/docker/overlay2/8feee71ff338d03a22ef090f8e5a49771ca8c1f418db345782ff0fb9b9fff3ce/

total 4.0K
drwxr-xr-x 21 root root 224 Apr  1 22:16 diff/
-rw-r--r--  1 root root  26 Apr  1 22:15 link

$ cat  /var/lib/docker/overlay2/8feee71ff338d03a22ef090f8e5a49771ca8c1f418db345782ff0fb9b9fff3ce/link

3GQZNQYZNRAXT6X453L5O73Y5U

$ ll /var/lib/docker/overlay2/l/|grep 3GQZNQYZNRAXT6X453L5O73Y5U

lrwxrwxrwx 1 root root 72 Apr  1 22:15 3GQZNQYZNRAXT6X453L5O73Y5U -&amp;gt; ../8feee71ff338d03a22ef090f8e5a49771ca8c1f418db345782ff0fb9b9fff3ce/diff/

# diff ç›®å½•ä¸‹é¢æ˜¯å±‚çš„å†…å®¹
$ ll /var/lib/docker/overlay2/8feee71ff338d03a22ef090f8e5a49771ca8c1f418db345782ff0fb9b9fff3ce/diff/

total 16K
drwxr-xr-x  2 root root 4.0K Feb 28 14:14 bin/
drwxr-xr-x  2 root root    6 Apr 12  2016 boot/
drwxr-xr-x  4 root root 4.0K Feb 28 14:14 dev/
drwxr-xr-x 42 root root 4.0K Feb 28 14:14 etc/
drwxr-xr-x  2 root root    6 Apr 12  2016 home/
...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»ç¬¬äºŒå±‚å¼€å§‹ï¼Œæ¯å±‚é•œåƒå±‚åŒ…å« &lt;code&gt;lower&lt;/code&gt; æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶çš„å†…å®¹è¡¨ç¤ºçˆ¶å±‚é•œåƒçš„ç¬¦å·é“¾æ¥ï¼Œæ ¹æ®è¿™ä¸ªæ–‡ä»¶å¯ä»¥ç´¢å¼•æ„å»ºå‡ºæ•´ä¸ªé•œåƒçš„å±‚æ¬¡ç»“æ„ã€‚åŒæ—¶è¿˜åŒ…å« &lt;code&gt;merged&lt;/code&gt; å’Œ &lt;code&gt;work&lt;/code&gt; ç›®å½•ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;æ¯å½“å¯åŠ¨ä¸€ä¸ªå®¹å™¨æ—¶ï¼Œä¼šå°† &lt;code&gt;link&lt;/code&gt; æŒ‡å‘çš„é•œåƒå±‚ç›®å½•ä»¥åŠ &lt;code&gt;lower&lt;/code&gt; æŒ‡å‘çš„é•œåƒå±‚ç›®å½•è”åˆæŒ‚è½½åˆ° &lt;code&gt;merged&lt;/code&gt; ç›®å½•ï¼Œå› æ­¤ï¼Œå®¹å™¨å†…çš„è§†è§’å°±æ˜¯ &lt;code&gt;merged&lt;/code&gt; ç›®å½•ä¸‹çš„å†…å®¹ã€‚&lt;/li&gt;
&lt;li&gt;è€Œ work ç›®å½•åˆ™æ˜¯ç”¨æ¥å®Œæˆå¦‚ &lt;code&gt;copy-on_write&lt;/code&gt; çš„æ“ä½œã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ tree -L 1 /var/lib/docker/overlay2/658299560be0fd7eaf4a14b0927e134049d13eb31070a9902b0d275836a13cfb

/var/lib/docker/overlay2/658299560be0fd7eaf4a14b0927e134049d13eb31070a9902b0d275836a13cfb
â”œâ”€â”€ diff
â”œâ”€â”€ link
â”œâ”€â”€ lower
â””â”€â”€ work

# çˆ¶å±‚é•œåƒçš„ç¬¦å·é“¾æ¥
$ cat /var/lib/docker/overlay2/658299560be0fd7eaf4a14b0927e134049d13eb31070a9902b0d275836a13cfb/lower

l/3GQZNQYZNRAXT6X453L5O73Y5U

$ ll /var/lib/docker/overlay2/658299560be0fd7eaf4a14b0927e134049d13eb31070a9902b0d275836a13cfb/diff

total 0
drwxr-xr-x 4 root root 29 Mar  6 17:17 etc/
drwxr-xr-x 2 root root 21 Mar  6 17:17 sbin/
drwxr-xr-x 3 root root 18 Feb 28 14:13 usr/
drwxr-xr-x 3 root root 17 Feb 28 14:14 var/
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;p-id-h2-6-manifestæ–‡ä»¶å»å“ªäº†-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;6. manifestæ–‡ä»¶å»å“ªäº†ï¼Ÿ&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;ä»å‰é¢ä»‹ç» docker pull çš„è¿‡ç¨‹ä¸­å¾—çŸ¥ï¼Œdocker æ˜¯å…ˆå¾—åˆ° &lt;code&gt;manifest&lt;/code&gt;ï¼Œç„¶åæ ¹æ® manifest å¾—åˆ° &lt;code&gt;config&lt;/code&gt; æ–‡ä»¶å’Œ &lt;code&gt;layer&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;å‰é¢å·²ç»ä»‹ç»äº† config æ–‡ä»¶å’Œ layer çš„å­˜å‚¨ä½ç½®ï¼Œä½†å”¯ç‹¬ä¸è§ manifestï¼Œå»å“ªäº†å‘¢ï¼Ÿ&lt;/p&gt;

&lt;p&gt;manifest é‡Œé¢åŒ…å«çš„å†…å®¹å°±æ˜¯å¯¹ config å’Œ layer çš„ &lt;code&gt;sha256 + media type&lt;/code&gt; æè¿°ï¼Œç›®çš„å°±æ˜¯ä¸ºäº†ä¸‹è½½ config å’Œ layerï¼Œç­‰ image ä¸‹è½½å®Œæˆåï¼Œmanifest çš„ä½¿å‘½å°±å®Œæˆäº†ï¼Œé‡Œé¢çš„ä¿¡æ¯å¯¹äº image çš„æœ¬åœ°ç®¡ç†æ¥è¯´æ²¡ä»€ä¹ˆç”¨ï¼Œæ‰€ä»¥ docker åœ¨æœ¬åœ°æ²¡æœ‰å•ç‹¬çš„å­˜å‚¨ä¸€ä»½ manifest æ–‡ä»¶ä¸ä¹‹å¯¹åº”ã€‚&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-7-ç»“æŸè¯­-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;7. ç»“æŸè¯­&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;æœ¬ç¯‡ä»‹ç»äº†imageåœ¨æœ¬åœ°çš„å­˜å‚¨æ–¹å¼ï¼ŒåŒ…æ‹¬äº† &lt;code&gt;/var/lib/docker/image&lt;/code&gt; å’Œ &lt;code&gt;/var/lib/docker/overlay2&lt;/code&gt; è¿™ä¸¤ä¸ªç›®å½•ï¼Œä½† /var/lib/docker/image ä¸‹é¢æœ‰ä¸¤ä¸ªç›®å½•æ²¡æœ‰æ¶‰åŠï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;/var/lib/docker/image/overlay2/imagedb/metadata&lt;/code&gt;ï¼šé‡Œé¢å­˜æ”¾çš„æ˜¯æœ¬åœ° image çš„ä¸€äº›ä¿¡æ¯ï¼Œä»æœåŠ¡å™¨ä¸Š pull ä¸‹æ¥çš„ image ä¸ä¼šå­˜æ•°æ®åˆ°è¿™ä¸ªç›®å½•ï¼Œä¸‹æ¬¡æœ‰æœºä¼šå†è¡¥å……è¿™éƒ¨åˆ†å†…å®¹ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;code&gt;/var/lib/docker/image/overlay2/layerdb/mounts&lt;/code&gt;: åˆ›å»º container æ—¶ï¼Œdocker ä¼šä¸ºæ¯ä¸ª container åœ¨ image çš„åŸºç¡€ä¸Šåˆ›å»ºä¸€å±‚æ–°çš„ layerï¼Œé‡Œé¢ä¸»è¦åŒ…å« /etc/hostsã€/etc/hostnameã€/etc/resolv.conf ç­‰æ–‡ä»¶ï¼Œåˆ›å»ºçš„è¿™ä¸€å±‚ layer ä¿¡æ¯å°±æ”¾åœ¨è¿™é‡Œï¼Œåç»­åœ¨ä»‹ç»å®¹å™¨çš„æ—¶å€™ï¼Œä¼šä¸“é—¨ä»‹ç»è¿™ä¸ªç›®å½•çš„å†…å®¹ã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;p-id-h2-8-å‚è€ƒ-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;8. å‚è€ƒ&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/moby/moby&#34; target=&#34;_blank&#34;&gt;dockeræºä»£ç &lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;style&gt;
#h2{
    margin-bottom:2em;
    margin-right: 5px;
    padding: 8px 15px;
    letter-spacing: 2px;
    background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181));
    background-color: rgb(63, 81, 181);
    color: rgb(255, 255, 255);
    border-left: 10px solid rgb(51, 51, 51);
    border-radius:5px;
    text-shadow: rgb(102, 102, 102) 1px 1px 1px;
    box-shadow: rgb(102, 102, 102) 1px 1px 2px;
}
#note {
    font-size: 1.5rem;
    font-style: italic;
    padding: 0 1rem;
    margin: 2.5rem 0;
    position: relative;
    background-color: #fafeff;
    border-top: 1px dotted #9954bb;
    border-bottom: 1px dotted #9954bb;
}
#note-title {
    padding: 0.2rem 0.5rem;
    background: #9954bb;
    color: #FFF;
    position: absolute;
    left: 0;
    top: 0.25rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    border-radius: 4px;
    -webkit-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    -moz-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    -ms-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    -o-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    transform: rotate(-5deg) translateX(-10px) translateY(-25px);
}
#inline-yellow {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #f0ad4e;
}
#inline-green {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #5cb85c;
}
#inline-blue {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #2780e3;
}
#inline-purple {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #9954bb;
}
#div-border-left-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #df3e3e;
}
#div-border-left-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #f0ad4e;
}
#div-border-left-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #5cb85c;
}
#div-border-left-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #2780e3;
}
#div-border-left-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #9954bb;
}
#div-border-right-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #df3e3e;
}
#div-border-right-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #f0ad4e;
}
#div-border-right-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #5cb85c;
}
#div-border-right-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #2780e3;
}
#div-border-right-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #9954bb;
}
#div-border-top-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #df3e3e;
}
#div-border-top-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #f0ad4e;
}
#div-border-top-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #5cb85c;
}
#div-border-top-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #2780e3;
}
#div-border-top-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #9954bb;
}
&lt;/style&gt;</description>
    </item>
    
    <item>
      <title>Kubernetes ä½¿ç”¨é›†ç¾¤è”é‚¦å®ç°å¤šé›†ç¾¤ç®¡ç†</title>
      <link>https://www.yangcs.net/posts/federation/</link>
      <pubDate>Thu, 22 Mar 2018 09:36:27 +0000</pubDate>
      
      <guid>https://www.yangcs.net/posts/federation/</guid>
      <description>&lt;p&gt;
åœ¨äº‘è®¡ç®—ç¯å¢ƒä¸­ï¼ŒæœåŠ¡çš„ä½œç”¨è·ç¦»èŒƒå›´ä»è¿‘åˆ°è¿œä¸€èˆ¬å¯ä»¥æœ‰ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;åŒä¸»æœºï¼ˆHostï¼ŒNodeï¼‰&lt;/li&gt;
&lt;li&gt;è·¨ä¸»æœºåŒå¯ç”¨åŒºï¼ˆAvailable Zoneï¼‰&lt;/li&gt;
&lt;li&gt;è·¨å¯ç”¨åŒºåŒåœ°åŒºï¼ˆRegionï¼‰&lt;/li&gt;
&lt;li&gt;è·¨åœ°åŒºåŒæœåŠ¡å•†ï¼ˆCloud Service Providerï¼‰&lt;/li&gt;
&lt;li&gt;è·¨äº‘å¹³å°&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;K8s çš„è®¾è®¡å®šä½æ˜¯å•ä¸€é›†ç¾¤åœ¨åŒä¸€ä¸ªåœ°åŸŸå†…ï¼Œå› ä¸ºåŒä¸€ä¸ªåœ°åŒºçš„ç½‘ç»œæ€§èƒ½æ‰èƒ½æ»¡è¶³ K8s çš„è°ƒåº¦å’Œè®¡ç®—å­˜å‚¨è¿æ¥è¦æ±‚ã€‚&lt;/p&gt;

&lt;p&gt;ä½†æ˜¯å®é™…æƒ…å†µä¸­ç»å¸¸é‡åˆ°çš„ä¸€äº›é—®é¢˜ï¼Œå°±æ˜¯å•ä¸ªé›†ç¾¤é€šå¸¸æ— æ³•è·¨å•ä¸ªäº‘å‚å•†çš„å¤šä¸ª Regionï¼Œæ›´ä¸ç”¨è¯´æ”¯æŒè·¨è·¨åŸŸä¸åŒçš„äº‘å‚å•†ã€‚è¿™æ ·ä¼šç»™ä¼ä¸šå¸¦æ¥ä¸€äº›æ‹…å¿§ï¼Œå¦‚ä½•åº”å¯¹å¯ç”¨åŒºçº§åˆ«çš„ Failï¼Œä»¥åŠå®¹ç¾å¤‡ä»½ï¼Ÿæ˜¯å¦ä¼šé€ æˆå‚å•†é”å®šï¼Œå¢åŠ è¿ç§»æˆæœ¬ï¼Ÿå¦‚ä½•åº”å¯¹çº¿ä¸Šçº¿ä¸‹çªå‘æµé‡ï¼Ÿå¦‚ä½•ç»Ÿä¸€ç®¡ç†è°ƒåº¦å®¹å™¨èµ„æºï¼Ÿå•ä¸ªé›†ç¾¤è§„æ¨¡çš„ä¸Šé™ç­‰ç­‰ã€‚&lt;/p&gt;

&lt;p&gt;é›†ç¾¤è”é‚¦ï¼ˆFederationï¼‰å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šè§£å†³è¿™äº›é—®é¢˜ã€‚&lt;code&gt;Federation&lt;/code&gt; æ˜¯å¯ä»¥å°†åˆ†å¸ƒåœ¨å¤šä¸ª Region æˆ–è€…å¤šä¸ªäº‘å‚å•†çš„ Kubernetes é›†ç¾¤æ•´åˆæˆä¸€ä¸ªå¤§çš„é›†ç¾¤ï¼Œç»Ÿä¸€ç®¡ç†ä¸è°ƒåº¦ã€‚&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-1-kubernetesé›†ç¾¤è”é‚¦ä»‹ç»-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;1. Kubernetesé›†ç¾¤è”é‚¦ä»‹ç»&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;h3 id=&#34;ç®¡ç†å¤šä¸ª-kuberntes-é›†ç¾¤&#34;&gt;ç®¡ç†å¤šä¸ª kuberntes é›†ç¾¤&lt;/h3&gt;

&lt;p&gt;&lt;strong&gt;é›†ç¾¤è”é‚¦&lt;/strong&gt;åœ¨æ¶æ„ä¸ŠåŒ kubernetes é›†ç¾¤å¾ˆç›¸ä¼¼ã€‚æœ‰ä¸€ä¸ª&lt;strong&gt;é›†ç¾¤è”é‚¦&lt;/strong&gt;çš„ API server æä¾›ä¸€ä¸ªæ ‡å‡†çš„ Kubernetes APIï¼Œå¹¶ä¸”é€šè¿‡ etcd æ¥å­˜å‚¨çŠ¶æ€ã€‚ä¸åŒçš„æ˜¯ï¼Œä¸€ä¸ªé€šå¸¸çš„Kubernetes åªæ˜¯ç®¡ç†èŠ‚ç‚¹è®¡ç®—ï¼Œè€Œ&lt;strong&gt;é›†ç¾¤è”é‚¦&lt;/strong&gt;ç®¡ç†æ‰€æœ‰çš„ kubernetes é›†ç¾¤ã€‚&lt;/p&gt;

&lt;p&gt;&lt;center&gt;&lt;img src=&#34;http://o7z41ciog.bkt.clouddn.com/federation-api-4x.png&#34; alt=&#34;&#34; /&gt;&lt;/center&gt;&lt;/p&gt;

&lt;p&gt;Federationä¸»è¦åŒ…æ‹¬ä¸‰ä¸ªç»„ä»¶ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;federation-apiserverï¼š&lt;/strong&gt;ç±»ä¼¼ &lt;code&gt;kube-apiserver&lt;/code&gt;ï¼Œä½†æä¾›çš„æ˜¯è·¨é›†ç¾¤çš„ REST API&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;federation-controller-managerï¼š&lt;/strong&gt;ç±»ä¼¼ &lt;code&gt;kube-controller-manager&lt;/code&gt;ï¼Œä½†æä¾›å¤šé›†ç¾¤çŠ¶æ€çš„åŒæ­¥æœºåˆ¶&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;kubefedï¼š&lt;/strong&gt;Federation ç®¡ç†å‘½ä»¤è¡Œå·¥å…·&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ç”¨æˆ·å¯ä»¥é€šè¿‡ Federation çš„ API Server æ³¨å†Œè¯¥ Federation çš„æˆå‘˜ &lt;code&gt;K8s Cluster&lt;/code&gt;ã€‚å½“ç”¨æˆ·é€šè¿‡ Federation çš„ API Server åˆ›å»ºã€æ›´æ”¹ API å¯¹è±¡æ—¶ï¼Œ&lt;code&gt;Federation API Server&lt;/code&gt; ä¼šåœ¨è‡ªå·±æ‰€æœ‰æ³¨å†Œçš„å­ K8s Cluster éƒ½åˆ›å»ºä¸€ä»½å¯¹åº”çš„ API å¯¹è±¡ã€‚&lt;/p&gt;

&lt;p&gt;åœ¨æä¾›ä¸šåŠ¡è¯·æ±‚æœåŠ¡æ—¶ï¼Œ&lt;code&gt;K8s Federation&lt;/code&gt; ä¼šå…ˆåœ¨è‡ªå·±çš„å„ä¸ªå­ Cluster ä¹‹é—´åšè´Ÿè½½å‡è¡¡ï¼Œè€Œå¯¹äºå‘é€åˆ°æŸä¸ªå…·ä½“ &lt;code&gt;K8s Cluster&lt;/code&gt; çš„ä¸šåŠ¡è¯·æ±‚ï¼Œä¼šä¾ç…§è¿™ä¸ª K8s Cluster ç‹¬ç«‹æä¾›æœåŠ¡æ—¶ä¸€æ ·çš„è°ƒåº¦æ¨¡å¼å»åš K8s Cluster å†…éƒ¨çš„è´Ÿè½½å‡è¡¡ã€‚è€ŒCluster ä¹‹é—´çš„è´Ÿè½½å‡è¡¡æ˜¯é€šè¿‡åŸŸåæœåŠ¡çš„è´Ÿè½½å‡è¡¡æ¥å®ç°çš„ã€‚&lt;/p&gt;

&lt;p&gt;æ‰€æœ‰çš„è®¾è®¡éƒ½å°½é‡ä¸å½±å“ K8s Cluster ç°æœ‰çš„å·¥ä½œæœºåˆ¶ï¼Œè¿™æ ·å¯¹äºæ¯ä¸ªå­ K8s é›†ç¾¤æ¥è¯´ï¼Œå¹¶ä¸éœ€è¦æ›´å¤–å±‚çš„æœ‰ä¸€ä¸ª K8s Federationï¼Œä¹Ÿå°±æ˜¯æ„å‘³ç€æ‰€æœ‰ç°æœ‰çš„ K8s ä»£ç å’Œæœºåˆ¶ä¸éœ€è¦å› ä¸º &lt;code&gt;Federation&lt;/code&gt; åŠŸèƒ½æœ‰ä»»ä½•å˜åŒ–ã€‚&lt;/p&gt;

&lt;h3 id=&#34;è·¨é›†ç¾¤æœåŠ¡å‘ç°&#34;&gt;è·¨é›†ç¾¤æœåŠ¡å‘ç°&lt;/h3&gt;

&lt;p&gt;Kubernetes æœ‰ä¸€ä¸ªæ ‡å‡†çš„æ’ä»¶ï¼š&lt;code&gt;kube-dns&lt;/code&gt;ï¼Œè¿™ä¸ªæ’ä»¶å¯ä»¥åœ¨é›†ç¾¤å†…éƒ¨æä¾› DNS æœåŠ¡ï¼Œé€šè¿‡ DNS è§£æ service åå­—æ¥è®¿é—® kubernetes æœåŠ¡ã€‚&lt;br /&gt;&lt;/p&gt;

&lt;p&gt;Kubernetes æœåŠ¡æ˜¯ç”±ä¸€ç»„ kubernetes POD ç»„æˆçš„ï¼Œè¿™äº› POD æ˜¯ä¸€äº›å·²ç»å®¹å™¨åŒ–äº†çš„åº”ç”¨ï¼Œè¿™äº› POD å‰é¢ä½¿ç”¨åˆ°äº†è´Ÿè½½å‡è¡¡å™¨ã€‚&lt;br /&gt;&lt;/p&gt;

&lt;p&gt;å‡å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ª kubernetes é›†ç¾¤ï¼Œè¿™ä¸ªé›†ç¾¤é‡Œé¢æœ‰ä¸€ä¸ªæœåŠ¡å«åš mysqlï¼Œè¿™ä¸ªæœåŠ¡æ˜¯ç”±ä¸€ç»„ mysql POD ç»„æˆçš„ã€‚åœ¨è¿™ä¸ª kubernetes é›†ç¾¤ä¸­ï¼Œå…¶ä»–åº”ç”¨å¯ä»¥é€šè¿‡ DNS æ¥è®¿é—®è¿™ä¸ª mysql æœåŠ¡ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://o7z41ciog.bkt.clouddn.com/federation-dns.jpg&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;è·¨é›†ç¾¤è°ƒåº¦&#34;&gt;è·¨é›†ç¾¤è°ƒåº¦&lt;/h3&gt;

&lt;p id=&#34;div-border-top-red&#34;&gt;ä¸ºäº†è¿½æ±‚é«˜å¯ç”¨æ€§å’Œæ›´é«˜çš„æ€§èƒ½ï¼Œé›†ç¾¤è”é‚¦èƒ½å¤ŸæŠŠä¸åŒ POD æŒ‡å®šç»™ä¸åŒçš„ Kubernetes é›†ç¾¤ä¸­ã€‚é›†ç¾¤è”é‚¦è°ƒåº¦å™¨å°†å†³å®šå¦‚ä½•åœ¨ä¸åŒ kubernetes é›†ç¾¤ä¸­åˆ†é…å·¥ä½œè´Ÿè½½ã€‚&lt;/p&gt;

&lt;p&gt;é€šè¿‡è·¨é›†ç¾¤è°ƒåº¦ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;è·¨ kubernetes é›†ç¾¤å‡åŒ€çš„è°ƒåº¦ä»»åŠ¡è´Ÿè½½&lt;/li&gt;
&lt;li&gt;å°†å„ä¸ª kubernetes é›†ç¾¤çš„å·¥ä½œè´Ÿè½½è¿›è¡Œæœ€å¤§åŒ–ï¼Œå¦‚æœå½“å‰ kubernetes é›†ç¾¤è¶…å‡ºäº†æ‰¿å—èƒ½åŠ›ï¼Œé‚£ä¹ˆå°†é¢å¤–çš„å·¥ä½œè´Ÿè½½è·¯ç”±åˆ°å¦ä¸€ä¸ªæ¯”è¾ƒç©ºé—²çš„ kubernetes é›†ç¾¤ä¸­&lt;/li&gt;
&lt;li&gt;æ ¹æ®åº”ç”¨åœ°ç†åŒºåŸŸéœ€æ±‚ï¼Œè°ƒåº¦å·¥ä½œè´Ÿè½½åˆ°ä¸åŒçš„ kubernetes é›†ç¾¤ä¸­ï¼Œå¯¹äºä¸åŒçš„ç»ˆç«¯ç”¨æˆ·ï¼Œæä¾›æ›´é«˜çš„å¸¦å®½å’Œæ›´ä½çš„å»¶è¿Ÿã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;é›†ç¾¤é«˜å¯ç”¨-æ•…éšœè‡ªåŠ¨è¿ç§»&#34;&gt;é›†ç¾¤é«˜å¯ç”¨ï¼Œæ•…éšœè‡ªåŠ¨è¿ç§»&lt;/h3&gt;

&lt;p&gt;é›†ç¾¤è”é‚¦å¯ä»¥è·¨é›†ç¾¤å†—é¦€éƒ¨ç½²ï¼Œå½“æŸä¸ªé›†ç¾¤æ‰€åœ¨åŒºåŸŸå‡ºç°æ•…éšœæ—¶ï¼Œå¹¶ä¸å½±å“æ•´ä¸ªæœåŠ¡ã€‚é›†ç¾¤è”é‚¦è¿˜å¯ä»¥æ£€æµ‹é›†ç¾¤æ˜¯å¦ä¸ºä¸å¯ç”¨çŠ¶æ€ï¼Œå¦‚æœå‘ç°æŸä¸ªé›†ç¾¤ä¸ºä¸å¯ç”¨çŠ¶æ€æ—¶ï¼Œå¯ä»¥å°†å¤±è´¥çš„ä»»åŠ¡é‡æ–°åˆ†é…ç»™é›†ç¾¤è”é‚¦ä¸­å…¶ä»–å¯ç”¨çŠ¶æ€çš„é›†ç¾¤ä¸Šã€‚&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-2-ä½¿ç”¨é›†ç¾¤è”é‚¦å®ç°å¤šé›†ç¾¤ç®¡ç†-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;2. ä½¿ç”¨é›†ç¾¤è”é‚¦å®ç°å¤šé›†ç¾¤ç®¡ç†&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;h3 id=&#34;ç³»ç»Ÿç¯å¢ƒ&#34;&gt;ç³»ç»Ÿç¯å¢ƒ&lt;/h3&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&#34;left&#34;&gt;åŠŸèƒ½ç»„ä»¶&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;ç³»ç»Ÿç»„ä»¶&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;ç³»ç»Ÿç‰ˆæœ¬&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;è®¾å¤‡æ•°é‡&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;å¤‡æ³¨&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&#34;left&#34;&gt;è”é‚¦é›†ç¾¤æ§åˆ¶å¹³é¢&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;k8s 1.9+Federation&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;CentOS 7.3&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;3å°&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;è”é‚¦é›†ç¾¤æ§åˆ¶å¹³é¢&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;left&#34;&gt;K8sé›†ç¾¤01&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;k8s 1.9 master+node&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;CentOS 7.3&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;3å°&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;è”é‚¦é›†ç¾¤èŠ‚ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;&lt;br /&gt;
&lt;style type=&#34;text/css&#34;&gt;
.tg  {border-collapse:collapse;border-spacing:0;border-color:#aabcfe;}
.tg td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:0px;overflow:hidden;word-break:normal;border-color:#aabcfe;color:#669;background-color:#e8edff;}
.tg th{font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 5px;border-style:solid;border-width:0px;overflow:hidden;word-break:normal;border-color:#aabcfe;color:#039;background-color:#b9c9fe;}
.tg .tg-l711{border-color:inherit}
.tg .tg-us36{border-color:inherit;vertical-align:top}
&lt;/style&gt;
&lt;table class=&#34;tg&#34;&gt;
  &lt;tr&gt;
    &lt;th class=&#34;tg-l711&#34;&gt;åŠŸèƒ½ç»„ä»¶&lt;/th&gt;
    &lt;th class=&#34;tg-l711&#34;&gt;ç³»ç»Ÿç»„ä»¶&lt;/th&gt;
    &lt;th class=&#34;tg-us36&#34;&gt;ç³»ç»Ÿç‰ˆæœ¬&lt;/th&gt;
    &lt;th class=&#34;tg-us36&#34;&gt;è®¾å¤‡æ•°é‡&lt;/th&gt;
    &lt;th class=&#34;tg-us36&#34;&gt;å¤‡æ³¨&lt;/th&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td class=&#34;tg-l711&#34;&gt;è”é‚¦é›†ç¾¤æ§åˆ¶å¹³é¢&lt;/td&gt;
    &lt;td class=&#34;tg-l711&#34;&gt;k8s 1.9+Federation&lt;/td&gt;
    &lt;td class=&#34;tg-us36&#34;&gt;CentOS 7.3&lt;/td&gt;
    &lt;td class=&#34;tg-us36&#34;&gt;3å°&lt;/td&gt;
    &lt;td class=&#34;tg-us36&#34;&gt;è”é‚¦é›†ç¾¤æ§åˆ¶å¹³é¢&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td class=&#34;tg-l711&#34;&gt;K8sé›†ç¾¤01&lt;/td&gt;
    &lt;td class=&#34;tg-l711&#34;&gt;k8s 1.9 master+node&lt;/td&gt;
    &lt;td class=&#34;tg-us36&#34;&gt;CentOS 7.3&lt;/td&gt;
    &lt;td class=&#34;tg-us36&#34;&gt;3å°&lt;/td&gt;
    &lt;td class=&#34;tg-us36&#34;&gt;è”é‚¦é›†ç¾¤èŠ‚ç‚¹&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h3 id=&#34;å®‰è£…-kubefed&#34;&gt;å®‰è£… kubefed&lt;/h3&gt;

&lt;p&gt;é€‰æ‹©å…¶ä¸­çš„ä¸€ä¸ªé›†ç¾¤ä½œä¸ºä¸»é›†ç¾¤ï¼Œè¿™ä¸ªä¸»é›†ç¾¤å°†è¿è¡Œç»„æˆè”é‚¦æ§åˆ¶é¢æ¿çš„æ‰€æœ‰ç»„ä»¶ã€‚&lt;/p&gt;

&lt;p&gt;ä½¿ç”¨ä¸‹åˆ—å‘½ä»¤ä¸‹è½½å¯¹åº”æœ€æ–°å‘è¡Œçš„ &lt;code&gt;kubefed&lt;/code&gt; å®‰è£…åŒ…å¹¶å°†å®‰è£…åŒ…é‡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶è§£å‹å‡ºæ¥ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ curl -LO https://storage.cloud.google.com/kubernetes-federation-release/release/${RELEASE-VERSION}/federation-client-linux-amd64.tar.gz
$ tar -xzvf federation-client-linux-amd64.tar.gz
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¯·ç”¨&lt;a href=&#34;https://github.com/kubernetes/federation/releases&#34; target=&#34;_blank&#34;&gt;federation release page&lt;/a&gt;é¡µé¢å®é™…çš„ç‰ˆæœ¬å·æ›¿æ¢å˜é‡ &lt;code&gt;RELEASE-VERSION&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;å°†è§£å‹å‡ºæ¥çš„å†…å®¹å¤åˆ¶åˆ°ä½ çš„ç¯å¢ƒå˜é‡ &lt;code&gt;$PATH&lt;/code&gt; é‡Œçš„éšä¾¿ä¸€ä¸ªè·¯å¾„ï¼Œ å¹¶è®¾ç½®å¯æ‰§è¡Œæƒé™ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cp federation/client/bin/kubefed /usr/local/bin
$ chmod +x /usr/local/bin/kubefed
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;é…ç½®-context&#34;&gt;é…ç½® context&lt;/h3&gt;

&lt;p&gt;åœ¨å‡†å¤‡é…ç½®è”é‚¦é›†ç¾¤çš„ DCE é›†ç¾¤ä¸­é…ç½®ä¸¤ä¸ª DCE é›†ç¾¤çš„ &lt;code&gt;context&lt;/code&gt;ã€‚è®©æ”¹èŠ‚ç‚¹èƒ½é€šè¿‡åˆ‡æ¢ &lt;code&gt;context&lt;/code&gt; è¿æ¥ä¸åŒçš„å­é›†ç¾¤ã€‚&lt;/p&gt;

&lt;p&gt;å…ˆåˆ›å»ºæœ¬åœ°é›†ç¾¤çš„ &lt;code&gt;kubeconfig&lt;/code&gt; æ–‡ä»¶&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ export KUBE_APISERVER=&amp;quot;https://192.168.123.250:6443&amp;quot;
# è®¾ç½®é›†ç¾¤å‚æ•°
$ kubectl config set-cluster kubernetes \
  --certificate-authority=/etc/kubernetes/ssl/ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER}
# è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°
$ kubectl config set-credentials admin \
  --client-certificate=/etc/kubernetes/ssl/admin.pem \
  --embed-certs=true \
  --client-key=/etc/kubernetes/ssl/admin-key.pem
# è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°
$ kubectl config set-context kubernetes \
  --cluster=kubernetes \
  --user=admin
# è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡
$ kubectl config use-context kubernetes
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç”Ÿæˆçš„ kubeconfig è¢«ä¿å­˜åˆ° &lt;code&gt;~/.kube/config&lt;/code&gt; æ–‡ä»¶ã€‚&lt;/p&gt;

&lt;div id=&#34;note&#34;&gt;
&lt;p id=&#34;note-title&#34;&gt;Note&lt;/p&gt;
&lt;br /&gt;
&lt;p&gt;~/.kube/config æ–‡ä»¶æ‹¥æœ‰å¯¹è¯¥é›†ç¾¤çš„æœ€é«˜æƒé™ï¼Œè¯·å¦¥å–„ä¿ç®¡ã€‚&lt;/p&gt;
&lt;/div&gt;

&lt;p&gt;é…ç½®ç»“æœå¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl config get-contexts

CURRENT   NAME          CLUSTER       AUTHINFO      NAMESPACE
*         kubernetes    kubernetes    admin
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;è®¾ç½®-coredns-ä½œä¸ºé›†ç¾¤è”é‚¦çš„-dns-æä¾›å•†&#34;&gt;è®¾ç½® CoreDNS ä½œä¸ºé›†ç¾¤è”é‚¦çš„ DNS æä¾›å•†&lt;/h3&gt;

&lt;h4 id=&#34;1-å‰æ&#34;&gt;1. å‰æ&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;ä¸ºå¯ç”¨ &lt;code&gt;CoreDNS&lt;/code&gt; æ¥å®ç°è·¨è”é‚¦é›†ç¾¤çš„æœåŠ¡å‘ç°ï¼Œè”é‚¦çš„æˆå‘˜é›†ç¾¤ä¸­å¿…é¡»æ”¯æŒ &lt;code&gt;LoadBalancer&lt;/code&gt; æœåŠ¡ã€‚ï¼ˆ&lt;font color=&#34;red&#34;&gt;æœ¬åœ°é›†ç¾¤é»˜è®¤ä¸æ”¯æŒ &lt;code&gt;LoadBalancer&lt;/code&gt; æœåŠ¡ï¼Œæ‰€ä»¥è¦è®©æœ¬åœ°é›†ç¾¤æ”¯æŒ &lt;code&gt;LoadBalancer&lt;/code&gt; æœåŠ¡æ‰èƒ½ä½¿ç”¨ &lt;code&gt;coredns&lt;/code&gt; æ¥å®ç° federation çš„æœåŠ¡å‘ç°åŠŸèƒ½ï¼ï¼ï¼&lt;/font&gt;ï¼‰&lt;/li&gt;
&lt;li&gt;æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ &lt;code&gt;helm charts&lt;/code&gt; æ¥éƒ¨ç½² CoreDNSã€‚ CoreDNS éƒ¨ç½²æ—¶ä¼šä»¥ etcd ä½œä¸ºåç«¯ï¼Œå¹¶ä¸” etcd åº”é¢„å…ˆå®‰è£…ã€‚ etcd ä¹Ÿå¯ä»¥åˆ©ç”¨ helm charts è¿›è¡Œéƒ¨ç½²ã€‚&lt;/li&gt;
&lt;li&gt;æ‰€æœ‰åŠ å…¥ federation çš„é›†ç¾¤çš„ node å¿…é¡»æ‰“ä¸Šä»¥ä¸‹çš„æ ‡ç­¾ï¼š&lt;br /&gt;
&lt;code&gt;failure-domain.beta.kubernetes.io/region=&amp;lt;region&amp;gt;&lt;/code&gt;&lt;br /&gt;
&lt;code&gt;failure-domain.beta.kubernetes.io/zone=&amp;lt;zone&amp;gt;&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;2-ä½¿æœ¬åœ°é›†ç¾¤æ”¯æŒ-loadbalancer-æœåŠ¡&#34;&gt;2. ä½¿æœ¬åœ°é›†ç¾¤æ”¯æŒ LoadBalancer æœåŠ¡&lt;/h4&gt;

&lt;p&gt;ä¸ºäº†ä½¿æœ¬åœ°é›†ç¾¤æ”¯æŒ &lt;code&gt;LoadBalancer&lt;/code&gt; æœåŠ¡ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹ä¸¤ç§å®ç°æ–¹æ¡ˆï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/munnerz/keepalived-cloud-provider&#34; target=&#34;_blank&#34;&gt;keepalived-cloud-provider&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/google/metallb&#34; target=&#34;_blank&#34;&gt;metalLB&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;è¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ &lt;code&gt;metalLB&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;metalLB çš„éƒ¨ç½²å¾ˆç®€å•ï¼Œç›´æ¥ä½¿ç”¨ yaml æ–‡ä»¶éƒ¨ç½²ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl apply -f https://raw.githubusercontent.com/google/metallb/v0.5.0/manifests/metallb.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…·ä½“å‚è€ƒ &lt;a href=&#34;https://metallb.universe.tf/installation/&#34; target=&#34;_blank&#34;&gt;https://metallb.universe.tf/installation/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;éƒ¨ç½²å®Œæˆåéœ€è¦ä¸º LoadBalancer æœåŠ¡é€‰æ‹©ä¸€ä¸ªç‰¹å®šçš„ IP åœ°å€æ± ï¼Œè¿™é‡Œé€šè¿‡ configmap æ¥åˆ›å»ºã€‚&lt;/p&gt;

&lt;p&gt;ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•ç¤ºä¾‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cat metallb-cm.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: metallb-system
  name: config
data:
  config: |
    address-pools:
    - name: default
      protocol: layer2
      addresses:
      - 192.168.1.58-192.168.1.60

$ kubectl create -f metallb-cm.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ›´å¤šé«˜çº§é…ç½®è¯·å‚è€ƒï¼š&lt;a href=&#34;https://metallb.universe.tf/configuration/&#34; target=&#34;_blank&#34;&gt;https://metallb.universe.tf/configuration/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;ç°åœ¨æœ¬åœ°é›†ç¾¤å·²ç»æ”¯æŒ LoadBalancer æœåŠ¡äº†ï¼Œä¸‹é¢æˆ‘ä»¬å¼€å§‹ federation çš„æ—…ç¨‹å§ï¼ğŸ‘&lt;/p&gt;

&lt;h4 id=&#34;3-å®‰è£…-helm&#34;&gt;3. å®‰è£… helm&lt;/h4&gt;

&lt;p&gt;é¦–å…ˆéœ€è¦å®‰è£… &lt;code&gt;helm&lt;/code&gt; å®¢æˆ·ç«¯&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ curl https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get &amp;gt; get_helm.sh
$ chmod 700 get_helm.sh
$ ./get_helm.sh
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åˆ›å»º tiller çš„ &lt;code&gt;serviceaccount&lt;/code&gt; å’Œ &lt;code&gt;clusterrolebinding&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl create serviceaccount --namespace kube-system tiller
$ kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶åå®‰è£… helm æœåŠ¡ç«¯ &lt;code&gt;tiller&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ helm init
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸ºåº”ç”¨ç¨‹åºè®¾ç½® &lt;code&gt;serviceAccount&lt;/code&gt;ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl patch deploy --namespace kube-system tiller-deploy -p &#39;{&amp;quot;spec&amp;quot;:{&amp;quot;template&amp;quot;:{&amp;quot;spec&amp;quot;:{&amp;quot;serviceAccount&amp;quot;:&amp;quot;tiller&amp;quot;}}}}&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl -n kube-system get pods|grep tiller

tiller-deploy-7bf964fff8-sklts                1/1       Running   0          7h

$ helm version

Client: &amp;amp;version.Version{SemVer:&amp;quot;v2.8.2&amp;quot;, GitCommit:&amp;quot;a80231648a1473929271764b920a8e346f6de844&amp;quot;, GitTreeState:&amp;quot;clean&amp;quot;}
Server: &amp;amp;version.Version{SemVer:&amp;quot;v2.8.2&amp;quot;, GitCommit:&amp;quot;a80231648a1473929271764b920a8e346f6de844&amp;quot;, GitTreeState:&amp;quot;clean&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h4 id=&#34;4-éƒ¨ç½²-etcd&#34;&gt;4. éƒ¨ç½² etcd&lt;/h4&gt;

&lt;p&gt;ä¸‹è½½ &lt;code&gt;helm charts&lt;/code&gt; ä»“åº“&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ git clone https://github.com/kubernetes/charts.git
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;éƒ¨ç½² &lt;code&gt;etcd-operator&lt;/code&gt;ï¼ˆetcd-operator ä¼šé€šè¿‡ kubernetes çš„ &lt;code&gt;CustomResourceDefinition&lt;/code&gt; è‡ªåŠ¨åˆ›å»º &lt;code&gt;etcd cluster&lt;/code&gt;ï¼‰&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cd charts

$ helm install --name etcd-operator stable/etcd-operator --set rbac.install=true,rbac.apiVersion=v1,customResources.createEtcdClusterCRD=true
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ£€æŸ¥æ˜¯å¦éƒ¨ç½²æˆåŠŸ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl get pods

NAME                                                              READY     STATUS    RESTARTS   AGE
etcd-cluster-6skfqj9mwp                                           1/1       Running   0          7m
etcd-cluster-6w8ntzvkwm                                           1/1       Running   0          8m
etcd-cluster-mclzhqrldf                                           1/1       Running   0          7m
etcd-operator-etcd-operator-etcd-backup-operator-5df985959bvvkw   1/1       Running   0          9m
etcd-operator-etcd-operator-etcd-operator-58d98b95c-x44bz         1/1       Running   0          9m
etcd-operator-etcd-operator-etcd-restore-operator-8688c7684nmdh   1/1       Running   0          9m

$ kubectl get crd

NAME                                    AGE
etcdbackups.etcd.database.coreos.com    1d
etcdclusters.etcd.database.coreos.com   1d
etcdrestores.etcd.database.coreos.com   1d

$ kubectl get crd etcdclusters.etcd.database.coreos.com -o yaml

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
...
...
spec:
  group: etcd.database.coreos.com
  names:
    kind: EtcdCluster
    listKind: EtcdClusterList
    plural: etcdclusters
    shortNames:
    - etcd
    singular: etcdcluster
  scope: Namespaced
  version: v1beta2
...
...

$ kubectl get EtcdCluster

NAME           AGE
etcd-cluster   11m

$ kubectl get svc

NAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
etcd-cluster            ClusterIP   None             &amp;lt;none&amp;gt;        2379/TCP,2380/TCP   17m
etcd-cluster-client     ClusterIP   10.254.140.7     &amp;lt;none&amp;gt;        2379/TCP            17m
etcd-restore-operator   ClusterIP   10.254.177.113   &amp;lt;none&amp;gt;        19999/TCP           18m
kubernetes              ClusterIP   10.254.0.1       &amp;lt;none&amp;gt;        443/TCP             16d
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;éƒ¨ç½²æˆåŠŸåï¼Œå¯ä»¥åœ¨ host é›†ç¾¤å†…é€šè¿‡ &lt;a href=&#34;http://etcd-cluster-client.default:2379&#34; target=&#34;_blank&#34;&gt;http://etcd-cluster-client.default:2379&lt;/a&gt; ç«¯ç‚¹è®¿é—® etcdã€‚&lt;/p&gt;

&lt;h4 id=&#34;5-éƒ¨ç½²-coredns&#34;&gt;5. éƒ¨ç½² CoreDNS&lt;/h4&gt;

&lt;p&gt;é¦–å…ˆéœ€è¦å®šåˆ¶ &lt;code&gt;CoreDNS chart&lt;/code&gt; æ¨¡æ¿çš„é»˜è®¤é…ç½®ï¼Œå®ƒä¼šè¦†ç›– &lt;code&gt;CoreDNS chart&lt;/code&gt; çš„é»˜è®¤é…ç½®å‚æ•°ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cat Value.yaml

isClusterService: false
serviceType: &amp;quot;NodePort&amp;quot;
plugins:
  kubernetes:
    enabled: false
  etcd:
    enabled: true
    zones:
    - &amp;quot;example.com.&amp;quot;
    endpoint: &amp;quot;http://etcd-cluster-client.default:2379&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å‚æ•°è¯´æ˜ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;isClusterService&lt;/code&gt;: æŒ‡å®š CoreDNS æ˜¯å¦ä»¥é›†ç¾¤æœåŠ¡çš„å½¢å¼éƒ¨ç½²ï¼ˆé»˜è®¤ä¸ºæ˜¯ï¼‰ã€‚ éœ€è¦å°†å…¶è®¾ç½®ä¸º â€œfalseâ€ï¼Œä»¥ä½¿ CoreDNS ä»¥ Kubernetes åº”ç”¨æœåŠ¡çš„å½¢å¼éƒ¨ç½²ï¼Œå¦åˆ™ä¼šä¸é›†ç¾¤çš„ dns æœåŠ¡ kubedns å†²çªã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;serviceType&lt;/code&gt;: æŒ‡å®šä¸º CoreDNS åˆ›å»ºçš„ Kubernetes æœåŠ¡ç±»å‹ã€‚ é€‰æ‹© â€œNodePortâ€ï¼Œä»¥ä½¿å¾— CoreDNS æœåŠ¡èƒ½å¤Ÿä» Kubernetes é›†ç¾¤å¤–éƒ¨è®¿é—®ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;plugins.kubernetes&lt;/code&gt;: é»˜è®¤æ˜¯å¯ç”¨çš„ï¼Œé€šè¿‡å°† &lt;code&gt;plugins.kubernetes.enabled&lt;/code&gt; è®¾ç½®ä¸º â€œfalseâ€ æ¥ç¦ç”¨ plugins.kubernetesã€‚&lt;/li&gt;
&lt;li&gt;é€šè¿‡å°† plugins.etcd.enabled è®¾ç½®ä¸º â€œtrueâ€ æ¥å¯ç”¨ plugins.etcdã€‚&lt;/li&gt;
&lt;li&gt;é€šè¿‡è®¾ç½® &lt;code&gt;plugins.etcd.zones&lt;/code&gt; æ¥é…ç½® CoreDNS è¢«æˆæƒçš„ DNS åŒºåŸŸï¼ˆè”é‚¦åŒºåŸŸï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;é€šè¿‡è®¾ç½® &lt;code&gt;plugins.etcd.endpoint&lt;/code&gt; æ¥è®¾ç½®å…ˆå‰éƒ¨ç½²çš„ etcd çš„ç«¯ç‚¹ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ç°åœ¨è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥éƒ¨ç½² CoreDNSï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ helm install --name coredns -f Values.yaml stable/coredns
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;éªŒè¯éƒ¨ç½²ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl get pods -l app=coredns-coredns

NAME                               READY     STATUS    RESTARTS   AGE
coredns-coredns-57b54ddb97-xffnc   1/1       Running   0          1d

$ kubectl get svc -l app=coredns-coredns

NAME              TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)                                    AGE
coredns-coredns   NodePort   10.254.198.211   &amp;lt;none&amp;gt;        53:27165/UDP,53:27165/TCP,9153:26492/TCP   1d
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h4 id=&#34;6-ä½¿ç”¨-coredns-ä½œä¸º-dns-æä¾›å•†æ¥éƒ¨ç½²-federation&#34;&gt;6. ä½¿ç”¨ CoreDNS ä½œä¸º DNS æä¾›å•†æ¥éƒ¨ç½² Federation&lt;/h4&gt;

&lt;p&gt;å¯ä»¥ä½¿ç”¨ &lt;code&gt;kubefed init&lt;/code&gt; æ¥éƒ¨ç½²è”é‚¦æ§åˆ¶å¹³é¢ã€‚ å¯ä»¥é€šè¿‡æŒ‡å®šä¸¤ä¸ªé™„åŠ å‚æ•°æ¥é€‰æ‹© CoreDNS ä½œä¸º DNS æä¾›å•†ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;--dns-provider=coredns
--dns-provider-config=coredns-provider.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;coredns-provider.conf å†…å®¹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[Global]
etcd-endpoints = http://etcd-cluster-client.default:2379
zones = example.com.
coredns-endpoints = &amp;lt;coredns-server-ip&amp;gt;:&amp;lt;port&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;etcd-endpoints&lt;/code&gt; æ˜¯è®¿é—® etcd çš„ç«¯ç‚¹ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;zones&lt;/code&gt; æ˜¯ CoreDNS è¢«æˆæƒçš„è”é‚¦åŒºåŸŸï¼Œå…¶å€¼ä¸ &lt;code&gt;kubefed init&lt;/code&gt; çš„ â€“-dns-zone-name å‚æ•°ç›¸åŒã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;coredns-endpoints&lt;/code&gt; æ˜¯è®¿é—® CoreDNS æœåŠ¡å™¨çš„ç«¯ç‚¹ã€‚ è¿™æ˜¯ä¸€ä¸ª 1.7 ç‰ˆæœ¬å¼€å§‹å¼•å…¥çš„å¯é€‰å‚æ•°ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;div id=&#34;note&#34;&gt;
&lt;p id=&#34;note-title&#34;&gt;Note&lt;/p&gt;
&lt;br /&gt;
&lt;p&gt;CoreDNS é…ç½®ä¸­çš„ &lt;code&gt;plugins.etcd.zones&lt;/code&gt; ä¸ kubefed init çš„ â€“-dns-zone-name å‚æ•°åº”åŒ¹é…ã€‚&lt;/p&gt;
&lt;/div&gt;

&lt;p&gt;ç»™æ‰€æœ‰ node æ‰“ä¸Š &lt;code&gt;region&lt;/code&gt; å’Œ &lt;code&gt;zone&lt;/code&gt; çš„æ ‡ç­¾ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl label nodes 192.168.123.248 failure-domain.beta.kubernetes.io/zone=shanghai failure-domain.beta.kubernetes.io/region=yangpu

$ kubectl label nodes 192.168.123.249 failure-domain.beta.kubernetes.io/zone=shanghai failure-domain.beta.kubernetes.io/region=yangpu

$ kubectl label nodes 192.168.123.250 failure-domain.beta.kubernetes.io/zone=shanghai failure-domain.beta.kubernetes.io/region=yangpu
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é€šè¿‡æœ¬æ¡å‘½ä»¤åˆå§‹åŒ– federation æ§åˆ¶å¹³é¢ï¼Œå‚æ•°å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubefed init federation \ # è”é‚¦çš„åå­—
  --host-cluster-context=kubernetes \ # ä¸»é›†ç¾¤çš„contextåå­—
  --dns-provider=coredns \ # DNSæœåŠ¡æä¾›å•†
  --dns-zone-name=&amp;quot;example.com.&amp;quot; \ # å‰é¢æ³¨å†Œå¥½çš„åŸŸåï¼Œå¿…é¡»ä»¥.ç»“æŸ
  --dns-provider-config=&amp;quot;coredns-provider.conf&amp;quot; \ # coredns é…ç½®æ–‡ä»¶
  --api-server-service-type=&amp;quot;NodePort&amp;quot; \
  --api-server-advertise-address=&amp;quot;192.168.123.250&amp;quot;

  Creating a namespace federation-system for federation system components... done
  Creating federation control plane service..... done
  Creating federation control plane objects (credentials, persistent volume claim)... done
  Creating federation component deployments... done
  Updating kubeconfig... done
  Waiting for federation control plane to come up..................................................................................................................................................... done
  Federation API server is running at: 10.110.151.216
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è§‚å¯Ÿä»¥ä¸Šè¾“å‡ºä¿¡æ¯ï¼Œè¯¥å‘½ä»¤åšäº†ä»¥ä¸‹å‡ ä»¶äº‹æƒ…ï¼š&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;åˆ›å»ºä¸€ä¸ª namespace &lt;code&gt;federation-system&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl get ns

NAME                STATUS    AGE
default             Active    8d
federation-system   Active    8s
kube-public         Active    8d
kube-system         Active    8d
my-namespace        Active    7d
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;åˆ›å»ºä¸¤ä¸ªæœåŠ¡ &lt;code&gt;federation-apiserver&lt;/code&gt; å’Œ &lt;code&gt;federation-controller-manager&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl -n federation-system get pods

NAME                                             READY     STATUS         RESTARTS   AGE
federation-apiserver-909415585-wktmw             1/1       Running   0          2s
federation-controller-manager-4247980660-c8ls5   1/1       Running   1          3s
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;åˆ›å»ºä¸€ä¸ª ServiceAccount &lt;code&gt;federation-controller-manager&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl -n federation-system get sa

NAME                            SECRETS   AGE
default                         1         31m
federation-controller-manager   1         31m
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;åˆ›å»ºä¸€ä¸ª Role &lt;code&gt;federation-system:federation-controller-manager&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl -n federation-system get role

NAME                                              AGE
federation-system:federation-controller-manager   38m
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;åˆ›å»ºä¸€ä¸ª RoleBinding &lt;code&gt;federation-system:federation-controller-manager&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl -n federation-system get rolebinding

NAME                                              AGE
federation-system:federation-controller-manager   39m
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;åˆ›å»ºä¸€ä¸ª context &lt;code&gt;federation&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;    $ kubectl config get-contexts

    CURRENT   NAME         CLUSTER      AUTHINFO     NAMESPACE
              federation   federation   federation
    *         kubernetes   kubernetes   admin
&lt;/code&gt;&lt;/pre&gt;

&lt;div id=&#34;note&#34;&gt;
&lt;p id=&#34;note-title&#34;&gt;Note&lt;/p&gt;
&lt;br /&gt;
&lt;p&gt;é»˜è®¤æƒ…å†µä¸‹ï¼Œ&lt;code&gt;kubefed init&lt;/code&gt; é€šè¿‡åŠ¨æ€åˆ›å»º PV çš„æ–¹å¼ä¸º etcd åˆ›å»ºæŒä¹…åŒ–å­˜å‚¨ã€‚å¦‚æœ kubernetes é›†ç¾¤ä¸æ”¯æŒåŠ¨æ€åˆ›å»º PVï¼Œåˆ™å¯ä»¥é¢„å…ˆåˆ›å»º PVï¼Œæ³¨æ„ PV è¦åŒ¹é… `kubefed` çš„ PVCã€‚æˆ–è€…ä½¿ç”¨ &lt;code&gt;hostpath&lt;/code&gt;ï¼ŒåŒæ—¶æŒ‡å®šè°ƒåº¦èŠ‚ç‚¹ã€‚&lt;/p&gt;
&lt;/div&gt;

&lt;h4 id=&#34;7-æ·»åŠ é›†ç¾¤è‡³-federation&#34;&gt;7. æ·»åŠ é›†ç¾¤è‡³ federation&lt;/h4&gt;

&lt;p&gt;ç›®å‰ä¸ºæ­¢æ‚¨å·²ç»æˆåŠŸçš„åˆå§‹åŒ–å¥½äº† &lt;code&gt;Federation&lt;/code&gt; çš„æ§åˆ¶å¹³é¢ã€‚æ¥ä¸‹æ¥éœ€è¦å°†å„ä¸ªå­é›†ç¾¤åŠ å…¥åˆ° Federation é›†ç¾¤ä¸­ã€‚&lt;/p&gt;

&lt;p&gt;æ·»åŠ é›†ç¾¤ &lt;code&gt;kubernetes&lt;/code&gt;ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubefed join kubernetes \ #åŠ å…¥è”é‚¦çš„é›†ç¾¤å‘½ååå­—
  --context=federation \ #è”é‚¦çš„context
  --cluster-context=kubernetes \ #è¦æ·»åŠ é›†ç¾¤çš„context
  --host-cluster-context=kubernetes #ä¸»é›†ç¾¤çš„context

$ kubectl --context=federation get cluster

NAME          STATUS    AGE
kubernetes    Ready     6d
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é€šè¿‡æˆ‘çš„è§‚å¯Ÿï¼Œä»¥ä¸Šè¿‡ç¨‹åœ¨ &lt;code&gt;åŠ å…¥ federation çš„ kubernetes é›†ç¾¤ä¸­&lt;/code&gt; åšäº†ä»¥ä¸‹å‡ ä»¶äº‹æƒ…ï¼š&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;åœ¨ namespace &lt;code&gt;federation-system&lt;/code&gt; ä¸­åˆ›å»ºä¸€ä¸ª ServiceAccount &lt;code&gt;kubernetes-kubernetes&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl -n federation-system get sa

NAME                            SECRETS   AGE
default                         1         45m
federation-controller-manager   1         45m
kubernetes-kubernetes           1         8m
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;åˆ›å»ºä¸€ä¸ª ClusterRole &lt;code&gt;federation-controller-manager:federation-kubernetes-kubernetes&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl get clusterrole|egrep &amp;quot;NAME|federation&amp;quot;

NAME                                                                   AGE
federation-controller-manager:federation-kubernetes-kubernetes         10m
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;åˆ›å»ºä¸€ä¸ª ClusterRoleBinding &lt;code&gt;federation-controller-manager:federation-kubernetes-kubernetes&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl get clusterrolebinding|egrep &amp;quot;NAME|federation&amp;quot;

NAME                                                             AGE
federation-controller-manager:federation-kubernetes-kubernetes   11m
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;æ•´ä¸ªè¿‡ç¨‹æ˜¯å¦è¿˜è¿›è¡Œäº†å…¶ä»–æ“ä½œï¼Œæš‚æ—¶æ²¡æœ‰å‘ç°ï¼Œæœ‰å¾…ç»§ç»­ç ”ç©¶ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;ä»‹ç»ä¸‹é›†ç¾¤æŸ¥è¯¢ï¼Œç§»é™¤é›†ç¾¤ï¼Œåˆ é™¤è”é‚¦ç­‰å‘½ä»¤ï¼š&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;æŸ¥è¯¢æ³¨å†Œåˆ° Federation çš„ kubernetes é›†ç¾¤åˆ—è¡¨&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl --context=federation get clusters

NAME          STATUS    AGE
kubernetes    Ready     8m
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç§»é™¤ &lt;code&gt;kubernetes&lt;/code&gt; é›†ç¾¤&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubefed unjoin kubernetes --host-cluster-context=kubernetes --context=federation

Successfully removed cluster &amp;quot;kubernetes&amp;quot; from federation

$ kubectl --context=federation get clusters

No resources found.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é›†ç¾¤è”é‚¦æ§åˆ¶å¹³é¢çš„åˆ é™¤åŠŸèƒ½è¿˜åœ¨å¼€å‘ä¸­ï¼Œç›®å‰å¯ä»¥é€šè¿‡åˆ é™¤ namespace &lt;code&gt;federation-system&lt;/code&gt; çš„æ–¹æ³•æ¥æ¸…ç†ï¼ˆæ³¨æ„pvä¸ä¼šåˆ é™¤ï¼‰ã€‚å‘½ä»¤åœ¨ host-cluster-context ä¸Šæ‰§è¡Œã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl delete ns federation-system
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;p-id-h2-3-federation-æ”¯æŒçš„æœåŠ¡-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;3. Federation æ”¯æŒçš„æœåŠ¡&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;é›†ç¾¤è”é‚¦æ”¯æŒä»¥ä¸‹è”é‚¦èµ„æºï¼Œè¿™äº›èµ„æºä¼šè‡ªåŠ¨åœ¨æ‰€æœ‰æ³¨å†Œçš„ &lt;code&gt;kubernetes&lt;/code&gt; é›†ç¾¤ä¸­åˆ›å»ºã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Federated ConfigMap&lt;/li&gt;
&lt;li&gt;Federated Service&lt;/li&gt;
&lt;li&gt;Federated DaemonSet&lt;/li&gt;
&lt;li&gt;Federated Deployment&lt;/li&gt;
&lt;li&gt;Federated Ingress&lt;/li&gt;
&lt;li&gt;Federated Namespaces&lt;/li&gt;
&lt;li&gt;Federated ReplicaSets&lt;/li&gt;
&lt;li&gt;Federated Secrets&lt;/li&gt;
&lt;li&gt;Federated Eventsï¼ˆä»…å­˜åœ¨federationæ§åˆ¶å¹³é¢ï¼‰&lt;/li&gt;
&lt;li&gt;Federated Jobsï¼ˆv1.8+ï¼‰&lt;/li&gt;
&lt;li&gt;Federated Horizontal Pod Autoscaling (HPAï¼Œv1.8+)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ç¤ºä¾‹ï¼š&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;åˆ›å»º &lt;code&gt;deployment&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cat nginx-deployment.yaml

apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 2
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80

$ kubectl --context=federation create ns default
$ kubectl --context=federation create -f nginx-deployment.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥é€šè¿‡ &lt;code&gt;kubectl scale deploy nginx --replicas=3 --context=federation&lt;/code&gt; æ¥æ‰©å±• nginx å‰¯æœ¬ï¼Œç„¶åè§‚å¯Ÿ nginx åº”ç”¨åœ¨å„ä¸ªå­é›†ç¾¤ä¸­çš„åˆ†å¸ƒæƒ…å†µã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl --context=kubernetes get deploy
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;é€šè¿‡ Federated Service æ¥å®ç°è·¨é›†ç¾¤æœåŠ¡å‘ç°&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cat nginx-svc.yaml

apiVersion: v1
kind: Service
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  type: LoadBalancer
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
    name: http
  selector:
    app: nginx

# è¿™ä¼šåœ¨æ‰€æœ‰æ³¨å†Œåˆ°è”é‚¦çš„ kubernetes é›†ç¾¤ä¸­åˆ›å»ºæœåŠ¡
$ kubectl --context=federation create -f nginx-svc.yaml

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
$ kubectl --context=federation describe services nginx

Name:                     nginx
Namespace:                default
Labels:                   app=nginx
Annotations:              federation.kubernetes.io/service-ingresses={&amp;quot;items&amp;quot;:[{&amp;quot;cluster&amp;quot;:&amp;quot;kubernetes&amp;quot;,&amp;quot;items&amp;quot;:[{&amp;quot;ip&amp;quot;:&amp;quot;192.168.1.58&amp;quot;}]}]}
Selector:                 app=nginx
Type:                     LoadBalancer
IP:
LoadBalancer Ingress:     192.168.1.58
Port:                     http  80/TCP
TargetPort:               80/TCP
Endpoints:                &amp;lt;none&amp;gt;
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   &amp;lt;none&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥é€šè¿‡ DNS æ¥è®¿é—®è”é‚¦æœåŠ¡ï¼Œè®¿é—®æ ¼å¼åŒ…æ‹¬ä»¥ä¸‹å‡ ç§ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;&amp;lt;service name&amp;gt;.&amp;lt;namespace&amp;gt;.&amp;lt;federation&amp;gt;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;&amp;lt;service name&amp;gt;.&amp;lt;namespace&amp;gt;.&amp;lt;federation&amp;gt;.svc.&amp;lt;domain&amp;gt;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;&amp;lt;service name&amp;gt;.&amp;lt;namespace&amp;gt;.&amp;lt;federation&amp;gt;.svc.&amp;lt;region&amp;gt;.&amp;lt;domain&amp;gt;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;&amp;lt;service name&amp;gt;.&amp;lt;namespace&amp;gt;.&amp;lt;federation&amp;gt;.svc.&amp;lt;zone&amp;gt;.&amp;lt;region&amp;gt;.&amp;lt;domain&amp;gt;&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æœ¬ä¾‹ä¸­å¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ä¸ªåŸŸåæ¥è®¿é—®ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;nginx.default.federation&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;nginx.default.federation.svc.example.com&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;nginx.default.federation.svc.shanghai.example.com&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;nginx.default.federation.svc.shanghai.yangpu.example.com&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;DNS åœ¨ etcd ä¸‹çš„å­˜å‚¨è·¯å¾„ä¸ºï¼š&lt;code&gt;/skydns&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl exec etcd-cluster-fznzsrttt9 etcdctl ls /skydns/com/example/

/skydns/com/example/kubernetes
/skydns/com/example/svc
/skydns/com/example/yangpu

$ kubectl exec etcd-cluster-fznzsrttt9 etcdctl ls /skydns/com/example/yangpu/

/skydns/com/example/yangpu/shanghai
/skydns/com/example/yangpu/svc
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;p-id-h2-4-å‚è€ƒæ–‡æ¡£-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;4. å‚è€ƒæ–‡æ¡£&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://kubernetes.io/docs/concepts/cluster-administration/federation/&#34; target=&#34;_blank&#34;&gt;Kubernetes federation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://kubernetes.io/docs/tasks/federation/set-up-coredns-provider-federation/&#34; target=&#34;_blank&#34;&gt;Set up CoreDNS as DNS provider for Cluster Federation&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;style&gt;
#h2 {
    margin-bottom:2em;
    margin-right: 5px;
    padding: 8px 15px;
    letter-spacing: 2px;
    background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181));
    background-color: rgb(63, 81, 181);
    color: rgb(255, 255, 255);
    border-left: 10px solid rgb(51, 51, 51);
    border-radius:5px;
    text-shadow: rgb(102, 102, 102) 1px 1px 1px;
    box-shadow: rgb(102, 102, 102) 1px 1px 2px;
}
#note {
    font-size: 1.5rem;
    font-style: italic;
    padding: 0 1rem;
    margin: 2.5rem 0;
    position: relative;
    background-color: #fafeff;
    border-top: 1px dotted #9954bb;
    border-bottom: 1px dotted #9954bb;
}
#note-title {
    padding: 0.2rem 0.5rem;
    background: #9954bb;
    color: #FFF;
    position: absolute;
    left: 0;
    top: 0.25rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    border-radius: 4px;
    -webkit-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    -moz-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    -ms-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    -o-transform: rotate(-5deg) translateX(-10px) translateY(-25px);
    transform: rotate(-5deg) translateX(-10px) translateY(-25px);
}
#inline-yellow {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #f0ad4e;
}
#inline-green {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #5cb85c;
}
#inline-blue {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #2780e3;
}
#inline-purple {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #9954bb;
}
#div-border-left-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #df3e3e;
}
#div-border-left-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #f0ad4e;
}
#div-border-left-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #5cb85c;
}
#div-border-left-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #2780e3;
}
#div-border-left-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #9954bb;
}
#div-border-right-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #df3e3e;
}
#div-border-right-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #f0ad4e;
}
#div-border-right-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #5cb85c;
}
#div-border-right-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #2780e3;
}
#div-border-right-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #9954bb;
}
#div-border-top-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #df3e3e;
}
#div-border-top-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #f0ad4e;
}
#div-border-top-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #5cb85c;
}
#div-border-top-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #2780e3;
}
#div-border-top-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #9954bb;
}
&lt;/style&gt;</description>
    </item>
    
    <item>
      <title>Kubernetes ç½‘ç»œæ‰©å±•</title>
      <link>https://www.yangcs.net/posts/k8s-network-expand/</link>
      <pubDate>Sun, 11 Feb 2018 10:40:33 +0000</pubDate>
      
      <guid>https://www.yangcs.net/posts/k8s-network-expand/</guid>
      <description>&lt;p&gt;&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-1-kubernetes-ä¸­æœåŠ¡æš´éœ²çš„æ–¹å¼-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;1. Kubernetes ä¸­æœåŠ¡æš´éœ²çš„æ–¹å¼&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;k8s çš„æœåŠ¡æš´éœ²åˆ†ä¸ºä»¥ä¸‹å‡ ç§æƒ…å†µï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;hostNetwork&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;hostPort&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;NodePort&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;LoadBalancer&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;Ingress&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;è¯´æ˜¯æš´éœ² Pod å…¶å®è·Ÿæš´éœ² Service æ˜¯ä¸€å›äº‹ï¼Œå› ä¸º Pod å°±æ˜¯ Service çš„ backendã€‚&lt;/p&gt;

&lt;h3 id=&#34;hostnetwork&#34;&gt;HostNetwork&lt;/h3&gt;

&lt;p&gt;è¿™æ˜¯ä¸€ç§ç›´æ¥å®šä¹‰ Pod ç½‘ç»œçš„æ–¹å¼ã€‚&lt;/p&gt;

&lt;p&gt;å¦‚æœåœ¨ Pod ä¸­ä½¿ç”¨ &lt;code&gt;hostNotwork:true&lt;/code&gt; é…ç½®çš„è¯ï¼Œåœ¨è¿™ç§ pod ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºå¯ä»¥ç›´æ¥çœ‹åˆ° pod å¯åŠ¨çš„ä¸»æœºçš„ç½‘ç»œæ¥å£ã€‚åœ¨ä¸»æœºçš„æ‰€æœ‰ç½‘ç»œæ¥å£ä¸Šéƒ½å¯ä»¥è®¿é—®åˆ°è¯¥åº”ç”¨ç¨‹åºã€‚ä»¥ä¸‹æ˜¯ä½¿ç”¨ä¸»æœºç½‘ç»œçš„ pod çš„ç¤ºä¾‹å®šä¹‰ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;apiVersion: v1
kind: Pod
metadata:
  name: influxdb
spec:
  hostNetwork: true
  containers:
    - name: influxdb
      image: influxdb
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™ç§ Pod çš„ç½‘ç»œæ¨¡å¼æœ‰ä¸€ä¸ªç”¨å¤„å°±æ˜¯å¯ä»¥å°†ç½‘ç»œæ’ä»¶åŒ…è£…åœ¨ Pod ä¸­ç„¶åéƒ¨ç½²åœ¨æ¯ä¸ªå®¿ä¸»æœºä¸Šï¼Œè¿™æ ·è¯¥ Pod å°±å¯ä»¥æ§åˆ¶è¯¥å®¿ä¸»æœºä¸Šçš„æ‰€æœ‰ç½‘ç»œã€‚&lt;/p&gt;

&lt;p id=&#34;div-border-top-purple&#34;&gt;&lt;font color=&#34;red&#34;&gt;ç¼ºç‚¹ï¼š&lt;/font&gt;æ¯æ¬¡å¯åŠ¨è¿™ä¸ªPodçš„æ—¶å€™éƒ½å¯èƒ½è¢«è°ƒåº¦åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œæ‰€æœ‰å¤–éƒ¨è®¿é—®Podçš„IPä¹Ÿæ˜¯å˜åŒ–çš„ï¼Œè€Œä¸”è°ƒåº¦Podçš„æ—¶å€™è¿˜éœ€è¦è€ƒè™‘æ˜¯å¦ä¸å®¿ä¸»æœºä¸Šçš„ç«¯å£å†²çªï¼Œå› æ­¤ä¸€èˆ¬æƒ…å†µä¸‹é™¤éæ‚¨çŸ¥é“éœ€è¦æŸä¸ªç‰¹å®šåº”ç”¨å ç”¨ç‰¹å®šå®¿ä¸»æœºä¸Šçš„ç‰¹å®šç«¯å£æ—¶æ‰ä½¿ç”¨ &lt;code&gt;hostNetwork: true&lt;/code&gt; çš„æ–¹å¼ã€‚&lt;/p&gt;

&lt;h3 id=&#34;hostport&#34;&gt;hostPort&lt;/h3&gt;

&lt;p&gt;è¿™æ˜¯ä¸€ç§ç›´æ¥å®šä¹‰ Pod ç½‘ç»œçš„æ–¹å¼ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;hostPort&lt;/code&gt; æ˜¯ç›´æ¥å°†å®¹å™¨çš„ç«¯å£ä¸æ‰€è°ƒåº¦çš„èŠ‚ç‚¹ä¸Šçš„ç«¯å£è·¯ç”±ï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥é€šè¿‡å®¿ä¸»æœºçš„ IP åŠ ä¸Šæ¥è®¿é—® Pod äº†ï¼Œå¦‚:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;apiVersion: v1
kind: Pod
metadata:
  name: influxdb
spec:
  containers:
    - name: influxdb
      image: influxdb
      ports:
        - containerPort: 8086
          hostPort: 8086
&lt;/code&gt;&lt;/pre&gt;

&lt;p id=&#34;div-border-top-purple&#34;&gt;&lt;font color=&#34;red&#34;&gt;ç¼ºç‚¹ï¼š&lt;/font&gt;å› ä¸º Pod é‡æ–°è°ƒåº¦çš„æ—¶å€™è¯¥Podè¢«è°ƒåº¦åˆ°çš„å®¿ä¸»æœºå¯èƒ½ä¼šå˜åŠ¨ï¼Œè¿™æ ·å°±å˜åŒ–äº†ï¼Œç”¨æˆ·å¿…é¡»è‡ªå·±ç»´æŠ¤ä¸€ä¸ª Pod ä¸æ‰€åœ¨å®¿ä¸»æœºçš„å¯¹åº”å…³ç³»ã€‚&lt;/p&gt;

&lt;h3 id=&#34;nodeport&#34;&gt;NodePort&lt;/h3&gt;

&lt;p&gt;NodePort åœ¨ kubenretes é‡Œæ˜¯ä¸€ä¸ªå¹¿æ³›åº”ç”¨çš„æœåŠ¡æš´éœ²æ–¹å¼ã€‚Kubernetes ä¸­çš„ service é»˜è®¤æƒ…å†µä¸‹éƒ½æ˜¯ä½¿ç”¨çš„ ClusterIP è¿™ç§ç±»å‹ï¼Œè¿™æ ·çš„ service ä¼šäº§ç”Ÿä¸€ä¸ª ClusterIPï¼Œè¿™ä¸ª IP åªèƒ½åœ¨é›†ç¾¤å†…éƒ¨è®¿é—®ï¼Œè¦æƒ³è®©å¤–éƒ¨èƒ½å¤Ÿç›´æ¥è®¿é—® serviceï¼Œéœ€è¦å°† service type ä¿®æ”¹ä¸º  &lt;code&gt;nodePort&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;apiVersion: v1
kind: Pod
metadata:
  name: influxdb
  labels:
    name: influxdb
spec:
  containers:
    - name: influxdb
      image: influxdb
      ports:
        - containerPort: 8086
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åŒæ—¶è¿˜å¯ä»¥ç»™ service æŒ‡å®šä¸€ä¸ª &lt;code&gt;nodePort&lt;/code&gt; å€¼ï¼ŒèŒƒå›´æ˜¯ 30000-32767ï¼Œè¿™ä¸ªå€¼åœ¨ API server çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œç”¨&amp;ndash; &lt;code&gt;service-node-port-range&lt;/code&gt; å®šä¹‰ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;kind: Service
apiVersion: v1
metadata:
  name: influxdb
spec:
  type: NodePort
  ports:
    - port: 8086
      nodePort: 30000
  selector:
    name: influxdb
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é›†ç¾¤å¤–å°±å¯ä»¥ä½¿ç”¨ kubernetes ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹çš„ IP åŠ ä¸Š 30000 ç«¯å£è®¿é—®è¯¥æœåŠ¡äº†ã€‚kube-proxy ä¼šè‡ªåŠ¨å°†æµé‡ä»¥ round-robin çš„æ–¹å¼è½¬å‘ç»™è¯¥ service çš„æ¯ä¸€ä¸ª podã€‚&lt;/p&gt;

&lt;p id=&#34;div-border-top-purple&#34;&gt;&lt;font color=&#34;red&#34;&gt;ç¼ºç‚¹ï¼š&lt;/font&gt;æ‰€æœ‰ node ä¸Šéƒ½ä¼šå¼€å¯ç«¯å£ç›‘å¬ï¼Œä¸”éœ€è¦è®°ä½ç«¯å£å·ã€‚&lt;/p&gt;

&lt;h3 id=&#34;loadbalancer&#34;&gt;LoadBalancer&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;LoadBalancer&lt;/code&gt; åªèƒ½åœ¨ service ä¸Šå®šä¹‰ã€‚è¿™æ˜¯å…¬æœ‰äº‘æä¾›çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œå¦‚ AWSã€Azureã€CloudStackã€GCE ç­‰ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;kind: Service
apiVersion: v1
metadata:
  name: influxdb
spec:
  type: LoadBalancer
  ports:
    - port: 8086
  selector:
    name: influxdb
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŸ¥çœ‹æœåŠ¡ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl get svc influxdb

NAME       CLUSTER-IP     EXTERNAL-IP     PORT(S)          AGE
influxdb   10.97.121.42   10.13.242.236   8086:30051/TCP   39s
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å†…éƒ¨å¯ä»¥ä½¿ç”¨ ClusterIP åŠ ç«¯å£æ¥è®¿é—®æœåŠ¡ï¼Œå¦‚ 19.97.121.42:8086ã€‚&lt;/p&gt;

&lt;p&gt;å¤–éƒ¨å¯ä»¥ç”¨ä»¥ä¸‹ä¸¤ç§æ–¹å¼è®¿é—®è¯¥æœåŠ¡ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ä½¿ç”¨ä»»ä¸€èŠ‚ç‚¹çš„ IP åŠ  30051 ç«¯å£è®¿é—®è¯¥æœåŠ¡&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨ &lt;code&gt;EXTERNAL-IP&lt;/code&gt; æ¥è®¿é—®ï¼Œè¿™æ˜¯ä¸€ä¸ª VIPï¼Œæ˜¯äº‘ä¾›åº”å•†æä¾›çš„è´Ÿè½½å‡è¡¡å™¨ IPï¼Œå¦‚ &lt;code&gt;10.13.242.236:8086&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p id=&#34;div-border-top-purple&#34;&gt;&lt;font color=&#34;red&#34;&gt;ç¼ºç‚¹ï¼š&lt;/font&gt;éœ€è¦äº‘æœåŠ¡å•†æ”¯æŒã€‚&lt;/p&gt;

&lt;h3 id=&#34;ingress&#34;&gt;Ingress&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;Ingress&lt;/code&gt; æ˜¯è‡ª kubernetes1.1 ç‰ˆæœ¬åå¼•å…¥çš„èµ„æºç±»å‹ã€‚å¿…é¡»è¦éƒ¨ç½² Ingress controller æ‰èƒ½åˆ›å»º Ingress èµ„æºï¼ŒIngress controller æ˜¯ä»¥ä¸€ç§æ’ä»¶çš„å½¢å¼æä¾›ã€‚Ingress controller æ˜¯éƒ¨ç½²åœ¨ Kubernetes ä¹‹ä¸Šçš„ Docker å®¹å™¨ã€‚å®ƒçš„ Docker é•œåƒåŒ…å«ä¸€ä¸ªåƒ &lt;code&gt;nginx&lt;/code&gt; æˆ– &lt;code&gt;HAProxy&lt;/code&gt; çš„è´Ÿè½½å‡è¡¡å™¨å’Œä¸€ä¸ªæ§åˆ¶å™¨å®ˆæŠ¤è¿›ç¨‹ã€‚æ§åˆ¶å™¨å®ˆæŠ¤ç¨‹åºä» Kubernetes æ¥æ”¶æ‰€éœ€çš„ Ingress é…ç½®ã€‚å®ƒä¼šç”Ÿæˆä¸€ä¸ª nginx æˆ– HAProxy é…ç½®æ–‡ä»¶ï¼Œå¹¶é‡æ–°å¯åŠ¨è´Ÿè½½å¹³è¡¡å™¨è¿›ç¨‹ä»¥ä½¿æ›´æ”¹ç”Ÿæ•ˆã€‚æ¢å¥è¯è¯´ï¼ŒIngress controller æ˜¯ç”± Kubernetes ç®¡ç†çš„è´Ÿè½½å‡è¡¡å™¨ã€‚&lt;/p&gt;

&lt;p&gt;Kubernetes Ingress æä¾›äº†è´Ÿè½½å¹³è¡¡å™¨çš„å…¸å‹ç‰¹æ€§ï¼šHTTP è·¯ç”±ï¼Œç²˜æ€§ä¼šè¯ï¼ŒSSL ç»ˆæ­¢ï¼ŒSSL ç›´é€šï¼ŒTCP å’Œ UDP è´Ÿè½½å¹³è¡¡ç­‰ã€‚ç›®å‰å¹¶ä¸æ˜¯æ‰€æœ‰çš„ Ingress controller éƒ½å®ç°äº†è¿™äº›åŠŸèƒ½ï¼Œéœ€è¦æŸ¥çœ‹å…·ä½“çš„ Ingress controller æ–‡æ¡£ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: influxdb
spec:
  rules:
    - host: influxdb.kube.example.com
      http:
        paths:
          - backend:
              serviceName: influxdb
              servicePort: 8086
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¤–éƒ¨è®¿é—® URL  &lt;a href=&#34;http://influxdb.kube.example.com/ping&#34; target=&#34;_blank&#34;&gt;http://influxdb.kube.example.com/ping&lt;/a&gt; è®¿é—®è¯¥æœåŠ¡ï¼Œå…¥å£å°±æ˜¯ 80 ç«¯å£ï¼Œç„¶å &lt;code&gt;Ingress controller&lt;/code&gt; ç›´æ¥å°†æµé‡è½¬å‘ç»™åç«¯ Podï¼Œä¸éœ€å†ç»è¿‡ kube-proxy çš„è½¬å‘ï¼Œæ¯” LoadBalancer æ–¹å¼æ›´é«˜æ•ˆã€‚&lt;/p&gt;

&lt;p id=&#34;div-border-top-purple&#34;&gt;&lt;font color=&#34;red&#34;&gt;ç¼ºç‚¹ï¼š&lt;/font&gt;80 ç«¯å£æš´éœ² å¿…éœ€é€šè¿‡åŸŸåå¼•å…¥ï¼Œè€Œä¸”ä¸€æ¬¡åªèƒ½ä¸€æ¡è§„åˆ™ï¼Œå¾ˆéº»çƒ¦ã€‚&lt;/p&gt;

&lt;p&gt;ä½†æ˜¯åœ¨æ­£å¸¸çš„è™šæ‹Ÿæœºç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸€ä¸ª &lt;code&gt;IP åœ°å€+ç«¯å£&lt;/code&gt; å³å¯è®¿é—®æœåŠ¡ã€‚&lt;/p&gt;

&lt;p&gt;ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½åšåˆ°åƒè®¿é—®è™šæ‹Ÿæœºä¸€æ ·ç›´æ¥è®¿é—® k8s é›†ç¾¤æœåŠ¡å‘¢ï¼Ÿå½“ç„¶å¯ä»¥ï¼Œä»¥ä¸‹æ¶æ„å¯ä»¥å®ç°ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;æ‰“é€š k8s ç½‘ç»œå’Œç‰©ç†ç½‘ç»œç›´é€š&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;ç‰©ç†ç½‘ç»œçš„ dns åŸŸåæœåŠ¡ç›´æ¥è°ƒç”¨ k8s-dns åŸŸåæœåŠ¡ç›´æ¥äº’è®¿&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;p-id-h2-2-é›†ç¾¤ç¯å¢ƒ-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;2. é›†ç¾¤ç¯å¢ƒ&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;h3 id=&#34;æ¶æ„ç¯å¢ƒ&#34;&gt;æ¶æ„ç¯å¢ƒ&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;k8s é›†ç¾¤ç½‘ç»œï¼š&lt;code&gt;172.28.0.0/16&lt;/code&gt;&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;k8s-service ç½‘ç»œï¼š&lt;code&gt;10.96.0.0/12&lt;/code&gt;&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;ç‰©ç†æœºç½‘ç»œï¼š&lt;code&gt;192.168.0.0/16&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;k8s-é›†ç¾¤èŠ‚ç‚¹&#34;&gt;k8s é›†ç¾¤èŠ‚ç‚¹&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl get cs

NAME                 STATUS    MESSAGE              ERROR
scheduler            Healthy   ok                   
controller-manager   Healthy   ok                   
etcd-0               Healthy   {&amp;quot;health&amp;quot;: &amp;quot;true&amp;quot;}

$ kubectl get nodes -owide

NAME      STATUS    AGE       VERSION   EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION
node1     Ready     13d       v1.7.11   &amp;lt;none&amp;gt;        CentOS Linux 7 (Core)   3.10.0-514.el7.x86_64
node2     Ready     13d       v1.7.11   &amp;lt;none&amp;gt;        CentOS Linux 7 (Core)   3.10.0-514.el7.x86_64
node3     Ready     13d       v1.7.11   &amp;lt;none&amp;gt;        CentOS Linux 7 (Core)   3.10.0-514.el7.x86_64
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è§’è‰²å®šä¹‰ï¼š&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&#34;left&#34;&gt;è§’è‰²åç§°&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;IP åœ°å€&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;ä¸»æœºå&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&#34;left&#34;&gt;è¾¹ç•Œç½‘å…³è·¯ç”±å™¨&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;192.168.2.173&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;calico-gateway&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;left&#34;&gt;è¾¹ç•Œ dns ä»£ç†æœåŠ¡å™¨&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;192.168.1.62&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;node3&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;å‡è®¾æˆ‘ä»¬è¦è®¿é—® k8s ä¸­çš„ &lt;code&gt;dao-2048&lt;/code&gt; æœåŠ¡ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl get svc|egrep &#39;NAME|2048&#39;

NAME                              CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
dao-2048                          10.98.217.155    &amp;lt;none&amp;gt;        80/TCP           13m
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¯¥æ–¹æ¡ˆçš„æ¶æ„åŸç†å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;          +-----------------+
          |                 |
          |  192.168.0.0/16 |          # ç‰©ç†ç½‘ç»œä»¥åŸŸåæˆ–tcpæ–¹å¼å‘èµ·è®¿é—®k8s serviceä»¥åŠç«¯å£
          |                 |
          +-----------------+
                   |
                   |
+------------------------------------+
| dao-2048.default.svc.cluster.local |  # è¯·æ±‚k8sæœåŠ¡æ‰€åœ¨ç©ºé—´çš„æœåŠ¡åï¼Œå®Œæ•´åŸŸå
+------------------------------------+
                   |
                   |
          +-----------------+
          |                 |           # dnsä»£ç†æœåŠ¡ä»¥ingress-udp podçš„æ¨¡å¼è¿è¡Œåœ¨æ­¤èŠ‚ç‚¹udp53å·ç«¯å£ä¸Šï¼Œ
          |   192.168.1.62  |           # ä¸ºç‰©ç†ç½‘ç»œæä¾›ä»¿é—®k8s-dnsçš„æ¡¥æ¢è§£ædns
          |                 |           # æ­¤èŠ‚ç‚¹åº”å›ºå®šåšä¸ºä¸€ä¸ªèŠ‚ç‚¹å¸ƒç½²ï¼Œæ‰€æœ‰å¤–éƒ¨æœºå™¨è®¾ç½®dnsä¸ºæ­¤ 192.168.1.62
          +-----------------+
                   |
                   |
          +-----------------+
          |                 |
          |  10.98.217.155  |           # è·å– svc çš„å®é™… clusterip
          |                 |
          +-----------------+
                   |
                   |
          +-----------------+           # è¾¹ç•Œç½‘å…³,ç”¨äºç‰©ç†ç½‘ç»œè¿æ¥k8sé›†ç¾¤ï¼Œéœ€è¦å¼€å¯å†…æ ¸è½¬å‘ï¼šnet.ipv4.ip_forward=1
          |                 |           # æ‰€æœ‰å¤–éƒ¨ç‰©ç†æœºåŠ ä¸€æ¡é™æ€è·¯ç”±ï¼šè®¿é—® k8s ç½‘ç»œ 10.96.0.0/12 ç½‘æ®µå¿…éœ€ç»è¿‡ç½‘å…³ 192.168.2.173
          |  192.168.2.173  |           # ip route add 10.96.0.0/12 via 192.168.2.173
          |                 |           # è¾¹ç•Œç½‘å…³è¿è¡Œ kube-proxy ç”¨äºé˜²ç«å¢™è§„åˆ™åŒæ­¥å®ç° svc åˆ†æµï¼Œæ­¤èŠ‚ç‚¹ä¸è¿è¡Œ kubele æœåŠ¡ï¼Œä¸å— k8s ç®¡æ§
          +-----------------+
                   |
                   |
         +-------------------+
         |                   |
         |  calico-Ifaceæ¥å£  |
         |                   |
         +-------------------+
                   |
                   |
          +-----------------+
          |   k8s é›†ç¾¤ç½‘ç»œ   |            # æµé‡æœ€ç»ˆåˆ°è¾¾ k8s é›†ç¾¤
          +-----------------+
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»¥ä¸‹ä¸ºè¯¥æ–¹æ¡ˆçš„å®æ–½æ­¥éª¤ã€‚&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-3-éƒ¨ç½²è¾¹ç•Œ-dns-ä»£ç†æœåŠ¡å™¨-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;3. éƒ¨ç½²è¾¹ç•Œ dns ä»£ç†æœåŠ¡å™¨&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;å¸ƒç½² dns ä»£ç†æœåŠ¡èŠ‚ç‚¹ä¸ºå¤–éƒ¨æä¾› dns æœåŠ¡,ä»¥ &lt;code&gt;hostNetwork: true&lt;/code&gt; ä¸ºé k8s é›†ç¾¤ç½‘ç»œç‰©ç†æœºèŠ‚ç‚¹æä¾› dns æœåŠ¡&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cd ~/dns-udp; ll ./

total 20K
-rw-r--r--. 1 root root 1.2K Feb 12 05:13 default-backend.yaml
-rw-r--r--. 1 root root  140 Feb 12 05:14 nginx-udp-ingress-configmap.yaml
-rw-r--r--. 1 root root 1.8K Feb 12 05:35 nginx-udp-ingress-controller.yaml
-rw-r--r--. 1 root root 2.4K Feb 12 05:15 rbac.yaml

$ cat default-backend.yaml

apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: default-http-backend
  labels:
    app: default-http-backend
  namespace: kube-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: default-http-backend
  template:
    metadata:
      labels:
        app: default-http-backend
    spec:
      terminationGracePeriodSeconds: 60
      containers:
      - name: default-http-backend
        # Any image is permissible as long as:
        # 1. It serves a 404 page at /
        # 2. It serves 200 on a /healthz endpoint
        image: gcr.io/google_containers/defaultbackend:1.4
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 30
          timeoutSeconds: 5
        ports:
        - containerPort: 8080
        resources:
          limits:
            cpu: 10m
            memory: 20Mi
          requests:
            cpu: 10m
            memory: 20Mi
---

apiVersion: v1
kind: Service
metadata:
  name: default-http-backend
  namespace: kube-system
  labels:
    app: default-http-backend
spec:
  ports:
  - port: 80
    targetPort: 8080
  selector:
    app: default-http-backend
    
$ cat nginx-udp-ingress-configmap.yaml

apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-udp-ingress-configmap
  namespace: kube-system
data:
  53: &amp;quot;kube-system/kube-dns:53&amp;quot;
  
$ cat nginx-udp-ingress-controller.yaml

apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: nginx-udp-ingress-controller
  labels:
    k8s-app: nginx-udp-ingress-lb
  namespace: kube-system
spec:
  replicas: 1
  selector:
    matchLabels:
      k8s-app: nginx-udp-ingress-lb
  template:
    metadata:
      labels:
        k8s-app: nginx-udp-ingress-lb
        name: nginx-udp-ingress-lb
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/hostname
                operator: In
                values:
                - node3
      hostNetwork: true
      serviceAccountName: nginx-ingress-serviceaccount
      terminationGracePeriodSeconds: 60
      containers:
      - image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.10.2
        name: nginx-udp-ingress-lb
        readinessProbe:
          httpGet:
            path: /healthz
            port: 10254
            scheme: HTTP
        livenessProbe:
          httpGet:
            path: /healthz
            port: 10254
            scheme: HTTP
          initialDelaySeconds: 10
          timeoutSeconds: 1
        env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: POD_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
        ports:
        - containerPort: 80
          hostPort: 80
        - containerPort: 443
          hostPort: 443
        - containerPort: 53
          hostPort: 53
        args:
        - /nginx-ingress-controller
        - --default-backend-service=$(POD_NAMESPACE)/default-http-backend
        - --udp-services-configmap=$(POD_NAMESPACE)/nginx-udp-ingress-configmap

$ cat rbac.yaml

apiVersion: v1
kind: ServiceAccount
metadata:
  name: nginx-ingress-serviceaccount
  namespace: kube-system

---

apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRole
metadata:
  name: nginx-ingress-clusterrole
rules:
  - apiGroups:
      - &amp;quot;&amp;quot;
    resources:
      - configmaps
      - endpoints
      - nodes
      - pods
      - secrets
    verbs:
      - list
      - watch
  - apiGroups:
      - &amp;quot;&amp;quot;
    resources:
      - nodes
    verbs:
      - get
  - apiGroups:
      - &amp;quot;&amp;quot;
    resources:
      - services
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - &amp;quot;extensions&amp;quot;
    resources:
      - ingresses
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - &amp;quot;&amp;quot;
    resources:
        - events
    verbs:
        - create
        - patch
  - apiGroups:
      - &amp;quot;extensions&amp;quot;
    resources:
      - ingresses/status
    verbs:
      - update

---

apiVersion: rbac.authorization.k8s.io/v1beta1
kind: Role
metadata:
  name: nginx-ingress-role
  namespace: kube-system
rules:
  - apiGroups:
      - &amp;quot;&amp;quot;
    resources:
      - configmaps
      - pods
      - secrets
      - namespaces
    verbs:
      - get
  - apiGroups:
      - &amp;quot;&amp;quot;
    resources:
      - configmaps
    resourceNames:
      # Defaults to &amp;quot;&amp;lt;election-id&amp;gt;-&amp;lt;ingress-class&amp;gt;&amp;quot;
      # Here: &amp;quot;&amp;lt;ingress-controller-leader&amp;gt;-&amp;lt;nginx&amp;gt;&amp;quot;
      # This has to be adapted if you change either parameter
      # when launching the nginx-ingress-controller.
      - &amp;quot;ingress-controller-leader-nginx&amp;quot;
    verbs:
      - get
      - update
  - apiGroups:
      - &amp;quot;&amp;quot;
    resources:
      - configmaps
    verbs:
      - create
  - apiGroups:
      - &amp;quot;&amp;quot;
    resources:
      - endpoints
    verbs:
      - get

---

apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  name: nginx-ingress-role-nisa-binding
  namespace: kube-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: nginx-ingress-role
subjects:
  - kind: ServiceAccount
    name: nginx-ingress-serviceaccount
    namespace: kube-system

---

apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: nginx-ingress-clusterrole-nisa-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: nginx-ingress-clusterrole
subjects:
  - kind: ServiceAccount
    name: nginx-ingress-serviceaccount
    namespace: kube-system
    
$ kubectl create -f ./

deployment &amp;quot;default-http-backend&amp;quot; created
service &amp;quot;default-http-backend&amp;quot; created
configmap &amp;quot;nginx-udp-ingress-configmap&amp;quot; created
deployment &amp;quot;nginx-udp-ingress-controller&amp;quot; created
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é€šè¿‡ nginx åå‘ä»£ç† &lt;code&gt;kube-dns&lt;/code&gt; æœåŠ¡ï¼ŒåŒæ—¶ä»¥ &lt;code&gt;hostNetwork: true&lt;/code&gt; å‘é›†ç¾¤å¤–éƒ¨æš´éœ² 53 ç«¯å£ï¼Œä¸ºé k8s é›†ç¾¤ç½‘ç»œç‰©ç†æœºèŠ‚ç‚¹æä¾› dns æœåŠ¡ã€‚&lt;/p&gt;

&lt;h2 id=&#34;p-id-h2-4-éƒ¨ç½²-gateway-è¾¹ç•Œç½‘å…³èŠ‚ç‚¹-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;4. éƒ¨ç½² gateway è¾¹ç•Œç½‘å…³èŠ‚ç‚¹&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;æ­¤èŠ‚ç‚¹åªè¿è¡Œ &lt;code&gt;calico&lt;/code&gt; å’Œ &lt;code&gt;kube-proxy&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;h3 id=&#34;é¦–å…ˆå¼€å¯å†…æ ¸è½¬å‘&#34;&gt;é¦–å…ˆå¼€å¯å†…æ ¸è½¬å‘&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ echo &#39;net.ipv4.ip_forward=1&#39; &amp;gt;&amp;gt;/etc/sysctl.conf
$ sysctl -p
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;è¿è¡Œ-calico&#34;&gt;è¿è¡Œ calico&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ docker run --net=host --privileged --name=calico-node -d --restart=always \
  -v /etc/etcd/ssl:/etc/kubernetes/ssl \
  -e ETCD_ENDPOINTS=https://192.168.1.60:12379 \
  -e ETCD_KEY_FILE=/etc/kubernetes/ssl/peer-key.pem \
  -e ETCD_CERT_FILE=/etc/kubernetes/ssl/peer-cert.pem \
  -e ETCD_CA_CERT_FILE=/etc/kubernetes/ssl/ca.pem \
  -e NODENAME=${HOSTNAME} \
  -e IP= \
  -e CALICO_IPV4POOL_CIDR=172.28.0.0/16 \
  -e NO_DEFAULT_POOLS= \
  -e AS= \
  -e CALICO_LIBNETWORK_ENABLED=true \
  -e IP6= \
  -e CALICO_NETWORKING_BACKEND=bird \
  -e FELIX_DEFAULTENDPOINTTOHOSTACTION=ACCEPT \
  -v /var/run/calico:/var/run/calico \
  -v /lib/modules:/lib/modules \
  -v /run/docker/plugins:/run/docker/plugins \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v /var/log/calico:/var/log/calico \
  calico/node:v2.6.7
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;éœ€è¦æå‰å°†ç›¸å…³è¯ä¹¦æ‹·è´åˆ° &lt;code&gt;/etc/kubernetes/ssl/&lt;/code&gt; ç›®å½•ä¸‹ã€‚&lt;/p&gt;

&lt;p id=&#34;div-border-top-red&#34;&gt;&lt;font color=&#34;blue&#34;&gt;æ³¨æ„ï¼š&lt;/font&gt;æ­¤å¤„çš„ &lt;code&gt;-e CALICO_IPV4POOL_CIDR=172.28.0.0/16&lt;/code&gt; è¦ä¸ k8s é›†ç¾¤ç½‘ç»œçš„ç½‘æ®µä¸€è‡´&lt;/p&gt;

&lt;h3 id=&#34;åˆ›å»ºè¾¹ç•Œè·¯ç”±å™¨&#34;&gt;åˆ›å»ºè¾¹ç•Œè·¯ç”±å™¨&lt;/h3&gt;

&lt;p&gt;ä»¥ä¸‹å‘½ä»¤åœ¨ k8s çš„ master èŠ‚ç‚¹ä¸Šè¿›è¡Œæ“ä½œ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cat bgpPeer.yaml

apiVersion: v1
kind: bgpPeer
metadata:
  peerIP: 192.168.2.173
  scope: global
spec:
  asNumber: 64512
  
$ calicoctl  create -f bgpPeer.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŸ¥çœ‹ node æƒ…å†µ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ calicoctl node status

Calico process is running.

IPv4 BGP status
+---------------+-------------------+-------+------------+-------------+
| PEER ADDRESS  |     PEER TYPE     | STATE |   SINCE    |    INFO     |
+---------------+-------------------+-------+------------+-------------+
| 192.168.1.61  | node-to-node mesh | up    | 2018-01-29 | Established |
| 192.168.1.62  | node-to-node mesh | up    | 2018-02-09 | Established |
| 192.168.2.173 | node-to-node mesh | up    | 2018-02-09 | Established |
| 192.168.2.173 | global            | start | 2018-02-09 | Idle        |
+---------------+-------------------+-------+------------+-------------+

IPv6 BGP status
No IPv6 peers found.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŸ¥çœ‹å…¨å±€å¯¹ç­‰ä½“èŠ‚ç‚¹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ calicoctl get bgpPeer --scope=global

SCOPE    PEERIP          NODE   ASN     
global   192.168.2.173          64512
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;éƒ¨ç½²-kube-proxy&#34;&gt;éƒ¨ç½² kube-proxy&lt;/h3&gt;

&lt;h4 id=&#34;å®‰è£…-conntrack&#34;&gt;å®‰è£… conntrack&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ yum install -y conntrack-tools
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;åˆ›å»º-kube-proxy-çš„-service-é…ç½®æ–‡ä»¶&#34;&gt;åˆ›å»º kube-proxy çš„ service é…ç½®æ–‡ä»¶&lt;/h4&gt;

&lt;p&gt;æ–‡ä»¶è·¯å¾„ &lt;code&gt;/usr/lib/systemd/system/kube-proxy.service&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[Unit]
Description=Kubernetes Kube-Proxy Server
Documentation=https://github.com/GoogleCloudPlatform/kubernetes
After=network.target

[Service]
EnvironmentFile=-/etc/kubernetes/config
EnvironmentFile=-/etc/kubernetes/proxy
ExecStart=/usr/local/bin/kube-proxy \
        --logtostderr=true \
        --v=2 \
        --bind-address=192.168.2.173 \
        --hostname-override=192.168.2.173 \
        --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig \
        --proxy-mode=iptables \
        --cluster-cidr=172.28.0.0/16
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;éœ€è¦æå‰å°† &lt;code&gt;kube-proxy.kubeconfig&lt;/code&gt; æ–‡ä»¶æ‹·è´åˆ° &lt;code&gt;/etc/kubernetes/&lt;/code&gt; ç›®å½•ä¸‹ã€‚&lt;/p&gt;

&lt;h4 id=&#34;å¯åŠ¨-kube-proxy&#34;&gt;å¯åŠ¨ kube-proxy&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ systemctl daemon-reload
$ systemctl enable kube-proxy
$ systemctl start kube-proxy
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;p-id-h2-5-æµ‹è¯•ç½‘å…³å’Œ-dns-è§£æä»¥åŠæœåŠ¡è®¿é—®æƒ…å†µ-p&#34;&gt;&lt;p id=&#34;h2&#34;&gt;5. æµ‹è¯•ç½‘å…³å’Œ dns è§£æä»¥åŠæœåŠ¡è®¿é—®æƒ…å†µ&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;æ‰¾å°é›†ç¾¤å¤–çš„æœºå™¨æ¥éªŒè¯ï¼Œè¿™å°æœºå™¨åªæœ‰ä¸€ä¸ªç½‘å¡ï¼Œæ²¡æœ‰å®‰è£… &lt;code&gt;calico&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;æ·»åŠ è·¯ç”±&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ip route add 10.96.0.0/12 via 192.168.2.173 dev ens160
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;ä¿®æ”¹ dns ä¸º &lt;code&gt;192.168.1.62&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cat /etc/resolv.conf

nameserver 192.168.1.62
search default.svc.cluster.local svc.cluster.local cluster.local
nameserver 223.5.5.5
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;è§£æ &lt;code&gt;dao-2048&lt;/code&gt; æœåŠ¡çš„åŸŸå&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ dig dao-2048.default.svc.cluster.local

; &amp;lt;&amp;lt;&amp;gt;&amp;gt; DiG 9.9.4-RedHat-9.9.4-51.el7_4.2 &amp;lt;&amp;lt;&amp;gt;&amp;gt; dao-2048.default.svc.cluster.local
;; global options: +cmd
;; Got answer:
;; -&amp;gt;&amp;gt;HEADER&amp;lt;&amp;lt;- opcode: QUERY, status: NOERROR, id: 57053
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;dao-2048.default.svc.cluster.local. IN A

;; ANSWER SECTION:
dao-2048.default.svc.cluster.local. 5 IN A      10.98.217.155

;; Query time: 1 msec
;; SERVER: 192.168.1.62#53(192.168.1.62)
;; WHEN: Mon Feb 12 06:46:38 EST 2018
;; MSG SIZE  rcvd: 79
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;è®¿é—® &lt;code&gt;dao-2048&lt;/code&gt; æœåŠ¡&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ curl dao-2048.default.svc.cluster.local

* About to connect() to dao-2048.default.svc.cluster.local port 80 (#0)
*   Trying 10.98.217.155...
* Connected to dao-2048.default.svc.cluster.local (10.98.217.155) port 80 (#0)
&amp;gt; GET / HTTP/1.1
&amp;gt; User-Agent: curl/7.29.0
&amp;gt; Host: dao-2048.default.svc.cluster.local
&amp;gt; Accept: */*
&amp;gt; 
&amp;lt; HTTP/1.1 200 OK
&amp;lt; Server: nginx/1.10.1
&amp;lt; Date: Mon, 12 Feb 2018 11:47:58 GMT
&amp;lt; Content-Type: text/html
&amp;lt; Content-Length: 4085
&amp;lt; Last-Modified: Sun, 11 Feb 2018 11:31:27 GMT
&amp;lt; Connection: keep-alive
&amp;lt; ETag: &amp;quot;5a80298f-ff5&amp;quot;
&amp;lt; Accept-Ranges: bytes
&amp;lt; 
&amp;lt;!DOCTYPE html&amp;gt;
&amp;lt;html&amp;gt;
&amp;lt;head&amp;gt;
  &amp;lt;meta charset=&amp;quot;utf-8&amp;quot;&amp;gt;
  &amp;lt;title&amp;gt;2048&amp;lt;/title&amp;gt;
.........
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;&lt;font color=&#34;red&#34;&gt;æˆåŠŸè®¿é—®ï¼&lt;/font&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;å¦‚æœæ˜¯ windows ç”¨æˆ·ï¼Œæ·»åŠ è·¯ç”±å¯ä»¥ç”¨ç®¡ç†å‘˜æ‰“å¼€ cmd å‘½ä»¤è¿è¡Œï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ route ADD -p 172.28.0.0 MASK 255.255.0.0 192.168.2.173
&lt;/code&gt;&lt;/pre&gt;

&lt;p id=&#34;div-border-top-red&#34;&gt;&lt;font color=&#34;blue&#34;&gt;PSï¼š&lt;/font&gt;å¦‚æœä½ ä¸æƒ³ä¸€å°å°æœºå™¨åŠ è·¯ç”±å’Œ dnsï¼Œä½ å¯ä»¥æŠŠè·¯ç”±ä¿¡æ¯åŠ å…¥ç‰©ç†è·¯ç”±å™¨ä¸Šï¼Œè¿™æ ·å°±ä¸ç”¨æ¯å°æœºéƒ½åŠ è·¯ç”±å’Œ dns äº†ï¼Œç›´æ¥æ‰“é€šæ‰€æœ‰é“¾è·¯ã€‚&lt;/p&gt;

&lt;h2 id=&#34;å‚è€ƒ&#34;&gt;å‚è€ƒ&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;http://blog.csdn.net/idea77/article/details/73863822&#34; target=&#34;_blank&#34;&gt;k8s-dns-gateway ç½‘å…³ç½‘ç»œæ‰©å±•å®æˆ˜&lt;/a&gt;&lt;/p&gt;

&lt;style&gt;
#h2{
    margin-bottom:2em; 
    margin-right: 5px; 
    padding: 8px 15px; 
    letter-spacing: 2px; 
    background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); 
    background-color: rgb(63, 81, 181); 
    color: rgb(255, 255, 255); 
    border-left: 10px solid rgb(51, 51, 51); 
    border-radius:5px; 
    text-shadow: rgb(102, 102, 102) 1px 1px 1px; 
    box-shadow: rgb(102, 102, 102) 1px 1px 2px;
}
#inline-yellow {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #f0ad4e;
}
#inline-green {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #5cb85c;
}
#inline-blue {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #2780e3;
}
#inline-purple {
display:inline;
padding:.2em .6em .3em;
font-size:80%;
font-weight:bold;
line-height:1;
color:#fff;
text-align:center;
white-space:nowrap;
vertical-align:baseline;
border-radius:0;
background-color: #9954bb;
}
#div-border-left-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #df3e3e;
}
#div-border-left-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #f0ad4e;
}
#div-border-left-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #5cb85c;
}
#div-border-left-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #2780e3;
}
#div-border-left-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-left-width: 5px;
border-radius: 3px;
border-left-color: #9954bb;
}
#div-border-right-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #df3e3e;
}
#div-border-right-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #f0ad4e;
}
#div-border-right-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #5cb85c;
}
#div-border-right-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #2780e3;
}
#div-border-right-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-right-width: 5px;
border-radius: 3px;
border-right-color: #9954bb;
}
#div-border-top-red {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #df3e3e;
}
#div-border-top-yellow {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #f0ad4e;
}
#div-border-top-green {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #5cb85c;
}
#div-border-top-blue {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #2780e3;
}
#div-border-top-purple {
display: block;
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-top-width: 5px;
border-radius: 3px;
border-top-color: #9954bb;
}
&lt;/style&gt;</description>
    </item>
    
    <item>
      <title>calico Router reflection(RR) æ¨¡å¼ä»‹ç»åŠéƒ¨ç½²</title>
      <link>https://www.yangcs.net/posts/calico-rr/</link>
      <pubDate>Thu, 01 Feb 2018 11:03:49 +0000</pubDate>
      
      <guid>https://www.yangcs.net/posts/calico-rr/</guid>
      <description>&lt;p&gt;
&lt;iframe frameborder=&#34;no&#34; border=&#34;0&#34; marginwidth=&#34;0&#34; marginheight=&#34;0&#34; width=0 height=0 src=&#34;http://o7z41ciog.bkt.clouddn.com/Two%20Steps%20From%20Hell%20-%20Star%20Sky.mp3&#34;&gt;&lt;/iframe&gt;&lt;/p&gt;

&lt;h2 id=&#34;p-markdown-1-style-margin-bottom-2em-margin-right-5px-padding-8px-15px-letter-spacing-2px-background-image-linear-gradient-to-right-bottom-rgb-0-188-212-rgb-63-81-181-background-color-rgb-63-81-181-color-rgb-255-255-255-border-left-10px-solid-rgb-51-51-51-border-radius-5px-text-shadow-rgb-102-102-102-1px-1px-1px-box-shadow-rgb-102-102-102-1px-1px-2px-1-åè¯è§£é‡Š-p&#34;&gt;&lt;p markdown=&#34;1&#34; style=&#34;margin-bottom:2em; margin-right: 5px; padding: 8px 15px; letter-spacing: 2px; background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); background-color: rgb(63, 81, 181); color: rgb(255, 255, 255); border-left: 10px solid rgb(51, 51, 51); border-radius:5px; text-shadow: rgb(102, 102, 102) 1px 1px 1px; box-shadow: rgb(102, 102, 102) 1px 1px 2px;&#34;&gt;1. åè¯è§£é‡Š&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;endpoint&lt;/code&gt;ï¼šæ¥å…¥åˆ°ç½‘ç»œä¸­çš„è®¾å¤‡ç§°ä¸º endpoint â¤ï¸&lt;/li&gt;
&lt;li&gt;&lt;code&gt;AS&lt;/code&gt;ï¼šç½‘ç»œè‡ªæ²»ç³»ç»Ÿï¼Œä¸€ä¸ªå®Œå…¨è‡ªæ²»çš„ç½‘ç»œï¼Œé€šè¿‡ BGP åè®®ä¸å…¶å®ƒ AS äº¤æ¢è·¯ç”±ä¿¡æ¯&lt;/li&gt;
&lt;li&gt;&lt;code&gt;ibgp&lt;/code&gt;ï¼šAS å†…éƒ¨çš„ BGP Speakerï¼Œä¸åŒä¸€ä¸ª AS å†…éƒ¨çš„ ibgpã€ebgp äº¤æ¢è·¯ç”±ä¿¡æ¯&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;code&gt;ebgp&lt;/code&gt;ï¼šAS è¾¹ç•Œçš„ BGP Speakerï¼Œä¸åŒä¸€ä¸ª AS å†…éƒ¨çš„ ibgpã€å…¶å®ƒ AS çš„ ebgp äº¤æ¢è·¯ç”±ä¿¡æ¯&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;code&gt;workloadEndpoint&lt;/code&gt;ï¼šCalico ç½‘ç»œä¸­çš„åˆ†é…è™šæ‹Ÿæœºã€å®¹å™¨ä½¿ç”¨çš„ endpoint&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;code&gt;hostEndpoints&lt;/code&gt;ï¼šCalico ç½‘ç»œä¸­çš„ç‰©ç†æœº(node)çš„åœ°å€&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;p-markdown-1-style-margin-bottom-2em-margin-right-5px-padding-8px-15px-letter-spacing-2px-background-image-linear-gradient-to-right-bottom-rgb-0-188-212-rgb-63-81-181-background-color-rgb-63-81-181-color-rgb-255-255-255-border-left-10px-solid-rgb-51-51-51-border-radius-5px-text-shadow-rgb-102-102-102-1px-1px-1px-box-shadow-rgb-102-102-102-1px-1px-2px-2-ç»„ç½‘åŸç†-p&#34;&gt;&lt;p markdown=&#34;1&#34; style=&#34;margin-bottom:2em; margin-right: 5px; padding: 8px 15px; letter-spacing: 2px; background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); background-color: rgb(63, 81, 181); color: rgb(255, 255, 255); border-left: 10px solid rgb(51, 51, 51); border-radius:5px; text-shadow: rgb(102, 102, 102) 1px 1px 1px; box-shadow: rgb(102, 102, 102) 1px 1px 2px;&#34;&gt;2. ç»„ç½‘åŸç†&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;code&gt;Calico&lt;/code&gt; ç»„ç½‘çš„æ ¸å¿ƒåŸç†å°±æ˜¯IPè·¯ç”±ï¼Œæ¯ä¸ªå®¹å™¨æˆ–è€…è™šæ‹Ÿæœºä¼šåˆ†é…ä¸€ä¸ª &lt;code&gt;workload-endpoint&lt;/code&gt;(wl)ã€‚&lt;/p&gt;

&lt;p&gt;ä» nodeA ä¸Šçš„å®¹å™¨ A å†…è®¿é—® nodeB ä¸Šçš„å®¹å™¨ B æ—¶:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-config&#34;&gt;+--------------------+              +--------------------+ 
|   +------------+   |              |   +------------+   | 
|   |            |   |              |   |            |   | 
|   |    ConA    |   |              |   |    ConB    |   | 
|   |            |   |              |   |            |   | 
|   +-----+------+   |              |   +-----+------+   | 
|         |          |              |         |          | 
|       wl-A         |              |       wl-B         | 
|         |          |              |         |          |
+-------node-A-------+              +-------node-B-------+ 
        |    |                               |    |
        |    | type1.  in the same lan       |    |
        |    +-------------------------------+    |
        |                                         |
        |      type2. in different network        |
        |             +-------------+             |
        |             |             |             |
        +-------------+   Routers   |-------------+
                      |             |
                      +-------------+

ä» ConA ä¸­å‘é€ç»™ ConB çš„æŠ¥æ–‡è¢« nodeA çš„ wl-A æ¥æ”¶ï¼Œæ ¹æ® nodeA ä¸Šçš„è·¯ç”±è§„åˆ™ï¼Œç»è¿‡å„ç§ iptables è§„åˆ™åï¼Œè½¬å‘åˆ° nodeBã€‚

å¦‚æœ nodeA å’Œ nodeB åœ¨åŒä¸€ä¸ªäºŒå±‚ç½‘æ®µï¼Œä¸‹ä¸€æ¡åœ°å€ç›´æ¥å°±æ˜¯ node-Bï¼Œç»è¿‡äºŒå±‚äº¤æ¢æœºå³å¯åˆ°è¾¾ã€‚
å¦‚æœ nodeA å’Œ nodeB åœ¨ä¸åŒçš„ç½‘æ®µï¼ŒæŠ¥æ–‡è¢«è·¯ç”±åˆ°ä¸‹ä¸€è·³ï¼Œç»è¿‡ä¸‰å±‚äº¤æ¢æˆ–è·¯ç”±å™¨ï¼Œä¸€æ­¥æ­¥è·³è½¬åˆ° node-Bã€‚
&lt;/code&gt;&lt;/pre&gt;

&lt;p id=&#34;div-border-left-red&#34;&gt;æ ¸å¿ƒé—®é¢˜æ˜¯ï¼ŒnodeA æ€æ ·å¾—çŸ¥ä¸‹ä¸€è·³çš„åœ°å€ï¼Ÿç­”æ¡ˆæ˜¯ node ä¹‹é—´é€šè¿‡ BGP åè®®äº¤æ¢è·¯ç”±ä¿¡æ¯ã€‚&lt;/p&gt;

&lt;p&gt;æ¯ä¸ª node ä¸Šè¿è¡Œä¸€ä¸ªè½¯è·¯ç”±è½¯ä»¶ &lt;code&gt;bird&lt;/code&gt;ï¼Œå¹¶ä¸”è¢«è®¾ç½®æˆ &lt;code&gt;BGP Speaker&lt;/code&gt;ï¼Œä¸å…¶å®ƒ node é€šè¿‡ BGP åè®®äº¤æ¢è·¯ç”±ä¿¡æ¯ã€‚&lt;/p&gt;

&lt;p&gt;å¯ä»¥ç®€å•ç†è§£ä¸ºï¼Œæ¯ä¸€ä¸ª node éƒ½ä¼šå‘å…¶å®ƒ node é€šçŸ¥è¿™æ ·çš„ä¿¡æ¯:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;æˆ‘æ˜¯X.X.X.Xï¼ŒæŸä¸ªIPæˆ–è€…ç½‘æ®µåœ¨æˆ‘è¿™é‡Œï¼Œå®ƒä»¬çš„ä¸‹ä¸€è·³åœ°å€æ˜¯æˆ‘ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;é€šè¿‡è¿™ç§æ–¹å¼æ¯ä¸ª node çŸ¥æ™“äº†æ¯ä¸ª &lt;code&gt;workload-endpoint&lt;/code&gt; çš„ä¸‹ä¸€è·³åœ°å€ã€‚&lt;/p&gt;

&lt;h2 id=&#34;p-markdown-1-style-margin-bottom-2em-margin-right-5px-padding-8px-15px-letter-spacing-2px-background-image-linear-gradient-to-right-bottom-rgb-0-188-212-rgb-63-81-181-background-color-rgb-63-81-181-color-rgb-255-255-255-border-left-10px-solid-rgb-51-51-51-border-radius-5px-text-shadow-rgb-102-102-102-1px-1px-1px-box-shadow-rgb-102-102-102-1px-1px-2px-3-bgp-ä¸-as-p&#34;&gt;&lt;p markdown=&#34;1&#34; style=&#34;margin-bottom:2em; margin-right: 5px; padding: 8px 15px; letter-spacing: 2px; background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); background-color: rgb(63, 81, 181); color: rgb(255, 255, 255); border-left: 10px solid rgb(51, 51, 51); border-radius:5px; text-shadow: rgb(102, 102, 102) 1px 1px 1px; box-shadow: rgb(102, 102, 102) 1px 1px 2px;&#34;&gt;3. BGP ä¸ AS&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;code&gt;BGP&lt;/code&gt; æ˜¯è·¯ç”±å™¨ä¹‹é—´çš„é€šä¿¡åè®®ï¼Œä¸»è¦ç”¨äº &lt;code&gt;AS&lt;/code&gt;ï¼ˆAutonomous System,è‡ªæ²»ç³»ç»Ÿï¼‰ä¹‹é—´çš„äº’è”ã€‚&lt;/p&gt;

&lt;p&gt;ASï¼Œè‡ªæ²»ç³»ç»Ÿï¼Œæ˜¯ä¸€ä¸ªè‡ªæ²»çš„ç½‘ç»œï¼Œæ‹¥æœ‰ç‹¬ç«‹çš„äº¤æ¢æœºã€è·¯ç”±å™¨ç­‰ï¼Œå¯ä»¥ç‹¬ç«‹è¿è½¬ã€‚&lt;/p&gt;

&lt;p&gt;æ¯ä¸ª AS æ‹¥æœ‰ä¸€ä¸ªå…¨çƒç»Ÿä¸€åˆ†é…çš„ 16 ä½çš„ ID å·ï¼Œå…¶ä¸­ 64512 åˆ° 65535 å…± 1023 ä¸ª AS å·ç è¢«é¢„ç•™ç”¨äºæœ¬åœ°æˆ–è€…ç§ç”¨ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# calicoé»˜è®¤ä½¿ç”¨çš„ASå·æ˜¯64512ï¼Œå¯ä»¥ä¿®æ”¹ï¼š

# æŸ¥çœ‹
$ calicoctl config get asNumber

# è®¾ç½®
$ calicoctl config set asNumber 64512
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;AS å†…éƒ¨æœ‰å¤šä¸ª &lt;code&gt;BGP speaker&lt;/code&gt;ï¼Œåˆ†ä¸º &lt;code&gt;ibgp&lt;/code&gt;ã€&lt;code&gt;ebgp&lt;/code&gt;ï¼Œ&lt;code&gt;ebgp&lt;/code&gt; è¿˜ä¸å…¶å®ƒçš„ AS ä¸­çš„ &lt;code&gt;ebgp&lt;/code&gt; å»ºç«‹ BGP è¿æ¥ã€‚&lt;/p&gt;

&lt;p&gt;AS å†…éƒ¨çš„ &lt;code&gt;BGP speaker&lt;/code&gt; é€šè¿‡ BGP åè®®äº¤æ¢è·¯ç”±ä¿¡æ¯ï¼Œæœ€ç»ˆæ¯ä¸€ä¸ª &lt;code&gt;BGP speaker&lt;/code&gt; æ‹¥æœ‰æ•´ä¸ª AS çš„è·¯ç”±ä¿¡æ¯ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;BGP speaker&lt;/code&gt; ä¸€èˆ¬æ˜¯ç½‘ç»œä¸­çš„ç‰©ç†è·¯ç”±å™¨ï¼Œcalico å°† node æ”¹é€ æˆäº†ä¸€ä¸ªè·¯ç”±å™¨ï¼ˆè½¯ä»¶bird)ï¼Œnode ä¸Šçš„è™šæ‹Ÿæœºã€å®¹å™¨ç­‰å°±æ˜¯æ¥å…¥è¿™ä¸ªè·¯ç”±å™¨çš„è®¾å¤‡ã€‚&lt;/p&gt;

&lt;p&gt;AS å†…éƒ¨çš„ &lt;code&gt;BGP Speaker&lt;/code&gt; ä¹‹é—´æœ‰ä¸¤ç§äº’è”æ–¹å¼:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å…¨äº’è”æ¨¡å¼æ¨¡å¼&lt;/li&gt;
&lt;li&gt;Router reflection(RR) æ¨¡å¼&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;3-1-bgp-speakerå…¨äº’è”æ¨¡å¼&#34;&gt;3.1 BGP Speakerå…¨äº’è”æ¨¡å¼&lt;/h3&gt;

&lt;p&gt;å…¨äº’è”æ¨¡å¼ï¼Œå°±æ˜¯ä¸€ä¸ª &lt;code&gt;BGP Speaker&lt;/code&gt; éœ€è¦ä¸å…¶å®ƒæ‰€æœ‰çš„ &lt;code&gt;BGP Speaker&lt;/code&gt; å»ºç«‹ bgp è¿æ¥ï¼ˆå½¢æˆä¸€ä¸ªbgp meshï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;ç½‘ç»œä¸­ bgp æ€»è¿æ¥æ•°æ˜¯æŒ‰ç…§ O(n^2) å¢é•¿çš„ï¼Œæœ‰å¤ªå¤šçš„ &lt;code&gt;BGP Speaker&lt;/code&gt; æ—¶ï¼Œä¼šæ¶ˆè€—å¤§é‡çš„è¿æ¥ã€‚&lt;/p&gt;

&lt;p&gt;Calico é»˜è®¤ä½¿ç”¨å…¨äº’è”çš„æ–¹å¼ï¼Œæ‰©å±•æ€§æ¯”è¾ƒå·®ï¼Œåªèƒ½æ”¯æŒå°è§„æ¨¡é›†ç¾¤ï¼Œå¯ä»¥æ‰“å¼€/å…³é—­å…¨äº’è”æ¨¡å¼ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ calicoctl config set nodeTonodeMesh off
$ calicoctl config set nodeTonodeMesh on
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;3-2-bgp-speaker-rr-æ¨¡å¼&#34;&gt;3.2 BGP Speaker RR æ¨¡å¼&lt;/h3&gt;

&lt;p&gt;RRæ¨¡å¼ï¼Œå°±æ˜¯åœ¨ç½‘ç»œä¸­æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ª &lt;code&gt;BGP Speaker&lt;/code&gt; ä½œä¸º åå°„è·¯ç”±ï¼ˆRouter Reflectorï¼‰ï¼ŒRR ä¸æ‰€æœ‰çš„ &lt;code&gt;BGP Speaker&lt;/code&gt; å»ºç«‹ bgp è¿æ¥ã€‚&lt;/p&gt;

&lt;p&gt;æ¯ä¸ª &lt;code&gt;BGP Speaker&lt;/code&gt; åªéœ€è¦ä¸ RR äº¤æ¢è·¯ç”±ä¿¡æ¯ï¼Œå°±å¯ä»¥å¾—åˆ°å…¨ç½‘è·¯ç”±ä¿¡æ¯ã€‚&lt;/p&gt;

&lt;p&gt;RR å¿…é¡»ä¸æ‰€æœ‰çš„ &lt;code&gt;BGP Speaker&lt;/code&gt; å»ºç«‹ BGP è¿æ¥ï¼Œä»¥ä¿è¯èƒ½å¤Ÿå¾—åˆ°å…¨ç½‘è·¯ç”±ä¿¡æ¯ã€‚&lt;/p&gt;

&lt;p&gt;åœ¨ Calico ä¸­å¯ä»¥é€šè¿‡ &lt;code&gt;Global Peer&lt;/code&gt; å®ç° RR æ¨¡å¼ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;Global Peer&lt;/code&gt; æ˜¯ä¸€ä¸ª &lt;code&gt;BGP Speaker&lt;/code&gt; ï¼Œéœ€è¦æ‰‹åŠ¨åœ¨ Calico ä¸­åˆ›å»ºï¼Œæ‰€æœ‰çš„ node éƒ½ä¼šä¸ &lt;code&gt;Global peer&lt;/code&gt; å»ºç«‹ BGP è¿æ¥ã€‚&lt;/p&gt;

&lt;p&gt;å…³é—­äº†å…¨äº’è”æ¨¡å¼åï¼Œå†å°† RR ä½œä¸º &lt;code&gt;Global Peers&lt;/code&gt; æ·»åŠ åˆ° Calico ä¸­ï¼ŒCalico ç½‘ç»œå°±åˆ‡æ¢åˆ°äº† RR æ¨¡å¼ï¼Œå¯ä»¥æ”¯æ’‘å®¹çº³æ›´å¤šçš„ nodeã€‚&lt;/p&gt;

&lt;h2 id=&#34;p-markdown-1-style-margin-bottom-2em-margin-right-5px-padding-8px-15px-letter-spacing-2px-background-image-linear-gradient-to-right-bottom-rgb-0-188-212-rgb-63-81-181-background-color-rgb-63-81-181-color-rgb-255-255-255-border-left-10px-solid-rgb-51-51-51-border-radius-5px-text-shadow-rgb-102-102-102-1px-1px-1px-box-shadow-rgb-102-102-102-1px-1px-2px-4-rr-æ¨¡å¼éƒ¨ç½²-p&#34;&gt;&lt;p markdown=&#34;1&#34; style=&#34;margin-bottom:2em; margin-right: 5px; padding: 8px 15px; letter-spacing: 2px; background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); background-color: rgb(63, 81, 181); color: rgb(255, 255, 255); border-left: 10px solid rgb(51, 51, 51); border-radius:5px; text-shadow: rgb(102, 102, 102) 1px 1px 1px; box-shadow: rgb(102, 102, 102) 1px 1px 2px;&#34;&gt;4. RR æ¨¡å¼éƒ¨ç½²&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;é›†ç¾¤ç¯å¢ƒï¼š&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&#34;left&#34;&gt;IP&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;ä¸»æœºå&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&#34;left&#34;&gt;10.10.31.190&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;kube-master&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;left&#34;&gt;10.10.31.193&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;kube-node1&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;left&#34;&gt;10.10.31.194&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;kube-node2&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;left&#34;&gt;10.10.31.168&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;node1&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h3 id=&#34;4-1-åœ¨-node1-èŠ‚ç‚¹ä¸Šå¯åŠ¨åå°„è·¯ç”±å®ä¾‹&#34;&gt;4.1 åœ¨ node1 èŠ‚ç‚¹ä¸Šå¯åŠ¨åå°„è·¯ç”±å®ä¾‹&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ docker run --privileged --net=host -d \
             -e IP=&amp;lt;IPv4_RR&amp;gt; \
             [-e IP6=&amp;lt;IPv6_RR&amp;gt;] \
             -e ETCD_ENDPOINTS=&amp;lt;https://ETCD_IP:PORT&amp;gt; \
             -v &amp;lt;FULL_PATH_TO_CERT_DIR&amp;gt;:&amp;lt;MOUNT_DIR&amp;gt; \
             -e ETCD_CA_CERT_FILE=&amp;lt;MOUNT_DIR&amp;gt;/&amp;lt;CA_FILE&amp;gt; \
             -e ETCD_CERT_FILE=&amp;lt;MOUNT_DIR&amp;gt;/&amp;lt;CERT_FILE&amp;gt; \
             -e ETCD_KEY_FILE=&amp;lt;MOUNT_DIR&amp;gt;/&amp;lt;KEY_FILE&amp;gt; \
             calico/routereflector:v0.4.0

# &amp;lt;FULL_PATH_TO_CERT_DIR&amp;gt; æ˜¯ä½ çš„å®¿ä¸»æœºçš„ etcd è¯ä¹¦å’Œç§˜é’¥çš„å­˜æ”¾ç›®å½•
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;4-2-é…ç½®åå°„è·¯ç”±çš„é›†ç¾¤&#34;&gt;4.2 é…ç½®åå°„è·¯ç”±çš„é›†ç¾¤&lt;/h3&gt;

&lt;p&gt;åå°„è·¯ç”±å…³äº ipv4 çš„é…ç½®åœ¨ etcd ä¸­çš„å­˜å‚¨è·¯å¾„ä¸ºï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;/calico/bgp/v1/rr_v4/&amp;lt;RR IPv4 address&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ipv6 çš„é…ç½®åœ¨ etcd ä¸­çš„å­˜å‚¨è·¯å¾„ä¸ºï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;/calico/bgp/v1/rr_v6/&amp;lt;RR IPv6 address&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ•°æ®æ ¼å¼ä¸º jsonï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-json&#34;&gt;{
  &amp;quot;ip&amp;quot;: &amp;quot;&amp;lt;IP address of Route Reflector&amp;gt;&amp;quot;,
  &amp;quot;cluster_id&amp;quot;: &amp;quot;&amp;lt;Cluster ID for this RR (see notes)&amp;gt;&amp;quot;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é€šè¿‡ curl å°†è¯¥æ¡ç›®æ·»åŠ åˆ° etcd ä¸­&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# IPv4 entries
$ curl --cacert &amp;lt;path_to_ca_cert&amp;gt; --cert &amp;lt;path_to_cert&amp;gt; --key &amp;lt;path_to_key&amp;gt; -L https://&amp;lt;ETCD_IP:PORT&amp;gt;:2379/v2/keys/calico/bgp/v1/rr_v4/&amp;lt;IPv4_RR&amp;gt; -XPUT -d value=&amp;quot;{\&amp;quot;ip\&amp;quot;:\&amp;quot;&amp;lt;IPv4_RR&amp;gt;\&amp;quot;,\&amp;quot;cluster_id\&amp;quot;:\&amp;quot;&amp;lt;CLUSTER_ID&amp;gt;\&amp;quot;}&amp;quot;
# IPv6 entries
$ curl --cacert &amp;lt;path_to_ca_cert&amp;gt; --cert &amp;lt;path_to_cert&amp;gt; --key &amp;lt;path_to_key&amp;gt; -L https://&amp;lt;ETCD_IP:PORT&amp;gt;:2379/v2/keys/calico/bgp/v1/rr_v6/&amp;lt;IPv6_RR&amp;gt; -XPUT -d value=&amp;quot;{\&amp;quot;ip\&amp;quot;:\&amp;quot;&amp;lt;IPv6_RR&amp;gt;\&amp;quot;,\&amp;quot;cluster_id\&amp;quot;:\&amp;quot;&amp;lt;CLUSTER_ID&amp;gt;\&amp;quot;}&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¾‹å¦‚ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ curl --cacert &amp;lt;path_to_ca_cert&amp;gt; --cert &amp;lt;path_to_cert&amp;gt; --key &amp;lt;path_to_key&amp;gt; -L https://10.10.31.190:2379/v2/keys/calico/bgp/v1/rr_v4/10.10.31.168 -XPUT -d value=&amp;quot;{\&amp;quot;ip\&amp;quot;:\&amp;quot;10.10.31.168\&amp;quot;,\&amp;quot;cluster_id\&amp;quot;:\&amp;quot;1.0.0.1\&amp;quot;}&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;4-3-é…ç½®-calico-ä½¿ç”¨åå°„è·¯ç”±&#34;&gt;4.3 é…ç½® calico ä½¿ç”¨åå°„è·¯ç”±&lt;/h3&gt;

&lt;p&gt;å…³é—­å…¨äº’è”æ¨¡å¼&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ calicoctl config set nodeToNodeMesh off
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç¡®å®šä½ çš„ç½‘ç»œçš„ AS å·ç &lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ calicoctl get nodes --output=wide

# æˆ–è€…ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤
$ calicoctl config get asNumber
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å°† RR ä½œä¸º &lt;code&gt;Global Peers&lt;/code&gt; æ·»åŠ åˆ° Calico ä¸­&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ calicoctl create -f - &amp;lt;&amp;lt; EOF
apiVersion: v1
kind: bgpPeer
metadata:
  peerIP: &amp;lt;IP_RR&amp;gt;
  scope: global
spec:
  asNumber: &amp;lt;AS_NUM&amp;gt;
EOF

# &amp;lt;IP_RR&amp;gt;ï¼šåå°„è·¯ç”±çš„ ipv4 æˆ– ipv6 åœ°å€
# &amp;lt;AS_NUM&amp;gt;ï¼šç½‘ç»œçš„ AS å·ç 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç”±äº BGP åè®®ä½¿ç”¨ TCP 179 ç«¯å£è¿›è¡Œé€šä¿¡ï¼Œå¯ä»¥åœ¨ node1 ä¸ŠæŸ¥çœ‹ä¸€ä¸‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ss -tnp|grep 179
ESTAB      0      0      10.10.31.168:179                10.10.31.196:55967               users:((&amp;quot;bird&amp;quot;,pid=10601,fd=8))
ESTAB      0      0      10.10.31.168:56393              10.10.31.193:179                 users:((&amp;quot;bird&amp;quot;,pid=10601,fd=9))
ESTAB      0      0      10.10.31.168:41164              10.10.31.194:179                 users:((&amp;quot;bird&amp;quot;,pid=10601,fd=10))
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨ node1 ä¸ŠæŸ¥çœ‹åå°„è·¯ç”±é…ç½®&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ docker exec 52e584f5bcf3 cat /config/bird.cfg
# Generated by confd
router id 10.10.31.168;

# Watch interface up/down events.
protocol device {
  scan time 2;    # Scan interfaces every 2 seconds
}

# Template for all BGP clients
template bgp bgp_template {
  debug off;
  description &amp;quot;Connection to BGP peer&amp;quot;;
  multihop;
  import all;        # Import all routes, since we don&#39;t know what the upstream
                     # topology is and therefore have to trust the ToR/RR.
  export all;        # Export all.
  source address 10.10.31.168;  # The local address we use for the TCP connection
  graceful restart;  # See comment in kernel section about graceful restart.
}



# ------------- RR-to-RR full mesh -------------



# For RR 10.10.31.168
# Skipping ourselves




# ------------- RR as a global peer -------------



# This RR is a global peer with *all* calico nodes.




# Peering with Calico node node1
protocol bgp Global_10_10_31_193 from bgp_template {
  local as 64512;
  neighbor 10.10.31.193 as 64512;
  rr client;
  rr cluster id 1.0.0.1;
}




# Peering with Calico node node2
protocol bgp Global_10_10_31_194 from bgp_template {
  local as 64512;
  neighbor 10.10.31.194 as 64512;
  rr client;
  rr cluster id 1.0.0.1;
}




# Peering with Calico node node3
protocol bgp Global_10_10_31_196 from bgp_template {
  local as 64512;
  neighbor 10.10.31.196 as 64512;
  rr client;
  rr cluster id 1.0.0.1;
}






# ------------- RR as a node-specific peer -------------
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨ kube-node1 ä¸ŠæŸ¥çœ‹ calico çš„é…ç½®&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ docker exec 7fcb072515d6 cat /etc/calico/confd/config/bird.cfg
# Generated by confd
include &amp;quot;bird_aggr.cfg&amp;quot;;
include &amp;quot;custom_filters.cfg&amp;quot;;
include &amp;quot;bird_ipam.cfg&amp;quot;;


router id 10.10.31.193;



# Configure synchronization between routing tables and kernel.
protocol kernel {
  learn;             # Learn all alien routes from the kernel
  persist;           # Don&#39;t remove routes on bird shutdown
  scan time 2;       # Scan kernel routing table every 2 seconds
  import all;
  export filter calico_ipip; # Default is export none
  graceful restart;  # Turn on graceful restart to reduce potential flaps in
                     # routes when reloading BIRD configuration.  With a full
                     # automatic mesh, there is no way to prevent BGP from
                     # flapping since multiple nodes update their BGP
                     # configuration at the same time, GR is not guaranteed to

# Watch interface up/down events.
protocol device {
  

  debug { states };


  scan time 2;    # Scan interfaces every 2 seconds
}

protocol direct {
  

  debug { states };


  interface -&amp;quot;cali*&amp;quot;, &amp;quot;*&amp;quot;; # Exclude cali* but include everything else.
}


# Template for all BGP clients
template bgp bgp_template {
  

  debug { states };


  description &amp;quot;Connection to BGP peer&amp;quot;;
  local as 64512;
  multihop;
  gateway recursive; # This should be the default, but just in case.
  import all;        # Import all routes, since we don&#39;t know what the upstream
                     # topology is and therefore have to trust the ToR/RR.
  export filter calico_pools;  # Only want to export routes for workloads.
  next hop self;     # Disable next hop processing and always advertise our
                     # local address as nexthop
  source address 10.10.31.193;  # The local address we use for the TCP connection
  add paths on;
  graceful restart;  # See comment in kernel section about graceful restart.
}


# ------------- Global peers -------------



# For peer /global/peer_v4/10.10.31.168
protocol bgp Global_10_10_31_168 from bgp_template {
  neighbor 10.10.31.168 as 64512;
}




# ------------- Node-specific peers -------------
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h2 id=&#34;p-markdown-1-style-margin-bottom-2em-margin-right-5px-padding-8px-15px-letter-spacing-2px-background-image-linear-gradient-to-right-bottom-rgb-0-188-212-rgb-63-81-181-background-color-rgb-63-81-181-color-rgb-255-255-255-border-left-10px-solid-rgb-51-51-51-border-radius-5px-text-shadow-rgb-102-102-102-1px-1px-1px-box-shadow-rgb-102-102-102-1px-1px-2px-5-å¤š-cluster-id-å®ä¾‹æ‹“æ‰‘-p&#34;&gt;&lt;p markdown=&#34;1&#34; style=&#34;margin-bottom:2em; margin-right: 5px; padding: 8px 15px; letter-spacing: 2px; background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); background-color: rgb(63, 81, 181); color: rgb(255, 255, 255); border-left: 10px solid rgb(51, 51, 51); border-radius:5px; text-shadow: rgb(102, 102, 102) 1px 1px 1px; box-shadow: rgb(102, 102, 102) 1px 1px 2px;&#34;&gt;5. å¤š cluster ID å®ä¾‹æ‹“æ‰‘&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;å½“æ‹“æ‰‘åŒ…å«äº†å¤šä¸ªåå°„è·¯ç”±æ—¶,BGP åˆ©ç”¨é›†ç¾¤ id æ¥ä¿è¯åˆ†é…è·¯ç”±æ—¶ä¸é™·å…¥å¾ªç¯è·¯ç”±ã€‚
åå°„è·¯ç”±é•œåƒå¸®åŠ©æ¯ä¸ªåå°„è·¯ç”±æä¾›å›ºå®šçš„é›†ç¾¤ id è€Œä¸æ˜¯ä¾èµ–å•ä¸€å¹³è¡ŒåŸåˆ™è¿›è¡Œé…ç½®,è¿™ç®€åŒ–äº†æ•´ä¸ªç½‘ç»œçš„é…ç½®,ä½†ä¹Ÿç»™æ‹“æ‰‘å¸¦æ¥äº†ä¸€äº›é™åˆ¶:&lt;/p&gt;

&lt;p&gt;The Route Reflector image provided assumes that it has a fixed cluster ID for each Route Reflector rather than being configurable on a per peer basis.&lt;/p&gt;

&lt;p&gt;For example, the topology outlined in the diagram below is based on the Top of Rack model:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Each rack is assigned its own cluster ID (a unique number in IPv4 address format).&lt;/li&gt;
&lt;li&gt;Each node (server in the rack) peers with a redundant set of route reflectors specific to that rack.&lt;/li&gt;
&lt;li&gt;All of the ToR route reflectors form a full mesh with each other.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&#34;http://o7z41ciog.bkt.clouddn.com/mesh-topology.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;For example, to set up the topology described above, you would:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Spin up nodes N1 - N9&lt;/li&gt;
&lt;li&gt;Spin up Route Reflectors RR1 - RR6&lt;/li&gt;
&lt;li&gt;Add node specific peers, peering:
N1, N2 and N3 with RR1 and RR2
N4, N5 and N6 with RR3 and RR4
N7, N8 and N9 with RR5 and RR6&lt;/li&gt;
&lt;li&gt;Add etcd config for the Route Reflectors:
RR1 and RR2 both using the cluster ID 1.0.0.1
RR2 and RR3 both using the cluster ID 1.0.0.2
RR4 and RR5 both using the cluster ID 1.0.0.3&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>Device Mapperç³»åˆ— (3)ï¼šDocker ä¸­ä½¿ç”¨ devicemapper å­˜å‚¨é©±åŠ¨</title>
      <link>https://www.yangcs.net/posts/use-devicemapper/</link>
      <pubDate>Mon, 22 Jan 2018 16:17:11 +0800</pubDate>
      
      <guid>https://www.yangcs.net/posts/use-devicemapper/</guid>
      <description>&lt;p&gt;&lt;/p&gt;

&lt;h2 id=&#34;p-markdown-1-style-margin-bottom-2em-margin-right-5px-padding-8px-15px-letter-spacing-2px-background-image-linear-gradient-to-right-bottom-rgb-0-188-212-rgb-63-81-181-background-color-rgb-63-81-181-color-rgb-255-255-255-border-left-10px-solid-rgb-51-51-51-border-radius-5px-text-shadow-rgb-102-102-102-1px-1px-1px-box-shadow-rgb-102-102-102-1px-1px-2px-1-å‡†å¤‡æ¡ä»¶-p&#34;&gt;&lt;p markdown=&#34;1&#34; style=&#34;margin-bottom:2em; margin-right: 5px; padding: 8px 15px; letter-spacing: 2px; background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); background-color: rgb(63, 81, 181); color: rgb(255, 255, 255); border-left: 10px solid rgb(51, 51, 51); border-radius:5px; text-shadow: rgb(102, 102, 102) 1px 1px 1px; box-shadow: rgb(102, 102, 102) 1px 1px 2px;&#34;&gt;1. &lt;strong&gt;å‡†å¤‡æ¡ä»¶&lt;/strong&gt;&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;devicemapper&lt;/code&gt; å­˜å‚¨é©±åŠ¨æ˜¯ &lt;code&gt;RHEL&lt;/code&gt;, &lt;code&gt;CentOS&lt;/code&gt; å’Œ &lt;code&gt;Oracle Linux&lt;/code&gt; ç³»ç»Ÿä¸Šå”¯ä¸€ä¸€ä¸ªæ”¯æŒ &lt;code&gt;Docker EE&lt;/code&gt; å’Œ &lt;code&gt;Commercially Supported Docker Engine&lt;/code&gt; (CS-Engine) çš„å­˜å‚¨é©±åŠ¨ï¼Œå…·ä½“å‚è€ƒ &lt;a href=&#34;https://success.docker.com/Policies/Compatibility_Matrix&#34; target=&#34;_blank&#34;&gt;Product compatibility matrix&lt;/a&gt;.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;code&gt;devicemapper&lt;/code&gt; åœ¨ &lt;code&gt;CentOS&lt;/code&gt;, &lt;code&gt;Fedora&lt;/code&gt;, &lt;code&gt;Ubuntu&lt;/code&gt; å’Œ &lt;code&gt;Debian&lt;/code&gt; ä¸Šä¹Ÿæ”¯æŒ &lt;code&gt;Docker CE&lt;/code&gt;ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;å¦‚æœä½ æ›´æ”¹äº† &lt;code&gt;Docker&lt;/code&gt; çš„å­˜å‚¨é©±åŠ¨ï¼Œé‚£ä¹ˆä½ ä¹‹å‰åœ¨æœ¬åœ°åˆ›å»ºçš„æ‰€æœ‰å®¹å™¨éƒ½å°†æ— æ³•è®¿é—®ã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;p-markdown-1-style-margin-bottom-2em-margin-right-5px-padding-8px-15px-letter-spacing-2px-background-image-linear-gradient-to-right-bottom-rgb-0-188-212-rgb-63-81-181-background-color-rgb-63-81-181-color-rgb-255-255-255-border-left-10px-solid-rgb-51-51-51-border-radius-5px-text-shadow-rgb-102-102-102-1px-1px-1px-box-shadow-rgb-102-102-102-1px-1px-2px-2-é…ç½®dockerä½¿ç”¨devicemapper-p&#34;&gt;&lt;p markdown=&#34;1&#34; style=&#34;margin-bottom:2em; margin-right: 5px; padding: 8px 15px; letter-spacing: 2px; background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); background-color: rgb(63, 81, 181); color: rgb(255, 255, 255); border-left: 10px solid rgb(51, 51, 51); border-radius:5px; text-shadow: rgb(102, 102, 102) 1px 1px 1px; box-shadow: rgb(102, 102, 102) 1px 1px 2px;&#34;&gt;2. &lt;strong&gt;é…ç½®Dockerä½¿ç”¨devicemapper&lt;/strong&gt;&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;Docker ä¸»æœºè¿è¡Œ &lt;code&gt;devicemapper&lt;/code&gt; å­˜å‚¨é©±åŠ¨æ—¶ï¼Œé»˜è®¤çš„é…ç½®æ¨¡å¼ä¸º &lt;code&gt;loop-lvm&lt;/code&gt;ã€‚æ­¤æ¨¡å¼ä½¿ç”¨ç©ºé—²çš„æ–‡ä»¶æ¥æ„å»ºç”¨äºé•œåƒå’Œå®¹å™¨å¿«ç…§çš„ç²¾ç®€å­˜å‚¨æ± ã€‚è¯¥æ¨¡å¼è®¾è®¡ä¸ºæ— éœ€é¢å¤–é…ç½®å¼€ç®±å³ç”¨(out-of-the-box)ã€‚ä¸è¿‡ç”Ÿäº§éƒ¨ç½²ä¸åº”è¯¥ä»¥ &lt;code&gt;loop-lvm&lt;/code&gt; æ¨¡å¼è¿è¡Œã€‚&lt;/p&gt;

&lt;h3 id=&#34;2-1-ç”Ÿäº§ç¯å¢ƒé…ç½®direct-lvmæ¨¡å¼&#34;&gt;&lt;strong&gt;2.1 ç”Ÿäº§ç¯å¢ƒé…ç½®direct-lvmæ¨¡å¼&lt;/strong&gt;&lt;/h3&gt;

&lt;p&gt;CentOS7 ä» &lt;code&gt;Docker 17.06&lt;/code&gt; å¼€å§‹æ”¯æŒé€šè¿‡ Docker è‡ªåŠ¨é…ç½®  &lt;code&gt;direct-lvm&lt;/code&gt;ï¼Œæ‰€ä»¥æ¨èä½¿ç”¨è¯¥å·¥å…·é…ç½®ã€‚å½“ç„¶ä¹Ÿå¯ä»¥æ‰‹åŠ¨é…ç½® &lt;code&gt;lvm&lt;/code&gt;ï¼Œæ·»åŠ ç›¸å…³é…ç½®é€‰é¡¹ï¼Œä¸è¿‡è¿‡ç¨‹è¾ƒä¸ºç¹çä¸€ç‚¹ã€‚&lt;/p&gt;

&lt;h4 id=&#34;è‡ªåŠ¨é…ç½®-direct-lvm-æ¨¡å¼&#34;&gt;&lt;strong&gt;è‡ªåŠ¨é…ç½® direct-lvm æ¨¡å¼&lt;/strong&gt;&lt;/h4&gt;

&lt;p&gt;è¯¥æ–¹æ³•åªé€‚ç”¨äºä¸€ä¸ªå—è®¾å¤‡ï¼Œå¦‚æœä½ æœ‰å¤šä¸ªå—è®¾å¤‡ï¼Œè¯·é€šè¿‡æ‰‹åŠ¨é…ç½® &lt;code&gt;direct-lvm&lt;/code&gt; æ¨¡å¼ã€‚&lt;/p&gt;

&lt;p&gt;ç¤ºä¾‹é…ç½®æ–‡ä»¶ä½ç½® &lt;code&gt;/usr/lib/docker-storage-setup/docker-storage-setup&lt;/code&gt;ï¼Œå¯ä»¥æŸ¥çœ‹å…¶ä¸­ç›¸å…³é…ç½®çš„è¯¦ç»†è¯´æ˜ï¼Œæˆ–è€…é€šè¿‡ &lt;code&gt;man docker-storage-setup&lt;/code&gt; è·å–å¸®åŠ©ï¼Œä»¥ä¸‹ä»‹ç»å‡ ä¸ªå…³é”®çš„é€‰é¡¹ï¼š&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&#34;left&#34;&gt;å‚æ•°&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;è§£é‡Š&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;æ˜¯å¦å¿…é¡»&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;é»˜è®¤å€¼&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;ç¤ºä¾‹&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&#34;left&#34;&gt;dm.directlvm_device&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;å‡†å¤‡é…ç½® direct-lvm çš„å—è®¾å¤‡çš„è·¯å¾„&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;æ˜¯&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;dm.directlvm_device=&amp;ldquo;/dev/xvdf&amp;rdquo;&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;left&#34;&gt;dm.thinp_percent&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;å®šä¹‰åˆ›å»º data thin pool çš„å¤§å°&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;å¦&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;95&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;dm.thinp_percent=95&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;left&#34;&gt;dm.thinp_metapercent&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;å®šä¹‰åˆ›å»º metadata thin pool çš„å¤§å°&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;å¦&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;1&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;dm.thinp_metapercent=1&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;left&#34;&gt;dm.thinp_autoextend_threshold&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;å®šä¹‰è‡ªåŠ¨æ‰©å®¹çš„ç™¾åˆ†æ¯”ï¼Œ100 è¡¨ç¤º disableï¼Œæœ€å°ä¸º 50ï¼Œå‚è€ƒ &lt;a href=&#34;http://man7.org/linux/man-pages/man7/lvmthin.7.html&#34; target=&#34;_blank&#34;&gt;lvmthin â€” LVM thin provisioning&lt;/a&gt;&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;å¦&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;80&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;dm.thinp_autoextend_threshold=80&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;left&#34;&gt;dm.thinp_autoextend_percent&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;å®šä¹‰æ¯æ¬¡æ‰©å®¹çš„å¤§å°ï¼Œ100 è¡¨ç¤º disable&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;å¦&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;20&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;dm.thinp_autoextend_percent=20&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;left&#34;&gt;dm.directlvm_device_force&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;å½“å—è®¾å¤‡å·²ç»å­˜åœ¨æ–‡ä»¶ç³»ç»Ÿæ—¶ï¼Œæ˜¯å¦æ ¼å¼åŒ–å—è®¾å¤‡&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;å¦&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;false&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;dm.directlvm_device_force=true&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;ç¼–è¾‘ &lt;code&gt;/etc/docker/daemon.json&lt;/code&gt;ï¼Œè®¾ç½®å¥½å‚æ•°åé‡æ–°å¯åŠ¨ Docker ä½¿æ›´æ”¹ç”Ÿæ•ˆã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;{
  &amp;quot;storage-driver&amp;quot;: &amp;quot;devicemapper&amp;quot;,
  &amp;quot;storage-opts&amp;quot;: [
    &amp;quot;dm.directlvm_device=/dev/xdf&amp;quot;,
    &amp;quot;dm.thinp_percent=95&amp;quot;,
    &amp;quot;dm.thinp_metapercent=1&amp;quot;,
    &amp;quot;dm.thinp_autoextend_threshold=80&amp;quot;,
    &amp;quot;dm.thinp_autoextend_percent=20&amp;quot;,
    &amp;quot;dm.directlvm_device_force=false&amp;quot;
  ]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…³äºå­˜å‚¨çš„æ›´å¤šå‚æ•°è¯·å‚è€ƒï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a href=&#34;https://docs.docker.com/engine/reference/commandline/dockerd/#storage-driver-options&#34; target=&#34;_blank&#34;&gt;Stable&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;a href=&#34;https://docs.docker.com/edge/engine/reference/commandline/dockerd/#storage-driver-options&#34; target=&#34;_blank&#34;&gt;Edge&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;æ‰‹åŠ¨é…ç½®-direct-lvm-æ¨¡å¼&#34;&gt;&lt;strong&gt;æ‰‹åŠ¨é…ç½® direct-lvm æ¨¡å¼&lt;/strong&gt;&lt;/h4&gt;

&lt;p&gt;ä¸‹é¢çš„æ­¥éª¤åˆ›å»ºä¸€ä¸ªé€»è¾‘å·ï¼Œé…ç½®ç”¨ä½œå­˜å‚¨æ± çš„åç«¯ã€‚æˆ‘ä»¬å‡è®¾ä½ æœ‰åœ¨ &lt;code&gt;/dev/xvdf&lt;/code&gt; çš„å……è¶³ç©ºé—²ç©ºé—´çš„å—è®¾å¤‡ã€‚ä¹Ÿå‡è®¾ä½ çš„ Docker daemon å·²åœæ­¢ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;1.ç™»å½•ä½ è¦é…ç½®çš„ &lt;code&gt;Docker&lt;/code&gt; ä¸»æœºå¹¶åœæ­¢ &lt;code&gt;Docker daemon&lt;/code&gt;ã€‚&lt;/li&gt;

&lt;li&gt;&lt;p&gt;2.å®‰è£…LVM2è½¯ä»¶åŒ…ã€‚LVM2è½¯ä»¶åŒ…å«ç®¡ç†Linuxä¸Šé€»è¾‘å·çš„ç”¨æˆ·ç©ºé—´å·¥å…·é›†ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;RHEL / CentOS:&lt;/strong&gt; &lt;code&gt;device-mapper-persistent-data&lt;/code&gt;, &lt;code&gt;lvm2&lt;/code&gt; ä»¥åŠç›¸å…³ä¾èµ–&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Ubuntu / Debian:&lt;/strong&gt; &lt;code&gt;thin-provisioning-tools&lt;/code&gt;, &lt;code&gt;lvm2&lt;/code&gt; ä»¥åŠç›¸å…³ä¾èµ–&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;3.åˆ›å»ºç‰©ç†å·ã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ pvcreate /dev/xvdf

Physical volume &amp;quot;/dev/xvdf&amp;quot; successfully created.
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;4.åˆ›å»ºä¸€ä¸ª â€œdockerâ€ å·ç»„ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ vgcreate docker /dev/xvdf

Volume group &amp;quot;docker&amp;quot; successfully created
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;5.åˆ›å»ºä¸€ä¸ªåä¸ºthinpoolçš„å­˜å‚¨æ± ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œè®¾ç½®æ± å¤§å°ä¸º â€œdockerâ€ å·ç»„å¤§å°çš„ &lt;code&gt;95ï¼…&lt;/code&gt;ã€‚ å…¶ä½™çš„ç©ºé—²ç©ºé—´å¯ä»¥ç”¨æ¥è‡ªåŠ¨æ‰©å±•æ•°æ®æˆ–å…ƒæ•°æ®ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ lvcreate --wipesignatures y -n thinpool docker -l 95%VG

Logical volume &amp;quot;thinpool&amp;quot; created.

$ lvcreate --wipesignatures y -n thinpoolmeta docker -l 1%VG

Logical volume &amp;quot;thinpoolmeta&amp;quot; created.
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;6.å°†å­˜å‚¨æ± è½¬æ¢ä¸º &lt;code&gt;thinpool&lt;/code&gt; æ ¼å¼ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ lvconvert -y \
--zero n \
-c 512K \
--thinpool docker/thinpool \
--poolmetadata docker/thinpoolmeta

WARNING: Converting logical volume docker/thinpool and docker/thinpoolmeta to
thin pool&#39;s data and metadata volumes with metadata wiping.
THIS WILL DESTROY CONTENT OF LOGICAL VOLUME (filesystem etc.)
Converted docker/thinpool to thin pool.
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;7.é€šè¿‡ &lt;code&gt;lvm profile&lt;/code&gt; é…ç½®å­˜å‚¨æ± çš„è‡ªåŠ¨æ‰©å±•ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ vi /etc/lvm/profile/docker-thinpool.profile
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;8.è®¾ç½®å‚æ•° &lt;code&gt;thin_pool_autoextend_threshold&lt;/code&gt; å’Œ &lt;code&gt;thin_pool_autoextend_percent&lt;/code&gt; çš„å€¼ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
&lt;p&gt;è®¾ç½® &lt;code&gt;thin_pool_autoextend_threshold&lt;/code&gt; å€¼ã€‚è¿™ä¸ªå€¼åº”è¯¥æ˜¯ä¹‹å‰è®¾ç½®å­˜å‚¨æ± ä½™ä¸‹ç©ºé—´çš„ç™¾åˆ†æ¯”(100 = disabled)ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;thin_pool_autoextend_threshold = 80
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;è®¾ç½®å½“å­˜å‚¨æ± è‡ªåŠ¨æ‰©å®¹æ—¶ï¼Œå¢åŠ å­˜å‚¨æ± çš„ç©ºé—´ç™¾åˆ†æ¯”ï¼ˆ100 =ç¦ç”¨ï¼‰&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;thin_pool_autoextend_percent = 20
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ£€æŸ¥ä½ çš„ &lt;code&gt;docker-thinpool.profile&lt;/code&gt; çš„è®¾ç½®ã€‚ä¸€ä¸ªç¤ºä¾‹ &lt;code&gt;/etc/lvm/profile/docker-thinpool.profile&lt;/code&gt; åº”è¯¥ç±»ä¼¼å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;activation {
  thin_pool_autoextend_threshold=80
  thin_pool_autoextend_percent=20
}
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;9.åº”ç”¨æ–°çš„ &lt;code&gt;lvm&lt;/code&gt; é…ç½®ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ lvchange --metadataprofile docker-thinpool docker/thinpool

Logical volume docker/thinpool changed.
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;10.æŸ¥çœ‹å·çš„ä¿¡æ¯ï¼ŒéªŒè¯ lv æ˜¯å¦å—ç›‘æ§ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ lvs -o+seg_monitor

LV       VG     Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert Monitor
thinpool docker twi-a-t--- 95.00g             0.00   0.01                             monitored
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;11.å¤‡ä»½ &lt;code&gt;Docker&lt;/code&gt; å­˜å‚¨ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ mkdir /var/lib/docker.bk
$ mv /var/lib/docker/* /var/lib/docker.bk
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;12.é…ç½®ä¸€äº›ç‰¹å®šçš„ &lt;code&gt;devicemapper&lt;/code&gt; é€‰é¡¹ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cat /etc/docker/daemon.json

{
    &amp;quot;storage-driver&amp;quot;: &amp;quot;devicemapper&amp;quot;,
    &amp;quot;storage-opts&amp;quot;: [
    &amp;quot;dm.thinpooldev=/dev/mapper/docker-thinpool&amp;quot;,
    &amp;quot;dm.use_deferred_removal=true&amp;quot;,
    &amp;quot;dm.use_deferred_deletion=true&amp;quot;
    ]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p markdown=&#34;1&#34; style=&#34;display: block;padding: 10px;margin: 10px 0;border: 1px solid #ccc;border-top-width: 5px;border-radius: 3px;border-top-color: #9954bb;&#34;&gt;
&lt;strong&gt;ã€æ³¨æ„äº‹é¡¹ã€‘&lt;/strong&gt;

Note: Always set both dm.use_deferred_removal=true and dm.use_deferred_deletion=true to prevent unintentionally leaking mount points.
&lt;br /&gt;
å¯ç”¨ä¸Šè¿°2ä¸ªå‚æ•°æ¥é˜»æ­¢å¯èƒ½æ„å¤–äº§ç”Ÿçš„æŒ‚è½½ç‚¹æ³„æ¼é—®é¢˜
&lt;/p&gt;

&lt;h4 id=&#34;æ£€æŸ¥ä¸»æœºä¸Šçš„-devicemapper-ç»“æ„&#34;&gt;&lt;strong&gt;æ£€æŸ¥ä¸»æœºä¸Šçš„ &lt;code&gt;devicemapper&lt;/code&gt; ç»“æ„&lt;/strong&gt;&lt;/h4&gt;

&lt;p&gt;ä½ å¯ä»¥ä½¿ç”¨ &lt;code&gt;lsblk&lt;/code&gt; å‘½ä»¤æ¥æŸ¥çœ‹ä»¥ä¸Šåˆ›å»ºçš„è®¾å¤‡æ–‡ä»¶å’Œå­˜å‚¨æ± ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ lsblk
NAME               MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
xvda               202:0    0    8G  0 disk
â””â”€xvda1            202:1    0    8G  0 part /
xvdf               202:80   0   10G  0 disk
â”œâ”€vg--docker-data          253:0    0   90G  0 lvm
â”‚ â””â”€docker-202:1-1032-pool 253:2    0   10G  0 dm
â””â”€vg--docker-metadata      253:1    0    4G  0 lvm
  â””â”€docker-202:1-1032-pool 253:2    0   10G  0 dm
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸‹å›¾æ˜¾ç¤ºç”± &lt;code&gt;lsblk&lt;/code&gt; å‘½ä»¤è¾“å‡ºçš„ä¹‹å‰é•œåƒçš„è¯¦ç»†ä¿¡æ¯ã€‚&lt;/p&gt;

&lt;p&gt;&lt;center&gt;&lt;img src=&#34;http://o7z41ciog.bkt.clouddn.com/devicemapper-in-practice-pic4.jpg&#34; alt=&#34;&#34; /&gt;&lt;/center&gt;&lt;/p&gt;

&lt;p&gt;å¯ä»¥çœ‹å‡ºï¼Œåä¸º &lt;code&gt;Docker-202:1-1032-pool&lt;/code&gt; çš„ pool æ¨ªè·¨åœ¨ &lt;code&gt;data&lt;/code&gt; å’Œ &lt;code&gt;metadata&lt;/code&gt; è®¾å¤‡ä¹‹ä¸Šã€‚pool çš„å‘½åè§„åˆ™ä¸ºï¼š&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Docker-ä¸»è®¾å¤‡å·:äºŒçº§è®¾å¤‡å·-inodeå·-pool&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;p-markdown-1-style-margin-bottom-2em-margin-right-5px-padding-8px-15px-letter-spacing-2px-background-image-linear-gradient-to-right-bottom-rgb-0-188-212-rgb-63-81-181-background-color-rgb-63-81-181-color-rgb-255-255-255-border-left-10px-solid-rgb-51-51-51-border-radius-5px-text-shadow-rgb-102-102-102-1px-1px-1px-box-shadow-rgb-102-102-102-1px-1px-2px-3-ç®¡ç†-devicemapper-p&#34;&gt;&lt;p markdown=&#34;1&#34; style=&#34;margin-bottom:2em; margin-right: 5px; padding: 8px 15px; letter-spacing: 2px; background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); background-color: rgb(63, 81, 181); color: rgb(255, 255, 255); border-left: 10px solid rgb(51, 51, 51); border-radius:5px; text-shadow: rgb(102, 102, 102) 1px 1px 1px; box-shadow: rgb(102, 102, 102) 1px 1px 2px;&#34;&gt;3. &lt;strong&gt;ç®¡ç† devicemapper&lt;/strong&gt;&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;h3 id=&#34;3-1-ç›‘æ§-thin-pool&#34;&gt;3.1 &lt;strong&gt;ç›‘æ§ thin pool&lt;/strong&gt;&lt;/h3&gt;

&lt;p&gt;ä¸è¦è¿‡äºä¾èµ– &lt;code&gt;lvm&lt;/code&gt; çš„è‡ªåŠ¨æ‰©å±•ï¼Œé€šå¸¸æƒ…å†µä¸‹ &lt;code&gt;Volume Group&lt;/code&gt; ä¼šè‡ªåŠ¨æ‰©å±•ï¼Œä½†æœ‰æ—¶å€™ &lt;code&gt;volume&lt;/code&gt; è¿˜æ˜¯ä¼šè¢«å¡æ»¡ï¼Œä½ å¯ä»¥é€šè¿‡å‘½ä»¤ &lt;code&gt;lvs&lt;/code&gt; æˆ– &lt;code&gt;lvs -a&lt;/code&gt; æ¥ç›‘æ§ volume å‰©ä½™çš„ç©ºé—´ã€‚ä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨ &lt;code&gt;nagios&lt;/code&gt; ç­‰ç›‘æ§å·¥å…·æ¥è¿›è¡Œç›‘æ§ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;å¯ä»¥æŸ¥çœ‹ &lt;code&gt;lvm&lt;/code&gt; æ—¥å¿—ï¼Œäº†è§£ &lt;code&gt;thin pool&lt;/code&gt; åœ¨è‡ªåŠ¨æ‰©å®¹è§¦åŠé˜ˆå€¼æ—¶çš„çŠ¶æ€ï¼š&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ journalctl -fu dm-event.service
&lt;/code&gt;&lt;/pre&gt;

&lt;p markdown=&#34;1&#34; style=&#34;display: block;padding: 10px;margin: 10px 0;border: 1px solid #ccc;border-top-width: 5px;border-radius: 3px;border-top-color: #2780e3;&#34;&gt;
å¦‚æœä½ åœ¨ä½¿ç”¨ç²¾ç®€æ± ï¼ˆthin poolï¼‰çš„è¿‡ç¨‹ä¸­é¢‘ç¹é‡åˆ°é—®é¢˜ï¼Œä½ å¯ä»¥åœ¨ &lt;code&gt;/etc/docker.daemon.json&lt;/code&gt; ä¸­è®¾ç½®å‚æ•° &lt;code&gt;dm.min_free_space&lt;/code&gt; çš„å€¼ï¼ˆè¡¨ç¤ºç™¾åˆ†æ¯”ï¼‰ã€‚ä¾‹å¦‚å°†å…¶è®¾ç½®ä¸º 10ï¼Œä»¥ç¡®ä¿å½“å¯ç”¨ç©ºé—´è¾¾åˆ°æˆ–æ¥è¿‘ 10ï¼… æ—¶æ“ä½œå¤±è´¥ï¼Œå¹¶å‘å‡ºè­¦å‘Šã€‚å‚è€ƒ &lt;a href=&#34;https://docs.docker.com/engine/reference/commandline/dockerd/#storage-driver-options&#34;&gt;storage driver options in the Engine daemon reference&lt;/a&gt;.
&lt;/p&gt;

&lt;h3 id=&#34;3-2-ä¸ºæ­£åœ¨è¿è¡Œçš„è®¾å¤‡å¢åŠ å®¹é‡&#34;&gt;3.2 &lt;strong&gt;ä¸ºæ­£åœ¨è¿è¡Œçš„è®¾å¤‡å¢åŠ å®¹é‡&lt;/strong&gt;&lt;/h3&gt;

&lt;p&gt;å¦‚æœ lv çš„å­˜å‚¨ç©ºé—´å·²æ»¡ï¼Œå¹¶ä¸” vg å¤„äºæ»¡è´Ÿè·çŠ¶æ€ï¼Œä½ å¯ä»¥ä¸ºæ­£åœ¨è¿è¡Œçš„ &lt;code&gt;thin-pool&lt;/code&gt; è®¾å¤‡å¢åŠ å­˜å‚¨å·çš„å®¹é‡ï¼Œå…·ä½“è¿‡ç¨‹å–å†³äºæ‚¨æ˜¯ä½¿ç”¨ &lt;code&gt;loop-lvm&lt;/code&gt; ç²¾ç®€æ± è¿˜æ˜¯ä½¿ç”¨ &lt;code&gt;direct-lvm&lt;/code&gt; ç²¾ç®€æ± ã€‚&lt;/p&gt;

&lt;h4 id=&#34;è°ƒæ•´-loop-lvm-ç²¾ç®€æ± çš„å¤§å°&#34;&gt;&lt;strong&gt;è°ƒæ•´ &lt;code&gt;loop-lvm&lt;/code&gt; ç²¾ç®€æ± çš„å¤§å°&lt;/strong&gt;&lt;/h4&gt;

&lt;p&gt;è°ƒæ•´ &lt;code&gt;loop-lvm&lt;/code&gt; ç²¾ç®€æ± çš„æœ€ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨ &lt;code&gt;device_tool&lt;/code&gt; å·¥å…·ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨æ“ä½œç³»ç»Ÿè‡ªå¸¦çš„å·¥å…·ã€‚&lt;/p&gt;

&lt;h5 id=&#34;a-ä½¿ç”¨-device-tool-å·¥å…·&#34;&gt;a. &lt;strong&gt;ä½¿ç”¨ &lt;code&gt;device_tool&lt;/code&gt; å·¥å…·&lt;/strong&gt;&lt;/h5&gt;

&lt;p&gt;åœ¨ &lt;code&gt;docker&lt;/code&gt; å®˜æ–¹ &lt;code&gt;github&lt;/code&gt; ä»“åº“çš„ &lt;code&gt;contrib/&lt;/code&gt; ç›®å½•ä¸­æœ‰ä¸€ä¸ªç¤¾åŒºè´¡çŒ®çš„è„šæœ¬ &lt;a href=&#34;https://raw.githubusercontent.com/docker/docker-ce/master/components/engine/contrib/docker-device-tool/device_tool.go&#34; target=&#34;_blank&#34;&gt;device_tool.go&lt;/a&gt;ï¼Œä½ å¯ä»¥é€šè¿‡æ­¤å·¥å…·å…å»ç¹ççš„æ­¥éª¤æ¥è°ƒæ•´ &lt;code&gt;loop-lvm&lt;/code&gt; ç²¾ç®€æ± çš„å¤§å°ã€‚è¿™ä¸ªå·¥å…·ä¸èƒ½ä¿è¯ 100% æœ‰æ•ˆï¼Œæœ€å¥½ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ &lt;code&gt;loop-lvm&lt;/code&gt; æ¨¡å¼ã€‚&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;clone&lt;/code&gt; æ•´ä¸ªä»“åº“ &lt;a href=&#34;https://github.com/docker/docker-ce&#34; target=&#34;_blank&#34;&gt;docker-ce&lt;/a&gt;ï¼Œåˆ‡æ¢åˆ°ç›®å½• &lt;code&gt;contrib/docker-device-tool&lt;/code&gt; ï¼ŒæŒ‰ç…§ &lt;code&gt;README.md&lt;/code&gt; ä¸­çš„è¯´æ˜ç¼–è¯‘è¯¥å·¥å…·ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;ä½¿ç”¨è¯¥å·¥å…·ã€‚ä¾‹å¦‚è°ƒæ•´ &lt;code&gt;thin pool&lt;/code&gt; çš„å¤§å°ä¸º 200GBã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ./device_tool resize 200GB
&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&#34;b-ä½¿ç”¨æ“ä½œç³»ç»Ÿå·¥å…·&#34;&gt;b. &lt;strong&gt;ä½¿ç”¨æ“ä½œç³»ç»Ÿå·¥å…·&lt;/strong&gt;&lt;/h5&gt;

&lt;p&gt;å¦‚æœä½ ä¸æƒ³ä½¿ç”¨ &lt;code&gt;device_tool&lt;/code&gt; å·¥å…·ï¼Œå¯ä»¥é€šè¿‡æ“ä½œç³»ç»Ÿå·¥å…·æ‰‹åŠ¨è°ƒæ•´ &lt;code&gt;loop-lvm&lt;/code&gt; ç²¾ç®€æ± çš„å¤§å°ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;åœ¨ &lt;code&gt;loop-lvm&lt;/code&gt; æ¨¡å¼ä¸­ï¼ŒDocker ä½¿ç”¨çš„ Device Mapper è®¾å¤‡é»˜è®¤ä½¿ç”¨ loopback è®¾å¤‡ï¼Œåç«¯ä¸ºè‡ªåŠ¨ç”Ÿæˆçš„ç¨€ç–æ–‡ä»¶ï¼Œå¦‚ä¸‹:&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ls -lsh /var/lib/docker/devicemapper/devicemapper/
æ€»ç”¨é‡ 510M
508M -rw-------. 1 root root 100G 10æœˆ 30 00:00 data
1.9M -rw-------. 1 root root 2.0G 10æœˆ 30 00:00 metadata
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;data&lt;/code&gt; [å­˜æ”¾æ•°æ®] å’Œ &lt;code&gt;metadata&lt;/code&gt; [å­˜æ”¾å…ƒæ•°æ®] çš„å¤§å°ä»è¾“å‡ºå¯ä»¥çœ‹å‡ºåˆå§‹åŒ–é»˜è®¤ä¸º 100G å’Œ 2G å¤§å°ï¼Œéƒ½æ˜¯ç¨€ç–æ–‡ä»¶ï¼Œä½¿ç”¨å¤šå°‘å ç”¨å¤šå°‘ã€‚&lt;/p&gt;

&lt;p&gt;Docker åœ¨åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œåˆ›å»º data å’Œ metadata è¿™ä¸¤ä¸ªç¨€ç–æ–‡ä»¶ï¼Œå¹¶åˆ†åˆ«é™„åŠ åˆ°å›ç¯è®¾å¤‡ &lt;code&gt;/dev/loop0&lt;/code&gt; å’Œ &lt;code&gt;/dev/loop1&lt;/code&gt; ä¸Šï¼Œç„¶ååŸºäºå›ç¯è®¾å¤‡åˆ›å»º thin poolã€‚ é»˜è®¤ä¸€ä¸ª container æœ€å¤§å­˜æ”¾æ•°æ®ä¸è¶…è¿‡ 10Gã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;æŸ¥çœ‹ &lt;code&gt;data&lt;/code&gt; å’Œ &lt;code&gt;metadata&lt;/code&gt; çš„æ–‡ä»¶è·¯å¾„ï¼š&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ docker info |grep &#39;loop file&#39;

 Data loop file: /var/lib/docker/devicemapper/data
 Metadata loop file: /var/lib/docker/devicemapper/metadata
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ¥å¢åŠ ç²¾ç®€æ± çš„å¤§å°ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œthin-pool åŸæ¥çš„å®¹é‡ä¸º 100GBï¼Œå¢åŠ åˆ°200GBã€‚&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;æŸ¥çœ‹ data å’Œ metadata çš„å¤§å°ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ls -lh /var/lib/docker/devicemapper/

total 1175492
-rw------- 1 root root 100G Mar 30 05:22 data
-rw------- 1 root root 2.0G Mar 31 11:17 metadata
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;ä½¿ç”¨ truncate å‘½ä»¤å°†æ•°æ®æ–‡ä»¶çš„å¤§å°å¢åŠ åˆ° 200Gã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ truncate -s 200G /var/lib/docker/devicemapper/data
&lt;/code&gt;&lt;/pre&gt;

&lt;p markdown=&#34;1&#34; style=&#34;display: block;padding: 10px;margin: 10px 0;border: 1px solid #ccc;border-top-width: 5px;border-radius: 3px;border-top-color: #9954bb;&#34;&gt;
æ³¨æ„ï¼šå‡å°æ•°æ®æ–‡ä»¶çš„å¤§å°æœ‰å¯èƒ½ä¼šå¯¹æ•°æ®é€ æˆç ´åï¼Œè¯·æ…é‡è€ƒè™‘ã€‚
&lt;/p&gt; 
  &lt;/li&gt;

&lt;li&gt;&lt;p&gt;éªŒè¯æ–‡ä»¶å¤§å°ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ls -lh /var/lib/docker/devicemapper/

total 1.2G
-rw------- 1 root root 200G Apr 14 08:47 data
-rw------- 1 root root 2.0G Apr 19 13:27 metadata
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ° &lt;code&gt;loopback&lt;/code&gt; æ–‡ä»¶çš„å¤§å°å·²ç»æ”¹å˜ï¼Œä½†è¿˜æ²¡æœ‰ä¿å­˜åˆ°å†…å­˜ä¸­ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;åœ¨å†…å­˜ä¸­åˆ—å‡ºç¯å›è®¾å¤‡çš„å¤§å°ï¼Œé‡æ–°åŠ è½½è¯¥è®¾å¤‡ï¼Œç„¶åå†æ¬¡åˆ—å‡ºå¤§å°ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ echo $[ $(sudo blockdev --getsize64 /dev/loop0) / 1024 / 1024 / 1024 ]

100

$ losetup -c /dev/loop0

$ echo $[ $(sudo blockdev --getsize64 /dev/loop0) / 1024 / 1024 / 1024 ]

200
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é‡æ–°åŠ è½½ä¹‹åï¼Œ&lt;code&gt;loopback&lt;/code&gt; è®¾å¤‡çš„å¤§å°å˜ä¸º 200GBã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;é‡æ–°åŠ è½½ &lt;code&gt;devicemapper thin pool&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;æŸ¥çœ‹ thin pool çš„åç§°&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ dmsetup status | grep &#39; thin-pool &#39; | awk -F &#39;: &#39; {&#39;print $1&#39;}
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;æŸ¥çœ‹å½“å‰å·çš„ä¿¡æ¯è¡¨&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ dmsetup table docker-8:1-123141-pool
  
0 209715200 thin-pool 7:1 7:0 128 32768 1 skip_block_zeroing
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;ç¬¬äºŒä¸ªæ•°å­—æ˜¯è®¾å¤‡çš„å¤§å°ï¼Œè¡¨ç¤ºæœ‰å¤šå°‘ä¸ª 512ï¼bytes çš„æ‰‡åŒºã€‚&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;128 æ˜¯æœ€å°çš„å¯åˆ†é…çš„ sector æ•°ã€‚&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;32768 æ˜¯æœ€å°‘å¯ç”¨ sector çš„ water markï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª thresholdã€‚&lt;/li&gt;
&lt;li&gt;1 ä»£è¡¨æœ‰ä¸€ä¸ªé™„åŠ å‚æ•°ã€‚&lt;/li&gt;
&lt;li&gt;skip_block_zeroingæ˜¯ä¸ªé™„åŠ å‚æ•°ï¼Œè¡¨ç¤ºç•¥è¿‡ç”¨0å¡«å……çš„å—ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;ä½¿ç”¨è¾“å‡ºçš„ç¬¬äºŒä¸ªå­—æ®µè®¡ç®—æ‰©å±•åçš„ &lt;code&gt;thin pool&lt;/code&gt; æ€»å¤§å°ï¼Œè¯¥å­—æ®µè¡¨ç¤ºæœ‰å¤šå°‘ä¸ªæ‰‡åŒºã€‚100G çš„æ–‡ä»¶å«æœ‰ 209715200 ä¸ªæ‰‡åŒºï¼Œæ‰©å±•åˆ° 200G åï¼Œæ‰‡åŒºæ•°ä¸º 419430400ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;ä½¿ç”¨æ–°çš„æ‰‡åŒºæ•°é‡æ–°åŠ è½½ thin poolã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ dmsetup suspend docker-8:1-123141-pool
  
$ dmsetup reload docker-8:1-123141-pool --table &#39;0 419430400 thin-pool 7:1 7:0 128 32768 1 skip_block_zeroing&#39;
  
$ dmsetup resume docker-8:1-123141-pool
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;h4 id=&#34;è°ƒæ•´-direct-lvm-ç²¾ç®€æ± çš„å¤§å°&#34;&gt;&lt;strong&gt;è°ƒæ•´ &lt;code&gt;direct-lvm&lt;/code&gt; ç²¾ç®€æ± çš„å¤§å°&lt;/strong&gt;&lt;/h4&gt;

&lt;p&gt;è¦è°ƒæ•´ &lt;code&gt;direct-lvm&lt;/code&gt; ç²¾ç®€æ± çš„å¤§å°ï¼Œéœ€è¦æ·»åŠ ä¸€å—æ–°çš„å—è®¾å¤‡åˆ° Docker çš„å®¿ä¸»æœºã€‚å¹¶è®°ä¸‹å†…æ ¸åˆ†é…ç»™å®ƒçš„è®¾å¤‡åç§°ã€‚ä¾‹å¦‚æ–°çš„å—è®¾å¤‡åç§°ä¸º &lt;code&gt;/dev/xvdg&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ¥å¢åŠ  &lt;code&gt;direct-lvm&lt;/code&gt; ç²¾ç®€æ± çš„å¤§å°ï¼Œè¯·æ ¹æ®å®é™…æƒ…å†µæ›¿æ¢ä»¥ä¸‹éƒ¨åˆ†å‚æ•°ã€‚&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;æŸ¥çœ‹å·ç»„çš„ä¿¡æ¯ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;ä½¿ç”¨ &lt;code&gt;pvdisplay&lt;/code&gt; å‘½ä»¤æŸ¥çœ‹ç²¾ç®€æ± å½“å‰æ­£åœ¨ä½¿ç”¨çš„ç‰©ç†å—è®¾å¤‡ä»¥åŠå·ç»„çš„åç§°&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ pvdisplay |grep &#39;VG Name&#39;

PV Name               /dev/xvdf
VG Name               docker
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;æ‰©å±•å·ç»„ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ vgextend docker /dev/xvdg

Physical volume &amp;quot;/dev/xvdg&amp;quot; successfully created.
Volume group &amp;quot;docker&amp;quot; successfully extended
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;æ‰©å±•é€»è¾‘å· &lt;code&gt;docker/thinpool&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ lvextend -l+100%FREE -n docker/thinpool
     
 Size of logical volume docker/thinpool_tdata changed from 95.00 GiB (24319 extents) to 198.00 GiB (50688 extents).
Logical volume docker/thinpool_tdata successfully resized.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¯¥å‘½ä»¤ä½¿ç”¨äº†å­˜å‚¨å·çš„å…¨éƒ¨ç©ºé—´ï¼Œæ²¡æœ‰é…ç½®è‡ªåŠ¨æ‰©å±•ã€‚å¦‚æœè¦æ‰©å±• metadata ç²¾ç®€æ± ï¼Œè¯·ä½¿ç”¨ &lt;code&gt;docker/thinpool_tmeta&lt;/code&gt; æ›¿æ¢ &lt;code&gt;docker/thinpool&lt;/code&gt;ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;éªŒè¯æ–°çš„ &lt;code&gt;thin pool&lt;/code&gt; çš„å¤§å°ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ docker info
    
......
Storage Driver: devicemapper
 Pool Name: docker-thinpool
 Pool Blocksize: 524.3 kB
 Base Device Size: 10.74 GB
 Backing Filesystem: xfs
 Data file:
 Metadata file:
 Data Space Used: 212.3 MB
 Data Space Total: 212.6 GB
 Data Space Available: 212.4 GB
 Metadata Space Used: 286.7 kB
 Metadata Space Total: 1.07 GB
 Metadata Space Available: 1.069 GB
&amp;lt;output truncated&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é€šè¿‡ &lt;code&gt;Data Space Available&lt;/code&gt; å­—æ®µçš„å€¼æŸ¥çœ‹ &lt;code&gt;thin pool&lt;/code&gt; çš„å¤§å°ã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;h4 id=&#34;é‡å¯æ“ä½œç³»ç»Ÿåé‡æ–°æ¿€æ´»-devicemapper&#34;&gt;&lt;strong&gt;é‡å¯æ“ä½œç³»ç»Ÿåé‡æ–°æ¿€æ´» devicemapper&lt;/strong&gt;&lt;/h4&gt;

&lt;p&gt;å¦‚æœé‡å¯ç³»ç»Ÿåå‘ç° docker æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œä½ ä¼šçœ‹åˆ°åƒ â€œNon existing deviceâ€ è¿™æ ·çš„æŠ¥é”™ä¿¡æ¯ã€‚è¿™æ—¶éœ€è¦é‡æ–°æ¿€æ´»é€»è¾‘å·ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ lvchange -ay docker/thinpool
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;p-markdown-1-style-margin-bottom-2em-margin-right-5px-padding-8px-15px-letter-spacing-2px-background-image-linear-gradient-to-right-bottom-rgb-0-188-212-rgb-63-81-181-background-color-rgb-63-81-181-color-rgb-255-255-255-border-left-10px-solid-rgb-51-51-51-border-radius-5px-text-shadow-rgb-102-102-102-1px-1px-1px-box-shadow-rgb-102-102-102-1px-1px-2px-4-devicemapper-å­˜å‚¨é©±åŠ¨çš„å·¥ä½œåŸç†-p&#34;&gt;&lt;p markdown=&#34;1&#34; style=&#34;margin-bottom:2em; margin-right: 5px; padding: 8px 15px; letter-spacing: 2px; background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); background-color: rgb(63, 81, 181); color: rgb(255, 255, 255); border-left: 10px solid rgb(51, 51, 51); border-radius:5px; text-shadow: rgb(102, 102, 102) 1px 1px 1px; box-shadow: rgb(102, 102, 102) 1px 1px 2px;&#34;&gt;4. &lt;strong&gt;devicemapper å­˜å‚¨é©±åŠ¨çš„å·¥ä½œåŸç†&lt;/strong&gt;&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p markdown=&#34;1&#34; style=&#34;display: block;padding: 10px;margin: 10px 0;border: 1px solid #ccc;border-top-width: 5px;border-radius: 3px;border-top-color: #9954bb;&#34;&gt;
&lt;strong&gt;æ³¨æ„&lt;/strong&gt;ï¼šä¸è¦ç›´æ¥æ“ä½œ &lt;code&gt;/var/lib/docker/&lt;/code&gt; ä¸­çš„ä»»ä½•æ–‡ä»¶æˆ–ç›®å½•ï¼Œè¿™äº›æ–‡ä»¶å’Œç›®å½•ç”± docker è‡ªåŠ¨ç®¡ç†ã€‚
&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;æŸ¥çœ‹è®¾å¤‡å’Œå­˜å‚¨æ± ï¼š&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ lsblk

NAME                    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
xvda                    202:0    0    8G  0 disk
â””â”€xvda1                 202:1    0    8G  0 part /
xvdf                    202:80   0  100G  0 disk
â”œâ”€docker-thinpool_tmeta 253:0    0 1020M  0 lvm
â”‚ â””â”€docker-thinpool     253:2    0   95G  0 lvm
â””â”€docker-thinpool_tdata 253:1    0   95G  0 lvm
  â””â”€docker-thinpool     253:2    0   95G  0 lvm
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;æŸ¥çœ‹ docker æ­£åœ¨ä½¿ç”¨çš„æŒ‚è½½ç‚¹ï¼š&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ mount |grep devicemapper
/dev/xvda1 on /var/lib/docker/devicemapper type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä½¿ç”¨ &lt;code&gt;devicemapper&lt;/code&gt; åï¼ŒDocker å°†é•œåƒå’Œå±‚çº§å†…å®¹å­˜å‚¨åœ¨ thin pool ä¸­ï¼Œå¹¶å°†å®ƒä»¬æŒ‚è½½åˆ° &lt;code&gt;/var/lib/docker/devicemapper/&lt;/code&gt; ç›®å½•ä¸­æš´éœ²ç»™å®¹å™¨ä½¿ç”¨ã€‚&lt;/p&gt;

&lt;h3 id=&#34;4-1-ç£ç›˜ä¸Šçš„é•œåƒå’Œå®¹å™¨å±‚&#34;&gt;4.1 &lt;strong&gt;ç£ç›˜ä¸Šçš„é•œåƒå’Œå®¹å™¨å±‚&lt;/strong&gt;&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;/var/lib/docker/devicemapper/metadata/&lt;/code&gt; ç›®å½•ä¸­åŒ…å«äº†æœ‰å…³ devicemapper é…ç½®æœ¬èº«çš„å…ƒæ•°æ®ï¼Œä»¥åŠå·ã€å¿«ç…§å’Œæ¯ä¸ªå·çš„å—æˆ–è€…å¿«ç…§åŒå­˜å‚¨æ± ä¸­å—çš„æ˜ å°„ä¿¡æ¯ã€‚&lt;code&gt;devicemapper&lt;/code&gt; ä½¿ç”¨äº†å¿«ç…§æŠ€æœ¯ï¼Œå…ƒæ•°æ®ä¸­ä¹ŸåŒ…å«äº†è¿™äº›å¿«ç…§çš„ä¿¡æ¯ï¼Œä»¥ json æ ¼å¼ä¿å­˜åœ¨æ–‡æœ¬ä¸­ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;/var/lib/devicemapper/mnt/&lt;/code&gt; ç›®å½•åŒ…å«äº†æ‰€æœ‰é•œåƒå’Œå®¹å™¨å±‚çš„æŒ‚è½½ç‚¹ã€‚é•œåƒå±‚çš„æŒ‚è½½ç‚¹è¡¨ç°ä¸ºç©ºç›®å½•ï¼Œå®¹å™¨å±‚çš„æŒ‚è½½ç‚¹æ˜¾ç¤ºçš„æ˜¯å®¹å™¨å†…éƒ¨çš„æ–‡ä»¶ç³»ç»Ÿã€‚&lt;/p&gt;

&lt;h3 id=&#34;4-2-é•œåƒåˆ†å±‚ä¸å…±äº«&#34;&gt;4.2 &lt;strong&gt;é•œåƒåˆ†å±‚ä¸å…±äº«&lt;/strong&gt;&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;devicemapper&lt;/code&gt; å­˜å‚¨é©±åŠ¨ä½¿ç”¨ä¸“ç”¨å—è®¾å¤‡è€Œä¸æ˜¯æ ¼å¼åŒ–çš„æ–‡ä»¶ç³»ç»Ÿï¼Œé€šè¿‡åœ¨å—çº§åˆ«ä¸Šå¯¹æ–‡ä»¶è¿›è¡Œæ“ä½œï¼Œèƒ½å¤Ÿåœ¨å†™æ—¶å¤åˆ¶ï¼ˆCoWï¼‰æœŸé—´å®ç°æœ€ä½³æ€§èƒ½ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;devicemapper&lt;/code&gt; é©±åŠ¨å°†æ‰€æœ‰çš„é•œåƒå’Œå®¹å™¨å­˜å‚¨åˆ° &lt;code&gt;/var/lib/docker/devicemapper/&lt;/code&gt; ç›®å½•ï¼Œè¯¥ç›®å½•ç”±ä¸€ä¸ªæˆ–å¤šä¸ªå—çº§è®¾å¤‡ã€ç¯å›è®¾å¤‡ï¼ˆä»…æµ‹è¯•ï¼‰æˆ–ç‰©ç†ç¡¬ç›˜ç»„æˆã€‚&lt;/p&gt;

&lt;p&gt;ä½¿ç”¨ &lt;code&gt;devicemapper&lt;/code&gt; åˆ›å»ºä¸€ä¸ªé•œåƒçš„è¿‡ç¨‹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;devicemapper&lt;/code&gt; å­˜å‚¨é©±åŠ¨åˆ›å»ºä¸€ä¸ªç²¾ç®€æ± (thin pool)ã€‚è¿™ä¸ªæ± æ˜¯ä»å—è®¾å¤‡æˆ–å¾ªç¯æŒ‚è½½çš„æ–‡ä»¶ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;ä¸‹ä¸€æ­¥æ˜¯åˆ›å»ºä¸€ä¸ª base è®¾å¤‡ã€‚ä¸€ä¸ª base è®¾å¤‡æ˜¯å…·æœ‰æ–‡ä»¶ç³»ç»Ÿçš„ç²¾ç®€è®¾å¤‡ã€‚ä½ å¯ä»¥é€šè¿‡è¿è¡Œ &lt;code&gt;docker info&lt;/code&gt; å‘½ä»¤æ£€æŸ¥ &lt;code&gt;Backing filesystem&lt;/code&gt; æ¥æŸ¥çœ‹ä½¿ç”¨çš„æ˜¯å“ªä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;æ¯ä¸€ä¸ªæ–°é•œåƒ(å’Œé•œåƒæ•°æ®å±‚)æ˜¯è¿™ä¸ª base è®¾å¤‡çš„ä¸€ä¸ªå¿«ç…§ã€‚è¿™äº›æ˜¯ç²¾ç®€ç½®å¤‡å†™æ—¶æ‹·è´å¿«ç…§ã€‚è¿™æ„å‘³ç€å®ƒä»¬åˆå§‹ä¸ºç©ºï¼Œåªåœ¨å¾€å®ƒä»¬å†™å…¥æ•°æ®æ—¶æ‰æ¶ˆè€—æ± ä¸­çš„ç©ºé—´ã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ä½¿ç”¨ &lt;code&gt;devicemapper&lt;/code&gt; é©±åŠ¨æ—¶ï¼Œå®¹å™¨æ•°æ®å±‚æ˜¯ä»å…¶åˆ›å»ºçš„é•œåƒçš„å¿«ç…§ã€‚ä¸é•œåƒä¸€æ ·ï¼Œå®¹å™¨å¿«ç…§æ˜¯ç²¾ç®€ç½®å¤‡å†™æ—¶æ‹·è´å¿«ç…§ã€‚å®¹å™¨å¿«ç…§å­˜å‚¨ç€å®¹å™¨çš„æ‰€æœ‰æ›´æ”¹ã€‚å½“æ•°æ®å†™å…¥å®¹å™¨æ—¶ï¼Œ&lt;code&gt;devicemapper&lt;/code&gt; ä»å­˜å‚¨æ± æŒ‰éœ€åˆ†é…ç©ºé—´ã€‚&lt;/p&gt;

&lt;p&gt;ä¸‹å›¾æ˜¾ç¤ºä¸€ä¸ªå…·æœ‰ä¸€ä¸ªbaseè®¾å¤‡å’Œä¸¤ä¸ªé•œåƒçš„ç²¾ç®€æ± ã€‚&lt;/p&gt;

&lt;p&gt;&lt;center&gt;&lt;img src=&#34;http://o7z41ciog.bkt.clouddn.com/devicemapper-in-practice-pic1.jpg&#34; alt=&#34;&#34; /&gt;&lt;/center&gt;&lt;/p&gt;

&lt;p&gt;å¦‚æœä½ ä»”ç»†æŸ¥çœ‹å›¾è¡¨ä½ ä¼šå‘ç°å¿«ç…§ä¸€ä¸ªè¿ç€ä¸€ä¸ªã€‚æ¯ä¸€ä¸ªé•œåƒæ•°æ®å±‚æ˜¯å®ƒä¸‹é¢æ•°æ®å±‚çš„ä¸€ä¸ªå¿«ç…§ã€‚æ¯ä¸ªé•œåƒçš„æœ€åº•ç«¯æ•°æ®å±‚æ˜¯å­˜å‚¨æ± ä¸­ &lt;code&gt;base&lt;/code&gt; è®¾å¤‡çš„å¿«ç…§ã€‚æ­¤ &lt;code&gt;base&lt;/code&gt; è®¾å¤‡æ˜¯ &lt;code&gt;Device Mapper&lt;/code&gt; çš„å·¥ä»¶ï¼Œè€Œä¸æ˜¯ Docker é•œåƒæ•°æ®å±‚ã€‚&lt;/p&gt;

&lt;p&gt;ä¸€ä¸ªå®¹å™¨æ˜¯ä»å…¶åˆ›å»ºçš„é•œåƒçš„ä¸€ä¸ªå¿«ç…§ã€‚ä¸‹å›¾æ˜¾ç¤ºä¸¤ä¸ªå®¹å™¨ï¼š ä¸€ä¸ªåŸºäº &lt;code&gt;Ubuntu&lt;/code&gt; é•œåƒå’Œå¦ä¸€ä¸ªåŸºäº &lt;code&gt;Busybox&lt;/code&gt; é•œåƒã€‚&lt;/p&gt;

&lt;p&gt;&lt;center&gt;&lt;img src=&#34;http://o7z41ciog.bkt.clouddn.com/devicemapper-in-practice-pic2.jpg&#34; alt=&#34;&#34; /&gt;&lt;/center&gt;&lt;/p&gt;

&lt;h2 id=&#34;p-markdown-1-style-margin-bottom-2em-margin-right-5px-padding-8px-15px-letter-spacing-2px-background-image-linear-gradient-to-right-bottom-rgb-0-188-212-rgb-63-81-181-background-color-rgb-63-81-181-color-rgb-255-255-255-border-left-10px-solid-rgb-51-51-51-border-radius-5px-text-shadow-rgb-102-102-102-1px-1px-1px-box-shadow-rgb-102-102-102-1px-1px-2px-5-devicemapper-è¯»å†™æ•°æ®çš„è¿‡ç¨‹-p&#34;&gt;&lt;p markdown=&#34;1&#34; style=&#34;margin-bottom:2em; margin-right: 5px; padding: 8px 15px; letter-spacing: 2px; background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); background-color: rgb(63, 81, 181); color: rgb(255, 255, 255); border-left: 10px solid rgb(51, 51, 51); border-radius:5px; text-shadow: rgb(102, 102, 102) 1px 1px 1px; box-shadow: rgb(102, 102, 102) 1px 1px 2px;&#34;&gt;5. &lt;strong&gt;devicemapper è¯»å†™æ•°æ®çš„è¿‡ç¨‹&lt;/strong&gt;&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;h3 id=&#34;5-1-è¯»æ•°æ®&#34;&gt;5.1 &lt;strong&gt;è¯»æ•°æ®&lt;/strong&gt;&lt;/h3&gt;

&lt;p&gt;æˆ‘ä»¬æ¥çœ‹ä¸‹ä½¿ç”¨ &lt;code&gt;devicemapper&lt;/code&gt; å­˜å‚¨é©±åŠ¨å¦‚ä½•è¿›è¡Œè¯»æ–‡ä»¶ã€‚ä¸‹å›¾æ˜¾ç¤ºåœ¨ç¤ºä¾‹å®¹å™¨ä¸­è¯»å–ä¸€ä¸ªå•ç‹¬çš„å— [0x44f] çš„è¿‡ç¨‹ã€‚&lt;/p&gt;

&lt;p&gt;&lt;center&gt;&lt;img src=&#34;http://o7z41ciog.bkt.clouddn.com/devicemapper-in-practice-pic3.jpg&#34; alt=&#34;&#34; /&gt;&lt;/center&gt;&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;ä¸€ä¸ªåº”ç”¨ç¨‹åºè¯·æ±‚è¯»å–å®¹å™¨ä¸­ &lt;code&gt;0x44f&lt;/code&gt; æ•°æ®å—ã€‚ç”±äºå®¹å™¨æ˜¯ä¸€ä¸ªé•œåƒçš„ä¸€ä¸ªç²¾ç®€å¿«ç…§ï¼Œå®ƒæ²¡æœ‰é‚£ä¸ªæ•°æ®ï¼Œåªæœ‰ä¸€ä¸ªæŒ‡å‘é•œåƒå­˜å‚¨çš„åœ°æ–¹çš„æŒ‡é’ˆã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;å­˜å‚¨é©±åŠ¨æ ¹æ®æŒ‡é’ˆï¼Œåˆ°é•œåƒå¿«ç…§çš„ &lt;code&gt;a005e&lt;/code&gt; é•œåƒå±‚å¯»æ‰¾ &lt;code&gt;0xf33&lt;/code&gt; å—åŒºã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;code&gt;devicemapper&lt;/code&gt; ä»é•œåƒå¿«ç…§å¤åˆ¶æ•°æ®å— &lt;code&gt;0xf33&lt;/code&gt; çš„å†…å®¹åˆ°å®¹å™¨å†…å­˜ä¸­ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;å­˜å‚¨é©±åŠ¨æœ€åå°†æ•°æ®è¿”å›ç»™è¯·æ±‚çš„åº”ç”¨ã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&#34;5-2-å†™æ•°æ®&#34;&gt;5.2 &lt;strong&gt;å†™æ•°æ®&lt;/strong&gt;&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;å†™å…¥æ–°æ•°æ®ï¼š&lt;/strong&gt;ä½¿ç”¨ &lt;code&gt;devicemapper&lt;/code&gt; é©±åŠ¨ï¼Œé€šè¿‡æŒ‰éœ€åˆ†é…ï¼ˆallocate-on-demandï¼‰æ“ä½œæ¥å®ç°å†™å…¥æ–°æ•°æ®åˆ°å®¹å™¨ï¼Œæ‰€æœ‰çš„æ–°æ•°æ®éƒ½è¢«å†™å…¥å®¹å™¨çš„å¯å†™å±‚ä¸­ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p markdown=&#34;1&#34; style=&#34;display: block;padding: 10px;margin: 10px 0;border: 1px solid #ccc;border-top-width: 5px;border-radius: 3px;border-top-color: #2780e3;&#34;&gt;
ä¾‹å¦‚è¦å†™å…¥ 56KB çš„æ–°æ•°æ®åˆ°å®¹å™¨ï¼š

  &amp;emsp;1. ä¸€ä¸ªåº”ç”¨ç¨‹åºè¯·æ±‚å†™å…¥56KBçš„æ–°æ•°æ®åˆ°å®¹å™¨ã€‚

  &amp;emsp;2. æŒ‰éœ€åˆ†é…æ“ä½œç»™å®¹å™¨å¿«ç…§åˆ†é…ä¸€ä¸ªæ–°çš„64KBæ•°æ®å—ã€‚å¦‚æœå†™æ“ä½œå¤§äº64KBï¼Œå°±åˆ†é…å¤šä¸ªæ–°æ•°æ®å—ç»™å®¹å™¨å¿«ç…§ã€‚

  &amp;emsp;3. æ–°çš„æ•°æ®å†™å…¥åˆ°æ–°åˆ†é…çš„æ•°æ®å—ã€‚
&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;è¦†ç›–å­˜åœ¨çš„æ•°æ®ï¼š&lt;/strong&gt;æ›´æ–°å­˜åœ¨çš„æ•°æ®ä½¿ç”¨å†™æ—¶æ‹·è´ï¼ˆcopy-on-writeï¼‰æ“ä½œï¼Œå…ˆä»æœ€è¿‘çš„é•œåƒå±‚ä¸­è¯»å–ä¸è¯¥æ–‡ä»¶ç›¸å…³çš„æ•°æ®å—ï¼›ç„¶ååˆ†é…æ–°çš„ç©ºç™½æ•°æ®å—ç»™å®¹å™¨å¿«ç…§å¹¶å¤åˆ¶æ•°æ®åˆ°è¿™äº›æ•°æ®å—ï¼›æœ€åæ›´æ–°å¥½çš„æ•°æ®å†™å…¥åˆ°æ–°åˆ†é…çš„æ•°æ®å—ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;åˆ é™¤æ•°æ®ï¼š&lt;/strong&gt;å½“ä»å®¹å™¨çš„å¯å†™å±‚ä¸­åˆ é™¤æ–‡ä»¶æˆ–ç›®å½•æ—¶ï¼Œæˆ–è€…ä»é•œåƒå±‚ä¸­åˆ é™¤å…¶çˆ¶å±‚é•œåƒä¸­å·²å­˜åœ¨çš„æ–‡ä»¶æ—¶ï¼Œ&lt;code&gt;devicemapper&lt;/code&gt; å­˜å‚¨é©±åŠ¨ä¼šæˆªè·å¯¹è¯¥æ–‡ä»¶æˆ–ç›®å½•çš„è¿›ä¸€æ­¥è¯»å–å°è¯•ï¼Œå¹¶å“åº”è¯¥æ–‡ä»¶æˆ–ç›®å½•ä¸å­˜åœ¨ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;å†™å…¥æ–°æ•°æ®å¹¶åˆ é™¤æ—§æ•°æ®ï¼š&lt;/strong&gt;å½“ä½ å‘å®¹å™¨ä¸­å†™å…¥æ–°æ•°æ®å¹¶åˆ é™¤æ—§æ•°æ®æ—¶ï¼Œæ‰€æœ‰è¿™äº›æ“ä½œéƒ½å‘ç”Ÿåœ¨å®¹å™¨çš„å¯å†™å±‚ã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ &lt;code&gt;direct-lvm&lt;/code&gt; æ¨¡å¼ï¼Œåˆ é™¤çš„æ•°æ®å—å°†ä¼šè¢«é‡Šæ”¾ï¼›å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ &lt;code&gt;loop-lvm&lt;/code&gt; æ¨¡å¼ï¼Œé‚£ä¹ˆè¿™äº›æ•°æ®å—å°±ä¸ä¼šè¢«é‡Šæ”¾ã€‚å› æ­¤ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ &lt;code&gt;loop-lvm&lt;/code&gt; æ¨¡å¼ã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;p-markdown-1-style-margin-bottom-2em-margin-right-5px-padding-8px-15px-letter-spacing-2px-background-image-linear-gradient-to-right-bottom-rgb-0-188-212-rgb-63-81-181-background-color-rgb-63-81-181-color-rgb-255-255-255-border-left-10px-solid-rgb-51-51-51-border-radius-5px-text-shadow-rgb-102-102-102-1px-1px-1px-box-shadow-rgb-102-102-102-1px-1px-2px-6-device-mapper-å¯¹-docker-æ€§èƒ½çš„å½±å“-p&#34;&gt;&lt;p markdown=&#34;1&#34; style=&#34;margin-bottom:2em; margin-right: 5px; padding: 8px 15px; letter-spacing: 2px; background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); background-color: rgb(63, 81, 181); color: rgb(255, 255, 255); border-left: 10px solid rgb(51, 51, 51); border-radius:5px; text-shadow: rgb(102, 102, 102) 1px 1px 1px; box-shadow: rgb(102, 102, 102) 1px 1px 2px;&#34;&gt;6. &lt;strong&gt;Device Mapper å¯¹ Docker æ€§èƒ½çš„å½±å“&lt;/strong&gt;&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;äº†è§£æŒ‰éœ€åˆ†é…å’Œå†™æ—¶æ‹·è´æ“ä½œå¯¹æ•´ä½“å®¹å™¨æ€§èƒ½çš„å½±å“å¾ˆé‡è¦ã€‚&lt;/p&gt;

&lt;h3 id=&#34;6-1-æŒ‰éœ€åˆ†é…å¯¹æ€§èƒ½çš„å½±å“&#34;&gt;6.1 &lt;strong&gt;æŒ‰éœ€åˆ†é…å¯¹æ€§èƒ½çš„å½±å“&lt;/strong&gt;&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;devicemapper&lt;/code&gt; å­˜å‚¨é©±åŠ¨é€šè¿‡æŒ‰éœ€åˆ†é…æ“ä½œç»™å®¹å™¨åˆ†é…æ–°çš„æ•°æ®å—ã€‚è¿™æ„å‘³ç€æ¯æ¬¡åº”ç”¨ç¨‹åºå†™å…¥å®¹å™¨å†…çš„æŸå¤„æ—¶ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªç©ºæ•°æ®å—ä»å­˜å‚¨æ± ä¸­åˆ†é…å¹¶æ˜ å°„åˆ°å®¹å™¨ä¸­ã€‚&lt;/p&gt;

&lt;p&gt;æ‰€æœ‰æ•°æ®å—ä¸º &lt;code&gt;64KB&lt;/code&gt;ã€‚ å†™å°äº &lt;code&gt;64KB&lt;/code&gt; çš„æ•°æ®ä»ç„¶åˆ†é…ä¸€ä¸ª &lt;code&gt;64KB&lt;/code&gt; æ•°æ®å—ã€‚å†™å…¥è¶…è¿‡ &lt;code&gt;64KB&lt;/code&gt; çš„æ•°æ®åˆ†é…å¤šä¸ª &lt;code&gt;64KB&lt;/code&gt; æ•°æ®å—ã€‚æ‰€ä»¥ï¼Œç‰¹åˆ«æ˜¯å½“å‘ç”Ÿå¾ˆå¤šå°çš„å†™æ“ä½œæ—¶ï¼Œå°±ä¼šæ¯”è¾ƒå½±å“å®¹å™¨çš„æ€§èƒ½ã€‚ä¸è¿‡ä¸€æ—¦æ•°æ®å—åˆ†é…ç»™å®¹å™¨ï¼Œåç»­çš„è¯»å’Œå†™å¯ä»¥ç›´æ¥åœ¨è¯¥æ•°æ®å—ä¸Šæ“ä½œã€‚&lt;/p&gt;

&lt;h3 id=&#34;6-2-å†™æ—¶æ‹·è´å¯¹æ€§èƒ½çš„å½±å“&#34;&gt;6.2 &lt;strong&gt;å†™æ—¶æ‹·è´å¯¹æ€§èƒ½çš„å½±å“&lt;/strong&gt;&lt;/h3&gt;

&lt;p&gt;æ¯å½“å®¹å™¨é¦–æ¬¡æ›´æ–°ç°æœ‰æ•°æ®æ—¶ï¼Œ&lt;code&gt;devicemapper&lt;/code&gt; å­˜å‚¨é©±åŠ¨å¿…é¡»æ‰§è¡Œå†™æ—¶æ‹·è´æ“ä½œã€‚è¿™ä¼šä»é•œåƒå¿«ç…§å¤åˆ¶æ•°æ®åˆ°å®¹å™¨å¿«ç…§ã€‚æ­¤è¿‡ç¨‹å¯¹å®¹å™¨æ€§èƒ½äº§ç”Ÿæ˜¾ç€å½±å“ã€‚å› æ­¤ï¼Œæ›´æ–°ä¸€ä¸ª &lt;code&gt;1GB&lt;/code&gt; æ–‡ä»¶çš„ &lt;code&gt;32KB&lt;/code&gt; æ•°æ®åªå¤åˆ¶ä¸€ä¸ª &lt;code&gt;64KB&lt;/code&gt; æ•°æ®å—åˆ°å®¹å™¨å¿«ç…§ã€‚è¿™æ¯”åœ¨æ–‡ä»¶çº§åˆ«æ“ä½œéœ€è¦å¤åˆ¶æ•´ä¸ª &lt;code&gt;1GB&lt;/code&gt; æ–‡ä»¶åˆ°å®¹å™¨æ•°æ®å±‚æœ‰æ˜æ˜¾çš„æ€§èƒ½ä¼˜åŠ¿ã€‚&lt;/p&gt;

&lt;p&gt;ä¸è¿‡åœ¨å®è·µä¸­ï¼Œå½“å®¹å™¨æ‰§è¡Œå¾ˆå¤šå°äº &lt;code&gt;64KB&lt;/code&gt; çš„å†™æ“ä½œæ—¶ï¼Œ&lt;code&gt;devicemapper&lt;/code&gt; çš„æ€§èƒ½ä¼šæ¯” &lt;code&gt;AUFS&lt;/code&gt; è¦å·®ã€‚&lt;/p&gt;

&lt;h3 id=&#34;6-3-å…¶ä»–æ³¨æ„äº‹é¡¹&#34;&gt;6.3 &lt;strong&gt;å…¶ä»–æ³¨æ„äº‹é¡¹&lt;/strong&gt;&lt;/h3&gt;

&lt;p&gt;è¿˜æœ‰å…¶ä»–ä¸€äº›å½±å“ &lt;code&gt;devicemapper&lt;/code&gt; å­˜å‚¨é©±åŠ¨æ€§èƒ½çš„å› ç´ ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;æ¨¡å¼&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Docker ä½¿ç”¨çš„ devicemapper å­˜å‚¨é©±åŠ¨çš„é»˜è®¤æ¨¡å¼æ˜¯ &lt;code&gt;loop-lvm&lt;/code&gt;ã€‚è¿™ä¸ªæ¨¡å¼ä½¿ç”¨ç©ºé—²æ–‡ä»¶æ¥æ„å»ºå­˜å‚¨æ± ï¼Œæ€§èƒ½éå¸¸ä½ã€‚ä¸å»ºè®®ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒã€‚æ¨èç”¨åœ¨ç”Ÿäº§ç¯å¢ƒçš„æ¨¡å¼æ˜¯ &lt;code&gt;direct-lvm&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;å­˜å–é€Ÿåº¦&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å¦‚æœå¸Œæœ›è·å¾—æ›´ä½³çš„æ€§èƒ½ï¼Œå¯ä»¥å°†æ•°æ®æ–‡ä»¶å’Œå…ƒæ•°æ®æ–‡ä»¶æ”¾åœ¨ &lt;code&gt;SSD&lt;/code&gt; è¿™æ ·çš„é«˜é€Ÿå­˜å‚¨ä¸Šã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;å†…å­˜ä½¿ç”¨&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;code&gt;devicemapper&lt;/code&gt; å¹¶ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆä½¿ç”¨å†…å­˜çš„å­˜å‚¨é©±åŠ¨ã€‚å½“ä¸€ä¸ªå®¹å™¨è¿è¡Œ n ä¸ªæ—¶ï¼Œå®ƒçš„æ–‡ä»¶ä¹Ÿä¼šè¢«æ‹·è´ n ä»½åˆ°å†…å­˜ä¸­ï¼Œè¿™å¯¹ &lt;code&gt;docker&lt;/code&gt; å®¿ä¸»æœºçš„å†…å­˜ä½¿ç”¨ä¼šé€ æˆæ˜æ˜¾å½±å“ã€‚å› æ­¤ï¼Œä¸å»ºè®®åœ¨ &lt;code&gt;PaaS&lt;/code&gt; æˆ–è€…èµ„æºå¯†é›†åœºåˆä½¿ç”¨ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;å¯¹äºå†™æ“ä½œè¾ƒå¤§çš„ï¼Œå¯ä»¥é‡‡ç”¨æŒ‚è½½ &lt;code&gt;data volumes&lt;/code&gt;ã€‚ä½¿ç”¨ &lt;code&gt;data volumes&lt;/code&gt; å¯ä»¥ç»•è¿‡å­˜å‚¨é©±åŠ¨ï¼Œä»è€Œé¿å… &lt;code&gt;thin provisioning&lt;/code&gt; å’Œ &lt;code&gt;copy-on-write&lt;/code&gt; å¼•å…¥çš„é¢å¤–å¼€é”€ã€‚&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;p&gt;&lt;center&gt;&lt;a href=&#34;https://www.yangcs.net/posts/devicemapper-theory/&#34; target=&#34;_blank&#34;&gt;Device Mapperç³»åˆ— (1)ï¼šDevice Mapper æŠ€æœ¯&lt;/a&gt;&lt;/center&gt;&lt;/p&gt;

&lt;p&gt;&lt;center&gt;&lt;a href=&#34;https://www.yangcs.net/posts/thin-provisioning/&#34; target=&#34;_blank&#34;&gt;Device Mapperç³»åˆ— (2)ï¼šThin Provisioning å®è·µ&lt;/a&gt;&lt;/center&gt;&lt;/p&gt;

&lt;p&gt;&lt;center&gt;&lt;a href=&#34;https://www.yangcs.net/posts/calico-rr/&#34; target=&#34;_blank&#34;&gt;Device Mapperç³»åˆ— (3)ï¼šDocker ä¸­ä½¿ç”¨ devicemapper å­˜å‚¨é©±åŠ¨&lt;/a&gt;&lt;/center&gt;&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>Device Mapperç³»åˆ— (2)ï¼šThin Provisioning å®è·µ</title>
      <link>https://www.yangcs.net/posts/thin-provisioning/</link>
      <pubDate>Mon, 22 Jan 2018 16:00:22 +0800</pubDate>
      
      <guid>https://www.yangcs.net/posts/thin-provisioning/</guid>
      <description>&lt;p&gt;&lt;/p&gt;

&lt;h2 id=&#34;p-markdown-1-style-margin-bottom-2em-margin-right-5px-padding-8px-15px-letter-spacing-2px-background-image-linear-gradient-to-right-bottom-rgb-0-188-212-rgb-63-81-181-background-color-rgb-63-81-181-color-rgb-255-255-255-border-left-10px-solid-rgb-51-51-51-border-radius-5px-text-shadow-rgb-102-102-102-1px-1px-1px-box-shadow-rgb-102-102-102-1px-1px-2px-1-thin-provisioning-snapshot-æ¼”ç¤º-p&#34;&gt;&lt;p markdown=&#34;1&#34; style=&#34;margin-bottom:2em; margin-right: 5px; padding: 8px 15px; letter-spacing: 2px; background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); background-color: rgb(63, 81, 181); color: rgb(255, 255, 255); border-left: 10px solid rgb(51, 51, 51); border-radius:5px; text-shadow: rgb(102, 102, 102) 1px 1px 1px; box-shadow: rgb(102, 102, 102) 1px 1px 2px;&#34;&gt;1. &lt;strong&gt;Thin Provisioning Snapshot æ¼”ç¤º&lt;/strong&gt;&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;ä¸Šä¸€ç¯‡æˆ‘ä»¬ä»‹ç»äº† &lt;code&gt;Device Mapper&lt;/code&gt; æ¡†æ¶çš„æŠ€æœ¯åŸç†åŠå…¶æ ¸å¿ƒæ¦‚å¿µï¼Œä¸‹é¢ï¼Œæˆ‘ä»¬ç”¨ä¸€ç³»åˆ—çš„å‘½ä»¤æ¥æ¼”ç¤ºä¸€ä¸‹ Device Mapper çš„ &lt;code&gt;Thin Provisioning Snapshot&lt;/code&gt; æ˜¯æ€ä¹ˆç©çš„ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å…ˆå»ºä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯data.imgï¼Œä¸€ä¸ªæ˜¯meta.data.imgï¼š&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ dd if=/dev/zero of=/tmp/data.img bs=1K count=1 seek=10M

1+0 records in
1+0 records out
1024 bytes (1.0 kB) copied, 0.000621428 s, 1.6 MB/s

$ dd if=/dev/zero of=/tmp/meta.data.img bs=1K count=1 seek=1G

1+0 records in
1+0 records out
1024 bytes (1.0 kB) copied, 0.000140858 s, 7.3 MB/s
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ³¨æ„å‘½ä»¤ä¸­ &lt;code&gt;seek&lt;/code&gt; é€‰é¡¹ï¼Œå…¶è¡¨ç¤ºä¸ºç•¥è¿‡ &lt;code&gt;of&lt;/code&gt; é€‰é¡¹æŒ‡å®šçš„è¾“å‡ºæ–‡ä»¶çš„å‰ 10G ä¸ª output çš„ &lt;code&gt;bloksize&lt;/code&gt; çš„ç©ºé—´åå†å†™å…¥å†…å®¹ã€‚&lt;/p&gt;

&lt;p&gt;å› ä¸º bs æ˜¯ 1 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥ä¹Ÿå°±æ˜¯ 10G çš„å°ºå¯¸ï¼Œä½†å…¶å®åœ¨ç¡¬ç›˜ä¸Šæ˜¯æ²¡æœ‰å æœ‰ç©ºé—´çš„ï¼Œå æœ‰ç©ºé—´åªæœ‰ 1k çš„å†…å®¹ã€‚å½“å‘å…¶å†™å…¥å†…å®¹æ—¶ï¼Œæ‰ä¼šåœ¨ç¡¬ç›˜ä¸Šä¸ºå…¶åˆ†é…ç©ºé—´ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;æˆ‘ä»¬å¯ä»¥ç”¨ &lt;code&gt;ls&lt;/code&gt; å‘½ä»¤çœ‹ä¸€ä¸‹ï¼Œå®é™…åˆ†é…äº† 12K å’Œ 4Kã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ls -lsh /tmp/data.img

12K -rw-r--r--. 1 root root 11G Aug 25 23:01 /tmp/data.img

$ ls -slh /tmp/meta.data.img

4.0K -rw-r--r--. 1 root root 101M Aug 25 23:17 /tmp/meta.data.img
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;ç„¶åï¼Œæˆ‘ä»¬ä¸ºè¿™ä¸ªæ–‡ä»¶åˆ›å»ºä¸€ä¸ª &lt;code&gt;loopback&lt;/code&gt; è®¾å¤‡ã€‚ï¼ˆloop2015 å’Œ loop2016 æ˜¯æˆ‘ä¹±å–çš„ä¸¤ä¸ªåå­—ï¼‰&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ losetup /dev/loop2015 /tmp/data.img
$ losetup /dev/loop2016 /tmp/meta.data.img

$ losetup -a

/dev/loop2015: [64768]:103991768 (/tmp/data.img)
/dev/loop2016: [64768]:103991765 (/tmp/meta.data.img)
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;ç°åœ¨ï¼Œæˆ‘ä»¬ä¸ºè¿™ä¸ªè®¾å¤‡å»ºä¸€ä¸ª &lt;code&gt;Thin Provisioning&lt;/code&gt; çš„ Poolï¼Œç”¨ &lt;code&gt;dmsetup&lt;/code&gt; å‘½ä»¤ï¼š&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ dmsetup create hchen-thin-pool \
  --table &amp;quot;0 20971522 thin-pool /dev/loop2016 /dev/loop2015 \
  128 65536 1 skip_block_zeroing&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä¸­çš„å‚æ•°è§£é‡Šå¦‚ä¸‹ï¼ˆæ›´å¤šä¿¡æ¯å¯å‚çœ‹ &lt;code&gt;Thin Provisioning&lt;/code&gt; çš„ man pageï¼‰:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;dmsetup create&lt;/code&gt; æ˜¯ç”¨æ¥åˆ›å»º thin pool çš„å‘½ä»¤&lt;/li&gt;
&lt;li&gt;&lt;code&gt;hchen-thin-pool&lt;/code&gt; æ˜¯è‡ªå®šä¹‰çš„ä¸€ä¸ª pool åï¼Œä¸å†²çªå°±å¥½ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;â€“-table&lt;/code&gt; æ˜¯è¿™ä¸ª pool çš„å‚æ•°è®¾ç½®

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;0&lt;/code&gt; ä»£è¡¨èµ·çš„ sector ä½ç½®&lt;/li&gt;
&lt;li&gt;&lt;code&gt;20971522&lt;/code&gt; ä»£è¡¨ç»“å°¾çš„ sector å·ï¼Œå‰é¢è¯´è¿‡ï¼Œä¸€ä¸ª sector æ˜¯ 512 å­—èŠ‚ï¼Œæ‰€ä»¥ï¼Œ20971522 ä¸ªæ­£å¥½æ˜¯ 10GB&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/dev/loop2016&lt;/code&gt; æ˜¯ meta æ–‡ä»¶çš„è®¾å¤‡ï¼ˆå‰é¢æˆ‘ä»¬å»ºå¥½äº†ï¼‰&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/dev/loop2015&lt;/code&gt; æ˜¯ data æ–‡ä»¶çš„è®¾å¤‡&lt;/li&gt;
&lt;li&gt;&lt;code&gt;128&lt;/code&gt; æ˜¯æœ€å°çš„å¯åˆ†é…çš„ sector æ•°&lt;/li&gt;
&lt;li&gt;&lt;code&gt;65536&lt;/code&gt; æ˜¯æœ€å°‘å¯ç”¨ sector çš„ water markï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª threshold&lt;/li&gt;
&lt;li&gt;&lt;code&gt;1&lt;/code&gt; ä»£è¡¨æœ‰ä¸€ä¸ªé™„åŠ å‚æ•°&lt;/li&gt;
&lt;li&gt;&lt;code&gt;skip_block_zeroing&lt;/code&gt; æ˜¯ä¸ªé™„åŠ å‚æ•°ï¼Œè¡¨ç¤ºç•¥è¿‡ç”¨ 0 å¡«å……çš„å—&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
&lt;p&gt;ç„¶åï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ä¸€ä¸ª &lt;code&gt;Device Mapper&lt;/code&gt; çš„è®¾å¤‡äº†ï¼š&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ll /dev/mapper/hchen-thin-pool

lrwxrwxrwx. 1 root root 7 Aug 25 23:24 /dev/mapper/hchen-thin-pool -&amp;gt; ../dm-4
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çš„åˆå§‹è¿˜æ²¡æœ‰å®Œæˆï¼Œè¿˜è¦åˆ›å»ºä¸€ä¸ª &lt;code&gt;Thin Provisioning&lt;/code&gt; çš„ Volumeï¼š&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ dmsetup message /dev/mapper/hchen-thin-pool 0 &amp;quot;create_thin 0&amp;quot;

$ dmsetup create hchen-thin-volumn-001 \
  --table &amp;quot;0 2097152 thin /dev/mapper/hchen-thin-pool 0&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä¸­ï¼š
+ ç¬¬ä¸€ä¸ªå‘½ä»¤ä¸­çš„ &lt;code&gt;create_thin&lt;/code&gt; æ˜¯å…³é”®å­—ï¼Œåé¢çš„ 0 è¡¨ç¤ºè¿™ä¸ª Volume çš„ device çš„  idã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ç¬¬äºŒä¸ªå‘½ä»¤ï¼Œæ˜¯çœŸæ­£çš„ä¸ºè¿™ä¸ª Volumn åˆ›å»ºä¸€ä¸ªå¯ä»¥ mount çš„è®¾å¤‡ï¼Œåå­—å« &lt;code&gt;hchen-thin-volumn-001&lt;/code&gt;ã€‚&lt;code&gt;2097152&lt;/code&gt; åªæœ‰ 1GBã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
&lt;p&gt;å¥½äº†ï¼Œåœ¨ mount å‰ï¼Œæˆ‘ä»¬è¿˜è¦æ ¼å¼åŒ–ä¸€ä¸‹ï¼š&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ mkfs.ext4 /dev/mapper/hchen-thin-volumn-001

mke2fs 1.42.9 (28-Dec-2013)
Discarding device blocks: done
Filesystem label=
OS type: Linux
Block size=4096 (log=2)
Fragment size=4096 (log=2)
Stride=16 blocks, Stripe width=16 blocks
65536 inodes, 262144 blocks
13107 blocks (5.00%) reserved for the super user
First data block=0
Maximum filesystem blocks=268435456
8 block groups
32768 blocks per group, 32768 fragments per group
8192 inodes per group
Superblock backups stored on blocks:
32768, 98304, 163840, 229376
 
Allocating group tables: done
Writing inode tables: done
Creating journal (8192 blocks): done
Writing superblocks and filesystem accounting information: done
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;å¥½äº†ï¼Œæˆ‘ä»¬å¯ä»¥ mount äº†ï¼ˆä¸‹é¢çš„å‘½ä»¤ä¸­ï¼Œæˆ‘è¿˜åˆ›å»ºäº†ä¸€ä¸ªæ–‡ä»¶ï¼‰&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-zsh&#34;&gt;$ mkdir -p /mnt/base

$ mount /dev/mapper/hchen-thin-volumn-001 /mnt/base

$ echo &amp;quot;hello world, I am a base&amp;quot; &amp;gt; /mnt/base/id.txt

$ cat /mnt/base/id.txt

hello world, I am a base
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;å¥½äº†ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ snapshot æ€ä¹ˆæï¼š&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ dmsetup message /dev/mapper/hchen-thin-pool 0 &amp;quot;create_snap 1 0&amp;quot;

$ dmsetup create mysnap1 \
  --table &amp;quot;0 2097152 thin /dev/mapper/hchen-thin-pool 1&amp;quot;
  
$ ll /dev/mapper/mysnap1

lrwxrwxrwx. 1 root root 7 Aug 25 23:49 /dev/mapper/mysnap1 -&amp;gt; ../dm-5
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸Šé¢çš„å‘½ä»¤ä¸­ï¼š
+ ç¬¬ä¸€æ¡å‘½ä»¤æ˜¯å‘ &lt;code&gt;hchen-thin-pool&lt;/code&gt; å‘ä¸€ä¸ª &lt;code&gt;create_snap&lt;/code&gt; çš„æ¶ˆæ¯ï¼Œåé¢è·Ÿä¸¤ä¸ª &lt;code&gt;id&lt;/code&gt;ï¼Œç¬¬ä¸€ä¸ªæ˜¯æ–°çš„ dev idï¼Œç¬¬äºŒä¸ªæ˜¯è¦ä»å“ªä¸ªå·²æœ‰çš„ dev id ä¸Šåš &lt;code&gt;snapshot&lt;/code&gt;ï¼ˆ0 è¿™ä¸ª dev id æ˜¯æˆ‘ä»¬å‰é¢å°±åˆ›å»ºäº†äº†ï¼‰&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ç¬¬äºŒæ¡å‘½ä»¤æ˜¯åˆ›å»ºä¸€ä¸ª &lt;code&gt;mysnap1&lt;/code&gt; çš„ deviceï¼Œå¹¶å¯ä»¥è¢« mountã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
&lt;p&gt;ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ï¼š&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ mkdir -p /mnt/mysnap1

$ mount /dev/mapper/mysnap1 /mnt/mysnap1

$ ll /mnt/mysnap1/

total 20
-rw-r--r--. 1 root root 25 Aug 25 23:46 id.txt
drwx------. 2 root root 16384 Aug 25 23:43 lost+found

$ cat /mnt/mysnap1/id.txt

hello world, I am a base
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;æˆ‘ä»¬æ¥ä¿®æ”¹ä¸€ä¸‹ &lt;code&gt;/mnt/mysnap1/id.txt&lt;/code&gt;ï¼Œå¹¶åŠ ä¸Šä¸€ä¸ª &lt;code&gt;snap1.txt&lt;/code&gt; çš„æ–‡ä»¶ï¼š&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ echo &amp;quot;I am snap1&amp;quot; &amp;gt;&amp;gt; /mnt/mysnap1/id.txt

$ echo &amp;quot;I am snap1&amp;quot; &amp;gt; /mnt/mysnap1/snap1.txt

$ cat /mnt/mysnap1/id.txt

hello world, I am a base
I am snap1

$ cat /mnt/mysnap1/snap1.txt

I am snap1
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;æˆ‘ä»¬å†çœ‹ä¸€ä¸‹ &lt;code&gt;/mnt/base&lt;/code&gt;ï¼Œä½ ä¼šå‘ç°æ²¡æœ‰ä»€ä¹ˆå˜åŒ–ï¼š&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ls /mnt/base

id.txt      lost+found

$ cat /mnt/base/id.txt

hello world, I am a base
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¥½äº†ï¼Œæˆ‘ç›¸ä¿¡ä½ çœ‹åˆ°äº†åˆ†å±‚é•œåƒçš„æ ·å­äº†ã€‚&lt;/p&gt;

&lt;h2 id=&#34;p-markdown-1-style-margin-bottom-2em-margin-right-5px-padding-8px-15px-letter-spacing-2px-background-image-linear-gradient-to-right-bottom-rgb-0-188-212-rgb-63-81-181-background-color-rgb-63-81-181-color-rgb-255-255-255-border-left-10px-solid-rgb-51-51-51-border-radius-5px-text-shadow-rgb-102-102-102-1px-1px-1px-box-shadow-rgb-102-102-102-1px-1px-2px-2-docker-çš„-devicemapper-p&#34;&gt;&lt;p markdown=&#34;1&#34; style=&#34;margin-bottom:2em; margin-right: 5px; padding: 8px 15px; letter-spacing: 2px; background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); background-color: rgb(63, 81, 181); color: rgb(255, 255, 255); border-left: 10px solid rgb(51, 51, 51); border-radius:5px; text-shadow: rgb(102, 102, 102) 1px 1px 1px; box-shadow: rgb(102, 102, 102) 1px 1px 2px;&#34;&gt;2. &lt;strong&gt;Docker çš„ devicemapper&lt;/strong&gt;&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;blockquote&gt;
&lt;p&gt;ä¸Šé¢åŸºæœ¬ä¸Šå°±æ˜¯ Docker çš„ç©æ³•äº†ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ docker çš„ loopback è®¾å¤‡ï¼š&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ losetup -a

/dev/loop0: [64768]:38050288 (/var/lib/docker/devicemapper/devicemapper/data)
/dev/loop1: [64768]:38050289 (/var/lib/docker/devicemapper/devicemapper/metadata)
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;å…¶ä¸­ data &lt;code&gt;100GB&lt;/code&gt;ï¼Œmetadata &lt;code&gt;2.0GB&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ls -alsh /var/lib/docker/devicemapper/devicemapper

506M -rw-------. 1 root root 100G Sep 10 20:15 data
1.1M -rw-------. 1 root root 2.0G Sep 10 20:15 metadata
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;ä¸‹é¢æ˜¯ç›¸å…³çš„ &lt;code&gt;thin-pool&lt;/code&gt;ã€‚å…¶ä¸­ï¼Œæœ‰ä¸ªå½“ä¸€å¤§ä¸² hash ä¸²çš„ device æ˜¯æ­£åœ¨å¯åŠ¨çš„å®¹å™¨ï¼š&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ll /dev/mapper/dock*

lrwxrwxrwx. 1 root root 7 Aug 25 07:57 /dev/mapper/docker-253:0-104108535-pool -&amp;gt; ../dm-2
lrwxrwxrwx. 1 root root 7 Aug 25 11:13 /dev/mapper/docker-253:0-104108535-deefcd630a60aa5ad3e69249f58a68e717324be4258296653406ff062f605edf -&amp;gt; ../dm-3
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹å®ƒçš„ &lt;code&gt;device id&lt;/code&gt;ï¼ˆDocker éƒ½æŠŠå®ƒä»¬è®°ä¸‹æ¥äº†ï¼‰ï¼š&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cat /var/lib/docker/devicemapper/metadata/deefcd630a60aa5ad3e69249f58a68e717324be4258296653406ff062f605edf
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;device_id&lt;/code&gt; æ˜¯ 24ï¼Œsize æ˜¯ &lt;code&gt;10737418240&lt;/code&gt;ï¼Œé™¤ä»¥ 512ï¼Œå°±æ˜¯ &lt;code&gt;20971520&lt;/code&gt; ä¸ª &lt;code&gt;sector&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;æˆ‘ä»¬ç”¨è¿™äº›ä¿¡æ¯æ¥åšä¸ª &lt;code&gt;snapshot&lt;/code&gt; çœ‹çœ‹ï¼ˆæ³¨ï¼šæˆ‘ç”¨äº†ä¸€ä¸ªæ¯”è¾ƒå¤§çš„ dev id â€“ 1024ï¼‰ï¼š&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ dmsetup message &amp;quot;/dev/mapper/docker-253:0-104108535-pool&amp;quot; 0 \
  &amp;quot;create_snap 1024 24&amp;quot;
  
$ dmsetup create dockersnap --table \
  &amp;quot;0 20971520 thin /dev/mapper/docker-253:0-104108535-pool 1024&amp;quot;
  
$ mkdir /mnt/docker

$ mount /dev/mapper/dockersnap /mnt/docker/

$ ls /mnt/docker/

id lost+found rootfs

$ ls /mnt/docker/rootfs/

bin dev etc home lib lib64 lost+found media mnt opt proc root run sbin srv sys tmp usr var
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;æˆ‘ä»¬åœ¨ docker çš„å®¹å™¨é‡Œç”¨ &lt;code&gt;findmnt&lt;/code&gt; å‘½ä»¤ä¹Ÿå¯ä»¥çœ‹åˆ°ç›¸å…³çš„ mount çš„æƒ…å†µï¼ˆå› ä¸ºå¤ªé•¿ï¼Œä¸‹é¢åªæ˜¯æ‘˜è¦ï¼‰ï¼š&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ findmnt

TARGET                SOURCE               
/                 /dev/mapper/docker-253:0-104108535-deefcd630a60[/rootfs]
/etc/resolv.conf  /dev/mapper/centos-root[/var/lib/docker/containers/deefcd630a60/resolv.conf]
/etc/hostname     /dev/mapper/centos-root[/var/lib/docker/containers/deefcd630a60/hostname]
/etc/hosts        /dev/mapper/centos-root[/var/lib/docker/containers/deefcd630a60/hosts]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;p&gt;&lt;center&gt;&lt;a href=&#34;https://www.yangcs.net/posts/devicemapper-theory/&#34; target=&#34;_blank&#34;&gt;Device Mapperç³»åˆ— (1)ï¼šDevice Mapper æŠ€æœ¯&lt;/a&gt;&lt;/center&gt;&lt;/p&gt;

&lt;p&gt;&lt;center&gt;&lt;a href=&#34;https://www.yangcs.net/posts/thin-provisioning/&#34; target=&#34;_blank&#34;&gt;Device Mapperç³»åˆ— (2)ï¼šThin Provisioning å®è·µ&lt;/a&gt;&lt;/center&gt;&lt;/p&gt;

&lt;p&gt;&lt;center&gt;&lt;a href=&#34;https://www.yangcs.net/posts/calico-rr/&#34; target=&#34;_blank&#34;&gt;Device Mapperç³»åˆ— (3)ï¼šDocker ä¸­ä½¿ç”¨ devicemapper å­˜å‚¨é©±åŠ¨&lt;/a&gt;&lt;/center&gt;&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>Device Mapperç³»åˆ— (1)ï¼šDevice Mapper æŠ€æœ¯</title>
      <link>https://www.yangcs.net/posts/devicemapper-theory/</link>
      <pubDate>Sun, 21 Jan 2018 09:28:41 +0000</pubDate>
      
      <guid>https://www.yangcs.net/posts/devicemapper-theory/</guid>
      <description>&lt;p&gt;&lt;/p&gt;

&lt;h2 id=&#34;p-markdown-1-style-margin-bottom-2em-margin-right-5px-padding-8px-15px-letter-spacing-2px-background-image-linear-gradient-to-right-bottom-rgb-0-188-212-rgb-63-81-181-background-color-rgb-63-81-181-color-rgb-255-255-255-border-left-10px-solid-rgb-51-51-51-border-radius-5px-text-shadow-rgb-102-102-102-1px-1px-1px-box-shadow-rgb-102-102-102-1px-1px-2px-1-device-mapper-ç®€ä»‹-p&#34;&gt;&lt;p markdown=&#34;1&#34; style=&#34;margin-bottom:2em; margin-right: 5px; padding: 8px 15px; letter-spacing: 2px; background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); background-color: rgb(63, 81, 181); color: rgb(255, 255, 255); border-left: 10px solid rgb(51, 51, 51); border-radius:5px; text-shadow: rgb(102, 102, 102) 1px 1px 1px; box-shadow: rgb(102, 102, 102) 1px 1px 2px;&#34;&gt;1. &lt;strong&gt;Device Mapper ç®€ä»‹&lt;/strong&gt;&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p markdown=&#34;1&#34; style=&#34;display: block;padding: 10px;margin: 10px 0;border: 1px solid #ccc;border-top-width: 5px;border-radius: 3px;border-top-color: #2780e3;&#34;&gt;
&amp;emsp;&amp;emsp; &lt;code&gt;Device Mapper&lt;/code&gt; æ˜¯ linux çš„å†…æ ¸ç”¨æ¥å°†å—è®¾å¤‡æ˜ å°„åˆ°è™šæ‹Ÿå—è®¾å¤‡çš„ frameworkï¼Œå®ƒæ”¯æŒè®¸å¤šé«˜çº§å·ç®¡ç†æŠ€æœ¯ã€‚docker çš„ devicemapper å­˜å‚¨é©±åŠ¨ç¨‹åºåˆ©ç”¨æ­¤æ¡†æ¶çš„&lt;code&gt;è‡ªåŠ¨ç²¾ç®€é…ç½®&lt;/code&gt;(thin provisioning) å’Œå¿«ç…§åŠŸèƒ½æ¥ç®¡ç† docker é•œåƒå’Œå®¹å™¨ã€‚æœ¬æ–‡å°† Device Mapper å­˜å‚¨é©±åŠ¨ç§°ä¸º &lt;code&gt;devicemapper&lt;/code&gt;ï¼Œå°†å®ƒçš„å†…æ ¸æ¡†æ¶ç§°ä¸º &lt;code&gt;Device Mapper&lt;/code&gt;ã€‚
&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;
&amp;emsp;&amp;emsp;&lt;code&gt;Device Mapper&lt;/code&gt; ä¸åŒäº AUFSã€ext4ã€NFS ç­‰ï¼Œå› ä¸ºå®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼ˆFile Systemï¼‰ï¼Œè€Œæ˜¯ Linux å†…æ ¸æ˜ å°„å—è®¾å¤‡çš„ä¸€ç§æŠ€æœ¯æ¡†æ¶ã€‚æä¾›çš„ä¸€ç§ä»é€»è¾‘è®¾å¤‡ï¼ˆè™šæ‹Ÿè®¾å¤‡ï¼‰åˆ°ç‰©ç†è®¾å¤‡çš„æ˜ å°„æ¡†æ¶æœºåˆ¶ï¼Œåœ¨è¯¥æœºåˆ¶ä¸‹ï¼Œç”¨æˆ·å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ ¹æ®è‡ªå·±çš„éœ€è¦åˆ¶å®šå®ç°å­˜å‚¨èµ„æºçš„ç®¡ç†ç­–ç•¥ã€‚&lt;/p&gt;

&lt;p&gt;&amp;emsp;&amp;emsp;å½“å‰æ¯”è¾ƒæµè¡Œçš„ Linux ä¸‹çš„é€»è¾‘å·ç®¡ç†å™¨å¦‚ &lt;code&gt;LVM2&lt;/code&gt;ï¼ˆLinux Volume Manager 2 version)ã€&lt;code&gt;EVMS&lt;/code&gt;(Enterprise Volume Management System)ã€&lt;code&gt;dmraid&lt;/code&gt;(Device Mapper Raid Tool)ç­‰éƒ½æ˜¯åŸºäºè¯¥æœºåˆ¶å®ç°çš„ã€‚&lt;/p&gt;

&lt;p&gt;&amp;emsp;&amp;emsp;å€¼å¾—ä¸€æçš„æ˜¯ &lt;code&gt;Device Mapper&lt;/code&gt; å·¥ä½œåœ¨å—çº§åˆ«ï¼ˆblockï¼‰ï¼Œå¹¶ä¸å·¥ä½œåœ¨æ–‡ä»¶çº§åˆ«ï¼ˆfileï¼‰ã€‚&lt;code&gt;Device Mapper&lt;/code&gt; è‡ª Linux 2.6.9 åç¼–å…¥ Linux å†…æ ¸ï¼Œæ‰€æœ‰åŸºäº Linux å†…æ ¸ 2.6.9 ä»¥åçš„å‘è¡Œç‰ˆéƒ½å†…ç½® &lt;code&gt;Device Mapper&lt;/code&gt;ï¼Œä½†ä½ éœ€è¦è¿›è¡Œä¸€äº›é¢å¤–çš„é…ç½®æ‰èƒ½åœ¨ &lt;code&gt;docker&lt;/code&gt; ä¸­ä½¿ç”¨å®ƒã€‚æ¯”å¦‚åœ¨ &lt;code&gt;RHEL&lt;/code&gt; å’Œ &lt;code&gt;CentOS&lt;/code&gt; ç³»ç»Ÿä¸­ï¼Œ&lt;code&gt;docker&lt;/code&gt; é»˜è®¤ä½¿ç”¨çš„å­˜å‚¨é©±åŠ¨æ˜¯ &lt;code&gt;overlay&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;&amp;emsp;&amp;emsp;&lt;code&gt;devicemapper&lt;/code&gt; å­˜å‚¨é©±åŠ¨ä½¿ç”¨ä¸“ç”¨äº &lt;code&gt;docker&lt;/code&gt; çš„å—è®¾å¤‡ï¼Œå®ƒè¿è¡Œåœ¨å—çº§åˆ«ä¸Šè€Œä¸æ˜¯æ–‡ä»¶çº§åˆ«ã€‚ä½¿ç”¨å—è®¾å¤‡æ¯”ç›´æ¥ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿæ€§èƒ½æ›´å¥½ï¼Œé€šè¿‡å‘ &lt;code&gt;Docker&lt;/code&gt; çš„å®¿ä¸»æœºæ·»åŠ ç‰©ç†å­˜å‚¨å¯ä»¥æ‰©å±•å—è®¾å¤‡çš„å­˜å‚¨ç©ºé—´ã€‚&lt;/p&gt;

&lt;h2 id=&#34;p-markdown-1-style-margin-bottom-2em-margin-right-5px-padding-8px-15px-letter-spacing-2px-background-image-linear-gradient-to-right-bottom-rgb-0-188-212-rgb-63-81-181-background-color-rgb-63-81-181-color-rgb-255-255-255-border-left-10px-solid-rgb-51-51-51-border-radius-5px-text-shadow-rgb-102-102-102-1px-1px-1px-box-shadow-rgb-102-102-102-1px-1px-2px-2-ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´-p&#34;&gt;&lt;p markdown=&#34;1&#34; style=&#34;margin-bottom:2em; margin-right: 5px; padding: 8px 15px; letter-spacing: 2px; background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); background-color: rgb(63, 81, 181); color: rgb(255, 255, 255); border-left: 10px solid rgb(51, 51, 51); border-radius:5px; text-shadow: rgb(102, 102, 102) 1px 1px 1px; box-shadow: rgb(102, 102, 102) 1px 1px 2px;&#34;&gt;2. &lt;strong&gt;ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´&lt;/strong&gt;&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;strong&gt;Device Mapperä¸»è¦åˆ†ä¸ºç”¨æˆ·ç©ºé—´éƒ¨åˆ†å’Œå†…æ ¸ç©ºé—´éƒ¨åˆ†&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;ç”¨æˆ·ç©ºé—´ç›¸å…³éƒ¨åˆ†ä¸»è¦è´Ÿè´£é…ç½®å…·ä½“çš„ç­–ç•¥å’Œæ§åˆ¶é€»è¾‘ï¼Œæ¯”å¦‚é€»è¾‘è®¾å¤‡å’Œå“ªäº›ç‰©ç†è®¾å¤‡å»ºç«‹æ˜ å°„ï¼Œæ€ä¹ˆå»ºç«‹è¿™äº›æ˜ å°„å…³ç³»ç­‰ï¼ŒåŒ…å« &lt;code&gt;device mapper&lt;/code&gt; åº“å’Œ &lt;code&gt;dmsetup&lt;/code&gt; å·¥å…·ã€‚å¯¹ç”¨æˆ·ç©ºé—´åˆ›å»ºåˆ é™¤ &lt;code&gt;device mapper&lt;/code&gt; è®¾å¤‡çš„æ“ä½œè¿›è¡Œå°è£…ã€‚&lt;/p&gt;

&lt;p&gt;å†…æ ¸ä¸­ä¸»è¦æä¾›å®Œæˆè¿™äº›ç”¨æˆ·ç©ºé—´ç­–ç•¥æ‰€éœ€è¦çš„æœºåˆ¶ï¼Œè´Ÿè´£å…·ä½“è¿‡æ»¤å’Œé‡å®šå‘ IO è¯·æ±‚ã€‚é€šè¿‡ä¸åŒçš„é©±åŠ¨æ’ä»¶ï¼Œè½¬å‘ IO è¯·æ±‚è‡³ç›®çš„è®¾å¤‡ä¸Šã€‚é™„ä¸Š &lt;code&gt;Device Mapper&lt;/code&gt; æ¶æ„å›¾ã€‚&lt;/p&gt;

&lt;p&gt;&lt;center&gt;&lt;img src=&#34;http://o7z41ciog.bkt.clouddn.com/device.mapper.2.gif&#34; alt=&#34;&#34; /&gt;&lt;/center&gt;&lt;/p&gt;

&lt;h2 id=&#34;p-markdown-1-style-margin-bottom-2em-margin-right-5px-padding-8px-15px-letter-spacing-2px-background-image-linear-gradient-to-right-bottom-rgb-0-188-212-rgb-63-81-181-background-color-rgb-63-81-181-color-rgb-255-255-255-border-left-10px-solid-rgb-51-51-51-border-radius-5px-text-shadow-rgb-102-102-102-1px-1px-1px-box-shadow-rgb-102-102-102-1px-1px-2px-3-device-mapper-æŠ€æœ¯åˆ†æ-p&#34;&gt;&lt;p markdown=&#34;1&#34; style=&#34;margin-bottom:2em; margin-right: 5px; padding: 8px 15px; letter-spacing: 2px; background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); background-color: rgb(63, 81, 181); color: rgb(255, 255, 255); border-left: 10px solid rgb(51, 51, 51); border-radius:5px; text-shadow: rgb(102, 102, 102) 1px 1px 1px; box-shadow: rgb(102, 102, 102) 1px 1px 2px;&#34;&gt;3. &lt;strong&gt;Device Mapper æŠ€æœ¯åˆ†æ&lt;/strong&gt;&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;strong&gt;&lt;code&gt;Device Mapper&lt;/code&gt;&lt;/strong&gt; ä½œä¸º Linux å—è®¾å¤‡æ˜ å°„æŠ€æœ¯æ¡†æ¶ï¼Œå‘å¤–éƒ¨æä¾›é€»è¾‘è®¾å¤‡ã€‚åŒ…å«ä¸‰ä¸ªé‡è¦æ¦‚å¿µï¼Œæ˜ å°„è®¾å¤‡ï¼ˆmapped deviceï¼‰ï¼Œæ˜ å°„è¡¨ï¼ˆmap tableï¼‰ï¼Œç›®æ ‡è®¾å¤‡ï¼ˆtarget deviceï¼‰ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;æ˜ å°„è®¾å¤‡å³å¯¹å¤–æä¾›çš„é€»è¾‘è®¾å¤‡ï¼Œæ˜ å°„è®¾å¤‡å‘ä¸‹å¯»æ‰¾å¿…é¡»æ‰¾åˆ°æ”¯æ’‘çš„ç›®æ ‡è®¾å¤‡ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;æ˜ å°„è¡¨å­˜å‚¨æ˜ å°„è®¾å¤‡å’Œç›®æ ‡è®¾å¤‡çš„æ˜ å°„å…³ç³»ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;ç›®æ ‡è®¾å¤‡å¯ä»¥æ˜¯æ˜ å°„è®¾å¤‡æˆ–è€…ç‰©ç†è®¾å¤‡ï¼Œå¦‚æœç›®æ ‡è®¾å¤‡æ˜¯ä¸€å—æ˜ å°„è®¾å¤‡ï¼Œåˆ™å±äºåµŒå¥—ï¼Œç†è®ºä¸Šå¯ä»¥æ— é™è¿­ä»£ä¸‹å»ã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ç®€è€Œè¨€ä¹‹ï¼Œ&lt;code&gt;Device Mapper&lt;/code&gt; å¯¹å¤–æä¾›ä¸€ä¸ªè™šæ‹Ÿè®¾å¤‡ä¾›ä½¿ç”¨ï¼Œè€Œè¿™å—è™šæ‹Ÿè®¾å¤‡å¯ä»¥é€šè¿‡æ˜ å°„è¡¨æ‰¾åˆ°ç›¸åº”çš„åœ°å€ï¼Œè¯¥åœ°å€å¯ä»¥æŒ‡å‘ä¸€å—ç‰©ç†è®¾å¤‡ï¼Œä¹Ÿå¯ä»¥æŒ‡å‘ä¸€ä¸ªè™šæ‹Ÿè®¾å¤‡ã€‚&lt;/p&gt;

&lt;p&gt;&lt;center&gt;&lt;img src=&#34;http://o7z41ciog.bkt.clouddn.com/device.mapper.3.png&#34; alt=&#34;&#34; /&gt;&lt;/center&gt;&lt;/p&gt;

&lt;p&gt;æ˜ å°„è¡¨ï¼Œæ˜¯ç”±ç”¨æˆ·ç©ºé—´åˆ›å»ºï¼Œä¼ é€’åˆ°å†…æ ¸ç©ºé—´ã€‚æ˜ å°„è¡¨é‡Œæœ‰æ˜ å°„è®¾å¤‡é€»è¾‘çš„èµ·å§‹åœ°å€ã€èŒƒå›´ã€å’Œè¡¨ç¤ºåœ¨ç›®æ ‡è®¾å¤‡æ‰€åœ¨ç‰©ç†è®¾å¤‡çš„åœ°å€åç§»é‡ä»¥åŠTarget ç±»å‹ç­‰ä¿¡æ¯ï¼ˆæ³¨ï¼šè¿™äº›åœ°å€å’Œåç§»é‡éƒ½æ˜¯ä»¥ç£ç›˜çš„æ‰‡åŒºä¸ºå•ä½çš„ï¼Œå³ 512 ä¸ªå­—èŠ‚å¤§å°ï¼Œæ‰€ä»¥ï¼Œå½“ä½ çœ‹åˆ° 128 çš„æ—¶å€™ï¼Œå…¶å®è¡¨ç¤ºçš„æ˜¯ 128*512=64Kï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;æ˜ å°„é©±åŠ¨åœ¨å†…æ ¸ç©ºé—´æ˜¯æ’ä»¶ï¼Œ&lt;code&gt;Device Mapper&lt;/code&gt; åœ¨å†…æ ¸ä¸­é€šè¿‡ä¸€ä¸ªä¸€ä¸ªæ¨¡å—åŒ–çš„ &lt;code&gt;Target Driver&lt;/code&gt; æ’ä»¶å®ç°å¯¹ IO è¯·æ±‚çš„è¿‡æ»¤æˆ–è€…é‡æ–°å®šå‘ç­‰å·¥ä½œï¼Œå½“å‰å·²ç»å®ç°çš„æ’ä»¶åŒ…æ‹¬è½¯ Raidã€åŠ å¯†ã€å¤šè·¯å¾„ã€é•œåƒã€å¿«ç…§ç­‰ï¼Œè¿™ä½“ç°äº†åœ¨ Linux å†…æ ¸è®¾è®¡ä¸­ç­–ç•¥å’Œæœºåˆ¶åˆ†ç¦»çš„åŸåˆ™ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;Device Mapper&lt;/code&gt; ä¸­çš„ IO æµå¤„ç†ï¼Œä»è™šæ‹Ÿè®¾å¤‡ï¼ˆé€»è¾‘è®¾å¤‡ï¼‰æ ¹æ®æ˜ å°„è¡¨å¹¶æŒ‡å®šç‰¹å®šçš„æ˜ å°„é©±åŠ¨è½¬å‘åˆ°ç›®æ ‡è®¾å¤‡ä¸Šã€‚&lt;/p&gt;

&lt;h2 id=&#34;p-markdown-1-style-margin-bottom-2em-margin-right-5px-padding-8px-15px-letter-spacing-2px-background-image-linear-gradient-to-right-bottom-rgb-0-188-212-rgb-63-81-181-background-color-rgb-63-81-181-color-rgb-255-255-255-border-left-10px-solid-rgb-51-51-51-border-radius-5px-text-shadow-rgb-102-102-102-1px-1px-1px-box-shadow-rgb-102-102-102-1px-1px-2px-4-docker-ä¸­çš„-device-mapper-æ ¸å¿ƒæŠ€æœ¯-p&#34;&gt;&lt;p markdown=&#34;1&#34; style=&#34;margin-bottom:2em; margin-right: 5px; padding: 8px 15px; letter-spacing: 2px; background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); background-color: rgb(63, 81, 181); color: rgb(255, 255, 255); border-left: 10px solid rgb(51, 51, 51); border-radius:5px; text-shadow: rgb(102, 102, 102) 1px 1px 1px; box-shadow: rgb(102, 102, 102) 1px 1px 2px;&#34;&gt;4. &lt;strong&gt;Docker ä¸­çš„ Device Mapper æ ¸å¿ƒæŠ€æœ¯&lt;/strong&gt;&lt;/p&gt;&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;Docker çš„ &lt;code&gt;devicemapper&lt;/code&gt; é©±åŠ¨æœ‰ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œ&lt;code&gt;copy on-writeï¼ˆå†™å¤åˆ¶ï¼‰&lt;/code&gt;ï¼Œ&lt;code&gt;thin-provisioningï¼ˆç²¾ç®€é…ç½®ï¼‰&lt;/code&gt;ã€‚&lt;code&gt;snapshotï¼ˆå¿«ç…§ï¼‰&lt;/code&gt;ï¼Œé¦–å…ˆç®€å•ä»‹ç»ä¸€ä¸‹è¿™ä¸‰ç§æŠ€æœ¯ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;&lt;code&gt;CoWï¼ˆcopy on writeï¼‰å†™å¤åˆ¶&lt;/code&gt;&lt;/strong&gt;ï¼šä¸€äº›æ–‡ä»¶ç³»ç»Ÿæä¾›çš„å†™æ—¶å¤åˆ¶ç­–ç•¥ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;code&gt;aufs&lt;/code&gt; çš„ cow åŸç†å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;p&gt;å½“å®¹å™¨éœ€è¦ä¿®æ”¹ä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œè¯¥æ–‡ä»¶ä½äºä½å±‚ &lt;code&gt;branch&lt;/code&gt; æ—¶ï¼Œé¡¶å±‚ &lt;code&gt;branch&lt;/code&gt; ä¼šç›´æ¥å¤åˆ¶ä½å±‚ &lt;code&gt;branch&lt;/code&gt; çš„æ–‡ä»¶è‡³é¡¶å±‚å†è¿›è¡Œä¿®æ”¹ï¼Œè€Œä½å±‚çš„æ–‡ä»¶ä¸å˜ï¼Œè¿™ç§æ–¹å¼å³æ˜¯ CoW æŠ€æœ¯ï¼ˆå†™å¤åˆ¶ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;å½“å®¹å™¨åˆ é™¤ä¸€ä¸ªä½å±‚ &lt;code&gt;branch&lt;/code&gt; æ–‡ä»¶æ—¶ï¼Œåªæ˜¯åœ¨é¡¶å±‚ &lt;code&gt;branch&lt;/code&gt; å¯¹è¯¥æ–‡ä»¶è¿›è¡Œé‡å‘½åå¹¶éšè—ï¼Œå®é™…å¹¶æœªåˆ é™¤æ–‡ä»¶ï¼Œåªæ˜¯ä¸å¯è§ã€‚&lt;/p&gt;

&lt;p&gt;ä¸‹å›¾æ‰€ç¤ºï¼Œå®¹å™¨å±‚æ‰€è§ file1 æ–‡ä»¶ä¸ºé•œåƒå±‚æ–‡ä»¶ï¼Œå½“éœ€è¦ä¿®æ”¹ file1 æ—¶ï¼Œä¼šä»é•œåƒå±‚æŠŠæ–‡ä»¶å¤åˆ¶åˆ°å®¹å™¨å±‚ï¼Œç„¶åè¿›è¡Œä¿®æ”¹ï¼Œä»è€Œä¿è¯é•œåƒå±‚æ•°æ®çš„å®Œæ•´æ€§å’Œå¤ç”¨æ€§ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://o7z41ciog.bkt.clouddn.com/cow-1.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;ä¸‹å›¾æ‰€ç¤ºï¼Œå½“éœ€è¦åˆ é™¤ file1 æ—¶ï¼Œç”±äº file1 æ˜¯é•œåƒå±‚æ–‡ä»¶ï¼Œå®¹å™¨å±‚ä¼šåˆ›å»ºä¸€ä¸ª .wh å‰ç½®çš„éšè—æ–‡ä»¶ï¼Œä»è€Œå®ç°å¯¹ file1 çš„éšè—ï¼Œå®é™…å¹¶æœªåˆ é™¤ file1ï¼Œä»è€Œä¿è¯é•œåƒå±‚æ•°æ®çš„å®Œæ•´æ€§å’Œå¤ç”¨æ€§ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://o7z41ciog.bkt.clouddn.com/cow-2.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;code&gt;devicemapper&lt;/code&gt; æ”¯æŒåœ¨å—çº§åˆ«ï¼ˆblockï¼‰å†™å¤åˆ¶ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;&lt;code&gt;Snapshotï¼ˆå¿«ç…§æŠ€æœ¯ï¼‰&lt;/code&gt;&lt;/strong&gt;ï¼šå…³äºæŒ‡å®šæ•°æ®é›†åˆçš„ä¸€ä¸ªå®Œå…¨å¯ç”¨æ‹·è´ï¼Œè¯¥æ‹·è´åŒ…æ‹¬ç›¸åº”æ•°æ®åœ¨æŸä¸ªæ—¶é—´ç‚¹ï¼ˆæ‹·è´å¼€å§‹çš„æ—¶é—´ç‚¹ï¼‰çš„æ˜ åƒã€‚å¿«ç…§å¯ä»¥æ˜¯å…¶æ‰€è¡¨ç¤ºçš„æ•°æ®çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œä¹Ÿå¯ä»¥æ˜¯æ•°æ®çš„ä¸€ä¸ªå¤åˆ¶å“ã€‚è€Œä»å…·ä½“çš„æŠ€æœ¯ç»†èŠ‚æ¥è®²ï¼Œå¿«ç…§æ˜¯æŒ‡å‘ä¿å­˜åœ¨å­˜å‚¨è®¾å¤‡ä¸­çš„æ•°æ®çš„å¼•ç”¨æ ‡è®°æˆ–æŒ‡é’ˆã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;&lt;code&gt;Thin-provisioningï¼ˆç²¾ç®€é…ç½®ï¼‰&lt;/code&gt;&lt;/strong&gt;ï¼Œç›´è¯‘ä¸ºç²¾ç®€é…ç½®ã€‚&lt;code&gt;Thin-provisioning&lt;/code&gt; æ˜¯åŠ¨æ€åˆ†é…ï¼Œéœ€è¦å¤šå°‘åˆ†é…å¤šå°‘ï¼ŒåŒºåˆ«äºä¼ ç»Ÿåˆ†é…å›ºå®šç©ºé—´ä»è€Œé€ æˆçš„èµ„æºæµªè´¹ã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å®ƒæ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿä½ å¯ä»¥è”æƒ³ä¸€ä¸‹æˆ‘ä»¬è®¡ç®—æœºä¸­çš„å†…å­˜ç®¡ç†ä¸­ç”¨åˆ°çš„â€”â€”â€œè™šæ‹Ÿå†…å­˜æŠ€æœ¯â€â€”â€”æ“ä½œç³»ç»Ÿç»™æ¯ä¸ªè¿›ç¨‹ N å¤š N å¤šç”¨ä¸å®Œçš„å†…å€åœ°å€ï¼ˆ32 ä½ä¸‹ï¼Œæ¯ä¸ªè¿›ç¨‹å¯ä»¥æœ‰æœ€å¤š 2GB çš„å†…å­˜ç©ºé—´ï¼‰ï¼Œä½†æ˜¯å‘¢ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œç‰©ç†å†…å­˜æ˜¯æ²¡æœ‰é‚£ä¹ˆå¤šçš„ï¼Œå¦‚æœæŒ‰ç…§è¿›ç¨‹å†…å­˜å’Œç‰©ç†å†…å­˜ä¸€ä¸€æ˜ å°„æ¥ç©çš„è¯ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬å¾—è¦å¤šå°‘çš„ç‰©ç†å†…å­˜å•Šã€‚æ‰€ä»¥ï¼Œæ“ä½œç³»ç»Ÿå¼•å…¥äº†è™šæ‹Ÿå†…å­˜çš„è®¾è®¡ï¼Œæ„æ€æ˜¯ï¼Œæˆ‘é€»è¾‘ä¸Šç»™ä½ æ— é™å¤šçš„å†…å­˜ï¼Œä½†æ˜¯å®é™…ä¸Šæ˜¯å®æŠ¥å®é”€ï¼Œå› ä¸ºæˆ‘çŸ¥é“ä½ ä¸€å®šç”¨ä¸äº†é‚£ä¹ˆå¤šï¼Œäºæ˜¯ï¼Œè¾¾åˆ°äº†å†…å­˜ä½¿ç”¨ç‡æé«˜çš„æ•ˆæœã€‚ï¼ˆä»Šå¤©äº‘è®¡ç®—ä¸­å¾ˆå¤šæ‰€è°“çš„è™šæ‹ŸåŒ–å…¶å®å®Œå…¨éƒ½æ˜¯åœ¨ç”¨å’Œâ€œè™šæ‹Ÿå†…å­˜â€ç›¸ä¼¼çš„ &lt;code&gt;Thin Provisioning&lt;/code&gt; çš„æŠ€æœ¯ï¼Œæ‰€è°“çš„è¶…é…ï¼Œæˆ–æ˜¯è¶…å–ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;å¥½äº†ï¼Œè¯é¢˜æ‹‰å›æ¥ï¼Œæˆ‘ä»¬è¿™é‡Œè¯´çš„æ˜¯å­˜å‚¨ã€‚çœ‹ä¸‹é¢ä¸¤ä¸ªå›¾ï¼Œç¬¬ä¸€ä¸ªæ˜¯ &lt;code&gt;Fat Provisioning&lt;/code&gt;ï¼Œç¬¬äºŒä¸ªæ˜¯ &lt;code&gt;Thin Provisioning&lt;/code&gt;ï¼Œå…¶å¾ˆå¥½çš„è¯´æ˜äº†æ˜¯ä¸ªæ€ä¹ˆä¸€å›äº‹ï¼ˆå’Œè™šæ‹Ÿå†…å­˜æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;&lt;center&gt;&lt;img src=&#34;http://o7z41ciog.bkt.clouddn.com/thin-provisioning-1.jpg&#34; alt=&#34;&#34; /&gt;&lt;/center&gt;&lt;/p&gt;

&lt;p&gt;&lt;center&gt;&lt;img src=&#34;http://o7z41ciog.bkt.clouddn.com/thin-provisioning-2.jpg&#34; alt=&#34;&#34; /&gt;&lt;/center&gt;&lt;/p&gt;

&lt;p markdown=&#34;1&#34; style=&#34;display: block;padding: 10px;margin: 10px 0;border: 1px solid #ccc;border-top-width: 5px;border-radius: 3px;border-top-color: #9954bb;&#34;&gt;
é‚£ä¹ˆï¼ŒDocker æ˜¯æ€ä¹ˆä½¿ç”¨ &lt;code&gt;Thin Provisioning&lt;/code&gt; è¿™ä¸ªæŠ€æœ¯åšåˆ°åƒ UnionFS é‚£æ ·çš„åˆ†å±‚é•œåƒçš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼ŒDocker ä½¿ç”¨äº† &lt;code&gt;Thin Provisioning&lt;/code&gt; çš„ &lt;code&gt;Snapshot&lt;/code&gt; çš„æŠ€æœ¯ã€‚ä¸‹é¢ä¸€ç¯‡æˆ‘ä»¬æ¥ä»‹ç»ä¸€ä¸‹ &lt;code&gt;Thin Provisioning&lt;/code&gt; çš„ &lt;code&gt;Snapshot&lt;/code&gt;ã€‚
&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;p&gt;&lt;center&gt;&lt;a href=&#34;https://www.yangcs.net/posts/devicemapper-theory/&#34; target=&#34;_blank&#34;&gt;Device Mapperç³»åˆ— (1)ï¼šDevice Mapper æŠ€æœ¯&lt;/a&gt;&lt;/center&gt;&lt;/p&gt;

&lt;p&gt;&lt;center&gt;&lt;a href=&#34;https://www.yangcs.net/posts/thin-provisioning/&#34; target=&#34;_blank&#34;&gt;Device Mapperç³»åˆ— (2)ï¼šThin Provisioning å®è·µ&lt;/a&gt;&lt;/center&gt;&lt;/p&gt;

&lt;p&gt;&lt;center&gt;&lt;a href=&#34;https://www.yangcs.net/posts/calico-rr/&#34; target=&#34;_blank&#34;&gt;Device Mapperç³»åˆ— (3)ï¼šDocker ä¸­ä½¿ç”¨ devicemapper å­˜å‚¨é©±åŠ¨&lt;/a&gt;&lt;/center&gt;&lt;/p&gt;</description>
    </item>
    
  </channel>
</rss>
