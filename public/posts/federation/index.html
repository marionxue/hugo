<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title> Kubernetes ä½¿ç”¨é›†ç¾¤è”é‚¦å®ç°å¤šé›†ç¾¤ç®¡ç† - æ¨ä¼ èƒœçš„åšå®¢|Cloud Native|yangcs.net</title>
  <meta name="description" content="æ¨ä¼ èƒœçš„åšå®¢|Cloud Native|yangcs.net" />
  <meta property="og:title" content="Kubernetes ä½¿ç”¨é›†ç¾¤è”é‚¦å®ç°å¤šé›†ç¾¤ç®¡ç†" />
  <meta name="twitter:title" content="Kubernetes ä½¿ç”¨é›†ç¾¤è”é‚¦å®ç°å¤šé›†ç¾¤ç®¡ç†" />
  <meta name="description" content="ä½¿ç”¨è”é‚¦æœåŠ¡è¿›è¡Œè·¨é›†ç¾¤æœåŠ¡å‘ç°">
  <meta property="og:description" content="ä½¿ç”¨è”é‚¦æœåŠ¡è¿›è¡Œè·¨é›†ç¾¤æœåŠ¡å‘ç°">
  <meta name="twitter:description" content="ä½¿ç”¨è”é‚¦æœåŠ¡è¿›è¡Œè·¨é›†ç¾¤æœåŠ¡å‘ç°">
  <meta name="author" content="{Description { .Site.Author.name }}"/>
  <link href='https://hugo-picture.oss-cn-beijing.aliyuncs.com/favicon-32x32.png' rel='icon' type='image/x-icon'/>
  <meta property="og:image" content="https://ws2.sinaimg.cn/large/006tNbRwgy1fwyhv7w4yjj307j07j0st.jpg" />
  <meta name="twitter:image" content="https://ws2.sinaimg.cn/large/006tNbRwgy1fwyhv7w4yjj307j07j0st.jpg" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@Paranoid_yang" />
  <meta name="twitter:creator" content="@Paranoid_yang" />
  <meta property="og:url" content="https://www.yangcs.net/posts/federation/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Ryan Yang" />

  <meta name="generator" content="Hugo 0.49" />
  <link rel="canonical" href="https://www.yangcs.net/posts/federation/" />
  <link rel="alternate" href="https://www.yangcs.net/index.xml" type="application/rss+xml" title="Ryan Yang">
  <script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/jquery-1.12.4.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  
  
  <link rel="stylesheet" href="https://www.yangcs.net/css/main.css" />
  <link rel="stylesheet" href="https://www.yangcs.net/css/my.css" />
  <link rel="stylesheet" href="https://www.yangcs.net/css/pace.css" />
  <link rel="stylesheet" href="https://www.yangcs.net/css/lightgallery.css" />
  <link rel="stylesheet" href="https://www.yangcs.net/css/baguetteBox.css" />
  <link rel="stylesheet" href="https://www.yangcs.net/css/search.css" />
  <link rel="stylesheet" href="https://www.yangcs.net/css/reward.css" />
  <link rel="stylesheet" href="https://www.yangcs.net/css/share.min.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://www.yangcs.net/css/pygment_highlights.css" />
  <link rel="stylesheet" href="https://www.yangcs.net/css/highlight.min.css" />
  <link rel="stylesheet" href="https://www.yangcs.net/css/toc.css" />
  <link rel="stylesheet" href="https://www.yangcs.net/css/lightbox.css" />
  <link rel="stylesheet" href="https://www.yangcs.net/live2d/css/live2d.css" />
  <link rel="stylesheet" href="https://www.yangcs.net/live2d/css/DPlayer.min.css" />
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video-js.min.css">


<meta name="baidu-site-verification" content="g8IYR9SNLF" />
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?cffe439e37449bb1c07ab26ab56484bb";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<link rel="stylesheet" href="https://www.yangcs.net/css/prism.css" />







<script async src="//cdn.busuanzi.ibruce.info/cdn/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script>
    $(document).ready(function() {
        var int = setInterval(fixCount, 100);
        var busuanziSiteOffset =  100000  
        function fixCount() {
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                clearInterval(int);
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + busuanziSiteOffset);
            }
        }
    });
</script>




<script src="https://www.yangcs.net/js/pace.min.js" data-no-instant></script>



<script src="https://www.yangcs.net/js/instantclick.min.js" data-no-instant></script>
   <script data-no-instant>
   InstantClick.on('change', function(isInitialLoad) {
     if (isInitialLoad === false) {
       if (typeof MathJax !== 'undefined') 
         MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
       if (typeof prettyPrint !== 'undefined') 
         prettyPrint();
       if (typeof _hmt !== 'undefined')  
         _hmt.push(['_trackPageview', location.pathname + location.search]);
       if (typeof ga !== 'undefined')  
           ga('send', 'pageview', location.pathname + location.search);
     }
   });
   InstantClick.init();
</script>


<script>
step=0
function flash_title()
{
step++
if (step==3) {step=1}         
if (step==1) {document.title='æ¨ä¼ èƒœçš„åšå®¢|Cloud Native|yangcs.net'}
if (step==2) {document.title='ã€ã€€ã€€ã€€ã€€        ã€‘'}
setTimeout("flash_title()",380);
}
flash_title()
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/gist-embed/2.7.1/gist-embed.min.js"></script>

<script src="https://www.yangcs.net/js/DPlayer.min.js"></script>



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />



<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-124447767-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://www.yangcs.net/">Ryan Yang</a>
    </div>
    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">æ–‡ç« åˆ†ç±»</a>
              <div class="navlinks-children">
                
                
                  <a href="https://www.yangcs.net/categories/kubernetes/">kubernetes</a>
                
                
                  <a href="https://www.yangcs.net/categories/service-mesh/">Service Mesh</a>
                
                
                  <a href="https://www.yangcs.net/categories/docker/">Docker</a>
                
                
                  <a href="https://www.yangcs.net/categories/python/">Python</a>
                
                
                  <a href="https://www.yangcs.net/categories/loadbalance/"> è´Ÿè½½å‡è¡¡</a>
                
                
                  <a href="https://www.yangcs.net/categories/gfw/">ç§‘å­¦ä¸Šç½‘</a>
                
                
                  <a href="https://www.yangcs.net/categories/math/">æ•°å­¦</a>
                
                
                  <a href="https://www.yangcs.net/categories/hugo/">Hugo</a>
                
                
                  <a href="https://www.yangcs.net/categories/share/">åˆ†äº«</a>
                
                
                  <a href="https://www.yangcs.net/tags/">Tags</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">ä¹¦ç±æ¨è</a>
              <div class="navlinks-children">
                
                
                  <a href="https://www.yangcs.net/talent-is-overrated/">å¤©æ‰æºè‡ªåˆ»æ„ç»ƒä¹ </a>
                
                
                  <a href="https://www.gitbook.com/book/yeasy/docker_practice">Docker handbook</a>
                
                
                  <a href="https://istio.io/zh/docs">Istio service mesh</a>
                
                
                  <a href="https://github.com/ruanyf/reading-list">é˜®ä¸€å³°ä¹¦å•</a>
                
                
                  <a href="https://github.com/fengdu78/Coursera-ML-AndrewNg-Notes">æœºå™¨å­¦ä¹ ç¬”è®°</a>
                
                
                  <a href="https://www.yangcs.net/the-way-to-go/">Go å…¥é—¨æŒ‡å—</a>
                
                
                  <a href="https://www.yangcs.net/prometheus-handbook/">Prometheus ä¸­æ–‡æ–‡æ¡£</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">è‘µèŠ±å®å…¸</a>
              <div class="navlinks-children">
                
                
                  <a href="https://www.yangcs.net/learn-english/"> è‹±è¯­å­¦ä¹ ç»ˆæç§˜è¯€</a>
                
                
                  <a href="https://www.yangcs.net/a-day-in-the-life-of-jeff/">A Day in the life of Jeff</a>
                
              </div>
            </li>
          
        
          
            <li>
              <a title="å…³äºæˆ‘" href="/resume/">å…³äºæˆ‘</a>
              
              
            </li>
          
        

        

        
        
          <li>
            <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch" style="outline: none;">
              <span class="hidden-sm hidden-md hidden-lg">Search</span> <span id="searchGlyph" class="glyphicon glyphicon-search"></span>
            </a>
          </li>
          
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
          <a title="Ryan Yang" href="https://www.yangcs.net/">
            <img class="avatar-img" src="https://ws2.sinaimg.cn/large/006tNbRwgy1fwyhv7w4yjj307j07j0st.jpg" alt="Ryan Yang" />
          </a>
        
      </div>
    </div>

  </div>
</nav>





  <div id="modalSearch" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Search yangcs.net</h4>
        </div>
        <div class="modal-body">
            
<div class="aa-input-container" id="aa-input-container">
    <input type="search" id="aa-search-input" class="aa-input-search" placeholder="Search for titles or URIs..." name="search" autocomplete="off" />
    <svg class="aa-input-icon" viewBox="654 -372 1664 1664">
        <path d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z" />
    </svg>
</div>



<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/algoliasearch.min.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/autocomplete.min.js"></script>

<script>
var client = algoliasearch("4BELQK2TOI", "62fd06bd949abb4211bfab0aa288f67b");
var index = client.initIndex('blog');

autocomplete('#aa-search-input',
{ hint: false}, {
    source: autocomplete.sources.hits(index, {hitsPerPage: 5}),
    
    displayKey: 'name',
    
    templates: {
        
        suggestion: function(suggestion) {
            
            return '<span>' + '<a href="/' + suggestion.uri+ '">' +
            suggestion._highlightResult.title.value + '</a></span>';
        }
    }
});
</script>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">close</button>
        </div>
      </div>
    </div>
  </div>


    
  
  
  




  
    <div id="header-big-imgs" data-num-img=1 data-img-src-1="https://ws2.sinaimg.cn/large/006tNbRwgy1fwtkgo7kp3j31kw0d0750.jpg" ></div>
  

  <header class="header-section has-img">
    
      <div class="intro-header big-img">
        
        
        <div class="container">
          <div class="row">
              <div class="col-lg-12 col-md-12 col-md-offset-0">
                
                <div class="post-heading">
                
                  
                     <h1>Kubernetes ä½¿ç”¨é›†ç¾¤è”é‚¦å®ç°å¤šé›†ç¾¤ç®¡ç†</h1>
                     
                     
                  
                  
                  
                    
                      <hr class="small">
                      <span class="post-subheading">ä½¿ç”¨è”é‚¦æœåŠ¡è¿›è¡Œè·¨é›†ç¾¤æœåŠ¡å‘ç°</span>
                    
                  
                  
                    <span class="post-meta">
  
  Posted on March 22, 2018
  
  
</span>


                  
                
              </div>
            </div>
          </div>
        </div>
        <span class="img-desc" style="display: inline;"></span>
      </div>
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-12 col-md-12 col-md-offset-0">
            <div class="posts-heading">
                <h1 align="center">Kubernetes ä½¿ç”¨é›†ç¾¤è”é‚¦å®ç°å¤šé›†ç¾¤ç®¡ç†</h1>
                
                  
                    <h2 align="center" class="posts-subheading">ä½¿ç”¨è”é‚¦æœåŠ¡è¿›è¡Œè·¨é›†ç¾¤æœåŠ¡å‘ç°</h2>
                  
                
                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main" itemscope itemtype="http://schema.org/Article">
    <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            
            
            
<div>
    <section id="datecount">
        <h4 id="date"> Thu Mar 22, 2018</h4>
    </section>
    <h5 id="wc">4400 Words|Read in about 9 Min|æœ¬æ–‡æ€»é˜…è¯»é‡<span id="busuanzi_value_page_pv"></span>æ¬¡</h5>
    <h5 id="tags">Tags: 
        
        <a href="https://www.yangcs.net/tags/kubernetes/">kubernetes</a> &nbsp;
    </h5>
</div>

            
            <article role="main" class="blog-post" itemprop="articleBody" id="content">
                
<aside class="toc">
    <div id='anchors-navbar'>
        <i class='fa fa-anchor'></i>
        <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#span-id-inline-toc-1-span-kubernetesé›†ç¾¤è”é‚¦ä»‹ç»"><span id="inline-toc">1.</span> Kubernetesé›†ç¾¤è”é‚¦ä»‹ç»</a>
<ul>
<li><a href="#ç®¡ç†å¤šä¸ª-kuberntes-é›†ç¾¤">ç®¡ç†å¤šä¸ª kuberntes é›†ç¾¤</a></li>
<li><a href="#è·¨é›†ç¾¤æœåŠ¡å‘ç°">è·¨é›†ç¾¤æœåŠ¡å‘ç°</a></li>
<li><a href="#è·¨é›†ç¾¤è°ƒåº¦">è·¨é›†ç¾¤è°ƒåº¦</a></li>
<li><a href="#é›†ç¾¤é«˜å¯ç”¨-æ•…éšœè‡ªåŠ¨è¿ç§»">é›†ç¾¤é«˜å¯ç”¨ï¼Œæ•…éšœè‡ªåŠ¨è¿ç§»</a></li>
</ul></li>
<li><a href="#span-id-inline-toc-2-span-ä½¿ç”¨é›†ç¾¤è”é‚¦å®ç°å¤šé›†ç¾¤ç®¡ç†"><span id="inline-toc">2.</span> ä½¿ç”¨é›†ç¾¤è”é‚¦å®ç°å¤šé›†ç¾¤ç®¡ç†</a>
<ul>
<li><a href="#ç³»ç»Ÿç¯å¢ƒ">ç³»ç»Ÿç¯å¢ƒ</a></li>
<li><a href="#å®‰è£…-kubefed">å®‰è£… kubefed</a></li>
<li><a href="#é…ç½®-context">é…ç½® context</a></li>
<li><a href="#è®¾ç½®-coredns-ä½œä¸ºé›†ç¾¤è”é‚¦çš„-dns-æä¾›å•†">è®¾ç½® CoreDNS ä½œä¸ºé›†ç¾¤è”é‚¦çš„ DNS æä¾›å•†</a>
<ul>
<li><a href="#span-id-inline-toc-1-span-å‰æ"><span id="inline-toc">1.</span> å‰æ</a></li>
<li><a href="#span-id-inline-toc-2-span-ä½¿æœ¬åœ°é›†ç¾¤æ”¯æŒ-loadbalancer-æœåŠ¡"><span id="inline-toc">2.</span> ä½¿æœ¬åœ°é›†ç¾¤æ”¯æŒ LoadBalancer æœåŠ¡</a></li>
<li><a href="#span-id-inline-toc-3-span-å®‰è£…-helm"><span id="inline-toc">3.</span> å®‰è£… helm</a></li>
<li><a href="#span-id-inline-toc-4-span-éƒ¨ç½²-etcd"><span id="inline-toc">4.</span> éƒ¨ç½² etcd</a></li>
<li><a href="#span-id-inline-toc-5-span-éƒ¨ç½²-coredns"><span id="inline-toc">5.</span> éƒ¨ç½² CoreDNS</a></li>
<li><a href="#span-id-inline-toc-6-span-ä½¿ç”¨-coredns-ä½œä¸º-dns-æä¾›å•†æ¥éƒ¨ç½²-federation"><span id="inline-toc">6.</span> ä½¿ç”¨ CoreDNS ä½œä¸º DNS æä¾›å•†æ¥éƒ¨ç½² Federation</a></li>
<li><a href="#span-id-inline-toc-7-span-æ·»åŠ é›†ç¾¤è‡³-federation"><span id="inline-toc">7.</span> æ·»åŠ é›†ç¾¤è‡³ federation</a></li>
</ul></li>
</ul></li>
<li><a href="#span-id-inline-toc-3-span-federation-æ”¯æŒçš„æœåŠ¡"><span id="inline-toc">3.</span> Federation æ”¯æŒçš„æœåŠ¡</a></li>
<li><a href="#span-id-inline-toc-4-span-å‚è€ƒæ–‡æ¡£"><span id="inline-toc">4.</span> å‚è€ƒæ–‡æ¡£</a></li>
</ul></li>
</ul>
</nav>
    </div>
    
</aside>


                <p></p>

<p>åœ¨äº‘è®¡ç®—ç¯å¢ƒä¸­ï¼ŒæœåŠ¡çš„ä½œç”¨è·ç¦»èŒƒå›´ä»è¿‘åˆ°è¿œä¸€èˆ¬å¯ä»¥æœ‰ï¼š</p>

<ul>
<li>åŒä¸»æœºï¼ˆHostï¼ŒNodeï¼‰</li>
<li>è·¨ä¸»æœºåŒå¯ç”¨åŒºï¼ˆAvailable Zoneï¼‰</li>
<li>è·¨å¯ç”¨åŒºåŒåœ°åŒºï¼ˆRegionï¼‰</li>
<li>è·¨åœ°åŒºåŒæœåŠ¡å•†ï¼ˆCloud Service Providerï¼‰</li>
<li>è·¨äº‘å¹³å°</li>
</ul>

<p>K8s çš„è®¾è®¡å®šä½æ˜¯å•ä¸€é›†ç¾¤åœ¨åŒä¸€ä¸ªåœ°åŸŸå†…ï¼Œå› ä¸ºåŒä¸€ä¸ªåœ°åŒºçš„ç½‘ç»œæ€§èƒ½æ‰èƒ½æ»¡è¶³ K8s çš„è°ƒåº¦å’Œè®¡ç®—å­˜å‚¨è¿æ¥è¦æ±‚ã€‚</p>

<p>ä½†æ˜¯å®é™…æƒ…å†µä¸­ç»å¸¸é‡åˆ°çš„ä¸€äº›é—®é¢˜ï¼Œå°±æ˜¯å•ä¸ªé›†ç¾¤é€šå¸¸æ— æ³•è·¨å•ä¸ªäº‘å‚å•†çš„å¤šä¸ª Regionï¼Œæ›´ä¸ç”¨è¯´æ”¯æŒè·¨è·¨åŸŸä¸åŒçš„äº‘å‚å•†ã€‚è¿™æ ·ä¼šç»™ä¼ä¸šå¸¦æ¥ä¸€äº›æ‹…å¿§ï¼Œå¦‚ä½•åº”å¯¹å¯ç”¨åŒºçº§åˆ«çš„ Failï¼Œä»¥åŠå®¹ç¾å¤‡ä»½ï¼Ÿæ˜¯å¦ä¼šé€ æˆå‚å•†é”å®šï¼Œå¢åŠ è¿ç§»æˆæœ¬ï¼Ÿå¦‚ä½•åº”å¯¹çº¿ä¸Šçº¿ä¸‹çªå‘æµé‡ï¼Ÿå¦‚ä½•ç»Ÿä¸€ç®¡ç†è°ƒåº¦å®¹å™¨èµ„æºï¼Ÿå•ä¸ªé›†ç¾¤è§„æ¨¡çš„ä¸Šé™ç­‰ç­‰ã€‚</p>

<p>é›†ç¾¤è”é‚¦ï¼ˆFederationï¼‰å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šè§£å†³è¿™äº›é—®é¢˜ã€‚<code>Federation</code> æ˜¯å¯ä»¥å°†åˆ†å¸ƒåœ¨å¤šä¸ª Region æˆ–è€…å¤šä¸ªäº‘å‚å•†çš„ Kubernetes é›†ç¾¤æ•´åˆæˆä¸€ä¸ªå¤§çš„é›†ç¾¤ï¼Œç»Ÿä¸€ç®¡ç†ä¸è°ƒåº¦ã€‚</p>

<h2 id="span-id-inline-toc-1-span-kubernetesé›†ç¾¤è”é‚¦ä»‹ç»"><span id="inline-toc">1.</span> Kubernetesé›†ç¾¤è”é‚¦ä»‹ç»</h2>

<hr />

<h3 id="ç®¡ç†å¤šä¸ª-kuberntes-é›†ç¾¤">ç®¡ç†å¤šä¸ª kuberntes é›†ç¾¤</h3>

<p><strong>é›†ç¾¤è”é‚¦</strong>åœ¨æ¶æ„ä¸ŠåŒ kubernetes é›†ç¾¤å¾ˆç›¸ä¼¼ã€‚æœ‰ä¸€ä¸ª<strong>é›†ç¾¤è”é‚¦</strong>çš„ API server æä¾›ä¸€ä¸ªæ ‡å‡†çš„ Kubernetes APIï¼Œå¹¶ä¸”é€šè¿‡ etcd æ¥å­˜å‚¨çŠ¶æ€ã€‚ä¸åŒçš„æ˜¯ï¼Œä¸€ä¸ªé€šå¸¸çš„Kubernetes åªæ˜¯ç®¡ç†èŠ‚ç‚¹è®¡ç®—ï¼Œè€Œ<strong>é›†ç¾¤è”é‚¦</strong>ç®¡ç†æ‰€æœ‰çš„ kubernetes é›†ç¾¤ã€‚</p>

<p><center><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fwv02hj3x5j31kw14y16z.jpg" alt="" /></center></p>

<p>Federationä¸»è¦åŒ…æ‹¬ä¸‰ä¸ªç»„ä»¶ï¼š</p>

<ul>
<li><strong>federation-apiserverï¼š</strong>ç±»ä¼¼ <code>kube-apiserver</code>ï¼Œä½†æä¾›çš„æ˜¯è·¨é›†ç¾¤çš„ REST API</li>
<li><strong>federation-controller-managerï¼š</strong>ç±»ä¼¼ <code>kube-controller-manager</code>ï¼Œä½†æä¾›å¤šé›†ç¾¤çŠ¶æ€çš„åŒæ­¥æœºåˆ¶</li>
<li><strong>kubefedï¼š</strong>Federation ç®¡ç†å‘½ä»¤è¡Œå·¥å…·</li>
</ul>

<p>ç”¨æˆ·å¯ä»¥é€šè¿‡ Federation çš„ API Server æ³¨å†Œè¯¥ Federation çš„æˆå‘˜ <code>K8s Cluster</code>ã€‚å½“ç”¨æˆ·é€šè¿‡ Federation çš„ API Server åˆ›å»ºã€æ›´æ”¹ API å¯¹è±¡æ—¶ï¼Œ<code>Federation API Server</code> ä¼šåœ¨è‡ªå·±æ‰€æœ‰æ³¨å†Œçš„å­ K8s Cluster éƒ½åˆ›å»ºä¸€ä»½å¯¹åº”çš„ API å¯¹è±¡ã€‚</p>

<p>åœ¨æä¾›ä¸šåŠ¡è¯·æ±‚æœåŠ¡æ—¶ï¼Œ<code>K8s Federation</code> ä¼šå…ˆåœ¨è‡ªå·±çš„å„ä¸ªå­ Cluster ä¹‹é—´åšè´Ÿè½½å‡è¡¡ï¼Œè€Œå¯¹äºå‘é€åˆ°æŸä¸ªå…·ä½“ <code>K8s Cluster</code> çš„ä¸šåŠ¡è¯·æ±‚ï¼Œä¼šä¾ç…§è¿™ä¸ª K8s Cluster ç‹¬ç«‹æä¾›æœåŠ¡æ—¶ä¸€æ ·çš„è°ƒåº¦æ¨¡å¼å»åš K8s Cluster å†…éƒ¨çš„è´Ÿè½½å‡è¡¡ã€‚è€ŒCluster ä¹‹é—´çš„è´Ÿè½½å‡è¡¡æ˜¯é€šè¿‡åŸŸåæœåŠ¡çš„è´Ÿè½½å‡è¡¡æ¥å®ç°çš„ã€‚</p>

<p>æ‰€æœ‰çš„è®¾è®¡éƒ½å°½é‡ä¸å½±å“ K8s Cluster ç°æœ‰çš„å·¥ä½œæœºåˆ¶ï¼Œè¿™æ ·å¯¹äºæ¯ä¸ªå­ K8s é›†ç¾¤æ¥è¯´ï¼Œå¹¶ä¸éœ€è¦æ›´å¤–å±‚çš„æœ‰ä¸€ä¸ª K8s Federationï¼Œä¹Ÿå°±æ˜¯æ„å‘³ç€æ‰€æœ‰ç°æœ‰çš„ K8s ä»£ç å’Œæœºåˆ¶ä¸éœ€è¦å› ä¸º <code>Federation</code> åŠŸèƒ½æœ‰ä»»ä½•å˜åŒ–ã€‚</p>

<h3 id="è·¨é›†ç¾¤æœåŠ¡å‘ç°">è·¨é›†ç¾¤æœåŠ¡å‘ç°</h3>

<p>Kubernetes æœ‰ä¸€ä¸ªæ ‡å‡†çš„æ’ä»¶ï¼š<code>kube-dns</code>ï¼Œè¿™ä¸ªæ’ä»¶å¯ä»¥åœ¨é›†ç¾¤å†…éƒ¨æä¾› DNS æœåŠ¡ï¼Œé€šè¿‡ DNS è§£æ service åå­—æ¥è®¿é—® kubernetes æœåŠ¡ã€‚<br /></p>

<p>Kubernetes æœåŠ¡æ˜¯ç”±ä¸€ç»„ kubernetes POD ç»„æˆçš„ï¼Œè¿™äº› POD æ˜¯ä¸€äº›å·²ç»å®¹å™¨åŒ–äº†çš„åº”ç”¨ï¼Œè¿™äº› POD å‰é¢ä½¿ç”¨åˆ°äº†è´Ÿè½½å‡è¡¡å™¨ã€‚<br /></p>

<p>å‡å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ª kubernetes é›†ç¾¤ï¼Œè¿™ä¸ªé›†ç¾¤é‡Œé¢æœ‰ä¸€ä¸ªæœåŠ¡å«åš mysqlï¼Œè¿™ä¸ªæœåŠ¡æ˜¯ç”±ä¸€ç»„ mysql POD ç»„æˆçš„ã€‚åœ¨è¿™ä¸ª kubernetes é›†ç¾¤ä¸­ï¼Œå…¶ä»–åº”ç”¨å¯ä»¥é€šè¿‡ DNS æ¥è®¿é—®è¿™ä¸ª mysql æœåŠ¡ã€‚</p>

<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fwv04ohxb4j30fe09a74z.jpg" alt="" /></p>

<h3 id="è·¨é›†ç¾¤è°ƒåº¦">è·¨é›†ç¾¤è°ƒåº¦</h3>

<p id="div-border-top-red">ä¸ºäº†è¿½æ±‚é«˜å¯ç”¨æ€§å’Œæ›´é«˜çš„æ€§èƒ½ï¼Œé›†ç¾¤è”é‚¦èƒ½å¤ŸæŠŠä¸åŒ POD æŒ‡å®šç»™ä¸åŒçš„ Kubernetes é›†ç¾¤ä¸­ã€‚é›†ç¾¤è”é‚¦è°ƒåº¦å™¨å°†å†³å®šå¦‚ä½•åœ¨ä¸åŒ kubernetes é›†ç¾¤ä¸­åˆ†é…å·¥ä½œè´Ÿè½½ã€‚</p>

<p>é€šè¿‡è·¨é›†ç¾¤è°ƒåº¦ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š</p>

<ul>
<li>è·¨ kubernetes é›†ç¾¤å‡åŒ€çš„è°ƒåº¦ä»»åŠ¡è´Ÿè½½</li>
<li>å°†å„ä¸ª kubernetes é›†ç¾¤çš„å·¥ä½œè´Ÿè½½è¿›è¡Œæœ€å¤§åŒ–ï¼Œå¦‚æœå½“å‰ kubernetes é›†ç¾¤è¶…å‡ºäº†æ‰¿å—èƒ½åŠ›ï¼Œé‚£ä¹ˆå°†é¢å¤–çš„å·¥ä½œè´Ÿè½½è·¯ç”±åˆ°å¦ä¸€ä¸ªæ¯”è¾ƒç©ºé—²çš„ kubernetes é›†ç¾¤ä¸­</li>
<li>æ ¹æ®åº”ç”¨åœ°ç†åŒºåŸŸéœ€æ±‚ï¼Œè°ƒåº¦å·¥ä½œè´Ÿè½½åˆ°ä¸åŒçš„ kubernetes é›†ç¾¤ä¸­ï¼Œå¯¹äºä¸åŒçš„ç»ˆç«¯ç”¨æˆ·ï¼Œæä¾›æ›´é«˜çš„å¸¦å®½å’Œæ›´ä½çš„å»¶è¿Ÿã€‚</li>
</ul>

<h3 id="é›†ç¾¤é«˜å¯ç”¨-æ•…éšœè‡ªåŠ¨è¿ç§»">é›†ç¾¤é«˜å¯ç”¨ï¼Œæ•…éšœè‡ªåŠ¨è¿ç§»</h3>

<p>é›†ç¾¤è”é‚¦å¯ä»¥è·¨é›†ç¾¤å†—é¦€éƒ¨ç½²ï¼Œå½“æŸä¸ªé›†ç¾¤æ‰€åœ¨åŒºåŸŸå‡ºç°æ•…éšœæ—¶ï¼Œå¹¶ä¸å½±å“æ•´ä¸ªæœåŠ¡ã€‚é›†ç¾¤è”é‚¦è¿˜å¯ä»¥æ£€æµ‹é›†ç¾¤æ˜¯å¦ä¸ºä¸å¯ç”¨çŠ¶æ€ï¼Œå¦‚æœå‘ç°æŸä¸ªé›†ç¾¤ä¸ºä¸å¯ç”¨çŠ¶æ€æ—¶ï¼Œå¯ä»¥å°†å¤±è´¥çš„ä»»åŠ¡é‡æ–°åˆ†é…ç»™é›†ç¾¤è”é‚¦ä¸­å…¶ä»–å¯ç”¨çŠ¶æ€çš„é›†ç¾¤ä¸Šã€‚</p>

<h2 id="span-id-inline-toc-2-span-ä½¿ç”¨é›†ç¾¤è”é‚¦å®ç°å¤šé›†ç¾¤ç®¡ç†"><span id="inline-toc">2.</span> ä½¿ç”¨é›†ç¾¤è”é‚¦å®ç°å¤šé›†ç¾¤ç®¡ç†</h2>

<hr />

<h3 id="ç³»ç»Ÿç¯å¢ƒ">ç³»ç»Ÿç¯å¢ƒ</h3>

<table>
<thead>
<tr>
<th align="left">åŠŸèƒ½ç»„ä»¶</th>
<th align="center">ç³»ç»Ÿç»„ä»¶</th>
<th align="left">ç³»ç»Ÿç‰ˆæœ¬</th>
<th align="left">è®¾å¤‡æ•°é‡</th>
<th align="left">å¤‡æ³¨</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">è”é‚¦é›†ç¾¤æ§åˆ¶å¹³é¢</td>
<td align="center">k8s 1.9+Federation</td>
<td align="left">CentOS 7.3</td>
<td align="left">3å°</td>
<td align="left">è”é‚¦é›†ç¾¤æ§åˆ¶å¹³é¢</td>
</tr>

<tr>
<td align="left">K8sé›†ç¾¤01</td>
<td align="center">k8s 1.9 master+node</td>
<td align="left">CentOS 7.3</td>
<td align="left">3å°</td>
<td align="left">è”é‚¦é›†ç¾¤èŠ‚ç‚¹</td>
</tr>
</tbody>
</table>

<h3 id="å®‰è£…-kubefed">å®‰è£… kubefed</h3>

<p>é€‰æ‹©å…¶ä¸­çš„ä¸€ä¸ªé›†ç¾¤ä½œä¸ºä¸»é›†ç¾¤ï¼Œè¿™ä¸ªä¸»é›†ç¾¤å°†è¿è¡Œç»„æˆè”é‚¦æ§åˆ¶é¢æ¿çš„æ‰€æœ‰ç»„ä»¶ã€‚</p>

<p>ä½¿ç”¨ä¸‹åˆ—å‘½ä»¤ä¸‹è½½å¯¹åº”æœ€æ–°å‘è¡Œçš„ <code>kubefed</code> å®‰è£…åŒ…å¹¶å°†å®‰è£…åŒ…é‡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶è§£å‹å‡ºæ¥ï¼š</p>

<pre><code class="language-bash">$ curl -LO https://storage.cloud.google.com/kubernetes-federation-release/release/${RELEASE-VERSION}/federation-client-linux-amd64.tar.gz
$ tar -xzvf federation-client-linux-amd64.tar.gz
</code></pre>

<p>è¯·ç”¨<a href="https://github.com/kubernetes/federation/releases" target="_blank">federation release page</a>é¡µé¢å®é™…çš„ç‰ˆæœ¬å·æ›¿æ¢å˜é‡ <code>RELEASE-VERSION</code>ã€‚</p>

<p>å°†è§£å‹å‡ºæ¥çš„å†…å®¹å¤åˆ¶åˆ°ä½ çš„ç¯å¢ƒå˜é‡ <code>$PATH</code> é‡Œçš„éšä¾¿ä¸€ä¸ªè·¯å¾„ï¼Œ å¹¶è®¾ç½®å¯æ‰§è¡Œæƒé™ã€‚</p>

<pre><code class="language-bash">$ cp federation/client/bin/kubefed /usr/local/bin
$ chmod +x /usr/local/bin/kubefed
</code></pre>

<h3 id="é…ç½®-context">é…ç½® context</h3>

<p>åœ¨å‡†å¤‡é…ç½®è”é‚¦é›†ç¾¤çš„ DCE é›†ç¾¤ä¸­é…ç½®ä¸¤ä¸ª DCE é›†ç¾¤çš„ <code>context</code>ã€‚è®©æ”¹èŠ‚ç‚¹èƒ½é€šè¿‡åˆ‡æ¢ <code>context</code> è¿æ¥ä¸åŒçš„å­é›†ç¾¤ã€‚</p>

<p>å…ˆåˆ›å»ºæœ¬åœ°é›†ç¾¤çš„ <code>kubeconfig</code> æ–‡ä»¶</p>

<pre><code class="language-bash">$ export KUBE_APISERVER=&quot;https://192.168.123.250:6443&quot;
# è®¾ç½®é›†ç¾¤å‚æ•°
$ kubectl config set-cluster kubernetes \
  --certificate-authority=/etc/kubernetes/ssl/ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER}
# è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°
$ kubectl config set-credentials admin \
  --client-certificate=/etc/kubernetes/ssl/admin.pem \
  --embed-certs=true \
  --client-key=/etc/kubernetes/ssl/admin-key.pem
# è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°
$ kubectl config set-context kubernetes \
  --cluster=kubernetes \
  --user=admin
# è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡
$ kubectl config use-context kubernetes
</code></pre>

<p>ç”Ÿæˆçš„ kubeconfig è¢«ä¿å­˜åˆ° <code>~/.kube/config</code> æ–‡ä»¶ã€‚</p>

<div id="note">
<p id="note-title">Note</p>
<br />
<p>~/.kube/config æ–‡ä»¶æ‹¥æœ‰å¯¹è¯¥é›†ç¾¤çš„æœ€é«˜æƒé™ï¼Œè¯·å¦¥å–„ä¿ç®¡ã€‚</p>
</div>

<p>é…ç½®ç»“æœå¦‚ä¸‹ï¼š</p>

<pre><code class="language-bash">$ kubectl config get-contexts

CURRENT   NAME          CLUSTER       AUTHINFO      NAMESPACE
*         kubernetes    kubernetes    admin
</code></pre>

<h3 id="è®¾ç½®-coredns-ä½œä¸ºé›†ç¾¤è”é‚¦çš„-dns-æä¾›å•†">è®¾ç½® CoreDNS ä½œä¸ºé›†ç¾¤è”é‚¦çš„ DNS æä¾›å•†</h3>

<h4 id="span-id-inline-toc-1-span-å‰æ"><span id="inline-toc">1.</span> å‰æ</h4>

<ul>
<li>ä¸ºå¯ç”¨ <code>CoreDNS</code> æ¥å®ç°è·¨è”é‚¦é›†ç¾¤çš„æœåŠ¡å‘ç°ï¼Œè”é‚¦çš„æˆå‘˜é›†ç¾¤ä¸­å¿…é¡»æ”¯æŒ <code>LoadBalancer</code> æœåŠ¡ã€‚ï¼ˆ<font color="red">æœ¬åœ°é›†ç¾¤é»˜è®¤ä¸æ”¯æŒ <code>LoadBalancer</code> æœåŠ¡ï¼Œæ‰€ä»¥è¦è®©æœ¬åœ°é›†ç¾¤æ”¯æŒ <code>LoadBalancer</code> æœåŠ¡æ‰èƒ½ä½¿ç”¨ <code>coredns</code> æ¥å®ç° federation çš„æœåŠ¡å‘ç°åŠŸèƒ½ï¼ï¼ï¼</font>ï¼‰</li>
<li>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <code>helm charts</code> æ¥éƒ¨ç½² CoreDNSã€‚ CoreDNS éƒ¨ç½²æ—¶ä¼šä»¥ etcd ä½œä¸ºåç«¯ï¼Œå¹¶ä¸” etcd åº”é¢„å…ˆå®‰è£…ã€‚ etcd ä¹Ÿå¯ä»¥åˆ©ç”¨ helm charts è¿›è¡Œéƒ¨ç½²ã€‚</li>
<li>æ‰€æœ‰åŠ å…¥ federation çš„é›†ç¾¤çš„ node å¿…é¡»æ‰“ä¸Šä»¥ä¸‹çš„æ ‡ç­¾ï¼š<br />
<code>failure-domain.beta.kubernetes.io/region=&lt;region&gt;</code><br />
<code>failure-domain.beta.kubernetes.io/zone=&lt;zone&gt;</code></li>
</ul>

<h4 id="span-id-inline-toc-2-span-ä½¿æœ¬åœ°é›†ç¾¤æ”¯æŒ-loadbalancer-æœåŠ¡"><span id="inline-toc">2.</span> ä½¿æœ¬åœ°é›†ç¾¤æ”¯æŒ LoadBalancer æœåŠ¡</h4>

<p>ä¸ºäº†ä½¿æœ¬åœ°é›†ç¾¤æ”¯æŒ <code>LoadBalancer</code> æœåŠ¡ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹ä¸¤ç§å®ç°æ–¹æ¡ˆï¼š</p>

<ul>
<li><a href="https://github.com/munnerz/keepalived-cloud-provider" target="_blank">keepalived-cloud-provider</a></li>
<li><a href="https://github.com/google/metallb" target="_blank">metalLB</a></li>
</ul>

<p>è¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ <code>metalLB</code>ã€‚</p>

<p>metalLB çš„éƒ¨ç½²å¾ˆç®€å•ï¼Œç›´æ¥ä½¿ç”¨ yaml æ–‡ä»¶éƒ¨ç½²ï¼š</p>

<pre><code class="language-bash">$ kubectl apply -f https://raw.githubusercontent.com/google/metallb/v0.5.0/manifests/metallb.yaml
</code></pre>

<p>å…·ä½“å‚è€ƒ <a href="https://metallb.universe.tf/installation/" target="_blank">https://metallb.universe.tf/installation/</a></p>

<p>éƒ¨ç½²å®Œæˆåéœ€è¦ä¸º LoadBalancer æœåŠ¡é€‰æ‹©ä¸€ä¸ªç‰¹å®šçš„ IP åœ°å€æ± ï¼Œè¿™é‡Œé€šè¿‡ configmap æ¥åˆ›å»ºã€‚</p>

<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•ç¤ºä¾‹ï¼š</p>

<pre><code class="language-bash">$ cat metallb-cm.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: metallb-system
  name: config
data:
  config: |
    address-pools:
    - name: default
      protocol: layer2
      addresses:
      - 192.168.1.58-192.168.1.60

$ kubectl create -f metallb-cm.yaml
</code></pre>

<p>æ›´å¤šé«˜çº§é…ç½®è¯·å‚è€ƒï¼š<a href="https://metallb.universe.tf/configuration/" target="_blank">https://metallb.universe.tf/configuration/</a></p>

<p>ç°åœ¨æœ¬åœ°é›†ç¾¤å·²ç»æ”¯æŒ LoadBalancer æœåŠ¡äº†ï¼Œä¸‹é¢æˆ‘ä»¬å¼€å§‹ federation çš„æ—…ç¨‹å§ï¼ğŸ‘</p>

<h4 id="span-id-inline-toc-3-span-å®‰è£…-helm"><span id="inline-toc">3.</span> å®‰è£… helm</h4>

<p>é¦–å…ˆéœ€è¦å®‰è£… <code>helm</code> å®¢æˆ·ç«¯</p>

<pre><code class="language-bash">$ curl https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get &gt; get_helm.sh
$ chmod 700 get_helm.sh
$ ./get_helm.sh
</code></pre>

<p>åˆ›å»º tiller çš„ <code>serviceaccount</code> å’Œ <code>clusterrolebinding</code></p>

<pre><code class="language-bash">$ kubectl create serviceaccount --namespace kube-system tiller
$ kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller
</code></pre>

<p>ç„¶åå®‰è£… helm æœåŠ¡ç«¯ <code>tiller</code></p>

<pre><code class="language-bash">$ helm init
</code></pre>

<p>ä¸ºåº”ç”¨ç¨‹åºè®¾ç½® <code>serviceAccount</code>ï¼š</p>

<pre><code class="language-bash">$ kubectl patch deploy --namespace kube-system tiller-deploy -p '{&quot;spec&quot;:{&quot;template&quot;:{&quot;spec&quot;:{&quot;serviceAccount&quot;:&quot;tiller&quot;}}}}'
</code></pre>

<p>æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸï¼š</p>

<pre><code class="language-bash">$ kubectl -n kube-system get pods|grep tiller

tiller-deploy-7bf964fff8-sklts                1/1       Running   0          7h

$ helm version

Client: &amp;version.Version{SemVer:&quot;v2.8.2&quot;, GitCommit:&quot;a80231648a1473929271764b920a8e346f6de844&quot;, GitTreeState:&quot;clean&quot;}
Server: &amp;version.Version{SemVer:&quot;v2.8.2&quot;, GitCommit:&quot;a80231648a1473929271764b920a8e346f6de844&quot;, GitTreeState:&quot;clean&quot;}
</code></pre>

<h4 id="span-id-inline-toc-4-span-éƒ¨ç½²-etcd"><span id="inline-toc">4.</span> éƒ¨ç½² etcd</h4>

<p>ä¸‹è½½ <code>helm charts</code> ä»“åº“</p>

<pre><code class="language-bash">$ git clone https://github.com/kubernetes/charts.git
</code></pre>

<p>éƒ¨ç½² <code>etcd-operator</code>ï¼ˆetcd-operator ä¼šé€šè¿‡ kubernetes çš„ <code>CustomResourceDefinition</code> è‡ªåŠ¨åˆ›å»º <code>etcd cluster</code>ï¼‰</p>

<pre><code class="language-bash">$ cd charts

$ helm install --name etcd-operator stable/etcd-operator --set rbac.install=true,rbac.apiVersion=v1,customResources.createEtcdClusterCRD=true
</code></pre>

<p>æ£€æŸ¥æ˜¯å¦éƒ¨ç½²æˆåŠŸ</p>

<pre><code class="language-bash">$ kubectl get pods

NAME                                                              READY     STATUS    RESTARTS   AGE
etcd-cluster-6skfqj9mwp                                           1/1       Running   0          7m
etcd-cluster-6w8ntzvkwm                                           1/1       Running   0          8m
etcd-cluster-mclzhqrldf                                           1/1       Running   0          7m
etcd-operator-etcd-operator-etcd-backup-operator-5df985959bvvkw   1/1       Running   0          9m
etcd-operator-etcd-operator-etcd-operator-58d98b95c-x44bz         1/1       Running   0          9m
etcd-operator-etcd-operator-etcd-restore-operator-8688c7684nmdh   1/1       Running   0          9m

$ kubectl get crd

NAME                                    AGE
etcdbackups.etcd.database.coreos.com    1d
etcdclusters.etcd.database.coreos.com   1d
etcdrestores.etcd.database.coreos.com   1d

$ kubectl get crd etcdclusters.etcd.database.coreos.com -o yaml

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
...
...
spec:
  group: etcd.database.coreos.com
  names:
    kind: EtcdCluster
    listKind: EtcdClusterList
    plural: etcdclusters
    shortNames:
    - etcd
    singular: etcdcluster
  scope: Namespaced
  version: v1beta2
...
...

$ kubectl get EtcdCluster

NAME           AGE
etcd-cluster   11m

$ kubectl get svc

NAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
etcd-cluster            ClusterIP   None             &lt;none&gt;        2379/TCP,2380/TCP   17m
etcd-cluster-client     ClusterIP   10.254.140.7     &lt;none&gt;        2379/TCP            17m
etcd-restore-operator   ClusterIP   10.254.177.113   &lt;none&gt;        19999/TCP           18m
kubernetes              ClusterIP   10.254.0.1       &lt;none&gt;        443/TCP             16d
</code></pre>

<p>éƒ¨ç½²æˆåŠŸåï¼Œå¯ä»¥åœ¨ host é›†ç¾¤å†…é€šè¿‡ <a href="http://etcd-cluster-client.default:2379" target="_blank">http://etcd-cluster-client.default:2379</a> ç«¯ç‚¹è®¿é—® etcdã€‚</p>

<h4 id="span-id-inline-toc-5-span-éƒ¨ç½²-coredns"><span id="inline-toc">5.</span> éƒ¨ç½² CoreDNS</h4>

<p>é¦–å…ˆéœ€è¦å®šåˆ¶ <code>CoreDNS chart</code> æ¨¡æ¿çš„é»˜è®¤é…ç½®ï¼Œå®ƒä¼šè¦†ç›– <code>CoreDNS chart</code> çš„é»˜è®¤é…ç½®å‚æ•°ã€‚</p>

<pre><code class="language-bash">$ cat Value.yaml

isClusterService: false
serviceType: &quot;NodePort&quot;
plugins:
  kubernetes:
    enabled: false
  etcd:
    enabled: true
    zones:
    - &quot;example.com.&quot;
    endpoint: &quot;http://etcd-cluster-client.default:2379&quot;
</code></pre>

<p>å‚æ•°è¯´æ˜ï¼š</p>

<ul>
<li><code>isClusterService</code>: æŒ‡å®š CoreDNS æ˜¯å¦ä»¥é›†ç¾¤æœåŠ¡çš„å½¢å¼éƒ¨ç½²ï¼ˆé»˜è®¤ä¸ºæ˜¯ï¼‰ã€‚ éœ€è¦å°†å…¶è®¾ç½®ä¸º â€œfalseâ€ï¼Œä»¥ä½¿ CoreDNS ä»¥ Kubernetes åº”ç”¨æœåŠ¡çš„å½¢å¼éƒ¨ç½²ï¼Œå¦åˆ™ä¼šä¸é›†ç¾¤çš„ dns æœåŠ¡ kubedns å†²çªã€‚</li>
<li><code>serviceType</code>: æŒ‡å®šä¸º CoreDNS åˆ›å»ºçš„ Kubernetes æœåŠ¡ç±»å‹ã€‚ é€‰æ‹© â€œNodePortâ€ï¼Œä»¥ä½¿å¾— CoreDNS æœåŠ¡èƒ½å¤Ÿä» Kubernetes é›†ç¾¤å¤–éƒ¨è®¿é—®ã€‚</li>
<li><code>plugins.kubernetes</code>: é»˜è®¤æ˜¯å¯ç”¨çš„ï¼Œé€šè¿‡å°† <code>plugins.kubernetes.enabled</code> è®¾ç½®ä¸º â€œfalseâ€ æ¥ç¦ç”¨ plugins.kubernetesã€‚</li>
<li>é€šè¿‡å°† plugins.etcd.enabled è®¾ç½®ä¸º â€œtrueâ€ æ¥å¯ç”¨ plugins.etcdã€‚</li>
<li>é€šè¿‡è®¾ç½® <code>plugins.etcd.zones</code> æ¥é…ç½® CoreDNS è¢«æˆæƒçš„ DNS åŒºåŸŸï¼ˆè”é‚¦åŒºåŸŸï¼‰ã€‚</li>
<li>é€šè¿‡è®¾ç½® <code>plugins.etcd.endpoint</code> æ¥è®¾ç½®å…ˆå‰éƒ¨ç½²çš„ etcd çš„ç«¯ç‚¹ã€‚</li>
</ul>

<p>ç°åœ¨è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥éƒ¨ç½² CoreDNSï¼š</p>

<pre><code class="language-bash">$ helm install --name coredns -f Values.yaml stable/coredns
</code></pre>

<p>éªŒè¯éƒ¨ç½²ï¼š</p>

<pre><code class="language-bash">$ kubectl get pods -l app=coredns-coredns

NAME                               READY     STATUS    RESTARTS   AGE
coredns-coredns-57b54ddb97-xffnc   1/1       Running   0          1d

$ kubectl get svc -l app=coredns-coredns

NAME              TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)                                    AGE
coredns-coredns   NodePort   10.254.198.211   &lt;none&gt;        53:27165/UDP,53:27165/TCP,9153:26492/TCP   1d
</code></pre>

<h4 id="span-id-inline-toc-6-span-ä½¿ç”¨-coredns-ä½œä¸º-dns-æä¾›å•†æ¥éƒ¨ç½²-federation"><span id="inline-toc">6.</span> ä½¿ç”¨ CoreDNS ä½œä¸º DNS æä¾›å•†æ¥éƒ¨ç½² Federation</h4>

<p>å¯ä»¥ä½¿ç”¨ <code>kubefed init</code> æ¥éƒ¨ç½²è”é‚¦æ§åˆ¶å¹³é¢ã€‚ å¯ä»¥é€šè¿‡æŒ‡å®šä¸¤ä¸ªé™„åŠ å‚æ•°æ¥é€‰æ‹© CoreDNS ä½œä¸º DNS æä¾›å•†ã€‚</p>

<pre><code class="language-bash">--dns-provider=coredns
--dns-provider-config=coredns-provider.conf
</code></pre>

<p>coredns-provider.conf å†…å®¹å¦‚ä¸‹ï¼š</p>

<pre><code class="language-bash">[Global]
etcd-endpoints = http://etcd-cluster-client.default:2379
zones = example.com.
coredns-endpoints = &lt;coredns-server-ip&gt;:&lt;port&gt;
</code></pre>

<ul>
<li><code>etcd-endpoints</code> æ˜¯è®¿é—® etcd çš„ç«¯ç‚¹ã€‚</li>
<li><code>zones</code> æ˜¯ CoreDNS è¢«æˆæƒçš„è”é‚¦åŒºåŸŸï¼Œå…¶å€¼ä¸ <code>kubefed init</code> çš„ â€“-dns-zone-name å‚æ•°ç›¸åŒã€‚</li>
<li><code>coredns-endpoints</code> æ˜¯è®¿é—® CoreDNS æœåŠ¡å™¨çš„ç«¯ç‚¹ã€‚ è¿™æ˜¯ä¸€ä¸ª 1.7 ç‰ˆæœ¬å¼€å§‹å¼•å…¥çš„å¯é€‰å‚æ•°ã€‚</li>
</ul>

<div id="note">
<p id="note-title">Note</p>
<br />
<p>CoreDNS é…ç½®ä¸­çš„ <code>plugins.etcd.zones</code> ä¸ kubefed init çš„ â€“-dns-zone-name å‚æ•°åº”åŒ¹é…ã€‚</p>
</div>

<p>ç»™æ‰€æœ‰ node æ‰“ä¸Š <code>region</code> å’Œ <code>zone</code> çš„æ ‡ç­¾ï¼š</p>

<pre><code class="language-bash">$ kubectl label nodes 192.168.123.248 failure-domain.beta.kubernetes.io/zone=shanghai failure-domain.beta.kubernetes.io/region=yangpu

$ kubectl label nodes 192.168.123.249 failure-domain.beta.kubernetes.io/zone=shanghai failure-domain.beta.kubernetes.io/region=yangpu

$ kubectl label nodes 192.168.123.250 failure-domain.beta.kubernetes.io/zone=shanghai failure-domain.beta.kubernetes.io/region=yangpu
</code></pre>

<p>é€šè¿‡æœ¬æ¡å‘½ä»¤åˆå§‹åŒ– federation æ§åˆ¶å¹³é¢ï¼Œå‚æ•°å¦‚ä¸‹ï¼š</p>

<pre><code class="language-bash">$ kubefed init federation \ # è”é‚¦çš„åå­—
  --host-cluster-context=kubernetes \ # ä¸»é›†ç¾¤çš„contextåå­—
  --dns-provider=coredns \ # DNSæœåŠ¡æä¾›å•†
  --dns-zone-name=&quot;example.com.&quot; \ # å‰é¢æ³¨å†Œå¥½çš„åŸŸåï¼Œå¿…é¡»ä»¥.ç»“æŸ
  --dns-provider-config=&quot;coredns-provider.conf&quot; \ # coredns é…ç½®æ–‡ä»¶
  --api-server-service-type=&quot;NodePort&quot; \
  --api-server-advertise-address=&quot;192.168.123.250&quot;

  Creating a namespace federation-system for federation system components... done
  Creating federation control plane service..... done
  Creating federation control plane objects (credentials, persistent volume claim)... done
  Creating federation component deployments... done
  Updating kubeconfig... done
  Waiting for federation control plane to come up..................................................................................................................................................... done
  Federation API server is running at: 10.110.151.216
</code></pre>

<p>è§‚å¯Ÿä»¥ä¸Šè¾“å‡ºä¿¡æ¯ï¼Œè¯¥å‘½ä»¤åšäº†ä»¥ä¸‹å‡ ä»¶äº‹æƒ…ï¼š</p>

<ol>
<li><p>åˆ›å»ºä¸€ä¸ª namespace <code>federation-system</code></p>

<pre><code class="language-bash">$ kubectl get ns

NAME                STATUS    AGE
default             Active    8d
federation-system   Active    8s
kube-public         Active    8d
kube-system         Active    8d
my-namespace        Active    7d
</code></pre></li>

<li><p>åˆ›å»ºä¸¤ä¸ªæœåŠ¡ <code>federation-apiserver</code> å’Œ <code>federation-controller-manager</code></p>

<pre><code class="language-bash">$ kubectl -n federation-system get pods

NAME                                             READY     STATUS         RESTARTS   AGE
federation-apiserver-909415585-wktmw             1/1       Running   0          2s
federation-controller-manager-4247980660-c8ls5   1/1       Running   1          3s
</code></pre></li>

<li><p>åˆ›å»ºä¸€ä¸ª ServiceAccount <code>federation-controller-manager</code></p>

<pre><code class="language-bash">$ kubectl -n federation-system get sa

NAME                            SECRETS   AGE
default                         1         31m
federation-controller-manager   1         31m
</code></pre></li>

<li><p>åˆ›å»ºä¸€ä¸ª Role <code>federation-system:federation-controller-manager</code></p>

<pre><code class="language-bash">$ kubectl -n federation-system get role

NAME                                              AGE
federation-system:federation-controller-manager   38m
</code></pre></li>

<li><p>åˆ›å»ºä¸€ä¸ª RoleBinding <code>federation-system:federation-controller-manager</code></p>

<pre><code class="language-bash">$ kubectl -n federation-system get rolebinding

NAME                                              AGE
federation-system:federation-controller-manager   39m
</code></pre></li>

<li><p>åˆ›å»ºä¸€ä¸ª context <code>federation</code></p></li>
</ol>

<pre><code class="language-bash">    $ kubectl config get-contexts

    CURRENT   NAME         CLUSTER      AUTHINFO     NAMESPACE
              federation   federation   federation
    *         kubernetes   kubernetes   admin
</code></pre>

<div id="note">
<p id="note-title">Note</p>
<br />
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>kubefed init</code> é€šè¿‡åŠ¨æ€åˆ›å»º PV çš„æ–¹å¼ä¸º etcd åˆ›å»ºæŒä¹…åŒ–å­˜å‚¨ã€‚å¦‚æœ kubernetes é›†ç¾¤ä¸æ”¯æŒåŠ¨æ€åˆ›å»º PVï¼Œåˆ™å¯ä»¥é¢„å…ˆåˆ›å»º PVï¼Œæ³¨æ„ PV è¦åŒ¹é… `kubefed` çš„ PVCã€‚æˆ–è€…ä½¿ç”¨ <code>hostpath</code>ï¼ŒåŒæ—¶æŒ‡å®šè°ƒåº¦èŠ‚ç‚¹ã€‚</p>
</div>

<h4 id="span-id-inline-toc-7-span-æ·»åŠ é›†ç¾¤è‡³-federation"><span id="inline-toc">7.</span> æ·»åŠ é›†ç¾¤è‡³ federation</h4>

<p>ç›®å‰ä¸ºæ­¢æ‚¨å·²ç»æˆåŠŸçš„åˆå§‹åŒ–å¥½äº† <code>Federation</code> çš„æ§åˆ¶å¹³é¢ã€‚æ¥ä¸‹æ¥éœ€è¦å°†å„ä¸ªå­é›†ç¾¤åŠ å…¥åˆ° Federation é›†ç¾¤ä¸­ã€‚</p>

<p>æ·»åŠ é›†ç¾¤ <code>kubernetes</code>ï¼š</p>

<pre><code class="language-bash">$ kubefed join kubernetes \ #åŠ å…¥è”é‚¦çš„é›†ç¾¤å‘½ååå­—
  --context=federation \ #è”é‚¦çš„context
  --cluster-context=kubernetes \ #è¦æ·»åŠ é›†ç¾¤çš„context
  --host-cluster-context=kubernetes #ä¸»é›†ç¾¤çš„context

$ kubectl --context=federation get cluster

NAME          STATUS    AGE
kubernetes    Ready     6d
</code></pre>

<p>é€šè¿‡æˆ‘çš„è§‚å¯Ÿï¼Œä»¥ä¸Šè¿‡ç¨‹åœ¨ <code>åŠ å…¥ federation çš„ kubernetes é›†ç¾¤ä¸­</code> åšäº†ä»¥ä¸‹å‡ ä»¶äº‹æƒ…ï¼š</p>

<ol>
<li><p>åœ¨ namespace <code>federation-system</code> ä¸­åˆ›å»ºä¸€ä¸ª ServiceAccount <code>kubernetes-kubernetes</code></p>

<pre><code class="language-bash">$ kubectl -n federation-system get sa

NAME                            SECRETS   AGE
default                         1         45m
federation-controller-manager   1         45m
kubernetes-kubernetes           1         8m
</code></pre></li>

<li><p>åˆ›å»ºä¸€ä¸ª ClusterRole <code>federation-controller-manager:federation-kubernetes-kubernetes</code></p>

<pre><code class="language-bash">$ kubectl get clusterrole|egrep &quot;NAME|federation&quot;

NAME                                                                   AGE
federation-controller-manager:federation-kubernetes-kubernetes         10m
</code></pre></li>

<li><p>åˆ›å»ºä¸€ä¸ª ClusterRoleBinding <code>federation-controller-manager:federation-kubernetes-kubernetes</code></p>

<pre><code class="language-bash">$ kubectl get clusterrolebinding|egrep &quot;NAME|federation&quot;

NAME                                                             AGE
federation-controller-manager:federation-kubernetes-kubernetes   11m
</code></pre></li>
</ol>

<p>æ•´ä¸ªè¿‡ç¨‹æ˜¯å¦è¿˜è¿›è¡Œäº†å…¶ä»–æ“ä½œï¼Œæš‚æ—¶æ²¡æœ‰å‘ç°ï¼Œæœ‰å¾…ç»§ç»­ç ”ç©¶ã€‚</p>

<p><strong>ä»‹ç»ä¸‹é›†ç¾¤æŸ¥è¯¢ï¼Œç§»é™¤é›†ç¾¤ï¼Œåˆ é™¤è”é‚¦ç­‰å‘½ä»¤ï¼š</strong></p>

<p>æŸ¥è¯¢æ³¨å†Œåˆ° Federation çš„ kubernetes é›†ç¾¤åˆ—è¡¨</p>

<pre><code class="language-bash">$ kubectl --context=federation get clusters

NAME          STATUS    AGE
kubernetes    Ready     8m
</code></pre>

<p>ç§»é™¤ <code>kubernetes</code> é›†ç¾¤</p>

<pre><code class="language-bash">$ kubefed unjoin kubernetes --host-cluster-context=kubernetes --context=federation

Successfully removed cluster &quot;kubernetes&quot; from federation

$ kubectl --context=federation get clusters

No resources found.
</code></pre>

<p>é›†ç¾¤è”é‚¦æ§åˆ¶å¹³é¢çš„åˆ é™¤åŠŸèƒ½è¿˜åœ¨å¼€å‘ä¸­ï¼Œç›®å‰å¯ä»¥é€šè¿‡åˆ é™¤ namespace <code>federation-system</code> çš„æ–¹æ³•æ¥æ¸…ç†ï¼ˆæ³¨æ„pvä¸ä¼šåˆ é™¤ï¼‰ã€‚å‘½ä»¤åœ¨ host-cluster-context ä¸Šæ‰§è¡Œã€‚</p>

<pre><code class="language-bash">$ kubectl delete ns federation-system
</code></pre>

<h2 id="span-id-inline-toc-3-span-federation-æ”¯æŒçš„æœåŠ¡"><span id="inline-toc">3.</span> Federation æ”¯æŒçš„æœåŠ¡</h2>

<hr />

<p>é›†ç¾¤è”é‚¦æ”¯æŒä»¥ä¸‹è”é‚¦èµ„æºï¼Œè¿™äº›èµ„æºä¼šè‡ªåŠ¨åœ¨æ‰€æœ‰æ³¨å†Œçš„ <code>kubernetes</code> é›†ç¾¤ä¸­åˆ›å»ºã€‚</p>

<ul>
<li>Federated ConfigMap</li>
<li>Federated Service</li>
<li>Federated DaemonSet</li>
<li>Federated Deployment</li>
<li>Federated Ingress</li>
<li>Federated Namespaces</li>
<li>Federated ReplicaSets</li>
<li>Federated Secrets</li>
<li>Federated Eventsï¼ˆä»…å­˜åœ¨federationæ§åˆ¶å¹³é¢ï¼‰</li>
<li>Federated Jobsï¼ˆv1.8+ï¼‰</li>
<li>Federated Horizontal Pod Autoscaling (HPAï¼Œv1.8+)</li>
</ul>

<p>ç¤ºä¾‹ï¼š</p>

<p><strong>åˆ›å»º <code>deployment</code></strong></p>

<pre><code class="language-bash">$ cat nginx-deployment.yaml

apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 2
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80

$ kubectl --context=federation create ns default
$ kubectl --context=federation create -f nginx-deployment.yaml
</code></pre>

<p>å¯ä»¥é€šè¿‡ <code>kubectl scale deploy nginx --replicas=3 --context=federation</code> æ¥æ‰©å±• nginx å‰¯æœ¬ï¼Œç„¶åè§‚å¯Ÿ nginx åº”ç”¨åœ¨å„ä¸ªå­é›†ç¾¤ä¸­çš„åˆ†å¸ƒæƒ…å†µã€‚</p>

<pre><code class="language-bash">$ kubectl --context=kubernetes get deploy
</code></pre>

<p><strong>é€šè¿‡ Federated Service æ¥å®ç°è·¨é›†ç¾¤æœåŠ¡å‘ç°</strong></p>

<pre><code class="language-bash">$ cat nginx-svc.yaml

apiVersion: v1
kind: Service
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  type: LoadBalancer
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
    name: http
  selector:
    app: nginx

# è¿™ä¼šåœ¨æ‰€æœ‰æ³¨å†Œåˆ°è”é‚¦çš„ kubernetes é›†ç¾¤ä¸­åˆ›å»ºæœåŠ¡
$ kubectl --context=federation create -f nginx-svc.yaml

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
$ kubectl --context=federation describe services nginx

Name:                     nginx
Namespace:                default
Labels:                   app=nginx
Annotations:              federation.kubernetes.io/service-ingresses={&quot;items&quot;:[{&quot;cluster&quot;:&quot;kubernetes&quot;,&quot;items&quot;:[{&quot;ip&quot;:&quot;192.168.1.58&quot;}]}]}
Selector:                 app=nginx
Type:                     LoadBalancer
IP:
LoadBalancer Ingress:     192.168.1.58
Port:                     http  80/TCP
TargetPort:               80/TCP
Endpoints:                &lt;none&gt;
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   &lt;none&gt;
</code></pre>

<p>å¯ä»¥é€šè¿‡ DNS æ¥è®¿é—®è”é‚¦æœåŠ¡ï¼Œè®¿é—®æ ¼å¼åŒ…æ‹¬ä»¥ä¸‹å‡ ç§ï¼š</p>

<ul>
<li><code>&lt;service name&gt;.&lt;namespace&gt;.&lt;federation&gt;</code></li>
<li><code>&lt;service name&gt;.&lt;namespace&gt;.&lt;federation&gt;.svc.&lt;domain&gt;</code></li>
<li><code>&lt;service name&gt;.&lt;namespace&gt;.&lt;federation&gt;.svc.&lt;region&gt;.&lt;domain&gt;</code></li>
<li><code>&lt;service name&gt;.&lt;namespace&gt;.&lt;federation&gt;.svc.&lt;zone&gt;.&lt;region&gt;.&lt;domain&gt;</code></li>
</ul>

<p>æœ¬ä¾‹ä¸­å¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ä¸ªåŸŸåæ¥è®¿é—®ï¼š</p>

<ul>
<li><code>nginx.default.federation</code></li>
<li><code>nginx.default.federation.svc.example.com</code></li>
<li><code>nginx.default.federation.svc.shanghai.example.com</code></li>
<li><code>nginx.default.federation.svc.shanghai.yangpu.example.com</code></li>
</ul>

<p>DNS åœ¨ etcd ä¸‹çš„å­˜å‚¨è·¯å¾„ä¸ºï¼š<code>/skydns</code></p>

<pre><code class="language-bash">$ kubectl exec etcd-cluster-fznzsrttt9 etcdctl ls /skydns/com/example/

/skydns/com/example/kubernetes
/skydns/com/example/svc
/skydns/com/example/yangpu

$ kubectl exec etcd-cluster-fznzsrttt9 etcdctl ls /skydns/com/example/yangpu/

/skydns/com/example/yangpu/shanghai
/skydns/com/example/yangpu/svc
</code></pre>

<h2 id="span-id-inline-toc-4-span-å‚è€ƒæ–‡æ¡£"><span id="inline-toc">4.</span> å‚è€ƒæ–‡æ¡£</h2>

<hr />

<ul>
<li><a href="https://kubernetes.io/docs/concepts/cluster-administration/federation/" target="_blank">Kubernetes federation</a></li>
<li><a href="https://kubernetes.io/docs/tasks/federation/set-up-coredns-provider-federation/" target="_blank">Set up CoreDNS as DNS provider for Cluster Federation</a></li>
</ul>
                <br />
                <div style="text-align:center;color: #ccc;font-size:16px;font-family: cursive;">-----------ä»–æ—¥æ±Ÿæ¹–ç›¸é€¢ <i class="fa fa-umbrella"></i> å†å½“æ¯é…’è¨€æ¬¢-----------</div>
                <script src="https://www.yangcs.net/js/particle.js"></script>
                
                <div class="entry-shang text-center">
	<p>ã€ŒçœŸè¯šèµèµï¼Œæ‰‹ç•™ä½™é¦™ã€</p>
        <button class="zs show-zs btn rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}"> <span>èµ</span> </button>
</div>
<div class="zs-modal-bg"></div>
<div class="zs-modal-box">
	<div class="zs-modal-head">
		<button type="button" class="close">Ã—</button>
		<span class="author"><img src="/img/avatar-icon.png"/>æ¨ä¼ èƒœ</span>
		<p class="tip"><i></i><span>çœŸè¯šèµèµï¼Œæ‰‹ç•™ä½™é¦™</span></p>
 	</div>
	<div class="zs-modal-body">
		<div class="zs-modal-btns">
			<button class="btn btn-blink" data-num="2">2å…ƒ</button>
			<button class="btn btn-blink" data-num="5">5å…ƒ</button>
			<button class="btn btn-blink" data-num="10">10å…ƒ</button>
			<button class="btn btn-blink" data-num="50">50å…ƒ</button>
			<button class="btn btn-blink" data-num="100">100å…ƒ</button>
			<button class="btn btn-blink" data-num="1">ä»»æ„é‡‘é¢</button>
		</div>
		<div class="zs-modal-pay">
			<button class="btn btn-bred" id="pay-text">2å…ƒ</button>
			<p>ä½¿ç”¨<span id="pay-type">å¾®ä¿¡</span>æ‰«æäºŒç»´ç å®Œæˆæ”¯ä»˜</p>
			<img src="/img/wechat-2.png" id="pay-image"/>
		</div>
	</div>
	<div class="zs-modal-footer">
                <span class="zs-wechat"><img src="/img/wechat-btn.png"/></span>
	</div>
</div>

                
                
                <div class="social-share" data-initialized="true" data-wechat-qrcode-title="ä¸æ‰«åˆ«åæ‚”">
    <center>
    <font style="font-size:18px;color:darkcyan;">åˆ†äº«åˆ°ï¼š</font>
    <a href="#" class="social-share-icon icon-weibo"></a>
    <a href="#" class="social-share-icon icon-wechat"></a>
    <a href="#" class="social-share-icon icon-twitter"></a>
    <a href="#" class="social-share-icon icon-linkedin"></a>
    <a href="#" class="social-share-icon icon-facebook"></a>
    <a href="#" class="social-share-icon icon-qq"></a>
    <a href="#" class="social-share-icon icon-qzone"></a>
    </center>
</div>


<script src="https://hugo-picture.oss-cn-beijing.aliyuncs.com/social-share.min.js"></script>

                
            </article>

            <ul class="pager blog-pager">
                
                <li class="previous">
                    <a href="https://www.yangcs.net/posts/k8s-network-expand/" data-toggle="tooltip" data-placement="top" title="Kubernetes ç½‘ç»œæ‰©å±•">&larr; Previous Post</a>
                </li>
                 
                <li class="next">
                    <a href="https://www.yangcs.net/posts/how-manage-image/" data-toggle="tooltip" data-placement="top" title="docker åœ¨æœ¬åœ°å¦‚ä½•ç®¡ç† imageï¼ˆé•œåƒï¼‰?">Next Post &rarr;</a>
                </li>
                
            </ul>
            
            <div>
                 
                <h2>See Also</h2>
                <ul>
                    
                    <li><a href="/posts/k8s-network-expand/">Kubernetes ç½‘ç»œæ‰©å±•</a></li>
                    
                    <li><a href="/posts/calico-rr/">calico Router reflection(RR) æ¨¡å¼ä»‹ç»åŠéƒ¨ç½²</a></li>
                    
                </ul>
                
            </div>
            
            
            
              
            
            </div>
        </div>
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            
            
                
                  
                  
<aside id=comments>
    
    <div id="lv-container" data-id="city" data-uid="MTAyMC8yOTAwMy81NTcy">
    	<script data-cfasync="false" src="/cdn-cgi/scripts/d07b1474/cloudflare-static/email-decode.min.js"></script><script type="text/javascript">
       (function(d, s) {
           var j, e = d.getElementsByTagName(s)[0];
           if (typeof LivereTower === 'function') { return; }
           j = d.createElement(s);
           j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
           j.async = true;
           e.parentNode.insertBefore(j, e);
       })(document, 'script');
    	</script>
    <noscript> ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·æ¿€æ´»JavaScript</noscript>
    </div>
    
</aside>


                
            
        </div>
    </div>
    </section>
</div>

    <div class="rocket"><img src="http://ycs.ylck.me/rocket_up.png" alt="" width="100" height="100"></div>
<script>
    $(function () {
      $(window).scroll(function () {
        
        if ($(window).scrollTop() >= 1000) {
          $('.rocket').stop().fadeIn(1000);
        }else {
          $('.rocket').stop().fadeOut(1000);
        }
      })
      
      $('.rocket').click(function () {
        $('html,body').stop().animate({scrollTop:0},200);
       
      })
    })

</script>

    
    <div id="landlord">
        <div class="message" style="opacity:0"></div>
        <canvas id="live2d" width="280" height="250" class="live2d"></canvas>
        <div class="hide-button">éšè—</div>
    </div>
    
    <hr style="filter: alpha(opacity=100,finishopacity=0,style=3)" width="80%" color=#987cb9 size=3>
        <div class="gallery gallery-text">
    <center><h4>æ‰«ç å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·ï¼Œè·å–æ¯æ—¥æ¨é€</h4></center>
    <table frame="void" align="center">
    <tr>
        <td>
            <a href="https://hugo-picture.oss-cn-beijing.aliyuncs.com/qcode-wechat.png" title="äº‘åŸç”Ÿå®éªŒå®¤">
            <img src="https://hugo-picture.oss-cn-beijing.aliyuncs.com/qcode-wechat.png">
            </a>
        </td>
    </tr>
    </table>
</div>

    
    <script src="//static.getclicky.com/js" type="text/javascript"></script>
    <script type="text/javascript">try{ clicky.init(101151419); }catch(e){}</script>
    <noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/101151419ns.gif" /></p></noscript>
    
    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="https://www.facebook.com/ryanyangio" title="Facebook">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://plus.google.com/111949124259063786697" title="Google&#43;">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-google-plus fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/yangchuansheng" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/Paranoid_yang" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://drive.google.com/drive/folders/0By_W-zIhlMXqSGJyU3pHaVVpV2M" title="å°è§†é¢‘å…±äº«">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-youtube-play fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="https://www.yangcs.net/index.xml" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
        &copy;2017-2018
          
            
              Ryan Yang
                      
          
          &nbsp;&bull;&nbsp;
          November 28,2018
          updated
          
            &nbsp;&bull;&nbsp;
            <a href="https://www.yangcs.net/">Home</a>
          
        </p>

        <p class="credits theme-by text-muted">
        <a href="https://servicemesher.github.io" target="_blank">ServiceMesher</a>&nbsp;&bull;&nbsp;<a href="https://www.processon.com/view/link/5ac64532e4b00dc8a02f05eb" target="_blank">Kubernetes çŸ¥è¯†å›¾è°±</a>&nbsp;&bull;&nbsp;<a href="/friend/">å‹æƒ…é“¾æ¥</a>
        <br />
        <span id="busuanzi_container_site_pv">
            æœ¬ç«™å·²ç»è¢«è®¿é—® <span id="busuanzi_value_site_pv"></span> æ¬¡å•¦
        </span>
        <span id="busuanzi_container_site_uv">
            &ensp;|&ensp;&thinsp;æ‚¨æ˜¯ç¬¬ <span id="busuanzi_value_site_uv"></span> ä½åˆ°è®¿çš„å°ä¼™ä¼´å–”
        </span>
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.49</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          &nbsp;&bull;&nbsp;[<a href="true"></a>]
          <center><section class="credits theme-by text-muted">
    <span class="footer__copyright">
    <div>
    <span id="span_dt_dt"> </span>
    <script language="javascript">
      function show_date_time(){
        window.setTimeout("show_date_time()", 1000);
        BirthDay=new Date("7/8/2017 10:56:12");
        today=new Date();
        timeold=(today.getTime()-BirthDay.getTime());
        sectimeold=timeold/1000
        secondsold=Math.floor(sectimeold);
        msPerDay=24*60*60*1000
        e_daysold=timeold/msPerDay
        daysold=Math.floor(e_daysold);
        e_hrsold=(e_daysold-daysold)*24;
        hrsold=Math.floor(e_hrsold);
        e_minsold=(e_hrsold-hrsold)*60;
        minsold=Math.floor((e_hrsold-hrsold)*60);
        seconds=Math.floor((e_minsold-minsold)*60);
        span_dt_dt.innerHTML="æœ¬åšå®¢å·²ç»å¼€å¿ƒè¿è¡Œ "+daysold+" å¤© "+hrsold+" å°æ—¶ "+minsold+" åˆ† "+seconds+" ç§’";
      }
      show_date_time();
    </script>
    </div>
</script>
</section>
</center>
        </p>
      </div>
    </div>
  </div>
</footer>


<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/bootstrap.min.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/photoswipe-ui-default.min.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/photoswipe.min.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/auto-render.min.js"></script>
<script src="https://www.yangcs.net/js/main.js"></script>
<script src="https://www.yangcs.net/js/prism.js?t=123"></script>
<script src="https://www.yangcs.net/js/highlight.min.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/katex.min.js"></script>
<script src="https://www.yangcs.net/js/reward.js"></script>
<script src="https://www.yangcs.net/js/canvas_ribbon.js"></script>
<script> renderMathInElement(document.body); </script>

<script src="https://www.yangcs.net/js/baguetteBox.js"></script>
<script> baguetteBox.run('.gallery');</script>






<script async defer src="https://buttons.github.io/buttons.js"></script>



<script type="text/javascript">
 
var a_idx = 0;
jQuery(document).ready(function($) {
    $("body").click(function(e) {
        var a = new Array("Docker", "Kubernetes", "Prometheus", "Envoy", "Istio", "Service Mesh", "Cloud Native");
        var $i = $("<span />").text(a[a_idx]);
        a_idx = (a_idx + 1) % a.length;
        var x = e.pageX,
        y = e.pageY;
        function randomColor() {
          var flakeColor = new Array("#FFDA65", "#00BFFF", "#BA55D3", "#FFA07A", "#87CEEB", "#FFB6C1");
          var snowColor = flakeColor[Math.floor(flakeColor.length * Math.random())];
          return snowColor;
        }
        $i.css({
            "z-index": 999999999999999999999999999999999999999999999999999999999999999999999,
            "top": y - 20,
            "left": x,
            "position": "absolute",
            "font-weight": "bold",
            "color": randomColor()
        });
        $("body").append($i);
        $i.animate({
            "top": y - 180,
            "opacity": 0
        },
        1500,
        function() {
            $i.remove();
        });
    });
});
</script>


<script type="text/javascript" src="https://www.yangcs.net/js/lightbox.js"></script>


<script type="text/javascript">
    var live2d_Path = '/live2d/model/pio/'
    var message_Path = '/live2d/'
    var home_Path = 'https://www.yangcs.net/'  
</script>
<script type="text/javascript" src="https://www.yangcs.net/live2d/js/live2d.js"></script>
<script type="text/javascript" src="https://www.yangcs.net/live2d/js/message.js"></script>
<script type="text/javascript">
    loadlive2d("live2d", "/live2d/model/pio/model.json");
</script>








<script async src="https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video.min.js"></script>


  </body>
</html>

